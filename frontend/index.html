<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="UTF-8" />
<title>Dashboard - WFS4 MAD OPS</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{ --ui-scale: 1; }                   /* 1 = 100% */
html{ font-size: calc(16px * var(--ui-scale)); }
@media (min-width: 1600px){
:root{ --ui-scale: 1.15; }             /* TVs grandes: sube ligeramente por defecto */
}

:root{
--brand-red-900:#7f1d1d; --brand-red-800:#991b1b; --brand-red-700:#b91c1c;
--brand-red-600:#dc2626; --brand-red-500:#ef4444; --brand-red-400:#f87171;

--bg-page:#f7f8fa;
--bg-card:#ffffff;
--border:#e6e8ec;
--text:#1f2937;
--text-muted:#6b7280;

/* Categor√≠as Kanban (fondo completo) */
--cat-seg:#fee2e2;
--cat-inc:#fff1e6;
--cat-man:#eaf8f0;
--cat-cal:#EE27F5;
--cat-ser:#F5EE27;  
}

/* Base */
html,body{ background:var(--bg-page); color:var(--text); height:100%; }
body{ margin:0; font:14px "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
h1,h2,h3,.widget-title,.column-title .count{ font-family:"Space Grotesk", Inter, system-ui, sans-serif; letter-spacing:.2px; }

/* Header */
header{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
header h1{ margin:0; color:var(--brand-red-600); font-weight:700; font-size: clamp(1.6rem, 1vw + 1rem, 2.2rem); }
.header-controls{ display:flex; gap:12px; align-items:center; }
.header-controls input{ padding:6px 10px; border:1px solid var(--border); border-radius:8px; font-size:.9rem; background:#fff; }
.btn-primary{
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff; border:none; border-radius:10px; padding:10px 16px;
box-shadow:0 6px 16px rgba(220,38,38,.25);
transition:.15s transform,.2s box-shadow,.2s filter; cursor:pointer;
}
.btn-primary:hover{ transform:translateY(-1px); filter:saturate(110%); }

/* ======= Layout 3 columnas ======= */
.dashboard-3col{
min-height: 100svh;   /* respeta barra/gestos iPad */
height: auto;
display:grid;
grid-template-columns: 320px 1fr 380px;  /* IZQ / CENTRO / DER */
grid-template-rows: auto 1fr;
gap:20px; padding:20px;
}
header{ grid-column: 1 / -1; }
.col-left, .col-middle, .col-right{
min-height:0; overflow:auto; display:flex; flex-direction:column; gap:20px;
}

/* Widgets / tarjetas */
.widget,.card{
background:var(--bg-card);
border:1px solid var(--border);
border-radius:12px;
box-shadow: 0 6px 18px rgba(17,24,39,.06);
padding:16px;
}
.widget-title{ font-size:1.05rem; font-weight:700; margin:0 0 12px; display:flex; align-items:center; justify-content:space-between; }
.widget-title-icon{ width:16px; height:16px; color:var(--text-muted); }

/* Kanban / Kaizen */
.board-container{ display:grid; gap:12px; }
.board-container.kanban{ grid-template-columns: repeat(4, minmax(0,1fr)); }
.board-container.kaizen{ grid-template-columns: repeat(3, minmax(0,1fr)); }

.kanban-column{ display:flex; flex-direction:column; min-width:0; }
.column-title{
display:flex; justify-content:space-between; align-items:baseline;
font-size:.85rem; font-weight:600; color:var(--text-muted);
margin:0 0 6px; padding-bottom:8px; border-bottom:2px solid #e9ecef;
}
.column-title .count{ background:#eef1f4; color:var(--text-muted); padding:2px 6px; border-radius:6px; font-size:.8rem; }
.cards-container{ min-height:120px; max-height: clamp(280px, 48svh, 70vh);
overscroll-behavior: contain;
-webkit-overflow-scrolling: touch; overflow:auto; padding-top:4px; }

.card{
position:relative;
margin-bottom:8px;
padding:10px 12px;
display:flex; align-items:center; justify-content:space-between; gap:8px;
cursor:grab;
}
.card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06); }
.card-content{ flex:1 1 auto; min-width:0; }
.card-title{
font-weight:600; font-size:.95rem; margin:0 0 4px; line-height:1.25;
overflow:hidden; max-height:2.5em; display:inline-block;
transform:scale(1.12); transform-origin:left top;
}
.card-details,.card-assignee{ font-size:.8rem; color:var(--text-muted); }
.card-assignee{ margin-top:4px; }
.card-actions .icon{ width:14px; height:14px; }
.delete-card-btn{ background:none; border:none; color:#9ca3af; display:none; cursor:pointer; }
.card:hover .delete-card-btn{ display:block; }

.sortable-ghost{ opacity:.4; background:#dee2e6; }
.sortable-drag{ opacity:1 !important; transform:rotate(2deg); box-shadow:0 8px 24px rgba(0,0,0,.15); }

/* Chips de categor√≠a */
.cat-chip{
display:inline-block; margin-left:8px; font-size:.7rem; font-weight:700;
padding:2px 6px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
vertical-align:middle; background:rgba(255,255,255,.7);
}

/* === KANBAN: te√±ido completo por categor√≠a (scoped) === */
#kanban-widget .card.cat-seguridad      { background: var(--cat-seg); }
#kanban-widget .card.cat-incidencias    { background: var(--cat-inc); }
#kanban-widget .card.cat-mantenimiento { background: var(--cat-man); }
#kanban-widget .card.cat-calidad { background: var(--cat-cal); }
#kanban-widget .card.cat-servicio { background: var(--cat-ser); }  

/* 5S & GW */
.checkbox-item{ display:flex; align-items:center; gap:8px; margin-bottom:8px; font-size:.9rem; }
.gw-task-item{
display:flex; align-items:center; gap:8px; padding:6px 4px;
font-size:.9rem; border-bottom:1px solid var(--border); cursor:pointer;
}
.gw-task-item:last-child{ border-bottom:none; }
.gw-task-item.completed label{ color:var(--text-muted); text-decoration:line-through; }
.gw-note{
font-size:.85rem; width:100%; margin-top:4px; padding:6px 8px;
border:1px solid var(--border); border-radius:6px;
}
.gw-note:disabled{ background:#f8f9fa; color:var(--text-muted); }

/* ===== 5S gestionable ===== */
.s5-compact{
display:flex; gap:6px; flex-wrap:wrap; align-items:center;
}
.s5-pill{
display:inline-flex; align-items:center; gap:6px;
border:1px solid var(--border); background:#fff;
border-radius:999px; padding:6px 10px; font-size:.8rem; line-height:1;
cursor:pointer; user-select:none;
transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.s5-pill:hover{ transform:translateY(-1px); }
.s5-pill:active{ transform:translateY(0); }
.s5-dot{ width:8px; height:8px; border-radius:50%; background:#d1d5db; }

/* Estado activado (OK) */
.s5-pill.on{
background:linear-gradient(135deg, #ecfdf5, #ffffff);
border-color: rgba(16,185,129,.55);
box-shadow: inset 0 0 0 2px rgba(16,185,129,.08);
}
.s5-pill.on .s5-dot{ background:#10b981; }
@keyframes s5-bump{ 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
.s5-pill.bump{ animation:s5-bump .18s ease-out; }
#s5-meta{ margin-top:4px; font-size:.78rem; }


/* EHS simple */
#ehs-widget{ display:flex; flex-direction:column; gap:8px; }
#ehs-month{ color:var(--text-muted); font-size:.95rem; }
.ehs-controls{
display:flex; align-items:center; gap:14px;
border:1px solid var(--border); border-radius:12px; padding:8px 10px;
}
.ehs-btn{
width:42px; height:42px; border:none; border-radius:10px; cursor:pointer;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff; font-size:1.3rem; line-height:1; display:flex; align-items:center; justify-content:center;
}
.ehs-big{ font-size: clamp(2rem, 2.2vw + .8rem, 3rem); font-weight:800; line-height:1; color:var(--brand-red-600); min-width:3ch; text-align:center; }

/* KPI Costes */
#kpi-costes .kpi-value.large{ font-size: clamp(2.1rem, 2.3vw + 1rem, 3.2rem); line-height:1; font-weight:700; }
#kpi-total-cost{ color:var(--brand-red-600); font-weight:800; }
.kpi-text{ color:var(--text-muted); margin:0; font-size:.9rem; }
.kpi-currency{ font-size:1rem; font-weight:600; margin-left:4px; vertical-align:super; color:var(--brand-red-600); }
.flash{ animation: flash-kpi 900ms ease-out; }
@keyframes flash-kpi{ from{ background:#fff3cd; } to{ background:transparent; } }

/* Responsive scroll */
.table-scroll,
.col-left, .col-middle, .col-right{
-webkit-overflow-scrolling: touch;
overscroll-behavior: contain;
scroll-padding-bottom: 40px; 
}
#planif-table{ width:100%; border-collapse:collapse; font-size:.9rem; }
#planif-table thead th{
position:sticky; top:0; background:#fafafa; border-bottom:1px solid var(--border);
text-align:left; padding:8px; z-index:1;
}
#planif-table tbody td{ padding:8px; border-bottom:1px solid var(--border); white-space:nowrap; }

/* Fullscreen helpers */
.widget, .card{ position:relative; }
.fs-toggle{
  position:absolute; top:10px; right:10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.95);
  border-radius:12px;
  padding:10px;                  /* antes ~6px */
  cursor:pointer; line-height:0; opacity:.8;
  display:inline-flex; align-items:center; justify-content:center;
  transition: opacity .15s, transform .15s, box-shadow .15s;
  box-shadow:0 4px 12px rgba(0,0,0,.10);
  min-width:44px; min-height:44px;   /* objetivo t√°ctil recomendado */
}
.fs-toggle:hover{ opacity:1; transform:scale(1.06); }
.fs-toggle svg{ width:18px; height:18px; display:block; }

.widget:fullscreen, .card:fullscreen{ background:#fff; border-radius:0; box-shadow:none; padding:24px; }
:fullscreen{ overflow:auto; }
html.fs-zoom{ font-size:18px; }
@media (min-width:1280px){ html.fs-zoom{ font-size:20px; } }

/* Responsive m√≠nimo */
@media (max-width: 1200px){
.dashboard-3col{ grid-template-columns: 280px 1fr 320px; }
}
@media (max-width: 980px){
.dashboard-3col{ grid-template-columns: 1fr; grid-template-rows: auto auto auto auto; }
.col-left,.col-right{ order:2; }
.col-middle{ order:1; }
}

/* Asa de arrastre MEJORADA PARA T√ÅCTIL */
.drag-handle{
    align-self:stretch;
    display:flex; align-items:center; justify-content:center;
    padding: 12px; 
    border:1px solid var(--border);
    border-radius:10px;
    background:var(--bg-card);
    cursor:grab;
    opacity:.7;
    touch-action: none; 
    -webkit-user-select: none;
    user-select: none;
}
.card:active .drag-handle{ cursor:grabbing; opacity:1; background: #f3f4f6; }
.drag-handle svg{ width:20px; height:20px; }

/* === Cron√≥metro (m√°s peque√±o) === */
.header-timer { min-height: 56px; display:flex; align-items:center; gap:10px;}
.header-timer .timer-face{ display:flex; align-items:center; gap:10px; }
.header-timer .timer-display{
font-size: clamp(1.8rem, 5vw, 5rem);
font-family:"Space Grotesk", Inter, system-ui, sans-serif; font-weight:800;
transition: color .2s ease, text-shadow .2s ease;
}
.header-timer .timer-display.is-red{ color: var(--brand-red-600); }
.header-timer .timer-dot{ width:10px; height:10px; border-radius:50%; background: var(--brand-red-600); opacity:.75; }
.header-timer .timer-reset{ min-width:40px; min-height:40px; padding:6px 10px; font-weight:600; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; }
.timer-start-btn {
    background: #10b981; color: white; border: none; border-radius: 8px;
    padding: 6px 12px; font-weight: 700; font-size: 0.9rem;
    cursor: pointer; box-shadow: 0 4px 10px rgba(16,185,129,0.3);
}

/* === Checklist en cuadr√≠cula (responsive) === */
.check-grid{
display:grid; gap:8px;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
.check-card{
display:flex; flex-direction:column;
align-items:flex-start; justify-content:flex-start;
gap:10px; padding:14px 16px; min-height:84px;
border: 1px solid var(--border); box-shadow: 0 6px 16px rgba(17,24,39,.06);
}
.check-card:focus{ outline: 2px solid rgba(239,68,68,.35); outline-offset: 2px; border-radius: 10px; }

.check-title{
font-weight:600; font-size:.95rem; line-height:1.25;
white-space:normal; overflow:visible; word-break:break-word;
}
.check-actions{ width:100%; display:flex; flex-wrap:wrap; gap:8px; }
.check-actions label{ padding:6px 12px; border-radius:999px; font-size:.78rem; cursor:pointer; user-select:none; border:1px solid var(--border); background:#fff;}
.check-actions input:checked + label{
background:#ecfdf5; border-color:rgba(16,185,129,.6);
box-shadow: inset 0 0 0 2px rgba(16,185,129,.08);
}
.check-actions input {display:none;}

/* === Spotlight Checklist === */
#brief-check{
position: sticky; top: 0; z-index: 5;
border: 2px solid rgba(239,68,68,.45);
box-shadow: 0 14px 36px rgba(239,68,68,.18), 0 2px 0 rgba(255,255,255,.9) inset;
background: radial-gradient(1200px 200px at 50% -60px, rgba(239,68,68,.06), transparent), #fff;
animation: brief-pop .25s ease-out;
height: auto !important; max-height: none !important; overflow: visible !important; padding-bottom: 10px;
}
#brief-check .widget-title{ font-size: 1.25rem; color: var(--brand-red-700); }
#brief-check .check-grid{ grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
#brief-check .check-card{ min-height: auto; padding: 8px 10px; }
#brief-check .check-title { font-size: 0.85rem; }
#brief-check .check-actions { margin-top: 0; justify-content: flex-start; }
#brief-check .check-actions label { padding: 2px 8px; font-size: 0.75rem; }
#brief-check .br-explain { display: none; }

@keyframes brief-pop { from { transform: scale(.985); opacity:.96; } to { transform: scale(1); opacity:1; } }

/* Chip de turno */
.shift-chip{
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 12px; border: 1px solid var(--border); border-radius: 999px;
  background: #fff; font-weight: 600; font-size: .9rem; margin: 6px auto 10px;
}
.shift-chip[data-shift="Ma√±ana"]{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
.shift-chip[data-shift="Tarde"]{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
.shift-chip[data-shift="Noche"]{ background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }

/* Spotlight / Parpadeo guiado */
.spotlight-blink{
position: relative;
border-color: rgba(239,68,68,.6) !important;
box-shadow: 0 0 0 3px rgba(239,68,68,.20), 0 14px 36px rgba(239,68,68,.12);
animation: blink-glow 1.2s ease-in-out infinite;
}
@keyframes blink-glow{
0%, 100% { box-shadow: 0 0 0 2px rgba(239,68,68,.18), 0 8px 22px rgba(239,68,68,.10); transform: translateZ(0) scale(1); }
50%      { box-shadow: 0 0 0 5px rgba(239,68,68,.28), 0 18px 44px rgba(239,68,68,.18); transform: translateZ(0) scale(1.01); }
}

/* === Est√©tica VIVID (Ops, Seguridad, Incidentes) === */
:root{
  --vivid-pink:#ff4d8d; --vivid-orange:#ff7a18; --vivid-yellow:#ffd43b;
  --vivid-green:#10b981; --vivid-blue:#3b82f6; --vivid-violet:#8b5cf6;
  --vivid-red:#ef4444; --vivid-amber:#f59e0b;
}
.widget.vivid .widget-title.hero{
  position: relative; display:flex; align-items:center; gap:10px;
  padding:12px 14px; margin:-16px -16px 12px;
  border-radius:12px 12px 0 0; color:#0b1220;
  background: radial-gradient(1200px 200px at 10% -140px, rgba(255,255,255,.7), transparent), linear-gradient(135deg, #fff 0%, #ffe9f2 40%, #fff5e6 100%);
  border-bottom: 2px solid rgba(0,0,0,.05);
}
.widget.vivid .hero-badge{
  margin-left:auto; font-size:.72rem; font-weight:900; letter-spacing:.3px;
  padding:6px 10px; border-radius:999px;
  background:linear-gradient(135deg, var(--vivid-blue), var(--vivid-violet));
  color:#fff; box-shadow:0 6px 14px rgba(59,130,246,.25);
}
.widget.vivid .hero-badge.warn{ background:linear-gradient(135deg, var(--vivid-amber), var(--vivid-yellow)); color:#2b1800; }
.widget.vivid .hero-badge.danger{ background:linear-gradient(135deg, #ff8a8a, var(--vivid-red)); color:#fff; }

/* OPS Vivid Items */
#ops-updates-widget.vivid .ops-item{
  position:relative; border:1px solid rgba(0,0,0,.06); background:#fff;
  border-radius:14px; padding:12px 12px 10px 12px;
  box-shadow:0 8px 22px rgba(17,24,39,.08); overflow:hidden; margin-bottom: 10px;
}
#ops-updates-widget.vivid .ops-item .ops-impact{ font-weight:900; padding:4px 10px; border-radius:999px; font-size:.75rem; }
#ops-updates-widget.vivid .ops-item .ops-impact.Alto{ background:linear-gradient(135deg,#ffb3b3, var(--vivid-red)); color:#611818; }
#ops-updates-widget.vivid .ops-item .ops-impact.Medio{ background:linear-gradient(135deg,#ffe7b3, var(--vivid-amber)); color:#663a00; }
#ops-updates-widget.vivid .ops-item .ops-impact.Bajo{ background:linear-gradient(135deg,#bff0da, var(--vivid-green)); color:#0b4a37; }
.ops-head{ display:flex; align-items:center; gap:8px; justify-content:space-between; }
.ops-title{ font-weight:800; font-size:1rem; }
.ops-flags{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.ops-meta{ color:var(--text-muted); font-size:.82rem; display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px;}
.ops-btn{ border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 10px; font-size:.8rem; cursor:pointer; }

/* Incidentes Table Candy */
#incidentes-widget.vivid .table-scroll table{ border:1px solid #ffe0e0; border-radius:12px; overflow:hidden; }
#incidentes-widget.vivid table thead th{ background: linear-gradient(180deg,#fff1f1,#ffe5e5); border-bottom:1px solid #ffd0d0; font-weight:800; }
#incidentes-widget .incident-remember{
  margin: 6px 0 8px; padding: 10px 12px;
  background: linear-gradient(135deg,#fff,#ffe7ea 60%), repeating-linear-gradient(45deg, rgba(239,68,68,.06) 0 8px, rgba(239,68,68,.12) 8px 16px);
  color: var(--brand-red-700); border: 2px solid var(--brand-red-600); border-radius: 12px;
  font-weight:800; letter-spacing:.2px;
}

/* === Navegaci√≥n y Modos Fullscreen === */
.widget-nav-bar {
    display: none; justify-content: space-between; align-items: center;
    background: #fff; padding: 10px 15px; border-bottom: 1px solid var(--border);
    margin: -16px -16px 16px -16px; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.widget:fullscreen .widget-nav-bar, .widget.widget--zoomed .widget-nav-bar { display: flex; }
.nav-group { display: flex; gap: 10px; align-items: center; }
.btn-nav {
    display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px;
    font-weight: 700; cursor: pointer; transition: all 0.2s; border: 1px solid #d1d5db; background: #f8fafc; color: #334155;
}
.btn-nav:hover { transform: translateY(-1px); }
.btn-nav.home { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
.btn-nav.next-ok { background: #dcfce7; color: #166534; border-color: #86efac; }

/* === MODO TURNO Y CRON√ìMETRO FLOTANTE === */
body.shift-mode #timer-widget {
    position: fixed !important; bottom: 20px !important; left: 50% !important; transform: translateX(-50%) !important;
    z-index: 2147483647 !important;
    display: flex !important; background: #ffffff !important; padding: 10px 40px !important;
    border-radius: 50px !important; border: 4px solid #dc2626 !important;
    box-shadow: 0 10px 100px rgba(0,0,0,0.5) !important;
    visibility: visible !important; opacity: 1 !important; width: auto !important; height: auto !important;
}
body.shift-mode #timer-display { font-size: 4rem !important; font-weight: 800 !important; color: #1f2937 !important; line-height: 1 !important; }
body.shift-mode #timer-reset { width: 50px !important; height: 50px !important; font-size: 20px !important; border-radius: 50% !important; }

/* Widget en "Fake Fullscreen" debajo del crono */
.widget.shift-focus {
    position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important;
    z-index: 10000 !important; background: #f8fafc !important; overflow-y: auto !important;
    padding: 30px 30px 140px 30px !important; border-radius: 0 !important; margin: 0 !important;
}
.widget.shift-focus .widget-title { font-size: 2rem !important; text-align: center; margin-bottom: 30px !important; color: #b91c1c; }
.widget.shift-focus .check-grid { display: grid !important; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important; gap: 15px !important; max-width: 1400px; margin: 0 auto; }
.widget.shift-focus .check-card { padding: 15px !important; min-height: auto !important; background: #fff; border: 1px solid #cbd5e1; display: flex; flex-direction: column; gap: 10px; }

/* Widget Zoomed (al navegar) */
.widget.widget--zoomed {
    position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important;
    z-index: 20000 !important; background: #ffffff !important; padding: 20px 20px 180px 20px !important;
    overflow-y: auto !important; margin: 0 !important; display: block !important;
}

/* === KPIs centro === */
.kpi-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
.kpi-tile{ border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; box-shadow:0 6px 18px rgba(17,24,39,.06); }
.kpi-label{ font-weight:700; font-size:.9rem; color:var(--text-muted); margin-bottom:4px; }
.kpi-value{ font-family:"Space Grotesk", Inter, system-ui, sans-serif; font-weight:800; font-size: clamp(1.6rem, 2.6vw + .4rem, 2.6rem); line-height:1; color:var(--brand-red-600); }

/* === Incidentes Manuales === */
.inc-card { background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; display: flex; flex-direction: column; gap: 6px; margin-bottom: 6px; }
.inc-card.type-incident { border-left: 5px solid #dc2626; }
.inc-card.type-lesson { border-left: 5px solid #8b5cf6; }
.inc-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.inc-badge { font-size: 0.75rem; font-weight: 800; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; }
.type-incident .inc-badge { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
.type-lesson .inc-badge { background: #f5f3ff; color: #5b21b6; border: 1px solid #ddd6fe; }
.inc-del-btn { background: none; border: none; cursor: pointer; opacity: 0.6; font-size: 1rem; }

/* === Turno Anterior === */
.prev-item { background: #fff; border: 1px solid var(--border); border-left: 4px solid #f59e0b; border-radius: 8px; padding: 8px 10px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
.prev-btn { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; font-size: 0.75rem; cursor: pointer; }

/* Bot√≥n cerrar vista turno */
#exit-shift-mode-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 2147483647 !important; padding: 12px 24px; background: #334155; color: white; border: 2px solid #fff; border-radius: 12px; cursor: pointer; font-weight: 800; }
body.shift-mode #exit-shift-mode-btn { display: block !important; }

/* === Post Briefing Screen === */
#post-briefing-screen { display: none; position: fixed; inset: 0; background-color: #f8fafc; z-index: 99999; padding: 20px; flex-direction: column; }
#post-briefing-screen.active { display: flex; }
.pb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
.pb-title { font-size: 1.8rem; font-weight: 800; color: var(--brand-red-700); }
.pb-close-btn { background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
.pb-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; flex: 1; overflow: hidden; }
@media (max-width: 1000px) { .pb-grid { grid-template-columns: 1fr; grid-template-rows: auto; overflow-y: auto; } }
.pb-card { background: white; border: 1px solid #cbd5e1; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
.pb-card-title { font-size: 1.4rem; font-weight: 700; border-bottom: 4px solid var(--brand-red-500); margin-bottom: 15px; width: fit-content; }
.pb-content { flex: 1; overflow-y: auto; font-size: 1.1rem; line-height: 1.6; }
.pb-kpi-box { display: flex; justify-content: space-around; align-items: center; height: 100%; }
.pb-kpi-item { text-align: center; padding: 20px; background: #f1f5f9; border-radius: 12px; }
.pb-kpi-val { font-size: 3rem; font-weight: 800; color: var(--brand-red-600); display: block; }
</style>
</head>
<body>

<button id="exit-shift-mode-btn" onclick="exitShiftMode()">Cerrar Vista Turno ‚úñ</button>

<select id="scale-select" aria-label="Escala UI">
<option value="1">100%</option>
<option value="1.15" selected>115%</option>
<option value="1.3">130%</option>
<option value="1.5">150%</option>
</select>
<button id="present-btn" class="btn-primary" type="button" title="Pantalla completa">Presentar</button>

<div class="dashboard-3col">
<header>
<div class="header-left">
<h1>Factory Floor Dashboard - WFS4 MAD OPS</h1>
<div id="now-header" role="status" aria-live="polite">‚Äî</div>
<span id="shift-badge-header" class="shift-chip">‚Äî</span>
</div>

<div class="header-timer" id="timer-widget" aria-label="Cron√≥metro">
    <div class="timer-face" id="timer-face">
        <div class="timer-display" id="timer-display">00:00:00</div>
        <span class="timer-dot" aria-hidden="true"></span>
    </div>
    <button type="button" id="timer-start-btn" class="timer-start-btn">Comenzar</button>
    <button type="button" class="timer-reset" id="timer-reset">Reiniciar</button>
</div>

<div class="header-controls">
    <input type="text" id="briefing-supervisor" placeholder="Supervisor" style="min-width: 140px; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
    <button type="button" class="btn-mic" data-target="briefing-supervisor" title="Dictar nombre">üéôÔ∏è</button>
    <button class="btn-primary" type="button">Generar Resumen</button>
</div>
</header>

<section class="col-left">
<div class="widget" id="team-widget">
<h2 class="widget-title">1) Equipo / Turno</h2>
<small class="kpi-text" id="team-meta">‚Äî</small>

<form id="team-form" class="team-form" autocomplete="off" style="display:flex; gap:8px; align-items:center; margin:8px 0;">
<input type="text" id="team-name" placeholder="A√±adir persona‚Ä¶" required style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;"/>
<button type="submit" class="btn-primary" style="padding:8px 12px;">+</button>
</form>

<form id="roster-upload-form" style="display:flex; gap:8px; align-items:center; margin:8px 0;">
  <input type="file" id="roster-file" accept=".xlsx,.xls" required style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;">
  <button class="btn-primary" type="submit">Subir Excel</button>
</form>
<small id="roster-upload-result" class="kpi-text">‚Äî</small>

<div id="team-list" class="team-list" style="display:flex; flex-direction:column; gap:6px;"></div>
</div>
</section>

<section class="col-middle">
<div class="widget" id="brief-check">
<h2 class="widget-title"><span>Checklist</span></h2>
<span id="shift-badge" class="shift-chip">‚Äî</span>
  
<div class="check-grid">
  <div class="check-card" tabindex="0" data-target="team-widget">
    <span class="check-title">1) Dotaci√≥n y recursos</span>
    <div class="check-actions" role="group" aria-label="Bloque 1">
      <input id="c1ok" type="radio" name="c1" value="OK"><label for="c1ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0" data-target="ops-updates-widget">
    <span class="check-title">2) Actualizaciones operativas</span>
    <div class="check-actions" role="group" aria-label="Bloque 2">
      <input id="c2ok" type="radio" name="c2" value="OK"><label for="c2ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0" data-target="prev-shift-widget">
    <span class="check-title">3) Highlights del turno anterior</span>
    <div class="check-actions" role="group" aria-label="Bloque 3">
      <input id="c3ok" type="radio" name="c3" value="OK"><label for="c3ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0" data-target="seguridad-widget">
    <span class="check-title">4) Safety, Security, Quality & PRL</span>
    <div class="check-actions" role="group" aria-label="Bloque 4">
      <input id="c4ok" type="radio" name="c4" value="OK"><label for="c4ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0" data-target="incidentes-widget">
    <span class="check-title">5) Preparaci√≥n/reportes incidentes</span>
    <div class="check-actions" role="group" aria-label="Bloque 5">
      <input id="c5ok" type="radio" name="c5" value="OK"><label for="c5ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0" data-target="kpi-center">
    <span class="check-title">6) Revisi√≥n Kpis</span>
    <div class="check-actions" role="group" aria-label="Bloque 6">
      <input id="c6ok" type="radio" name="c6" value="OK"><label for="c6ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0" data-target="kanban-widget">
    <span class="check-title">7) Feedback ‚Üí Acciones</span>
    <div class="check-actions" role="group" aria-label="Bloque 7">
      <input id="c7ok" type="radio" name="c7" value="OK"><label for="c7ok">OK</label>
    </div>
  </div>
</div>
<small class="kpi-text" id="brief-check-meta">‚Äî</small>
</div>

<div class="widget vivid" id="ops-updates-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">üöß</span><span>2) Actualizaciones operativas</span>
    <span class="hero-badge">EN VIVO</span>
  </h2>

  <div class="ops-toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
    <input id="ops-q" type="search" placeholder="Buscar‚Ä¶" style="flex:1;min-width:220px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;">
    <select id="ops-prio" style="padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;">
      <option value="">Todas</option><option>Alto</option><option>Medio</option><option>Bajo</option>
    </select>
    <select id="ops-scope" style="padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;">
      <option value="">√Åmbito</option>
      <option>General</option><option>Isla</option><option>Dorada</option>
      <option>Muelle Imp</option><option>Muelle Exp</option><option>Import</option><option>Export</option>
    </select>
    <button type="button" class="btn-compact" id="ops-add">+ Nueva</button>
  </div>

  <div id="ops-list" class="ops-list" role="list"></div>

  <dialog id="ops-dialog" style="border:1px solid var(--border);border-radius:12px;padding:12px;max-width:520px;width:clamp(280px,90vw,520px);">
    <form method="dialog" id="ops-form" style="display:grid;gap:8px;">
      <h3 style="margin:0;">Actualizar</h3>
      <input type="hidden" id="ops-id">
      <label>T√≠tulo <input id="ops-title" type="text" required style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;"></label>
      <label>Prioridad <select id="ops-impact" required style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;"><option>Alto</option><option>Medio</option><option>Bajo</option></select></label>
      <label>√Åmbito <select id="ops-scope-field" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;"><option>General</option><option>Isla</option><option>Dorada</option><option>Muelle Imp</option><option>Muelle Exp</option><option>Import</option><option>Export</option></select></label>
      <label>Responsable <input id="ops-owner" type="text" placeholder="Ej.: @juan"></label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <label>Desde <input id="ops-from" type="date"></label>
        <label>Hasta <input id="ops-to" type="date"></label>
      </div>
      <menu style="display:flex;gap:8px;justify-content:flex-end;margin:0;padding-top:8px;">
        <button type="button" class="btn-compact" value="cancel">Cancelar</button>
        <button type="submit" class="btn-primary" id="ops-save">Guardar</button>
      </menu>
    </form>
  </dialog>
</div>

<div class="widget vivid" id="seguridad-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">üõ°Ô∏è</span><span>4) Safety, Security, Quality & PRL</span>
    <span class="hero-badge warn">PRIORIDAD</span>
  </h2>
  <div class="ops-item" id="sec-random-tips" style="margin-bottom:12px; background:#ffffff; border-left:4px solid #f59e0b;">
    <div class="ops-head">
      <div class="ops-title">Recordatorio del d√≠a</div>
      <span class="ops-scope" id="sec-random-scope">Turno ‚Äî</span>
    </div>
    <ul id="sec-random-list" style="margin:6px 0 0 18px; padding:0; list-style:disc;"></ul>
  </div>
  <form id="sec-form" class="inline-form" autocomplete="off" style="margin-bottom:8px;">
    <input type="text" id="sec-title" placeholder="A√±adir riesgo..." required>
    <input type="text" id="sec-owner" placeholder="Responsable">
    <button type="submit" class="btn-primary">A√±adir</button>
  </form>
  <div id="sec-cards" class="sec-list" role="list"></div>
  <small class="kpi-text" id="sec-meta">‚Äî</small>
</div>

<div class="widget vivid" id="incidentes-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">‚ö†Ô∏è</span><span>5) Incidentes & Aprendizaje</span>
    <span class="hero-badge danger">MANUAL</span>
  </h2>
  <div class="incident-remember">RECORDAR: Reportar cualquier incidente inmediatamente en ENABLON.</div>
  
  <form id="manual-inc-form" style="background:#fff5f5; padding:12px; border-radius:10px; border:1px dashed #fecaca; margin-bottom:15px;">
    <div style="display:grid; grid-template-columns: 140px 1fr auto; gap:8px; margin-bottom:8px;">
      <select id="new-inc-type" style="padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-weight:bold;">
        <option value="incident">üî¥ Incidente</option>
        <option value="lesson">üí° Lecci√≥n</option>
      </select>
      <input type="text" id="new-inc-title" placeholder="T√≠tulo corto..." required style="padding:8px; border-radius:8px; border:1px solid #e5e7eb;">
      <button type="submit" class="btn-primary" style="padding:8px 16px;">A√±adir</button>
    </div>
    <textarea id="new-inc-desc" rows="2" placeholder="Descripci√≥n detallada o aprendizaje..." style="width:100%; padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-size:0.9rem;"></textarea>
  </form>
  <div id="incidents-list-container" class="ops-list" style="max-height:400px; overflow-y:auto; padding-right:4px;"></div>
</div>

<div class="widget kpi-widget" id="kpi-center">
  <h2 class="widget-title">6) KPIs Operativos & Mantenimiento</h2>
  <div class="kpi-grid" style="margin-bottom: 15px;">
    <div class="kpi-tile"><div class="kpi-label">UPH (Prod)</div><div class="kpi-value" id="kpi-uph">‚Äî</div></div>
    <div class="kpi-tile"><div class="kpi-label">DG Autocheck</div><div class="kpi-value" id="kpi-otif">‚Äî</div></div>
    <div class="kpi-tile"><div class="kpi-label">Costes Da√±os</div><div class="kpi-value" style="color:var(--brand-red-600)"><span id="kpi-total-cost">‚Äî</span><span class="kpi-currency">‚Ç¨</span></div></div>
  </div>
  <hr style="border:0; border-top:1px solid var(--border); margin: 10px 0;">
  <div class="kpi-grid">
    <div class="kpi-tile" style="border-left: 4px solid #3b82f6;"><div class="kpi-label">Backlog (Abiertas)</div><div class="kpi-value" id="fiix-backlog">‚Äî</div></div>
    <div class="kpi-tile" id="tile-fiix-urgent" style="border-left: 4px solid #f59e0b;"><div class="kpi-label">Correctivos</div><div class="kpi-value" id="fiix-urgent">‚Äî</div></div>
    <div class="kpi-tile" style="border-left: 4px solid #10b981;"><div class="kpi-label">Gasto Mes (Mto)</div><div class="kpi-value"><span id="fiix-cost">‚Äî</span><span class="kpi-currency">‚Ç¨</span></div></div>
  </div>
  <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
    <div style="background: #fafafa; border-radius: 10px; padding: 12px; border: 1px solid var(--border);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><strong style="font-size:0.95rem;">Estado 5S</strong><small id="s5-meta" class="kpi-text">‚Äî</small></div>
      <div id="s5-strip" class="s5-compact" role="group" aria-label="Estado 5S" style="justify-content: center;">
        <button type="button" class="s5-pill" data-key="seiri"><span class="s5-dot"></span>1S</button>
        <button type="button" class="s5-pill" data-key="seiton"><span class="s5-dot"></span>2S</button>
        <button type="button" class="s5-pill" data-key="seiso"><span class="s5-dot"></span>3S</button>
        <button type="button" class="s5-pill" data-key="seiketsu"><span class="s5-dot"></span>4S</button>
        <button type="button" class="s5-pill" data-key="shitsuke"><span class="s5-dot"></span>5S</button>
      </div>
    </div>
    <div style="background: #fafafa; border-radius: 10px; padding: 12px; border: 1px solid var(--border);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><strong style="font-size:0.95rem;">Gemba Walk</strong></div>
      <form id="gw-upload-form" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;"><input type="file" id="gw-file" accept=".xlsx,.xls" style="flex:1; font-size:0.8rem; padding:4px; width:0;"><button class="btn-primary" type="submit" style="padding:4px 8px; font-size:0.8rem;">Subir</button></form>
      <small id="gw-upload-status" class="kpi-text" style="display:block; margin-bottom:6px;">‚Äî</small>
      <div id="gw-tasks-dynamic-container"></div>
    </div>
  </div>
</div>
 
<div class="widget" id="kanban-widget">
<h2 class="widget-title">7) Feedback directo</h2>
<div class="board-container kanban">
<div class="kanban-column"><h3 class="column-title"><span>Abiertas</span><span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-Abiertas" data-status="Abiertas"></div></div>
<div class="kanban-column"><h3 class="column-title"><span>En Curso</span><span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-En-Curso" data-status="En Curso"></div></div>
<div class="kanban-column"><h3 class="column-title"><span>Cerradas</span><span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-Cerradas" data-status="Cerradas"></div></div>
<div class="kanban-column"><h3 class="column-title"><span>Vencidas</span><span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-Vencidas" data-status="Vencidas"></div></div>
</div>
<form class="new-item-form" id="new-kanban-form" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border); display:grid; grid-template-columns: 1fr 1fr auto 1fr auto; gap:8px; align-items:center;">
<select id="problem-category" name="category" required><option value="" disabled selected>Categor√≠a‚Ä¶</option><option value="seguridad">Seguridad</option><option value="incidencias">Incidencias</option><option value="mantenimiento">Mantenimiento</option><option value="calidad">Calidad</option><option value="servicio">Servicio</option></select>
<input type="text" name="title" placeholder="Tipo de problema" required>
<input type="date" name="due_date" required>
<select name="assigned_to" required title="Equipo de soporte"><option value="" disabled selected>Soporte‚Ä¶</option><option>Mantenimiento</option><option>IT</option><option>Calidad</option><option>Ops</option></select>
<button type="submit" class="btn-primary">A√±adir</button>
</form>
</div>

<div class="widget" id="kaizen-widget" style="margin-top: 20px;">
  <h2 class="widget-title">KAIZEN (Proyectos de mejora)</h2>
  <form class="new-item-form" id="new-kaizen-form" autocomplete="off" style="display:grid; grid-template-columns: 1fr 1fr auto auto; gap:8px; align-items:center;">
    <input type="text" name="title" placeholder="Proyecto de mejora‚Ä¶" required>
    <input type="text" name="assigned_to" placeholder="Responsable‚Ä¶">
    <input type="date" name="due_date" aria-label="Fecha m√°xima">
    <button type="submit" class="btn-primary">A√±adir</button>
  </form>
  <div class="board-container kaizen" style="margin-top:12px;">
    <div class="kanban-column"><h3 class="column-title"><span>Proyectos</span><span class="count">(0)</span></h3><div class="cards-container" id="kaizen-Proyectos" data-status="Proyectos"></div></div>
    <div class="kanban-column"><h3 class="column-title"><span>En Progreso</span><span class="count">(0)</span></h3><div class="cards-container" id="kaizen-En-Progreso" data-status="En Progreso"></div></div>
    <div class="kanban-column"><h3 class="column-title"><span>Hecho</span><span class="count">(0)</span></h3><div class="cards-container" id="kaizen-Hecho" data-status="Hecho"></div></div>
  </div>
</div>
</section>

<section class="col-right">
  <div class="widget" id="prev-shift-widget">
  <h2 class="widget-title">3) Turno Anterior</h2>
  <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input type="text" id="prev-input" placeholder="A√±adir highlight..." style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;">
      <button id="prev-add-btn" class="btn-primary" style="padding:0 12px;">+</button>
      <button type="button" class="btn-mic" data-target="prev-input">üéôÔ∏è</button>
  </div>
  <div id="prev-list" style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;"></div>
</div>
<div class="widget" id="ehs-widget">
  <h2 class="widget-title">D√≠as sin accidentes</h2>
  <div class="ehs-month" id="ehs-month">‚Äî</div>
  <div id="ehs-spin" class="ehs-controls" role="spinbutton" style="justify-content: center; cursor: pointer;" title="Doble clic para reportar incidente">
      <div class="ehs-big" id="ehs-days">0</div>
  </div>
</div>
</section>
</div>

<div id="post-briefing-screen">
    <div class="pb-header">
        <div class="pb-title">üöÄ MODO OPERATIVO - INFORMACI√ìN ACTIVA</div>
        <button class="pb-close-btn" onclick="closePostBriefingMode()">‚úñ Volver al Dashboard</button>
    </div>
    <div class="pb-grid">
        <div class="pb-card"><div class="pb-card-title">‚Ü©Ô∏è Highlights Turno Anterior</div><div id="pb-prev-content" class="pb-content"></div></div>
        <div class="pb-card"><div class="pb-card-title">üöß Actualizaciones Operativas</div><div id="pb-ops-content" class="pb-content"></div></div>
        <div class="pb-card"><div class="pb-card-title">üìä KPIs del Turno</div><div id="pb-kpi-content" class="pb-content"><div class="pb-kpi-box"><div class="pb-kpi-item"><span class="pb-kpi-lbl">UPH</span><span id="pb-val-uph" class="pb-kpi-val">-</span></div><div class="pb-kpi-item"><span class="pb-kpi-lbl">Costes</span><span id="pb-val-cost" class="pb-kpi-val">-</span></div></div></div></div>
        <div class="pb-card"><div class="pb-card-title">üõ°Ô∏è Seguridad y Riesgos</div><div id="pb-sec-content" class="pb-content"></div></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
window.STATION_OVERRIDE = 'MAD';

function esc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,"&#39;"); }
function getTaskId(obj){ if(!obj) return null; const raw = obj.id ?? obj.task_id ?? obj._id ?? null; if (raw == null || raw === '') return `client-${Date.now()}-${Math.random().toString(36).slice(2,7)}`; return String(raw); }

// Roster Upload
(function initRosterUpload(){
  const form = document.getElementById('roster-upload-form');
  const input = document.getElementById('roster-file');
  const status = document.getElementById('roster-upload-result');
  if (!form) return;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = input.files?.[0];
    if (!f) { status.textContent = 'Selecciona un .xlsx/.xls'; return; }
    const fd = new FormData(); fd.append('file', f);
    status.textContent = 'Subiendo‚Ä¶';
    try {
      // Simulaci√≥n local si no hay backend:
      status.textContent = "OK: Archivo recibido (Simulado)";
      // En producci√≥n descomentar:
      // const res = await fetch('/api/roster/upload', { method:'POST', body: fd }); ...
    } catch (err) { status.textContent = `Error: ${err.message}`; }
  });
})();

// Escala UI
(function initUIScaling(){
const UI_SCALE_KEY='ui_scale_v1';
function applyScale(v){ document.documentElement.style.setProperty('--ui-scale', v); }
const sel = document.getElementById('scale-select');
if (sel){
  const saved = localStorage.getItem(UI_SCALE_KEY) || sel.value || '1.15';
  applyScale(saved); sel.value = saved;
  sel.addEventListener('change', e => { localStorage.setItem(UI_SCALE_KEY, e.target.value); applyScale(e.target.value); });
}
})();

// Fullscreen helpers
function ensureFullscreenBtn(host){
  if (!host || host.querySelector('.fs-toggle')) return;
  const btn = document.createElement('button');
  btn.className = 'fs-toggle'; btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v4"/><path d="M9 21H5a2 2 0 0 1-2-2v-4"/><path d="M15 21h4a2 2 0 0 0 2-2v-4"/><path d="M9 3H5a2 2 0 0 0-2 2v4"/></svg>';
  btn.addEventListener('click', async (e) => { e.preventDefault(); e.stopPropagation(); try { if (document.fullscreenElement === host) await document.exitFullscreen(); else await host.requestFullscreen(); } catch (err) {} });
  host.appendChild(btn);
}
function initFullscreenToggles(){
  document.querySelectorAll('.widget, .card').forEach(ensureFullscreenBtn);
  document.getElementById('present-btn')?.addEventListener('click', async ()=>{ const host = document.querySelector('.dashboard-3col') || document.body; try { await host.requestFullscreen(); } catch(e){} });
}

// Cron√≥metro Header
(function(){
    const KEY='header_big_timer_v1';
    let running=false, startedAt=0, elapsed=0, tick=null;
    const display = document.getElementById('timer-display'), resetBtn = document.getElementById('timer-reset'), startBtn = document.getElementById('timer-start-btn');
    function fmt(ms){ const t = Math.floor(ms/1000); const h = Math.floor(t/3600); const m = Math.floor((t%3600)/60); const s = t%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
    function paint(){ display.textContent = fmt(running ? Date.now()-startedAt : elapsed); if ((running ? Date.now()-startedAt : elapsed) > 240000) display.classList.add('is-red'); else display.classList.remove('is-red'); }
    function save(){ try{ localStorage.setItem(KEY, JSON.stringify({running, startedAt, elapsed})); }catch{} }
    function load(){ try{ const s = JSON.parse(localStorage.getItem(KEY)||'null'); if(s){ running=!!s.running; elapsed=Number(s.elapsed)||0; startedAt=Number(s.startedAt)||0; if(running){ elapsed=Math.max(elapsed, Date.now()-startedAt); startedAt=Date.now()-elapsed; } } }catch{} }
    function start(){ if(running)return; running=true; startedAt=Date.now()-elapsed; tick=setInterval(paint,250); paint(); save(); if(window.navTo) window.navTo('team-widget'); if(startBtn) startBtn.style.display='none'; }
    function reset(){ running=false; startedAt=0; elapsed=0; clearInterval(tick); tick=null; paint(); save(); if(startBtn){ startBtn.style.display='inline-block'; startBtn.textContent='Comenzar'; } }
    display?.addEventListener('click', ()=> (running ? (running=false, elapsed=Date.now()-startedAt, clearInterval(tick), paint(), save()) : start()));
    resetBtn?.addEventListener('click', reset);
    startBtn?.addEventListener('click', start);
    window.resetFactoryTimer = reset;
    window.initHeaderTimer = function(){ load(); paint(); if(running){ tick=setInterval(paint,250); if(startBtn) startBtn.style.display='none'; } };
})();

// EHS Simple
function initEhsSimple(){
    const daysEl = document.getElementById('ehs-days'), monthEl = document.getElementById('ehs-month'), container = document.getElementById('ehs-spin');
    if (!daysEl) return;
    const now = new Date(); if(monthEl) monthEl.textContent = now.toLocaleDateString('es-ES',{month:'long',year:'numeric'});
    const KEY = 'ehs_last_incident_date_mad_v1';
    function render() {
        const lastDateStr = localStorage.getItem(KEY);
        let lastDate = lastDateStr ? new Date(lastDateStr) : new Date();
        const today = new Date(); today.setHours(0,0,0,0); lastDate.setHours(0,0,0,0);
        daysEl.textContent = Math.max(0, Math.floor((today - lastDate) / (1000 * 60 * 60 * 24)));
    }
    container.addEventListener('dblclick', () => { if(confirm("¬øReportar incidente hoy?")) { localStorage.setItem(KEY, new Date().toISOString()); render(); } });
    if(!localStorage.getItem(KEY)) localStorage.setItem(KEY, new Date().toISOString());
    render();
}

// 5S LocalStorage
const S5_STATE_KEY = 's5_state_v1';
function init5S(){
  const strip = document.getElementById('s5-strip'); if(!strip) return;
  function load(){ try{return JSON.parse(localStorage.getItem(S5_STATE_KEY)||'{}')}catch{return{}} }
  function render(){
    const st=load(); let d=0;
    strip.querySelectorAll('.s5-pill').forEach(b=>{ const k=b.dataset.key; const on=!!st[k]; b.classList.toggle('on',on); if(on)d++; });
    const m=document.getElementById('s5-meta'); if(m) m.textContent=`${d}/5 completadas`;
  }
  strip.addEventListener('click', e=>{
    const b=e.target.closest('.s5-pill'); if(!b)return;
    const st=load(); st[b.dataset.key]=!st[b.dataset.key]; localStorage.setItem(S5_STATE_KEY, JSON.stringify(st));
    render(); b.classList.add('bump'); setTimeout(()=>b.classList.remove('bump'),200);
  });
  render();
}

// Team Manual Add
(function initTeamManualAdd(){
  const listEl = document.getElementById('team-list'), form = document.getElementById('team-form'), input = document.getElementById('team-name');
  if(!listEl) return;
  window.TEAM_STATE = { people: [], attendance: {}, zones: {} };
  
  function render(){
    listEl.innerHTML = window.TEAM_STATE.people.length ? '' : '<div style="color:#666;padding:10px;">Lista vac√≠a. A√±ade personal.</div>';
    window.TEAM_STATE.people.forEach((p, idx)=>{
      const row = document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;padding:8px;border:1px solid #eee;margin-bottom:4px;background:#fff;border-radius:8px;align-items:center;';
      const pres = window.TEAM_STATE.attendance[p.name];
      row.innerHTML = `<span>${esc(p.name)}</span>
        <div class="presence-toggle">
          <label style="cursor:pointer;margin-right:8px;color:${pres===true?'green':'#ccc'}"><input type="radio" name="att_${idx}" value="yes" ${pres===true?'checked':''} style="display:none">‚úì</label>
          <label style="cursor:pointer;color:${pres===false?'red':'#ccc'}"><input type="radio" name="att_${idx}" value="no" ${pres===false?'checked':''} style="display:none">‚úï</label>
          <button class="btn-tiny" onclick="deletePerson(${idx})">üóëÔ∏è</button>
        </div>`;
      row.querySelectorAll('input').forEach(r => r.addEventListener('change', (e)=>{
        window.TEAM_STATE.attendance[p.name] = e.target.value === 'yes';
        render();
      }));
      listEl.appendChild(row);
    });
    const meta = document.getElementById('team-meta');
    if(meta) meta.textContent = `Total: ${window.TEAM_STATE.people.length} | Presentes: ${Object.values(window.TEAM_STATE.attendance).filter(v=>v===true).length}`;
  }

  window.deletePerson = (idx) => {
    const p = window.TEAM_STATE.people[idx];
    delete window.TEAM_STATE.attendance[p.name];
    window.TEAM_STATE.people.splice(idx, 1);
    render();
  };

  form?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const val = input.value.trim();
    if(val) {
      window.TEAM_STATE.people.push({name: val});
      window.TEAM_STATE.attendance[val] = true; 
      input.value=''; render();
    }
  });
  render();
})();

// Actualizaciones Operativas V3 (Local)
(function initOpsUpdates(){
  const LIST = document.getElementById('ops-list'), DIALOG = document.getElementById('ops-dialog'), FORM = document.getElementById('ops-form');
  const KEY = 'ops_updates_v3';
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
  function save(d){ localStorage.setItem(KEY, JSON.stringify(d)); }
  
  window.renderOpsCard = function(it){
    const el = document.createElement('div'); el.className = 'ops-item'; el.id = `ops-${it.id}`;
    const pct = it.ack_pct || 0;
    el.innerHTML = `<div class="ops-head"><div class="ops-title">${esc(it.title)}</div><div class="ops-flags"><span class="ops-impact ${esc(it.impact)}">${esc(it.impact)}</span><span class="ops-scope">${esc(it.scope)}</span></div></div>
      <div class="ops-meta"><span>Resp: ${esc(it.owner)}</span></div>
      ${it.require_ack ? `<div class="ops-ack" style="margin-top:5px;padding:5px;background:#f9fafb;border-radius:6px;"><div class="ops-ack-bar" style="height:4px;background:#eee;width:100%;"><span style="display:block;height:100%;width:${pct}%;background:${pct==100?'green':'blue'}"></span></div><small>Ack: ${pct}%</small></div>` : ''}
      <div class="ops-actions" style="margin-top:8px;"><button class="ops-btn" onclick="deleteOps('${it.id}')" style="color:#b91c1c;">Eliminar</button></div>`;
    LIST.prepend(el);
  };

  function render(){ LIST.innerHTML=''; const l=load(); if(!l.length) LIST.innerHTML='<div style="padding:10px;color:#999;text-align:center">Sin actualizaciones</div>'; l.forEach(window.renderOpsCard); }
  
  document.getElementById('ops-add')?.addEventListener('click', ()=>{ FORM.reset(); document.getElementById('ops-id').value=''; DIALOG.showModal(); });
  FORM?.addEventListener('submit', e=>{
    e.preventDefault();
    const it = {
        id: document.getElementById('ops-id').value || 'op_'+Date.now(),
        title: document.getElementById('ops-title').value,
        impact: document.getElementById('ops-impact').value,
        scope: document.getElementById('ops-scope-field').value,
        owner: document.getElementById('ops-owner').value,
        require_ack: true, ack_pct: 0, created_at: new Date()
    };
    const l=load(); const idx=l.findIndex(x=>x.id===it.id);
    if(idx>=0) l[idx]=it; else l.push(it);
    save(l); render(); DIALOG.close();
  });
  FORM?.querySelector('[value="cancel"]')?.addEventListener('click', ()=>DIALOG.close());

  window.deleteOps = (id) => { if(confirm('¬øBorrar?')){ save(load().filter(x=>x.id!==id)); render(); } };
  render();
})();

// Incidentes Manuales
(function initManualIncidents() {
    const KEY = 'incidents_manual_entries_v1', listEl = document.getElementById('incidents-list-container'), form = document.getElementById('manual-inc-form');
    function load() { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } }
    function save(data) { localStorage.setItem(KEY, JSON.stringify(data)); }
    function render() {
        const items = load(); listEl.innerHTML = '';
        if (!items.length) { listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#9ca3af;">No hay incidentes registrados hoy.</div>'; return; }
        items.sort((a, b) => new Date(b.date) - new Date(a.date));
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = `inc-card ${item.type === 'incident' ? 'type-incident' : 'type-lesson'}`;
            card.innerHTML = `<div class="inc-header"><div><span class="inc-badge">${item.type === 'incident' ? 'üî¥ INCIDENTE' : 'üí° LECCI√ìN'}</span><div class="inc-title" style="margin-top:4px;">${esc(item.title)}</div></div><button class="inc-del-btn" data-id="${item.id}">üóëÔ∏è</button></div><div class="inc-desc">${esc(item.desc)}</div>`;
            listEl.appendChild(card);
        });
    }
    form?.addEventListener('submit', (e) => {
        e.preventDefault();
        const items = load();
        items.push({ id: Date.now().toString(), type: document.getElementById('new-inc-type').value, title: document.getElementById('new-inc-title').value.trim(), desc: document.getElementById('new-inc-desc').value.trim(), date: new Date().toISOString() });
        save(items); document.getElementById('new-inc-title').value = ''; document.getElementById('new-inc-desc').value = ''; render();
    });
    listEl?.addEventListener('click', (e) => { if (e.target.classList.contains('inc-del-btn') && confirm("¬øBorrar?")) { save(load().filter(i => i.id !== e.target.dataset.id)); render(); } });
    render();
})();

// Turno Anterior (Filas)
(function initPrevShiftSystem(){
    const input = document.getElementById('prev-input'), btn = document.getElementById('prev-add-btn'), list = document.getElementById('prev-list');
    const KEY = 'prev_shift_items_v2';
    function load() { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    function save(data) { localStorage.setItem(KEY, JSON.stringify(data)); }
    function render() {
        const items = load(); list.innerHTML = '';
        items.forEach((text, idx) => {
            const row = document.createElement('div'); row.className = 'prev-item';
            row.innerHTML = `<div class="prev-text" contenteditable="true" data-idx="${idx}">${text}</div><div class="prev-actions"><button class="prev-btn del-btn" data-idx="${idx}">üóëÔ∏è</button></div>`;
            list.appendChild(row);
        });
    }
    btn?.addEventListener('click', () => { const v=input.value.trim(); if(v){ const i=load(); i.unshift(v); save(i); render(); input.value=''; } });
    list?.addEventListener('click', (e) => { if(e.target.closest('.del-btn')){ const i=load(); i.splice(e.target.closest('.del-btn').dataset.idx,1); save(i); render(); } });
    list?.addEventListener('input', (e) => { if(e.target.classList.contains('prev-text')){ const i=load(); i[e.target.dataset.idx]=e.target.innerText; save(i); } });
    render();
})();

// Navegaci√≥n Guiada
document.addEventListener('DOMContentLoaded', () => {
   const WIDGET_MAP = [ { id: 'team-widget', check: 'c1', label: '1. Dotaci√≥n' }, { id: 'ops-updates-widget', check: 'c2', label: '2. Actualizaciones' }, { id: 'prev-shift-widget', check: 'c3', label: '3. Turno Ant' }, { id: 'seguridad-widget', check: 'c4', label: '4. Seguridad' }, { id: 'incidentes-widget', check: 'c5', label: '5. Incidentes' }, { id: 'kpi-center', check: 'c6', label: '6. KPIs' }, { id: 'kanban-widget', check: 'c7', label: '7. Feedback' } ];
   WIDGET_MAP.forEach((step, index) => {
       const widget = document.getElementById(step.id);
       if (!widget) return;
       const next = WIDGET_MAP[index+1], prev = WIDGET_MAP[index-1];
       const nav = document.createElement('div'); nav.className = 'widget-nav-bar';
       nav.innerHTML = `<div class="nav-group"><button class="btn-nav" onclick="navTo('${prev?prev.id:''}')" ${!prev?'disabled':''}>‚¨Ö</button></div><div class="nav-group" style="font-size:0.9rem;">${step.label}</div><div class="nav-group"><button class="btn-nav home" onclick="exitFlow()">‚úñ</button><button class="btn-nav next-ok" onclick="markOkAndNext('${step.check}','${next?next.id:''}')">‚úÖ OK ‚û°</button></div>`;
       widget.prepend(nav);
   });
});

window.navTo = function(id) {
    const el = document.getElementById(id); if(!el) return;
    document.querySelectorAll('.widget--zoomed').forEach(w => w.classList.remove('widget--zoomed'));
    document.body.classList.add('card-open');
    el.classList.add('widget--zoomed');
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
};
window.exitFlow = function() {
    document.querySelectorAll('.widget--zoomed').forEach(w => w.classList.remove('widget--zoomed'));
    document.body.classList.remove('card-open');
    if(document.body.classList.contains('shift-mode')) document.getElementById('brief-check').classList.add('shift-focus');
};
window.markOkAndNext = function(chk, nextId) {
    const r = document.querySelector(`input[name="${chk}"][value="OK"]`);
    if(r) { r.checked=true; r.dispatchEvent(new Event('change')); }
    if(nextId) navTo(nextId); else { exitFlow(); alert("Checklist completado"); }
};

// Voz
(function initVoice() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return;
    const r = new SR(); r.lang = 'es-ES';
    let target = null;
    r.onresult = e => { if(target) { target.value += " " + e.results[0][0].transcript; target.dispatchEvent(new Event('input')); } };
    document.body.addEventListener('click', e => {
        const btn = e.target.closest('.btn-mic');
        if(btn) { target = document.getElementById(btn.dataset.target); r.start(); }
    });
})();

// Auto Turno
setInterval(() => {
    const h = new Date().getHours();
    let shift = h >= 6 && h < 14 ? 'Ma√±ana' : h >= 14 && h < 22 ? 'Tarde' : 'Noche';
    const badge = document.getElementById('shift-badge-header');
    if(badge && badge.textContent !== shift) {
        console.log("Cambio turno:", shift);
        badge.textContent = shift;
        document.body.classList.add('shift-mode');
        document.getElementById('brief-check').classList.add('shift-focus');
    }
}, 5000);

window.exitShiftMode = function() {
    document.body.classList.remove('shift-mode');
    document.getElementById('brief-check').classList.remove('shift-focus');
};

// Start
document.addEventListener('DOMContentLoaded', ()=>{
    try{ initHeaderTimer(); }catch(e){}
    try{ initFullscreenToggles(); }catch(e){}
    try{ ensureFullscreenBtn(document.getElementById('brief-check')); }catch(e){}
    console.log('MAD OPS Dashboard Ready');
});
</script>
</body>
</html>
