<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Factory Floor Dashboard - BCN</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root {
      --bg-main: #060814;
      --bg-elevated: #0c1020;
      --bg-elevated-soft: #15192a;
      --accent-bcn: #2f8fff;
      --accent-bcn-soft: rgba(47, 143, 255, 0.16);
      --accent-ok: #35c759;
      --accent-warn: #ffcc00;
      --accent-bad: #ff3b30;
      --accent-info: #5ac8fa;
      --border-subtle: rgba(255,255,255,0.08);
      --text-main: #ffffff;
      --text-soft: rgba(255,255,255,0.72);
      --radius-xl: 18px;
      --radius-lg: 14px;
      --shadow-soft: 0 14px 40px rgba(0,0,0,0.32);
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.28s ease-out;
      --ui-scale: 1;
      --widget-gap: 14px;
      --header-height: 82px;
      --touch-min: 44px;
      --font-main: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --font-title: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg-main);
      color: var(--text-main);
      font-family: var(--font-main);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    body {
      padding: max(10px, env(safe-area-inset-top)) 
               max(10px, env(safe-area-inset-right))
               max(10px, env(safe-area-inset-bottom))
               max(10px, env(safe-area-inset-left));
      transform-origin: top left;
      transform: scale(var(--ui-scale));
      transform-box: border-box;
    }

    .app-shell {
      max-width: 1920px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* =======================
       HEADER
    ======================== */
    header.app-header {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 380px) auto;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      background: radial-gradient(circle at top left, rgba(47,143,255,0.16), transparent) #050814;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(14px);
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title {
      font-family: var(--font-title);
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title span.station {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--accent-bcn-soft);
      color: var(--accent-bcn);
      border: 1px solid rgba(47,143,255,0.5);
    }

    .app-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .shift-pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.18);
      color: var(--accent-info);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .clock-display {
      display: inline-flex;
      align-items: baseline;
      gap: 8px;
      font-size: 14px;
      color: var(--text-soft);
    }

    .clock-display span.time {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-main);
    }

    /* Timer widget */
    #timer-widget {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    #big-timer-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }

    #big-timer-display {
      font-family: var(--font-title);
      font-size: 26px;
      line-height: 1;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 10px;
      background: rgba(5, 10, 25, 0.96);
      border: 1px solid rgba(47,143,255,0.5);
      cursor: pointer;
      user-select: none;
      min-width: 130px;
      text-align: center;
    }

    #timer-controls {
      display: flex;
      gap: 6px;
    }

    #timer-reset-btn {
      border: none;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      background: rgba(255,255,255,0.06);
      color: var(--text-soft);
      min-height: var(--touch-min);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Header controls */
    .header-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      justify-content: center;
    }

    .scale-select-wrap {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--text-soft);
    }

    #scale-select {
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--text-main);
      padding: 3px 8px;
      font-size: 11px;
      min-height: var(--touch-min);
      cursor: pointer;
    }

    #present-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent-bcn), #7b5cff);
      color: #fff;
      min-height: var(--touch-min);
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    }

    #present-btn span.icon {
      font-size: 14px;
      line-height: 1;
    }

    /* =======================
       GRID 3 COLUMNAS
    ======================== */
    .dashboard-3col {
      display: grid;
      grid-template-columns: minmax(260px, 320px) minmax(0, 1fr) minmax(300px, 360px);
      gap: var(--widget-gap);
      align-items: flex-start;
      margin-top: 4px;
    }

    @media (max-width: 1180px) {
      .dashboard-3col {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .col {
      display: flex;
      flex-direction: column;
      gap: var(--widget-gap);
    }

    /* =======================
       WIDGETS BASE
    ======================== */
    .widget {
      background: var(--bg-elevated);
      border-radius: var(--radius-xl);
      padding: 10px 10px 9px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      min-height: 40px;
    }

    .widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .widget-title {
      font-family: var(--font-title);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent-bcn);
    }

    .widget-subtitle {
      font-size: 10px;
      color: var(--text-soft);
    }

    .widget-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pill {
      font-size: 9px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .fs-toggle {
      border: none;
      background: transparent;
      color: var(--text-soft);
      cursor: pointer;
      padding: 2px 4px;
      min-height: var(--touch-min);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .widget-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--text-soft);
    }

    /* =======================
       TEAM / ROSTER
    ======================== */
    #team-widget {
      background: radial-gradient(circle at top, rgba(47,143,255,0.12), transparent) var(--bg-elevated);
    }

    #team-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 9px;
      color: var(--text-soft);
    }

    #team-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 2px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .team-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) 0.9fr 0.6fr 0.7fr;
      gap: 4px;
      align-items: center;
      padding: 4px 5px;
      border-radius: 9px;
      background: rgba(9,12,25,0.96);
      border: 1px solid rgba(255,255,255,0.04);
      font-size: 9px;
    }

    .team-name {
      font-size: 10px;
      color: var(--text-main);
    }

    .presence-toggle {
      width: 26px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.24);
      color: var(--accent-ok);
      background: rgba(0,0,0,0.7);
      user-select: none;
    }

    .presence-toggle.off {
      color: var(--accent-bad);
      opacity: 0.7;
    }

    .zone-select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.02);
      color: var(--text-soft);
      font-size: 9px;
      padding: 2px 4px;
      min-height: 22px;
      cursor: pointer;
    }

    #roster-upload {
      font-size: 8px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    /* =======================
       BRIEFING CHECKLIST BCN
    ======================== */
    #brief-check {
      background: radial-gradient(circle at top right, rgba(47,143,255,0.10), transparent) var(--bg-elevated);
    }

    .checklist-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px;
    }

    .check-card {
      padding: 6px;
      border-radius: 10px;
      background: rgba(5,8,18,0.98);
      border: 1px solid rgba(255,255,255,0.05);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      position: relative;
    }

    .check-label {
      font-size: 9px;
      color: var(--text-main);
      font-weight: 500;
    }

    .check-meta {
      font-size: 8px;
      color: var(--text-soft);
    }

    .check-options {
      display: flex;
      gap: 4px;
      margin-top: 2px;
      font-size: 8px;
      align-items: center;
    }

    .check-options label {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      cursor: pointer;
    }

    .check-options input {
      margin: 0;
      width: 10px;
      height: 10px;
    }

    #brief-help {
      margin-top: 2px;
      font-size: 8px;
      color: var(--accent-info);
      min-height: 12px;
    }

    /* =======================
       KANBAN RAPIDA BCN
    ======================== */
    #kanban-widget {
      background: var(--bg-elevated-soft);
    }

    .kanban-layout {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 6px;
      margin-top: 4px;
    }

    .kanban-col {
      background: rgba(0,0,0,0.6);
      border-radius: 10px;
      padding: 4px;
      border: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 8px;
    }

    .kanban-col-header {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: center;
      font-size: 8px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .kanban-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 40px;
    }

    .kanban-card {
      padding: 4px;
      border-radius: 8px;
      background: rgba(9,15,30,0.98);
      border: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: grab;
      position: relative;
    }

    .kanban-title {
      font-size: 9px;
      color: var(--text-main);
      font-weight: 500;
    }

    .kanban-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      font-size: 7px;
      color: var(--text-soft);
      align-items: center;
    }

    .badge {
      padding: 1px 4px;
      border-radius: 999px;
      font-size: 7px;
      background: rgba(255,255,255,0.04);
    }

    .badge-cat-seguridad { background-color: rgba(255, 59, 48, 0.16); color: #ff3b30; }
    .badge-cat-incidencias { background-color: rgba(255, 204, 0, 0.18); color: #ffcc00; }
    .badge-cat-mantenimiento { background-color: rgba(88, 86, 214, 0.20); color: #8e8aff; }
    .badge-cat-calidad { background-color: rgba(52, 199, 89, 0.18); color: #34c759; }
    .badge-cat-servicio { background-color: rgba(90, 200, 250, 0.18); color: #5ac8fa; }

    .btn-delete {
      position: absolute;
      top: 2px;
      right: 2px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.34);
      font-size: 9px;
      cursor: pointer;
    }

    .kanban-form {
      margin-top: 4px;
      display: grid;
      grid-template-columns: 0.9fr 1.4fr 0.9fr 0.9fr auto;
      gap: 4px;
      align-items: center;
      font-size: 8px;
    }

    .kanban-form input,
    .kanban-form select {
      width: 100%;
      padding: 3px 4px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.7);
      color: var(--text-main);
      font-size: 9px;
      min-height: 22px;
    }

    .kanban-form button {
      padding: 4px 7px;
      border-radius: 8px;
      border: none;
      background: var(--accent-bcn);
      color: #fff;
      font-size: 9px;
      cursor: pointer;
      min-height: 22px;
      white-space: nowrap;
    }

    /* =======================
       KAIZEN
    ======================== */
    #kaizen-widget .kaizen-layout {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 6px;
      font-size: 8px;
      margin-top: 4px;
    }

    .kaizen-col {
      background: rgba(0,0,0,0.7);
      border-radius: 10px;
      padding: 4px;
      border: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kaizen-col-title {
      font-size: 8px;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 2px;
    }

    .kaizen-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 32px;
    }

    .kaizen-card {
      padding: 3px 4px;
      border-radius: 8px;
      background: rgba(9,14,25,0.98);
      border: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: grab;
      font-size: 8px;
    }

    .kaizen-form {
      margin-top: 4px;
      display: grid;
      grid-template-columns: 1.6fr 1fr auto;
      gap: 4px;
      font-size: 8px;
    }

    .kaizen-form input {
      width: 100%;
      padding: 3px 4px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.7);
      color: var(--text-main);
      font-size: 9px;
      min-height: 22px;
    }

    .kaizen-form button {
      padding: 4px 7px;
      border-radius: 8px;
      border: none;
      background: #34c759;
      color: #000;
      font-size: 9px;
      cursor: pointer;
      min-height: 22px;
      white-space: nowrap;
    }

    /* =======================
       5S & GW (TOP 3)
    ======================== */
    #rotativas-widget {
      background: var(--bg-elevated-soft);
    }

    .s5-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 2px;
    }

    .s5-pill {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 8px;
      border: 1px solid rgba(255,255,255,0.18);
      cursor: pointer;
      color: var(--text-soft);
      background: rgba(0,0,0,0.7);
      min-height: 22px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .s5-pill.active {
      background: var(--accent-ok);
      color: #000;
      border-color: var(--accent-ok);
    }

    .s5-meta {
      font-size: 8px;
      color: var(--text-soft);
    }

    .gw-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 8px;
    }

    .gw-item {
      padding: 3px 4px;
      border-radius: 7px;
      background: rgba(0,0,0,0.8);
      border: 1px solid rgba(255,255,255,0.08);
      display: grid;
      grid-template-columns: auto minmax(0,1.9fr) minmax(0, 2.2fr);
      gap: 4px;
      align-items: center;
    }

    .gw-item input[type="checkbox"] {
      width: 11px;
      height: 11px;
      margin: 0;
    }

    .gw-note {
      width: 100%;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.9);
      color: var(--text-main);
      font-size: 8px;
      padding: 2px 4px;
      min-height: 18px;
    }

    .gw-note:disabled {
      opacity: 0.45;
    }

    /* =======================
       KPI COSTES BCN
    ======================== */
    #kpi-costes {
      background: radial-gradient(circle at top, rgba(47,143,255,0.14), transparent) var(--bg-elevated);
    }

    .kpi-main {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-family: var(--font-title);
    }

    #kpi-costes-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-bcn);
    }

    .kpi-label {
      font-size: 9px;
      color: var(--text-soft);
      max-width: 150px;
    }

    .kpi-updated {
      font-size: 7px;
      color: var(--text-soft);
    }

    .flash {
      animation: flash 0.5s ease-out;
    }

    @keyframes flash {
      0% { box-shadow: 0 0 0 rgba(47,143,255,0.0); }
      40% { box-shadow: 0 0 22px rgba(47,143,255,0.65); }
      100% { box-shadow: 0 0 0 rgba(47,143,255,0.0); }
    }

    /* =======================
       EHS
    ======================== */
    #ehs-widget .ehs-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 9px;
    }

    .ehs-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ehs-value {
      font-size: 16px;
      font-weight: 700;
      min-width: 38px;
      text-align: center;
    }

    .ehs-btn {
      padding: 3px 6px;
      border-radius: 7px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.8);
      color: var(--text-soft);
      font-size: 9px;
      cursor: pointer;
      min-height: 22px;
    }

    /* =======================
       PLANIFICACIÓN EXTERNA
    ======================== */
    #planificacion-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 8px;
    }

    #planificacion-table th,
    #planificacion-table td {
      padding: 3px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      text-align: left;
      white-space: nowrap;
    }

    #planificacion-table th {
      color: var(--accent-info);
      font-weight: 500;
      position: sticky;
      top: 0;
      background: rgba(5,8,18,0.98);
      z-index: 1;
    }

    .scroll-y {
      max-height: 200px;
      overflow-y: auto;
      padding-right: 2px;
    }

    /* =======================
       INFO TURNO ANTERIOR
    ======================== */
    #prev-shift-body {
      font-size: 9px;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    /* Fullscreen util */
    .fullscreen-target:fullscreen,
    :fullscreen .fullscreen-target {
      z-index: 999;
    }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- ================= HEADER ================= -->
  <header class="app-header">
    <div class="app-title-block">
      <div class="app-title">
        Factory Floor Dashboard
        <span class="station">BCN</span>
      </div>
      <div class="app-subtitle">
        <span>Operación en tiempo real • Export / Import • Handling BCN</span>
        <span class="shift-pill" id="shift-pill">
          Turno actual: <strong id="shift-label">N/A</strong>
        </span>
        <span class="clock-display">
          <span class="time" id="clock-time">--:--</span>
          <span id="clock-date">--/--/----</span>
        </span>
      </div>
    </div>

    <div id="timer-widget">
      <div id="big-timer-label">Cronómetro briefing / incidencias</div>
      <div id="big-timer-display" aria-label="Cronómetro de sala">00:00:00</div>
      <div id="timer-controls">
        <button id="timer-reset-btn">Reiniciar</button>
      </div>
    </div>

    <div class="header-controls">
      <div class="scale-select-wrap">
        Escala UI:
        <select id="scale-select">
          <option value="0.9">90%</option>
          <option value="1" selected>100%</option>
          <option value="1.1">110%</option>
          <option value="1.2">120%</option>
        </select>
      </div>
      <button id="present-btn">
        <span class="icon">⤢</span>
        Presentar BCN
      </button>
    </div>
  </header>

  <!-- ================= GRID 3 COL ================= -->
  <main class="dashboard-3col fullscreen-target" id="dashboard-root">
    <!-- COL IZQUIERDA -->
    <section class="col" id="left-col">

      <!-- TEAM / TURNO -->
      <section class="widget" id="team-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">Equipo / Turno BCN</div>
            <div class="widget-subtitle">Roster operativo en vivo desde SAP / Excel</div>
          </div>
          <div class="widget-actions">
            <div class="pill" id="team-count-pill">0 personas</div>
            <button class="fs-toggle" data-fs-target="#team-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div id="team-meta">
            <span>Fecha hoja: <span id="team-sheet-date">--/--</span></span>
            <span>Shift: <span id="team-shift">--</span></span>
            <span>Ventana: <span id="team-window">--</span></span>
          </div>
          <div id="team-list"></div>
          <div id="roster-upload">
            <label>
              Actualizar roster BCN:
              <input type="file" id="roster-file" accept=".xlsx,.xls" />
            </label>
          </div>
        </div>
      </section>

      <!-- INFO TURNO ANTERIOR -->
      <section class="widget" id="prev-shift-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">Turno anterior BCN</div>
            <div class="widget-subtitle">Resumen rápido para handover</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#prev-shift-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body" id="prev-shift-body">
          <div id="prev-shift-notes">Sin datos aún. Sincronizar con backend para mostrar incidencias clave.</div>
        </div>
      </section>

      <!-- EHS -->
      <section class="widget" id="ehs-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">EHS BCN</div>
            <div class="widget-subtitle">Días sin incidentes / con incidentes</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#ehs-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body ehs-body">
          <div class="ehs-row">
            <span>Días sin incidentes (mes actual)</span>
            <span class="ehs-value" id="ehs-days-safe">0</span>
            <button class="ehs-btn" data-ehs-delta="safe:-1">-</button>
            <button class="ehs-btn" data-ehs-delta="safe:+1">+</button>
          </div>
          <div class="ehs-row">
            The
            <span>Días con incidentes (mes actual)</span>
            <span class="ehs-value" id="ehs-days-inc">0</span>
            <button class="ehs-btn" data-ehs-delta="inc:-1">-</button>
            <button class="ehs-btn" data-ehs-delta="inc:+1">+</button>
          </div>
          <div class="kpi-updated" id="ehs-updated">Pendiente de sincronizar backend / ws</div>
        </div>
      </section>

    </section>

    <!-- COL CENTRAL -->
    <section class="col" id="center-col">

      <!-- BRIEFING CHECKLIST -->
      <section class="widget" id="brief-check">
        <div class="widget-header">
          <div>
            <div class="widget-title">Briefing de inicio turno BCN</div>
            <div class="widget-subtitle">Validación rápida de condiciones críticas</div>
          </div>
          <div class="widget-actions">
            <div class="pill">Tap para fijar foco en el widget relacionado</div>
            <button class="fs-toggle" data-fs-target="#brief-check">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="checklist-grid">
            <div class="check-card" data-help="Revisar dotación por isla / posiciones críticas."
                 data-target="#team-widget">
              <div class="check-label">1. Equipo y posiciones clave cubiertas</div>
              <div class="check-meta">Roster BCN / posiciones sensibles</div>
              <div class="check-options">
                <label><input type="radio" name="c1" value="ok">OK</label>
                <label><input type="radio" name="c1" value="no">NO</label>
              </div>
            </div>
            <div class="check-card" data-help="Confirmar planificación actualizada desde sistemas externos."
                 data-target="#planificacion-widget">
              <div class="check-label">2. Planificación vuelos / ULD validada</div>
              <div class="check-meta">Cruce con tabla externa</div>
              <div class="check-options">
                <label><input type="radio" name="c2" value="ok">OK</label>
                <label><input type="radio" name="c2" value="no">NO</label>
              </div>
            </div>
            <div class="check-card" data-help="Revisar incidencias abiertas que impacten inicio turno."
                 data-target="#kanban-widget">
              <div class="check-label">3. Incidencias críticas conocidas</div>
              <div class="check-meta">Feedback rápido BCN</div>
              <div class="check-options">
                <label><input type="radio" name="c3" value="ok">OK</label>
                <label><input type="radio" name="c3" value="no">NO</label>
              </div>
            </div>
            <div class="check-card" data-help="Revisar estado 5S zonas sensibles (rampas, docks, etc.)."
                 data-target="#rotativas-widget">
              <div class="check-label">4. 5S zonas clave</div>
              <div class="check-meta">Orden, limpieza, pasillos libres</div>
              <div class="check-options">
                <label><input type="radio" name="c4" value="ok">OK</label>
                <label><input type="radio" name="c4" value="no">NO</label>
              </div>
            </div>
            <div class="check-card" data-help="Verificar equipos críticos disponibles (tugs, belts, etc.)."
                 data-target="#kpi-costes">
              <div class="check-label">5. Equipos operativos</div>
              <div class="check-meta">Sin bloqueos por averías</div>
              <div class="check-options">
                <label><input type="radio" name="c5" value="ok">OK</label>
                <label><input type="radio" name="c5" value="no">NO</label>
              </div>
            </div>
            <div class="check-card" data-help="Recordatorio EHS / brief seguridad BCN."
                 data-target="#ehs-widget">
              <div class="check-label">6. Mensaje seguridad comunicado</div>
              <div class="check-meta">Uso EPI, zonas rojas, acceso pista</div>
              <div class="check-options">
                <label><input type="radio" name="c6" value="ok">OK</label>
                <label><input type="radio" name="c6" value="no">NO</label>
              </div>
            </div>
            <div class="check-card" data-help="Validar status proyectos KAIZEN activos turno BCN."
                 data-target="#kaizen-widget">
              <div class="check-label">7. KAIZEN / acciones sostenidas</div>
              <div class="check-meta">Seguimiento visual</div>
              <div class="check-options">
                <label><input type="radio" name="c7" value="ok">OK</label>
                <label><input type="radio" name="c7" value="no">NO</label>
              </div>
            </div>
          </div>
          <div id="brief-help"></div>
        </div>
      </section>

      <!-- KANBAN RESPUESTA RAPIDA BCN -->
      <section class="widget" id="kanban-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">Feedback directo BCN</div>
            <div class="widget-subtitle">Incidencias rápidas / seguridad / servicio</div>
          </div>
          <div class="widget-actions">
            <div class="pill">Drag & Drop (táctil optimizado)</div>
            <button class="fs-toggle" data-fs-target="#kanban-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="kanban-layout">
            <div class="kanban-col">
              <div class="kanban-col-header">
                <span>Abiertas</span>
                <span id="count-abiertas">0</span>
              </div>
              <div class="kanban-list" id="kanban_rapida-Abiertas"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header">
                <span>En curso</span>
                <span id="count-encurso">0</span>
              </div>
              <div class="kanban-list" id="kanban_rapida-EnCurso"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header">
                <span>Cerradas</span>
                <span id="count-cerradas">0</span>
              </div>
              <div class="kanban-list" id="kanban_rapida-Cerradas"></div>
            </div>
            <div class="kanban-col">
              <div class="kanban-col-header">
                <span>Vencidas</span>
                <span id="count-vencidas">0</span>
              </div>
              <div class="kanban-list" id="kanban_rapida-Vencidas"></div>
            </div>
          </div>

          <form class="kanban-form" id="kanban-form">
            <select name="category" required>
              <option value="" disabled selected>Categoria</option>
              <option value="Seguridad">Seguridad</option>
              <option value="Incidencias">Incidencias</option>
              <option value="Mantenimiento">Mantenimiento</option>
              <option value="Calidad">Calidad</option>
              <option value="Servicio">Servicio</option>
            </select>
            <input type="text" name="title" placeholder="Descripción breve" required />
            <input type="date" name="due_date" />
            <input type="text" name="assigned_to" placeholder="Responsable" />
            <button type="submit">Añadir</button>
          </form>
        </div>
      </section>

      <!-- KAIZEN BCN -->
      <section class="widget" id="kaizen-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">KAIZEN BCN</div>
            <div class="widget-subtitle">Mejoras continuas de operación</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#kaizen-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="kaizen-layout">
            <div class="kaizen-col">
              <div class="kaizen-col-title">Propuestas</div>
              <div class="kaizen-list" id="kaizen-Pendiente"></div>
            </div>
            <div class="kaizen-col">
              <div class="kaizen-col-title">En progreso</div>
              <div class="kaizen-list" id="kaizen-EnCurso"></div>
            </div>
            <div class="kaizen-col">
              <div class="kaizen-col-title">Implementado</div>
              <div class="kaizen-list" id="kaizen-Hecho"></div>
            </div>
          </div>
          <form class="kaizen-form" id="kaizen-form">
            <input type="text" name="title" placeholder="Nueva mejora BCN" required />
            <input type="text" name="owner" placeholder="Responsable" />
            <button type="submit">Crear KAIZEN</button>
          </form>
        </div>
      </section>

      <!-- 5S & GW TOP3 -->
      <section class="widget" id="rotativas-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">5S & Gemba Walk BCN</div>
            <div class="widget-subtitle">Estado visual + TOP-3 acciones</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#rotativas-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="s5-row" id="s5-row">
            <div class="s5-pill" data-s="1S">1S Clasificar</div>
            <div class="s5-pill" data-s="2S">2S Ordenar</div>
            <div class="s5-pill" data-s="3S">3S Limpiar</div>
            <div class="s5-pill" data-s="4S">4S Estandarizar</div>
            <div class="s5-pill" data-s="5S">5S Disciplina</div>
          </div>
          <div class="s5-meta" id="s5-meta">0/5 completadas • Actualizado: --:--</div>
          <div class="gw-list" id="gw-top3">
            <!-- Render dinámico desde GW_MAP -->
          </div>
        </div>
      </section>

    </section>

    <!-- COL DERECHA -->
    <section class="col" id="right-col">

      <!-- KPI COSTES BCN -->
      <section class="widget" id="kpi-costes">
        <div class="widget-header">
          <div>
            <div class="widget-title">KPI Costes BCN</div>
            <div class="widget-subtitle">Costes mantenimiento / daños equipos BCN</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#kpi-costes">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="kpi-main">
            <div id="kpi-costes-value">0 €</div>
            <div class="kpi-label">Coste acumulado mes actual (referencia BCN)</div>
          </div>
          <div class="kpi-updated" id="kpi-costes-updated">Pendiente de datos iniciales</div>
        </div>
      </section>

      <!-- PLANIFICACIÓN EXTERNA -->
      <section class="widget" id="planificacion-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">Planificación Operativa</div>
            <div class="widget-subtitle">Tabla externa filtrada (vuelos / ULD / peso)</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#planificacion-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body scroll-y">
          <table id="planificacion-table">
            <thead>
              <tr>
                <th>FlightId</th>
                <th>Type</th>
                <th>Aircraft</th>
                <th>Flight</th>
                <th>STD</th>
                <th>PCS Manif.</th>
                <th>KG Manif.</th>
              </tr>
            </thead>
            <tbody id="planificacion-tbody">
              <!-- filled vía /api/external-table -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- RESERVA / OTROS WIDGETS FUTURO -->
      <section class="widget" id="misc-widget">
        <div class="widget-header">
          <div>
            <div class="widget-title">Notas rápidas BCN</div>
            <div class="widget-subtitle">Espacio para próximos integraciones</div>
          </div>
          <div class="widget-actions">
            <button class="fs-toggle" data-fs-target="#misc-widget">⤢</button>
          </div>
        </div>
        <div class="widget-body">
          <div class="tag">Checklist Enablon / incidencias formales pendiente de integrar aquí igual que MAD.</div>
        </div>
      </section>

    </section>
  </main>
</div>

<script>
  // ===============================
  // CONFIG / ESTADO GLOBAL
  // ===============================
  const UI_SCALE_KEY = 'bcn_ui_scale_v1';
  const BIG_TIMER_KEY = 'header_big_timer_v1'; // compartido entre estaciones
  const S5_STATE_KEY = 'bcn_s5_state_v1';
  const KPI_COSTES_KEY = 'bcn_kpi_costes_v1';
  const GW_MAP = {}; // id -> task gw_task

  let timerState = {
    running: false,
    startTs: null,
    offsetMs: 0
  };

  let ws;

  // ===============================
  // INIT
  // ===============================
  document.addEventListener('DOMContentLoaded', () => {
    initScale();
    initClock();
    initBigTimer();
    initFullscreenButtons();
    initRoster();
    initKanban();
    initKaizen();
    initS5();
    initGwTop3(); // initial blank
    initKpiCostes();
    initPlanificacion();
    initBriefChecklist();
    initEhs();
    initWebSocket();
    initWakeLockHint();
  });

  // ===============================
  // ESCALA UI
  // ===============================
  function initScale() {
    const saved = localStorage.getItem(UI_SCALE_KEY);
    const select = document.getElementById('scale-select');
    if (saved) {
      document.documentElement.style.setProperty('--ui-scale', saved);
      if (select) select.value = saved;
    }
    select.addEventListener('change', () => {
      const val = select.value || '1';
      document.documentElement.style.setProperty('--ui-scale', val);
      localStorage.setItem(UI_SCALE_KEY, val);
    });
  }

  // ===============================
  // RELOJ
  // ===============================
  function initClock() {
    const timeEl = document.getElementById('clock-time');
    const dateEl = document.getElementById('clock-date');
    const update = () => {
      const now = new Date();
      timeEl.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      dateEl.textContent = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };
    update();
    setInterval(update, 1000 * 15);
  }

  // ===============================
  // TIMER HEADER (compartido)
  // ===============================
  function initBigTimer() {
    const display = document.getElementById('big-timer-display');
    const resetBtn = document.getElementById('timer-reset-btn');
    const saved = localStorage.getItem(BIG_TIMER_KEY);
    if (saved) {
      try {
        timerState = JSON.parse(saved);
      } catch (e) {}
    }
    const syncDisplay = () => {
      const totalMs = timerState.running
        ? (Date.now() - timerState.startTs) + (timerState.offsetMs || 0)
        : (timerState.offsetMs || 0);
      const totalSec = Math.max(0, Math.floor(totalMs / 1000));
      const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
      const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
      const s = String(totalSec % 60).padStart(2, '0');
      display.textContent = `${h}:${m}:${s}`;
    };
    const persist = () => {
      localStorage.setItem(BIG_TIMER_KEY, JSON.stringify(timerState));
    };
    display.addEventListener('click', () => {
      if (!timerState.running) {
        timerState.running = true;
        timerState.startTs = Date.now();
      } else {
        // pause
        timerState.running = false;
        timerState.offsetMs = (Date.now() - timerState.startTs) + (timerState.offsetMs || 0);
        timerState.startTs = null;
      }
      persist();
      syncDisplay();
    });
    resetBtn.addEventListener('click', () => {
      timerState = { running: false, startTs: null, offsetMs: 0 };
      persist();
      syncDisplay();
    });
    syncDisplay();
    setInterval(() => {
      if (timerState.running) {
        syncDisplay();
      }
    }, 500);
  }

  // ===============================
  // FULLSCREEN
  // ===============================
  function initFullscreenButtons() {
    const presentBtn = document.getElementById('present-btn');
    const dashboard = document.getElementById('dashboard-root');

    function toggleFsFor(el) {
      if (!document.fullscreenElement) {
        el.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    }

    presentBtn.addEventListener('click', () => toggleFsFor(dashboard));

    document.querySelectorAll('.fs-toggle').forEach(btn => {
      const targetSel = btn.getAttribute('data-fs-target');
      const target = document.querySelector(targetSel);
      if (!target) return;
      btn.addEventListener('click', () => toggleFsFor(target));
    });

    document.addEventListener('fullscreenchange', () => {
      // Icon / estado si quieres diferenciar. Aquí mantenemos simple.
    });
  }

  // ===============================
  // ROSTER
  // ===============================
  async function initRoster() {
    await loadRoster();
    const fileInput = document.getElementById('roster-file');
    if (fileInput) {
      fileInput.addEventListener('change', handleRosterUpload);
    }
  }

  async function loadRoster() {
    try {
      const res = await fetch('/api/roster/current');
      if (!res.ok) return;
      const data = await res.json();
      renderRoster(data);
    } catch (e) {
      console.warn('Roster BCN error', e);
    }
  }

  function renderRoster(data) {
    const list = document.getElementById('team-list');
    const metaDate = document.getElementById('team-sheet-date');
    const metaShift = document.getElementById('team-shift');
    const metaWindow = document.getElementById('team-window');
    const countPill = document.getElementById('team-count-pill');
    list.innerHTML = '';
    if (!data || !Array.isArray(data.people)) {
      countPill.textContent = '0 personas';
      return;
    }

    metaDate.textContent = data.sheet_date || '--';
    metaShift.textContent = data.shift || '--';
    metaWindow.textContent = data.window || '--';

    data.people.forEach(person => {
      const row = document.createElement('div');
      row.className = 'team-row';
      row.dataset.id = person.id || person.nombre_completo;

      const name = document.createElement('div');
      name.className = 'team-name';
      name.textContent = person.nombre_completo || '-';

      const horario = document.createElement('div');
      horario.textContent = person.horario || '';

      const presence = document.createElement('div');
      const pBtn = document.createElement('div');
      pBtn.className = 'presence-toggle';
      const isPresent = person.attendance !== false;
      if (!isPresent) pBtn.classList.add('off');
      pBtn.textContent = isPresent ? '✓' : '✕';
      pBtn.addEventListener('click', () => togglePresence(person, pBtn));
      presence.appendChild(pBtn);

      const zoneWrap = document.createElement('div');
      const zoneSel = document.createElement('select');
      zoneSel.className = 'zone-select';
      const zones = ['', 'Isla', 'Dorada', 'Import', 'Export', 'Rampa', 'Clasificación', 'Oficina'];
      zones.forEach(z => {
        const opt = document.createElement('option');
        opt.value = z;
        opt.textContent = z || 'Zona';
        if ((person.zone || person.zona) === z) opt.selected = true;
        zoneSel.appendChild(opt);
      });
      zoneSel.addEventListener('change', () => updateZone(person, zoneSel.value));
      zoneWrap.appendChild(zoneSel);

      row.appendChild(name);
      row.appendChild(horario);
      row.appendChild(presence);
      row.appendChild(zoneWrap);

      list.appendChild(row);
    });

    countPill.textContent = `${data.people.length} personas`;
  }

  async function handleRosterUpload(ev) {
    const file = ev.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('file', file);
    try {
      await fetch('/api/roster/upload', {
        method: 'POST',
        body: formData
      });
      await loadRoster();
    } catch (e) {
      console.warn('Roster upload BCN error', e);
    }
  }

  async function togglePresence(person, btn) {
    const newVal = btn.classList.contains('off');
    btn.classList.toggle('off', !newVal);
    btn.textContent = newVal ? '✓' : '✕';
    try {
      await fetch('/api/roster/presence', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: person.id,
          nombre_completo: person.nombre_completo,
          attendance: newVal
        })
      });
    } catch (e) {
      console.warn('Error update presence BCN', e);
    }
  }

  async function updateZone(person, zone) {
    try {
      await fetch('/api/roster/zone', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: person.id,
          nombre_completo: person.nombre_completo,
          zone
        })
      });
    } catch (e) {
      console.warn('Error update zone BCN', e);
    }
  }

  // ===============================
  // KANBAN RAPIDA BCN
  // ===============================
  function initKanban() {
    // Sortable configuración táctil suave
    const sortableOptions = {
      group: 'kanban_rapida',
      animation: 120,
      handle: undefined,
      ghostClass: 'drag-ghost',
      forceFallback: true,
      delayOnTouchOnly: true,
      delay: 80,
      onEnd: onKanbanDrop
    };

    ['Abiertas','EnCurso','Cerradas','Vencidas'].forEach(status => {
      const el = document.getElementById('kanban_rapida-' + status);
      if (el) new Sortable(el, sortableOptions);
    });

    document.getElementById('kanban-form').addEventListener('submit', createKanbanTask);

    // Carga inicial tareas
    loadTasks();
  }

  async function loadTasks() {
    try {
      const res = await fetch('/api/tasks');
      if (!res.ok) return;
      const data = await res.json();
      if (!Array.isArray(data)) return;
      data.forEach(t => processTaskUpdate(t, { silent: true }));
      updateKanbanCounters();
    } catch (e) {
      console.warn('Error load tasks BCN', e);
    }
  }

  function renderKanbanCard(task) {
    if (task.station && task.station !== 'BCN') return; // filtramos
    const baseId = 'kanban_rapida-' + (task.status || 'Abiertas');
    const col = document.getElementById(baseId);
    if (!col) return;

    // borrar previa
    const existing = document.querySelector(`.kanban-card[data-id="${task.id}"]`);
    if (existing && existing.parentElement !== col) {
      existing.parentElement.removeChild(existing);
    }

    let card = existing || document.createElement('div');
    card.className = 'kanban-card';
    card.dataset.id = task.id;
    card.innerHTML = '';

    const title = document.createElement('div');
    title.className = 'kanban-title';
    title.textContent = task.title || '(Sin título)';

    const meta = document.createElement('div');
    meta.className = 'kanban-meta';

    const cat = (task.category || '').toLowerCase();
    if (cat) {
      const b = document.createElement('span');
      b.className = 'badge ' + getCategoryBadgeClass(cat);
      b.textContent = task.category;
      meta.appendChild(b);
    }

    if (task.due_date) {
      const due = document.createElement('span');
      due.className = 'badge';
      due.textContent = 'Vence: ' + formatShortDate(task.due_date);
      meta.appendChild(due);
    }

    if (task.assigned_to) {
      const asg = document.createElement('span');
      asg.className = 'badge';
      asg.textContent = 'Resp: ' + task.assigned_to;
      meta.appendChild(asg);
    }

    const delBtn = document.createElement('button');
    delBtn.className = 'btn-delete';
    delBtn.textContent = '×';
    delBtn.addEventListener('click', (ev) => {
      ev.stopPropagation();
      deleteTask(task.id);
    });

    card.appendChild(title);
    card.appendChild(meta);
    card.appendChild(delBtn);

    col.appendChild(card);
  }

  function getCategoryBadgeClass(cat) {
    if (cat.includes('seguridad')) return 'badge-cat-seguridad';
    if (cat.includes('incidencia')) return 'badge-cat-incidencias';
    if (cat.includes('mantenimiento')) return 'badge-cat-mantenimiento';
    if (cat.includes('calidad')) return 'badge-cat-calidad';
    if (cat.includes('servicio')) return 'badge-cat-servicio';
    return '';
  }

  async function createKanbanTask(ev) {
    ev.preventDefault();
    const form = ev.target;
    const payload = {
      task_type: 'kanban_rapida',
      status: 'Abiertas',
      category: form.category.value,
      title: form.title.value,
      due_date: form.due_date.value || null,
      assigned_to: form.assigned_to.value || null,
      station: 'BCN'
    };
    try {
      const res = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        const created = await res.json();
        processTaskUpdate(created);
        form.reset();
      }
    } catch (e) {
      console.warn('Error create kanban BCN', e);
    }
  }

  async function onKanbanDrop(evt) {
    const card = evt.item;
    const id = card.dataset.id;
    if (!id) return;
    const colId = evt.to.id; // ej. kanban_rapida-EnCurso
    const status = colId.replace('kanban_rapida-', '');
    try {
      await fetch(`/api/tasks/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
    } catch (e) {
      console.warn('Error update status BCN', e);
    }
    updateKanbanCounters();
  }

  function updateKanbanCounters() {
    const map = {
      'Abiertas': 'count-abiertas',
      'EnCurso': 'count-encurso',
      'Cerradas': 'count-cerradas',
      'Vencidas': 'count-vencidas'
    };
    Object.entries(map).forEach(([status, elId]) => {
      const col = document.getElementById('kanban_rapida-' + status);
      const n = col ? col.querySelectorAll('.kanban-card').length : 0;
      const el = document.getElementById(elId);
      if (el) el.textContent = n;
    });
  }

  async function deleteTask(id) {
    try {
      await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
      const card = document.querySelector(`.kanban-card[data-id="${id}"]`);
      if (card && card.parentElement) {
        card.parentElement.removeChild(card);
      }
      updateKanbanCounters();
    } catch (e) {
      console.warn('Error delete task BCN', e);
    }
  }

  // ===============================
  // KAIZEN BCN
  // ===============================
  function initKaizen() {
    ['Pendiente','EnCurso','Hecho'].forEach(status => {
      const el = document.getElementById('kaizen-' + status);
      if (el) {
        new Sortable(el, {
          group: 'kaizen',
          animation: 120,
          forceFallback: true,
          delayOnTouchOnly: true,
          delay: 80,
          onEnd: evt => {
            const id = evt.item.dataset.id;
            const newStatus = evt.to.id.replace('kaizen-','');
            if (!id) return;
            fetch(`/api/tasks/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: newStatus })
            }).catch(e => console.warn('KAIZEN move error BCN', e));
          }
        });
      }
    });

    document.getElementById('kaizen-form').addEventListener('submit', createKaizen);
  }

  function renderKaizenCard(task) {
    if (task.station && task.station !== 'BCN') return;
    const col = document.getElementById('kaizen-' + (task.status || 'Pendiente'));
    if (!col) return;
    let card = document.querySelector(`.kaizen-card[data-id="${task.id}"]`);
    if (!card) {
      card = document.createElement('div');
      card.className = 'kaizen-card';
      card.dataset.id = task.id;
      col.appendChild(card);
    } else {
      card.innerHTML = '';
    }

    const t = document.createElement('div');
    t.textContent = task.title || '(Sin título)';
    const o = document.createElement('div');
    o.style.color = 'var(--text-soft)';
    o.textContent = (task.owner || task.assigned_to) ? 'Resp: ' + (task.owner || task.assigned_to) : '';
    card.appendChild(t);
    if (o.textContent) card.appendChild(o);
  }

  async function createKaizen(ev) {
    ev.preventDefault();
    const form = ev.target;
    const payload = {
      task_type: 'kaizen',
      status: 'Pendiente',
      title: form.title.value,
      owner: form.owner.value || null,
      station: 'BCN'
    };
    try {
      const res = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        const created = await res.json();
        processTaskUpdate(created);
        form.reset();
      }
    } catch (e) {
      console.warn('Error create KAIZEN BCN', e);
    }
  }

  // ===============================
  // 5S & GW TOP 3
  // ===============================
  function initS5() {
    const saved = localStorage.getItem(S5_STATE_KEY);
    let state = { completed: [] };
    if (saved) {
      try { state = JSON.parse(saved); } catch(e){}
    }
    const pills = document.querySelectorAll('.s5-pill');
    const meta = document.getElementById('s5-meta');

    const refresh = () => {
      let count = 0;
      pills.forEach(p => {
        const key = p.dataset.s;
        const active = state.completed.includes(key);
        p.classList.toggle('active', active);
        if (active) count++;
      });
      meta.textContent = `${count}/5 completadas • Actualizado: ${new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}`;
      localStorage.setItem(S5_STATE_KEY, JSON.stringify(state));
    };

    pills.forEach(p => {
      p.addEventListener('click', () => {
        const key = p.dataset.s;
        if (!state.completed.includes(key)) {
          state.completed.push(key);
        } else {
          state.completed = state.completed.filter(k => k !== key);
        }
        refresh();
      });
    });

    refresh();
  }

  function initGwTop3() {
    renderGwTop3();
  }

  function renderGwTop3() {
    const container = document.getElementById('gw-top3');
    if (!container) return;
    container.innerHTML = '';

    const tasks = Object.values(GW_MAP)
      .filter(t => !t.station || t.station === 'BCN')
      .sort((a,b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0))
      .slice(0,3);

    if (!tasks.length) {
      container.innerHTML = `<div class="tag">Sin acciones GW recientes para BCN.</div>`;
      return;
    }

    tasks.forEach(t => {
      const row = document.createElement('div');
      row.className = 'gw-item';
      row.dataset.id = t.id;

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = !!t.is_completed;
      cb.addEventListener('change', () => toggleGwComplete(t, cb));

      const label = document.createElement('div');
      label.textContent = t.title || '(sin título)';

      const note = document.createElement('textarea');
      note.className = 'gw-note';
      note.value = t.note || '';
      note.placeholder = 'Nota al completar (opcional)';
      note.disabled = !cb.checked;
      note.addEventListener('change', () => updateGwNote(t, note.value));

      row.appendChild(cb);
      row.appendChild(label);
      row.appendChild(note);

      container.appendChild(row);
    });
  }

  async function toggleGwComplete(task, cb) {
    const completed = cb.checked;
    const noteEl = cb.parentElement.querySelector('.gw-note');
    if (noteEl) noteEl.disabled = !completed;
    try {
      await fetch(`/api/tasks/${task.id}/complete`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_completed: completed })
      });
      task.is_completed = completed;
    } catch(e) {
      console.warn('Error GW complete BCN', e);
    }
  }

  async function updateGwNote(task, note) {
    try {
      await fetch(`/api/tasks/${task.id}/note`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ note })
      });
      task.note = note;
    } catch(e) {
      console.warn('Error GW note BCN', e);
    }
  }

  // ===============================
  // KPI COSTES BCN
  // ===============================
  function initKpiCostes() {
    const saved = localStorage.getItem(KPI_COSTES_KEY);
    if (saved) {
      try {
        const data = JSON.parse(saved);
        applyKpiCostes(data.value, data.updated_at, { noFlash: true });
      } catch(e){}
    }
  }

  function applyKpiCostes(value, updatedAt, opts = {}) {
    const el = document.getElementById('kpi-costes-value');
    const up = document.getElementById('kpi-costes-updated');
    if (!el || !up) return;
    el.textContent = `${Number(value || 0).toLocaleString('es-ES',{minimumFractionDigits:0})} €`;
    up.textContent = `Actualizado: ${updatedAt ? new Date(updatedAt).toLocaleString('es-ES') : 'N/D'}`;
    localStorage.setItem(KPI_COSTES_KEY, JSON.stringify({
      value,
      updated_at: updatedAt || new Date().toISOString()
    }));
    if (!opts.noFlash) {
      el.classList.remove('flash');
      void el.offsetWidth;
      el.classList.add('flash');
    }
  }

  // ===============================
  // PLANIFICACIÓN EXTERNA
  // ===============================
  async function initPlanificacion() {
    await loadExternalTable();
  }

  async function loadExternalTable() {
    try {
      const res = await fetch('/api/external-table');
      if (!res.ok) return;
      const data = await res.json();
      renderExternalTable(data);
    } catch(e) {
      console.warn('Error external table BCN', e);
    }
  }

  function renderExternalTable(data) {
    const tbody = document.getElementById('planificacion-tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!Array.isArray(data)) return;
    const colsAllow = [
      'FlightId',
      'FlightType',
      'AircraftType',
      'FlightIdentifier',
      'Departure.Scheduled',
      'PiecesProgress.Members.Manifested.Item1',
      'WeightProgress.Members.Manifested.Item1'
    ];
    data.forEach(row => {
      const tr = document.createElement('tr');
      colsAllow.forEach(c => {
        const td = document.createElement('td');
        td.textContent = resolvePath(row, c) ?? '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function resolvePath(obj, path) {
    return path.split('.').reduce((acc, k) => acc && acc[k] !== undefined ? acc[k] : null, obj);
  }

  // ===============================
  // BRIEF CHECKLIST (help dinámico)
  // ===============================
  function initBriefChecklist() {
    const helpEl = document.getElementById('brief-help');
    document.querySelectorAll('#brief-check .check-card').forEach(card => {
      card.addEventListener('click', () => {
        const help = card.getAttribute('data-help') || '';
        const target = card.getAttribute('data-target');
        helpEl.textContent = help;
        if (target) {
          const w = document.querySelector(target);
          if (w) {
            w.classList.add('flash');
            setTimeout(() => w.classList.remove('flash'), 500);
          }
        }
      });
    });
  }

  // ===============================
  // EHS
  // ===============================
  function initEhs() {
    document.querySelectorAll('#ehs-widget [data-ehs-delta]').forEach(btn => {
      btn.addEventListener('click', () => {
        const [type, delta] = btn.getAttribute('data-ehs-delta').split(':');
        const valEl = type === 'safe' ? document.getElementById('ehs-days-safe') : document.getElementById('ehs-days-inc');
        let val = parseInt(valEl.textContent || '0', 10) || 0;
        val += (delta === '+1' ? 1 : -1);
        if (val < 0) val = 0;
        valEl.textContent = String(val);
        document.getElementById('ehs-updated').textContent =
          'Actualizado manualmente • pendiente sincronización server';
      });
    });
  }

  // ===============================
  // WEBSOCKET
  // ===============================
  function initWebSocket() {
    try {
      ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');
    } catch(e) {
      console.warn('WS BCN error create', e);
      return;
    }

    ws.onopen = () => {
      // opcional: enviar handshake si backend lo usa
    };

    ws.onmessage = (event) => {
      let msg;
      try { msg = JSON.parse(event.data); } catch(e){ return; }

      if (msg.type === 'kpi_update' || msg.type === 'kpi_state') {
        if (msg.key === 'bcn_costes' || msg.kpi === 'bcn_costes') {
          applyKpiCostes(msg.value, msg.updated_at);
        }
      } else if (msg.type === 'table_state' || msg.type === 'table_ping') {
        if (msg.table === 'external') {
          loadExternalTable();
        }
      } else if (msg.type === 'roster_update') {
        loadRoster();
      } else if (msg.type === 'ehs_update') {
        applyEhsState(msg);
      } else if (msg.task_type) {
        // mensajes de tareas en tiempo real
        processTaskUpdate(msg);
      }
    };

    ws.onclose = () => {
      // reconexión simple
      setTimeout(initWebSocket, 5000);
    };
  }

  function applyEhsState(msg) {
    if (typeof msg.days_safe === 'number') {
      document.getElementById('ehs-days-safe').textContent = msg.days_safe;
    }
    if (typeof msg.days_inc === 'number') {
      document.getElementById('ehs-days-inc').textContent = msg.days_inc;
    }
    document.getElementById('ehs-updated').textContent =
      'Actualizado desde servidor: ' + new Date().toLocaleString('es-ES');
  }

  // ===============================
  // TASK UPDATE GENÉRICO (clave)
  // ===============================
  function processTaskUpdate(task, opts = {}) {
    if (!task) return;

    // sincronización eliminación
    if (task.action === 'delete' && task.id) {
      const el = document.querySelector(`[data-id="${task.id}"]`);
      if (el && el.parentElement) el.parentElement.removeChild(el);
      if (task.task_type === 'kanban_rapida') updateKanbanCounters();
      if (task.task_type === 'gw_task') {
        delete GW_MAP[task.id];
        renderGwTop3();
      }
      return;
    }

    // según tipo
    switch (task.task_type) {
      case 'kanban_rapida':
        renderKanbanCard(task);
        if (!opts.silent) updateKanbanCounters();
        break;
      case 'kaizen':
        renderKaizenCard(task);
        break;
      case 'gw_task':
        GW_MAP[task.id] = task;
        renderGwTop3();
        break;
      default:
        break;
    }
  }

  // ===============================
  // UTILIDADES
  // ===============================
  function formatShortDate(str) {
    if (!str) return '';
    const d = new Date(str);
    if (isNaN(d)) return str;
    return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
  }

  function initWakeLockHint() {
    // No forzamos wakeLock (no todos los navegadores lo soportan),
    // pero dejamos este stub listo si queréis activarlo:
    // if ('wakeLock' in navigator) { ... }
  }
</script>
</body>
</html>
