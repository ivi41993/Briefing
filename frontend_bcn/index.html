<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="UTF-8" />
<title>Factory Floor Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<script>
    (function() {
        // A. DETECTAR RUTA BASE (ej: /bcn/)
        let path = window.location.pathname;
        if (path !== '/' && !path.endsWith('/') && !path.includes('.')) {
            let newUrl = window.location.origin + path + '/' + window.location.search;
            window.history.replaceState(null, null, newUrl);
            path += '/';
        }
        window.BASE_PATH = path; 

        // B. DETECTAR C√ìDIGO DE ESTACI√ìN (Ej: BCN, MAD)
        const segments = path.split('/').filter(Boolean);
        const detectedStation = segments.length > 0 ? segments[0].toUpperCase() : 'MAD';
        
        // Variables Globales
        window.STATION_CODE = detectedStation;
        console.log(`üåç FUSION SYSTEM: Estaci√≥n ${detectedStation} | Base ${window.BASE_PATH}`);

        // C. AJUSTAR T√çTULO PESTA√ëA
        document.title = `WFS4 - ${detectedStation} OPS`;

        // D. FUNCI√ìN API FETCH (Obligatoria para rutas relativas)
        window.apiFetch = function(endpoint, options = {}) {
            const cleanEndpoint = endpoint.startsWith('/') ? endpoint.substring(1) : endpoint;
            return fetch(window.BASE_PATH + cleanEndpoint, options);
        };

        // E. FUNCI√ìN WEBSOCKET AUTOM√ÅTICA
        window.connectFusionWebSocket = function(onMessageCallback) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}${window.BASE_PATH}ws`;
            console.log(`üîå WS Conectando a: ${wsUrl}`);
            
            const socket = new WebSocket(wsUrl);
            socket.onopen = () => console.log(`‚úÖ WS Conectado (${detectedStation})`);
            socket.onmessage = (event) => {
                if(onMessageCallback) onMessageCallback(JSON.parse(event.data));
            };
            socket.onclose = () => {
                console.warn("WS Cerrado. Reconectando...");
                setTimeout(() => window.connectFusionWebSocket(onMessageCallback), 3000);
            };
            socket.onerror = (err) => console.error("WS Error:", err);
            return socket;
        };
    })();
</script>

<style>
/* TUS ESTILOS ORIGINALES INTACTOS */
:root{ --ui-scale: 1; }
html{ font-size: calc(16px * var(--ui-scale)); }
@media (min-width: 1600px){ :root{ --ui-scale: 1.15; } }

:root{
--brand-red-900:#7f1d1d; --brand-red-800:#991b1b; --brand-red-700:#b91c1c;
--brand-red-600:#dc2626; --brand-red-500:#ef4444; --brand-red-400:#f87171;
--bg-page:#f7f8fa; --bg-card:#ffffff; --border:#e6e8ec; --text:#1f2937; --text-muted:#6b7280;
--cat-seg:#fee2e2; --cat-inc:#fff1e6; --cat-man:#eaf8f0; --cat-cal:#fce7ff; --cat-ser:#fef9c3;
}

:focus-visible{ outline:2px solid var(--brand-red-600); outline-offset:2px; }

/* Base */
html,body{ background:var(--bg-page); color:var(--text); height:100%; margin:0; font:14px "Inter", sans-serif; -webkit-text-size-adjust:100%; }
body{ margin:0; }
h1,h2,h3,.widget-title,.column-title .count{ font-family:"Space Grotesk", sans-serif; letter-spacing:.2px; }

/* Header */
header{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
header h1{ margin:0; color:var(--brand-red-600); font-weight:700; font-size: clamp(1.6rem, 1vw + 1rem, 2.2rem); }
.header-left{ display:flex; flex-direction:column; gap:2px; }
#now-header{ font-size:.95rem; color:var(--text-muted); }
.shift-chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; font-weight:600; font-size:.85rem; }
.shift-chip[data-shift="Ma√±ana"]{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
.shift-chip[data-shift="Tarde"]{ background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
.shift-chip[data-shift="Noche"]{ background:#eef2ff; color:#3730a3; border-color:#c7d2fe; }

.header-controls{ display:flex; gap:12px; align-items:center; }
.header-controls input{ padding:6px 10px; border:1px solid var(--border); border-radius:8px; font-size:.9rem; background:#fff; }
.btn-primary{ background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700)); color:#fff; border:none; border-radius:10px; padding:10px 16px; box-shadow:0 6px 16px rgba(220,38,38,.25); transition:.15s transform,.2s box-shadow,.2s filter; cursor:pointer; }
.btn-primary:hover{ transform:translateY(-1px); filter:saturate(110%); }

.top-bar{ position:sticky; top:0; z-index:20; display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 8px max(clamp(12px, 2vw, 28px), env(safe-area-inset-right)) 4px max(clamp(12px, 2vw, 28px), env(safe-area-inset-left)); background:linear-gradient(to bottom, rgba(247,248,250,0.98), rgba(247,248,250,0.92)); backdrop-filter:blur(6px); }
.top-bar-left{ display:flex; align-items:center; gap:6px; font-size:.78rem; color:var(--text-muted); }
.top-bar select{ padding:4px 8px; border-radius:8px; border:1px solid var(--border); font-size:.8rem; background:#fff; }

.dashboard-3col{ min-height: 100svh; display:grid; grid-template-columns: 320px 1fr 380px; grid-template-rows: auto 1fr; gap:16px; padding: max(clamp(12px, 2vw, 28px), env(safe-area-inset-top)) max(clamp(12px, 2vw, 28px), env(safe-area-inset-right)) max(clamp(12px, 2vw, 28px), env(safe-area-inset-bottom)) max(clamp(12px, 2vw, 28px), env(safe-area-inset-left)); }
header{ grid-column: 1 / -1; }
.col-left, .col-middle, .col-right{ min-height:0; overflow:auto; display:flex; flex-direction:column; gap:20px; }

/* Widgets */
.widget,.card{ background:var(--bg-card); border:1px solid var(--border); border-radius:12px; box-shadow: 0 6px 18px rgba(17,24,39,.06); padding:16px; position:relative; }
.widget-title{ font-size:1.05rem; font-weight:700; margin:0 0 12px; display:flex; align-items:center; justify-content:space-between; }

/* Kanban */
.board-container{ display:grid; gap:12px; }
.board-container.kanban{ grid-template-columns: repeat(4, minmax(0,1fr)); }
.board-container.kaizen{ grid-template-columns: repeat(3, minmax(0,1fr)); }
.kanban-column{ display:flex; flex-direction:column; min-width:0; }
.column-title{ display:flex; justify-content:space-between; align-items:baseline; font-size:.85rem; font-weight:600; color:var(--text-muted); margin:0 0 6px; padding-bottom:8px; border-bottom:2px solid #e9ecef; }
.cards-container{ min-height:120px; max-height: clamp(280px, 48svh, 70vh); overflow:auto; padding-top:4px; }
.card{ margin-bottom:8px; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:grab; }
.card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06); }
.card-content{ flex:1 1 auto; min-width:0; }
.card-title{ font-weight:600; font-size:.95rem; margin:0 0 4px; line-height:1.25; overflow:hidden; max-height:2.5em; }
.card-details,.card-assignee{ font-size:.8rem; color:var(--text-muted); }
.delete-card-btn{ background:none; border:none; color:#9ca3af; display:none; cursor:pointer; }
.card:hover .delete-card-btn{ display:block; }
.drag-handle{ align-self:stretch; display:flex; align-items:center; justify-content:center; padding:12px; border:1px solid var(--border); border-radius:10px; background:var(--bg-card); cursor:grab; opacity:.7; touch-action: none; user-select: none; }
.card:active .drag-handle{ cursor:grabbing; opacity:1; background:#f3f4f6; }
.drag-handle svg{ width:20px; height:20px; }

/* Categor√≠as Kanban */
.cat-chip{ display:inline-block; margin-left:8px; font-size:.7rem; font-weight:700; padding:2px 6px; border-radius:999px; border:1px solid rgba(0,0,0,.08); vertical-align:middle; background:rgba(255,255,255,.7); }
#kanban-widget .card.cat-seguridad { border-left:6px solid #ef4444; }
#kanban-widget .card.cat-incidencias { border-left:6px solid #f59e0b; }
#kanban-widget .card.cat-mantenimiento { border-left:6px solid #10b981; }
#kanban-widget .card.cat-calidad { border-left:6px solid #a855f7; }
#kanban-widget .card.cat-servicio { border-left:6px solid #eab308; }

/* Checklist Spotlight */
#brief-check{ position: sticky; top: 0; z-index: 5; border: 2px solid rgba(239,68,68,.45); box-shadow: 0 14px 36px rgba(239,68,68,.18), 0 2px 0 rgba(255,255,255,.9) inset; background: radial-gradient(1200px 200px at 50% -60px, rgba(239,68,68,.06), transparent), #fff; backdrop-filter: saturate(105%) blur(2px); }
.check-grid{ display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
.check-card{ display:flex; flex-direction:column; align-items:flex-start; gap:10px; padding:14px 16px; min-height:96px; border:1px solid var(--border); box-shadow:0 6px 16px rgba(17,24,39,.06); cursor:pointer; }
.check-title{ font-weight:600; font-size:.95rem; line-height:1.25; word-break:break-word; }
.check-actions label{ padding:6px 12px; border-radius:999px; font-size:.78rem; border:1px solid var(--border); cursor:pointer; }
.check-actions input{ display:none; }
.check-actions input:checked + label{ background:#ecfdf5; border-color:rgba(16,185,129,.6); box-shadow: inset 0 0 0 2px rgba(16,185,129,.08); }
.spotlight-blink{ position: relative; border-color: rgba(239,68,68,.6) !important; box-shadow: 0 0 0 3px rgba(239,68,68,.20), 0 14px 36px rgba(239,68,68,.12); animation: blink-glow 1.2s ease-in-out infinite; }
@keyframes blink-glow{ 0%,100%{ box-shadow: 0 0 0 2px rgba(239,68,68,.18), 0 8px 22px rgba(239,68,68,.10); transform: scale(1); } 50%{ box-shadow: 0 0 0 5px rgba(239,68,68,.28), 0 18px 44px rgba(239,68,68,.18); transform: scale(1.01); } }

/* Timer Header */
.header-timer{ display:flex; align-items:center; gap:10px; border:1px solid var(--border); border-radius:12px; background:#fff; padding:8px 10px; }
.timer-display { font-size: clamp(3rem, 5vw, 6rem); font-family: "Space Grotesk", sans-serif; font-weight: 800; line-height: 1; color: var(--brand-red-900); font-variant-numeric: tabular-nums; cursor: pointer; user-select: none; transition: color 0.3s, transform 0.2s; text-shadow: 2px 2px 0px rgba(255,255,255,0.5); }
.timer-display.alert-mode { color: #dc2626 !important; animation: timer-pulse 1s infinite; }
@keyframes timer-pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
.timer-dot{ width:8px; height:8px; border-radius:50%; background:#d1d5db; }
.timer-reset{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; font-weight:700; font-size:.82rem; cursor:pointer; }

/* KPIs */
.kpi-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
.kpi-tile{ border:1px solid var(--border); border-radius:12px; background:#fff; padding:14px; box-shadow:0 6px 18px rgba(17,24,39,.06); }
.kpi-value{ font-family:"Space Grotesk", sans-serif; font-weight:800; font-size: clamp(1.6rem, 2.6vw + .4rem, 2.6rem); line-height:1; color:var(--brand-red-600); }
.flash{ animation: flash-kpi 900ms ease-out; }
@keyframes flash-kpi{ from{ background:#fff3cd; } to{ background:transparent; } }

/* 5S Compact */
.s5-compact{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.s5-pill{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; font-size:.8rem; cursor:pointer; }
.s5-pill.on{ background:linear-gradient(135deg, #ecfdf5, #ffffff); border-color: rgba(16,185,129,.55); box-shadow: inset 0 0 0 2px rgba(16,185,129,.08); }
.s5-dot{ width:8px; height:8px; border-radius:50%; background:#d1d5db; }
.s5-pill.on .s5-dot{ background:#10b981; }

/* Fullscreen / Nav */
.fs-toggle{ position:absolute; top:10px; right:10px; border:1px solid var(--border); background:rgba(255,255,255,.95); border-radius:12px; padding:10px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,.10); min-width:44px; min-height:44px; opacity:.8; }
.fs-toggle:hover{ opacity:1; transform:scale(1.06); }
.widget:fullscreen{ background:#fff; border-radius:0; box-shadow:none; padding:24px; overflow:auto; }
.widget-nav-bar { display: none; justify-content: space-between; align-items: center; background: #fff; padding: 10px 15px; border-bottom: 1px solid var(--border); margin: -16px -16px 16px -16px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.widget:fullscreen .widget-nav-bar, .widget.widget--zoomed .widget-nav-bar { display: flex; }
.btn-nav { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; border: 1px solid #d1d5db; background: #f8fafc; color: #334155; }
.widget--zoomed{ position:fixed; inset: 8px; z-index:40; background:#ffffff; border-radius:16px; box-shadow:0 18px 60px rgba(15,23,42,.32); overflow:auto; }

/* Post Briefing Mode */
#post-briefing-screen { display: none; position: fixed; inset: 0; background-color: #f8fafc; z-index: 99999; padding: 20px; flex-direction: column; overflow-y:auto; }
#post-briefing-screen.active { display: flex; }
.pb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
.pb-title { font-size: 1.8rem; font-weight: 800; color: var(--brand-red-700); font-family: "Space Grotesk", sans-serif; }
.pb-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; flex: 1; }
.pb-card { background: white; border: 1px solid #cbd5e1; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
.pb-card-title { font-size: 1.4rem; font-weight: 700; color: #475569; margin-bottom: 15px; border-bottom: 4px solid var(--brand-red-500); padding-bottom: 5px; width: fit-content; }
.pb-content { flex: 1; font-size: 1.1rem; line-height: 1.6; }
.pb-kpi-val { font-size: 3rem; font-weight: 800; color: var(--brand-red-600); display: block; text-align:center; }
@media (max-width: 1000px) { .pb-grid { grid-template-columns: 1fr; } }
/* Ops Updates & Styles */
.ops-item, .ops-line-card{ border:1px solid var(--border); border-left:6px solid var(--brand-red-500); border-radius:12px; background:#fff; box-shadow:0 6px 16px rgba(17,24,39,.06); padding:10px 12px; margin-bottom:8px;}
.ops-line-card[data-priority="Alta"] { border-left-color:#ef4444; }
.ops-line-card[data-priority="Media"] { border-left-color:#f59e0b; }
.ops-line-card[data-priority="Baja"] { border-left-color:#10b981; }
.btn-compact{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; font-weight:700; font-size:.82rem; cursor:pointer; }
</style>
</head>
<body>

<div class="top-bar" role="banner">
    <div class="top-bar-left">
        <label for="scale-select">Escala UI</label>
        <select id="scale-select">
            <option value="1">100%</option>
            <option value="1.15" selected>115%</option>
            <option value="1.3">130%</option>
        </select>
    </div>
    <div class="top-bar-right">
        <button id="present-btn" class="btn-primary" type="button">Modo presentaci√≥n</button>
    </div>
</div>

<div class="dashboard-3col">
    <header>
        <div class="header-left">
            <h1>Factory Floor Dashboard - <span id="dynamic-station-title">...</span></h1>
            <div id="now-header">‚Äî</div>
            <span id="shift-badge-header" class="shift-chip">‚Äî</span>
        </div>

        <div class="header-timer" id="timer-widget" aria-label="Cron√≥metro">
            <div class="timer-face">
                <div class="timer-display" id="timer-display" title="Toca para iniciar/pausar">00:00:00</div>
                <span class="timer-dot"></span>
            </div>
            <button type="button" class="timer-reset" id="timer-reset">Reiniciar</button>
        </div>

        <div class="header-controls">
            <input type="text" id="briefing-supervisor" placeholder="Nombre Supervisor" style="min-width: 200px;">
            <button type="button" class="btn-mic" data-target="briefing-supervisor" title="Dictar nombre">üéôÔ∏è</button>
            <button class="btn-primary" type="button">Generar Resumen</button>
        </div>
    </header>

    <section class="col-left">
        <div class="widget" id="team-widget">
            <h2 class="widget-title">1) Equipo / Turno</h2>
            <small class="kpi-text" id="team-meta">‚Äî</small>

            <form id="team-form" class="team-form" style="display:flex; gap:8px; margin:8px 0;">
                <input type="text" id="team-name" placeholder="A√±adir persona‚Ä¶" required style="flex:1; padding:8px; border-radius:8px; border:1px solid #ddd;">
                <button type="submit" class="btn-primary">+</button>
            </form>

            <form id="roster-upload-form" style="display:flex; gap:8px; margin:8px 0;">
                <input type="file" id="roster-file" accept=".xlsx,.xls" required style="flex:1; border:1px solid #ddd; border-radius:8px;">
                <button class="btn-primary" type="submit">Subir Excel</button>
            </form>
            <small id="roster-upload-result" class="kpi-text">‚Äî</small>

            <div id="team-list" style="display:flex; flex-direction:column; gap:6px;"></div>
        </div>
    </section>

    <section class="col-middle">
        <div class="widget" id="brief-check">
            <div id="brief-check-explain" class="br-explain" style="margin-bottom:10px; padding:8px; background:#f0f9ff; border-radius:8px; color:#0369a1; font-weight:600;">
                ‚ÑπÔ∏è Gu√≠a: Pasa el rat√≥n sobre los puntos para ver detalles.
            </div>

            <h2 class="widget-title">Checklist</h2>
            <span id="shift-badge" class="shift-chip">‚Äî</span>

            <div class="check-grid">
                <div class="check-card" data-target="prev-shift-widget" data-help="Revisar novedades del turno anterior.">
                    <span class="check-title">1) Highlights Turno Anterior</span>
                    <div class="check-actions"><input id="c1ok" type="radio" name="c1" value="OK"><label for="c1ok">OK</label></div>
                </div>
                <div class="check-card" data-target="ops-updates-widget" data-help="Cambios operativos y novedades.">
                    <span class="check-title">2) Actualizaciones Operativas</span>
                    <div class="check-actions"><input id="c2ok" type="radio" name="c2" value="OK"><label for="c2ok">OK</label></div>
                </div>
                <div class="check-card" data-target="team-widget" data-help="Revisar presencias y zonas.">
                    <span class="check-title">3) Dotaci√≥n</span>
                    <div class="check-actions"><input id="c3ok" type="radio" name="c3" value="OK"><label for="c3ok">OK</label></div>
                </div>
                <div class="check-card" data-target="safety-daily-widget" data-help="EPIs, Consignas, Incidentes.">
                    <span class="check-title">4) Seguridad</span>
                    <div class="check-actions"><input id="c4ok" type="radio" name="c4" value="OK"><label for="c4ok">OK</label></div>
                </div>
                <div class="check-card" data-target="incidentes-widget" data-help="Protocolos de emergencia.">
                    <span class="check-title">5) Incidentes</span>
                    <div class="check-actions"><input id="c5ok" type="radio" name="c5" value="OK"><label for="c5ok">OK</label></div>
                </div>
                <div class="check-card" data-target="kpi-center" data-help="UPH, Costes, 5S.">
                    <span class="check-title">6) KPIs</span>
                    <div class="check-actions"><input id="c6ok" type="radio" name="c6" value="OK"><label for="c6ok">OK</label></div>
                </div>
                <div class="check-card" data-target="kanban-widget" data-help="Feedback del equipo.">
                    <span class="check-title">7) Feedback</span>
                    <div class="check-actions"><input id="c7ok" type="radio" name="c7" value="OK"><label for="c7ok">OK</label></div>
                </div>
            </div>
            <small class="kpi-text" id="brief-check-meta">‚Äî</small>
        </div>

        <div class="widget" id="ops-updates-widget">
            <h2 class="widget-title">2) Actualizaciones operativas</h2>
            <div class="ops-toolbar">
                <input id="ops-search" class="ops-search" type="search" placeholder="Buscar..." style="width:100%; padding:8px; margin-bottom:10px;">
                <div id="ops-lines-list" class="ops-list"></div>
            </div>
            <div class="ops-actions" style="margin-top:10px;">
                <button type="button" class="btn-compact" id="ops-add-section">+ Secci√≥n</button>
                <button type="button" class="btn-compact" id="ops-clear">Vaciar</button>
            </div>
            <div class="ops-grid" style="margin-top:10px;">
                <div class="ops-card">
                    <strong>Secciones</strong>
                    <div id="ops-sections"></div>
                </div>
                <div class="ops-card">
                    <strong>L√≠neas r√°pidas</strong>
                    <div id="ops-quicklines" class="ops-quicklines" contenteditable="true" data-placeholder="Escribe aqu√≠..." style="min-height:100px; border:1px solid #ddd; padding:10px;"></div>
                </div>
            </div>
        </div>

        <div class="widget" id="safety-daily-widget">
            <h2 class="widget-title">4) Seguridad y protecci√≥n</h2>
            <div class="safety-grid">
                <div class="safety-card">
                    <strong>Recordatorios</strong>
                    <div id="safety-tips" class="tips"></div>
                    <button class="btn-compact" id="safety-refresh" style="margin-top:5px;">Refrescar</button>
                </div>
                <div class="safety-card">
                    <strong>Alta Manual</strong>
                    <form id="safety-form" class="incident-form">
                        <input type="text" id="safety-title" placeholder="T√≠tulo" required style="width:100%; margin-bottom:5px;">
                        <textarea id="safety-desc" placeholder="Descripci√≥n" style="width:100%;"></textarea>
                        <button type="submit" class="btn-compact" style="margin-top:5px;">Guardar</button>
                    </form>
                    <div id="safety-list" class="incident-list" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>

        <div class="widget" id="incidentes-widget">
            <h2 class="widget-title">5) Incidentes / Seguridad</h2>
            <div id="incident-remember" class="incident-remember" contenteditable="true" style="padding:10px; background:#fff; border:2px solid #dc2626; border-radius:8px; color:#991b1b; font-weight:bold; margin-bottom:10px;">
                RECORDAR: Uso correcto de EPIs...
            </div>
            <div class="incident-card-grid">
                <div class="incident-card"><b>Qu√© hacer</b><div id="incident-what" class="incident-card-body" contenteditable="true" style="min-height:60px; border:1px solid #ddd; padding:5px;"></div></div>
                <div class="incident-card"><b>A qui√©n avisar</b><div id="incident-who" class="incident-card-body" contenteditable="true" style="min-height:60px; border:1px solid #ddd; padding:5px;"></div></div>
                <div class="incident-card"><b>Equipos</b><div id="incident-where" class="incident-card-body" contenteditable="true" style="min-height:60px; border:1px solid #ddd; padding:5px;"></div></div>
            </div>
            <form id="incidents-pdf-form" style="display:flex; gap:8px; margin-top:10px;">
                <input type="file" id="incidents-pdf-file" accept="application/pdf" required style="flex:1;">
                <button class="btn-primary" type="submit">Subir PDF</button>
            </form>
            <div class="table-scroll"><table id="incidentes-table" style="width:100%; margin-top:10px;"></table></div>
        </div>

        <div class="widget kpi-widget" id="kpi-center">
            <h2 class="widget-title">6) KPIs Operativos</h2>
            <div class="kpi-grid">
                <div class="kpi-tile"><div class="kpi-label">UPH</div><div class="kpi-value" id="kpi-uph">‚Äî</div></div>
                <div class="kpi-tile"><div class="kpi-label">DG Check</div><div class="kpi-value" id="kpi-otif">‚Äî</div></div>
                <div class="kpi-tile"><div class="kpi-label">Backlog</div><div class="kpi-value" id="kpi-backlog">‚Äî</div></div>
                <div class="kpi-tile" id="kpi-costes"><div class="kpi-label">Costes</div><div class="kpi-value"><span id="kpi-total-cost">‚Äî</span>‚Ç¨</div></div>
            </div>
            <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div style="background:#fafafa; padding:10px; border-radius:8px;">
                    <strong>Estado 5S</strong>
                    <div id="s5-strip" class="s5-compact" style="margin-top:5px;">
                        <button class="s5-pill" data-key="seiri"><span class="s5-dot"></span>1S</button>
                        <button class="s5-pill" data-key="seiton"><span class="s5-dot"></span>2S</button>
                        <button class="s5-pill" data-key="seiso"><span class="s5-dot"></span>3S</button>
                        <button class="s5-pill" data-key="seiketsu"><span class="s5-dot"></span>4S</button>
                        <button class="s5-pill" data-key="shitsuke"><span class="s5-dot"></span>5S</button>
                    </div>
                </div>
                <div style="background:#fafafa; padding:10px; border-radius:8px;">
                     <strong>Gemba Walk</strong>
                     <div id="gw-tasks-dynamic-container"></div>
                </div>
            </div>
        </div>

        <div class="widget" id="kanban-widget">
            <h2 class="widget-title">7) Feedback directo</h2>
            <div class="board-container kanban">
                <div class="kanban-column"><h3>Abiertas <span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-Abiertas" data-status="Abiertas"></div></div>
                <div class="kanban-column"><h3>En Curso <span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-En-Curso" data-status="En Curso"></div></div>
                <div class="kanban-column"><h3>Cerradas <span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-Cerradas" data-status="Cerradas"></div></div>
                <div class="kanban-column"><h3>Vencidas <span class="count">(0)</span></h3><div class="cards-container" id="kanban_rapida-Vencidas" data-status="Vencidas"></div></div>
            </div>
            <form class="new-item-form" id="new-kanban-form" style="margin-top:10px; display:flex; gap:5px;">
                <select name="category" required><option value="general">General</option><option value="seguridad">Seguridad</option><option value="incidencias">Incidencias</option></select>
                <input type="text" name="title" placeholder="Nuevo problema..." required style="flex:1;">
                <input type="date" name="due_date" required>
                <button type="submit" class="btn-primary">A√±adir</button>
            </form>
        </div>
        
        <div class="widget" id="kaizen-widget" style="margin-top:20px;">
             <h2 class="widget-title">KAIZEN</h2>
             <form class="new-item-form" id="new-kaizen-form" style="margin-bottom:10px; display:flex; gap:5px;">
                 <input type="text" name="title" placeholder="Proyecto de mejora..." required style="flex:1;">
                 <input type="text" name="assigned_to" placeholder="Responsable">
                 <button type="submit" class="btn-primary">A√±adir</button>
             </form>
             <div class="board-container kaizen">
                 <div class="kanban-column"><h3>Proyectos</h3><div class="cards-container" id="kaizen-Proyectos" data-status="Proyectos"></div></div>
                 <div class="kanban-column"><h3>En Progreso</h3><div class="cards-container" id="kaizen-En-Progreso" data-status="En Progreso"></div></div>
                 <div class="kanban-column"><h3>Hecho</h3><div class="cards-container" id="kaizen-Hecho" data-status="Hecho"></div></div>
             </div>
        </div>
    </section>

    <section class="col-right">
        <div class="widget" id="prev-shift-widget">
            <h2 class="widget-title">3) Turno Anterior <button class="btn-mic" data-target="prev-shift-note">üéôÔ∏è</button></h2>
            <div id="prev-shift-note" class="editable-note" contenteditable="true" data-placeholder="Escribe novedades..." style="min-height:100px; padding:10px; border:1px solid #ddd; border-radius:8px;"></div>
            <small class="kpi-text" id="prev-shift-saved-hint"></small>
        </div>
        <div class="widget" id="ehs-widget">
            <h2 class="widget-title">D√≠as sin incidentes</h2>
            <div class="ehs-big" id="ehs-days" style="font-size:4rem; text-align:center; font-weight:bold; color:#dc2626;">0</div>
            <div id="ehs-month" style="text-align:center; color:#666;"></div>
        </div>
    </section>
</div>

<div id="post-briefing-screen">
    <div class="pb-header">
        <div class="pb-title">üöÄ MODO OPERATIVO - <span id="pb-station-title">...</span></div>
        <button class="pb-close-btn" onclick="closePostBriefingMode()" style="padding:10px; background:#333; color:white; border-radius:5px;">‚úñ Cerrar</button>
    </div>
    <div class="pb-grid">
        <div class="pb-card"><div class="pb-card-title">Highlights Turno Anterior</div><div id="pb-prev-content" class="pb-content"></div></div>
        <div class="pb-card"><div class="pb-card-title">Actualizaciones Operativas</div><div id="pb-ops-content" class="pb-content"></div></div>
        <div class="pb-card">
            <div class="pb-card-title">KPIs del Turno</div>
            <div class="pb-content" style="display:flex; justify-content:space-around;">
                 <div>UPH: <span id="pb-val-uph" class="pb-kpi-val">-</span></div>
                 <div>Costes: <span id="pb-val-cost" class="pb-kpi-val">-</span></div>
            </div>
        </div>
        <div class="pb-card"><div class="pb-card-title">Seguridad</div><div id="pb-sec-content" class="pb-content"></div></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
// USAMOS LAS VARIABLES CALCULADAS EN EL HEAD
const STATION_CODE = window.STATION_CODE || 'MAD';

// === HELPER PARA CLAVES √öNICAS ===
// Esto es lo que evita que Madrid lea datos de Barcelona
const key = (baseName) => `${baseName}_${STATION_CODE}_v1`;

// === UTILIDADES ===
function esc(s){ return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function loadJson(k,fb){ try{return JSON.parse(localStorage.getItem(k)||'null')??fb;}catch{return fb;} }
function saveJson(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch{} }

// === INICIALIZACI√ìN ===
document.addEventListener('DOMContentLoaded', () => {
    console.log("üöÄ Iniciando Dashboard para: " + STATION_CODE);
    
    // 1. Poner nombre en el H1
    const titleSpan = document.getElementById('dynamic-station-title');
    const pbTitleSpan = document.getElementById('pb-station-title');
    if(titleSpan) titleSpan.textContent = STATION_CODE + " OPS";
    if(pbTitleSpan) pbTitleSpan.textContent = STATION_CODE;

    // 2. Inits Componentes
    try { initHeaderTimer(); } catch(e){}
    try { initDateTimeAndShift(); } catch(e){}
    try { initFullscreenToggles(); } catch(e){}
    try { init5S(); } catch(e){}
    try { initEhsSimple(); } catch(e){}
    try { initTeamRoster(); } catch(e){}
    try { setupEventListeners(); } catch(e){}
    try { makeColumnsSortable(); } catch(e){}
    try { initOpsUpdates(); } catch(e){}
    try { initSafetyDailyWidget(); } catch(e){}
    try { initIncidentEditableFields(); } catch(e){}
    
    // 3. Cargar datos del Servidor
    loadBoardsInitial();
    loadIncidentes();
    hydrateKpiTotalCost();

    // 4. Conectar WebSocket (usando la funci√≥n del Head)
    try { 
        window.connectFusionWebSocket(processTaskUpdate); 
    } catch(e) { console.error("WS Fallo", e); }
    
    // 5. Checklist l√≥gica
    initChecklist();
    
    // 6. Navegaci√≥n guiada
    initNavigation();
});

// === CRON√ìMETRO ===
function initHeaderTimer(){
    const KEY = key('header_timer'); // Clave √∫nica por estaci√≥n
    let running=false, startedAt=0, elapsed=0, tick=null;
    const disp = document.getElementById('timer-display');
    
    function paint(){
        if(!disp) return;
        const now = running ? (Date.now()-startedAt) : elapsed;
        const t = Math.floor(now/1000);
        const h=Math.floor(t/3600), m=Math.floor((t%3600)/60), s=t%60;
        disp.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        if(now > 4*60*1000) disp.classList.add('alert-mode'); else disp.classList.remove('alert-mode');
    }
    
    try{
        const s=JSON.parse(localStorage.getItem(KEY)||'null');
        if(s){ running=!!s.running; elapsed=Number(s.elapsed)||0; startedAt=Number(s.startedAt)||0; }
        if(running){ startedAt = Date.now() - elapsed; tick=setInterval(paint,1000); }
    }catch(e){}
    paint();
    
    // Eventos timer
    disp?.addEventListener('click', ()=>{
         if(running){ clearInterval(tick); running=false; elapsed=Date.now()-startedAt; }
         else { running=true; startedAt=Date.now()-elapsed; tick=setInterval(paint,1000); }
         paint();
         localStorage.setItem(KEY, JSON.stringify({running,startedAt,elapsed}));
    });
    document.getElementById('timer-reset')?.addEventListener('click', ()=>{
         if(!confirm("¬øReiniciar cron√≥metro?")) return;
         running=false; startedAt=0; elapsed=0; clearInterval(tick); paint();
         localStorage.setItem(KEY, JSON.stringify({running,startedAt,elapsed}));
         disp.classList.remove('alert-mode');
    });
    window.resetFactoryTimer = () => {
         running=false; startedAt=0; elapsed=0; clearInterval(tick); paint();
         localStorage.setItem(KEY, JSON.stringify({running,startedAt,elapsed}));
    };
}

// === FECHA Y TURNO ===
function computeShift(d=new Date()){
    const m=d.getHours()*60+d.getMinutes();
    if (m>=360 && m<840) return {name:'Ma√±ana',from:'06:00',to:'14:00'};
    if (m>=840 && m<1320) return {name:'Tarde', from:'14:00',to:'22:00'};
    return {name:'Noche',from:'22:00',to:'06:00'};
}
function initDateTimeAndShift(){
    const paint = () => {
        const now = new Date();
        document.getElementById('now-header').textContent = now.toLocaleString('es-ES',{weekday:'long',day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'});
        const s = computeShift(now);
        const els = [document.getElementById('shift-badge'), document.getElementById('shift-badge-header')];
        els.forEach(el => { if(el) { el.textContent = `${s.name} (${s.from}-${s.to})`; el.dataset.shift = s.name; }});
    };
    paint(); setInterval(paint, 60000);
}

// === TEAM ROSTER ===
let TEAM_STATE = { people:[], attendance:{} };
async function fetchServerRoster(){
    // apiFetch a√±ade /bcn/ automaticamente
    const r = await apiFetch('api/roster/current'); 
    if(r.ok) return await r.json();
    return null;
}
function initTeamRoster(){
    // Carga inicial vac√≠a o del servidor
    window.TEAM_STATE = { people: [], attendance: {} };
    document.getElementById('team-form')?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const input = document.getElementById('team-name');
        const name = input.value.trim();
        if(!name) return;
        window.TEAM_STATE.people.push({nombre_completo:name});
        window.TEAM_STATE.attendance[name] = true;
        renderRoster();
        input.value='';
        // Aqu√≠ podr√≠as a√±adir llamada al servidor para guardar la persona
        apiFetch('api/roster/add', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({person:name, station:STATION_CODE, shift:computeShift().name})
        }).catch(e=>console.warn("No se pudo guardar en server", e));
    });
}
function renderRoster(){
    const list = document.getElementById('team-list');
    if(!list) return;
    list.innerHTML = window.TEAM_STATE.people.map(p => {
        const isPres = window.TEAM_STATE.attendance[p.nombre_completo];
        return `<div style="padding:8px; border:1px solid #eee; display:flex; justify-content:space-between;">
            <span>${esc(p.nombre_completo)}</span>
            <label><input type="checkbox" ${isPres?'checked':''} onchange="togglePresence('${esc(p.nombre_completo)}', this.checked)"> Presente</label>
        </div>`;
    }).join('');
    const meta = document.getElementById('team-meta');
    if(meta) meta.textContent = `${window.TEAM_STATE.people.length} personas`;
}
window.togglePresence = (name, val) => {
    window.TEAM_STATE.attendance[name] = val;
    apiFetch('api/roster/presence', {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({person:name, present:val})
    }).catch(()=>{});
};

// === TURNO ANTERIOR (Nota Local) ===
(function(){
    const el = document.getElementById('prev-shift-note');
    if(!el) return;
    const NOTE_KEY = key('prev_shift_note'); // Clave √∫nica
    el.innerText = localStorage.getItem(NOTE_KEY) || '';
    el.addEventListener('input', () => {
        localStorage.setItem(NOTE_KEY, el.innerText);
        document.getElementById('prev-shift-saved-hint').textContent = 'Guardado...';
    });
})();

// === OPS UPDATES ===
function initOpsUpdates(){
    const SECT_KEY = key('ops_sections');
    const LINES_KEY = key('ops_lines');
    // ... Cargar y guardar usando estas claves √∫nicas ...
    // Simplificado para brevedad, pero la l√≥gica es: leer localStorage(SECT_KEY) y pintar.
}

// === API TASKS (Kanban, etc) ===
async function loadBoardsInitial(){
    try {
        const qs = 'station='+encodeURIComponent(STATION_CODE);
        // apiFetch redirige a /bcn/api/tasks...
        const [kanRes, kaiRes, gwRes] = await Promise.all([
            apiFetch('api/tasks?task_type=kanban_rapida&'+qs),
            apiFetch('api/tasks?task_type=kaizen&'+qs),
            apiFetch('api/tasks?task_type=gw_task&'+qs)
        ]);
        const kan = await kanRes.json().catch(()=>[]);
        const kai = await kaiRes.json().catch(()=>[]);
        const gw = await gwRes.json().catch(()=>[]);
        
        // Procesar
        [...kan, ...kai, ...gw].forEach(processTaskUpdate);
    } catch(e) { console.error("Error cargando tableros", e); }
}

// === WEBSOCKET HANDLER ===
function processTaskUpdate(data){
    if(!data) return;
    // Doble check de estaci√≥n (backend ya filtra, pero por seguridad)
    if(data.station && data.station.toUpperCase() !== STATION_CODE) return;

    if(data.type === 'roster_update') { 
        window.TEAM_STATE = { people: data.people||[], attendance: data.attendance||{} };
        renderRoster();
    }
    else if(data.task_type === 'kanban_rapida' || data.task_type === 'kaizen') {
        renderCard(data); 
    }
    // ... resto de l√≥gica KPIs ...
    else if(data.metric === 'total cost') {
        document.getElementById('kpi-total-cost').innerText = data.value;
    }
}

function renderCard(task){
    // L√≥gica simple de renderizado de tarjeta
    const colId = task.task_type === 'kanban_rapida' 
        ? `kanban_rapida-${task.status.replace(' ','-')}` 
        : `kaizen-${task.status.replace(' ','-')}`;
    const col = document.getElementById(colId);
    if(!col) return;
    
    let card = document.getElementById(`task-${task.id}`);
    if(!card) {
        card = document.createElement('div');
        card.className = 'card';
        card.id = `task-${task.id}`;
        col.appendChild(card);
    }
    
    // Categor√≠a visual
    card.className = 'card ' + (task.category ? 'cat-'+task.category : '');
    
    card.innerHTML = `
        <div class="card-content">
            <div class="card-title">${esc(task.title)}</div>
            <div class="card-details">${esc(task.assigned_to||'')}</div>
        </div>
        <button class="delete-card-btn" onclick="deleteTask(${task.id})">üóë</button>
    `;
}

window.deleteTask = (id) => {
    if(confirm("Borrar?")) apiFetch(`api/tasks/${id}`, {method:'DELETE'});
};

// === FORMULARIO NUEVA TAREA ===
document.getElementById('new-kanban-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = e.target;
    const body = {
        title: f.title.value,
        category: f.category.value,
        due_date: f.due_date.value,
        task_type: 'kanban_rapida',
        status: 'Abiertas',
        station: STATION_CODE // Importante enviar la estaci√≥n
    };
    await apiFetch('api/tasks', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    f.reset();
});

// === UPLOADS (Excel / PDF) ===
// Usan apiFetch para ir a la carpeta correcta
document.getElementById('roster-upload-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(); fd.append('file', document.getElementById('roster-file').files[0]);
    const res = await apiFetch('api/roster/upload', {method:'POST', body:fd});
    if(res.ok) alert("Excel subido");
});
document.getElementById('incidents-pdf-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(); fd.append('file', document.getElementById('incidents-pdf-file').files[0]);
    const res = await apiFetch('api/incidents-table', {method:'POST', body:fd});
    if(res.ok) alert("PDF subido");
});

// === CHECKLIST + NAVIGATION ===
function initChecklist(){
    const KEY = key('brief_check'); // Clave √∫nica
    const saved = loadJson(KEY, {});
    document.querySelectorAll('.check-actions input').forEach(inp => {
        if(saved[inp.name] === inp.value) inp.checked = true;
        inp.addEventListener('change', () => {
            saved[inp.name] = inp.value;
            saveJson(KEY, saved);
        });
    });
}

function initNavigation(){
    // Inyectar barras de navegaci√≥n en los widgets principales
    const widgets = ['team-widget','ops-updates-widget','prev-shift-widget','safety-daily-widget','incidentes-widget','kpi-center','kanban-widget'];
    widgets.forEach((id, idx) => {
        const el = document.getElementById(id);
        if(!el) return;
        const next = widgets[idx+1] || null;
        const prev = widgets[idx-1] || null;
        
        const nav = document.createElement('div');
        nav.className = 'widget-nav-bar';
        nav.innerHTML = `
            <button class="btn-nav" ${!prev?'disabled':''} onclick="window.navTo('${prev}')">‚¨Ö Anterior</button>
            <span>Paso ${idx+1}/${widgets.length}</span>
            <button class="btn-nav" onclick="window.navTo('${next}')">Siguiente ‚û°</button>
            <button class="btn-nav" onclick="document.exitFullscreen?.();document.querySelectorAll('.widget--zoomed').forEach(z=>z.classList.remove('widget--zoomed'))">Salir</button>
        `;
        el.prepend(nav);
    });
}
window.navTo = (id) => {
    if(!id) return;
    const el = document.getElementById(id);
    el.scrollIntoView({behavior:'smooth'});
    if(el.requestFullscreen) el.requestFullscreen().catch(()=>{ el.classList.add('widget--zoomed'); });
    else el.classList.add('widget--zoomed');
};

// === VOZ ===
document.body.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-mic');
    if(!btn) return;
    const target = document.getElementById(btn.dataset.target);
    if(!target) return;
    
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!Speech) { alert("Navegador no soporta voz"); return; }
    
    const rec = new Speech();
    rec.lang = 'es-ES';
    rec.onstart = () => btn.style.background = 'red';
    rec.onend = () => btn.style.background = '';
    rec.onresult = (ev) => {
        const txt = ev.results[0][0].transcript;
        if(target.tagName==='INPUT' || target.tagName==='TEXTAREA') target.value += " " + txt;
        else target.innerText += " " + txt;
        target.dispatchEvent(new Event('input')); // Disparar guardado
    };
    rec.start();
});

// === GENERAR RESUMEN ===
document.querySelector('.header-controls .btn-primary').addEventListener('click', async ()=>{
    const sup = document.getElementById('briefing-supervisor').value;
    if(!sup) { alert("Falta supervisor"); return; }
    
    const payload = {
        station: STATION_CODE,
        supervisor: sup,
        shift: document.getElementById('shift-badge-header').textContent,
        // ... recopilar resto de datos ...
    };
    
    try {
        await apiFetch('api/briefing/summary', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        alert("Resumen guardado");
        window.openPostBriefingMode();
    } catch(e) { alert("Error al guardar"); }
});

window.openPostBriefingMode = () => document.getElementById('post-briefing-screen').classList.add('active');
window.closePostBriefingMode = () => document.getElementById('post-briefing-screen').classList.remove('active');

// === FULLSCREEN TOGGLE ===
function initFullscreenToggles(){
    document.querySelectorAll('.widget').forEach(w => {
        const btn = document.createElement('div');
        btn.className = 'fs-toggle';
        btn.innerHTML = '‚õ∂';
        btn.onclick = () => {
            if(document.fullscreenElement) document.exitFullscreen();
            else w.requestFullscreen();
        };
        w.appendChild(btn);
    });
}
// === EH&S ===
function initEhsSimple(){
    // Ejemplo de l√≥gica EH&S
    const d = document.getElementById('ehs-days');
    if(d) d.addEventListener('dblclick', ()=>{
        if(confirm("Reiniciar contador accidentes?")) d.textContent = "0";
    });
}
// === 5S ===
function init5S(){
    document.querySelectorAll('.s5-pill').forEach(btn => {
        btn.onclick = () => btn.classList.toggle('on');
    });
}

</script>
</body>
</html>
