<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="UTF-8" />
<title>Factory Floor Dashboard - BCN OPS</title>

<script>
    (function() {
        // 1. Detectar d√≥nde estamos (Ej: /bcn/)
        let path = window.location.pathname;
        if (!path.endsWith('/')) path += '/';
        const BASE_PATH = path; 

        // 2. Arreglar autom√°ticamente las llamadas al servidor (/api -> /bcn/api)
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (typeof url === 'string') {
                // Si el c√≥digo intenta ir a la ra√≠z (/api), lo redirigimos a la carpeta (/bcn/api)
                if (url.startsWith('/api/')) {
                    url = BASE_PATH + url.substring(1); // quita la primera barra
                } else if (url.startsWith('api/')) {
                    url = BASE_PATH + url;
                }
            }
            return originalFetch(url, options);
        };

        // 3. Arreglar el WebSocket autom√°ticamente
        window.ORIGINAL_WS_URL = null;
        const OriginalWebSocket = window.WebSocket;
        window.WebSocket = function(url) {
            // Si intenta conectar a la ra√≠z, lo forzamos a la carpeta
            if (url.includes('/ws') && !url.includes(BASE_PATH)) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                url = `${protocol}//${window.location.host}${BASE_PATH}ws`;
            }
            return new OriginalWebSocket(url);
        };
    })();
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
/* TUS ESTILOS ORIGINALES INTACTOS */
:root{ --ui-scale: 1; }              /* 1 = 100% */
html{ font-size: calc(16px * var(--ui-scale)); }
@media (min-width: 1600px){
:root{ --ui-scale: 1.15; }           /* TVs grandes: sube ligeramente por defecto */
}

:root{
--brand-red-900:#7f1d1d; --brand-red-800:#991b1b; --brand-red-700:#b91c1c;
--brand-red-600:#dc2626; --brand-red-500:#ef4444; --brand-red-400:#f87171;

--bg-page:#f7f8fa;
--bg-card:#ffffff;
--border:#e6e8ec;
--text:#1f2937;
--text-muted:#6b7280;

/* Categor√≠as Kanban (fondo completo) */
--cat-seg:#fee2e2;
--cat-inc:#fff1e6;
--cat-man:#eaf8f0;
--cat-cal:#fce7ff;
--cat-ser:#fef9c3;
}

:focus-visible{
outline:2px solid var(--brand-red-600);
outline-offset:2px;
}


/* Base */
html,body{ background:var(--bg-page); color:var(--text); height:100%; }
body{
margin:0;
font:14px "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
-webkit-text-size-adjust:100%;
}
h1,h2,h3,.widget-title,.column-title .count{
font-family:"Space Grotesk", Inter, system-ui, sans-serif;
letter-spacing:.2px;
}

/* Header */
header{
display:flex;
align-items:center;
justify-content:space-between;
gap:16px;
}
header h1{
margin:0;
color:var(--brand-red-600);
font-weight:700;
font-size: clamp(1.6rem, 1vw + 1rem, 2.2rem);
}
.header-left{ display:flex; flex-direction:column; gap:2px; }
#now-header{
font-size:.95rem;
color:var(--text-muted);
}
.shift-chip{
display:inline-flex; align-items:center; gap:6px;
padding:4px 10px; border:1px solid var(--border);
border-radius:999px; background:#fff;
font-weight:600; font-size:.85rem;
}

/* Turnos colores */
.shift-chip[data-shift="Ma√±ana"]{
background:#ecfdf5; color:#065f46; border-color:#a7f3d0;
}
.shift-chip[data-shift="Tarde"]{
background:#fff7ed; color:#9a3412; border-color:#fed7aa;
}
.shift-chip[data-shift="Noche"]{
background:#eef2ff; color:#3730a3; border-color:#c7d2fe;
}

.header-controls{
display:flex; gap:12px; align-items:center;
}
.header-controls input{
padding:6px 10px;
border:1px solid var(--border);
border-radius:8px;
font-size:.9rem;
background:#fff;
}
.btn-primary{
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff; border:none; border-radius:10px; padding:10px 16px;
box-shadow:0 6px 16px rgba(220,38,38,.25);
transition:.15s transform,.2s box-shadow,.2s filter;
cursor:pointer;
}
.btn-primary:hover{
transform:translateY(-1px);
filter:saturate(110%);
}

.top-bar{
position:sticky;
top:0;
z-index:20;
display:flex;
justify-content:space-between;
align-items:center;
gap:12px;
padding:
8px
max(clamp(12px, 2vw, 28px), env(safe-area-inset-right))
4px
max(clamp(12px, 2vw, 28px), env(safe-area-inset-left));
background:linear-gradient(to bottom, rgba(247,248,250,0.98), rgba(247,248,250,0.92));
backdrop-filter:blur(6px);
}
.top-bar-left{
display:flex;
align-items:center;
gap:6px;
font-size:.78rem;
color:var(--text-muted);
}
.top-bar select{
padding:4px 8px;
border-radius:8px;
border:1px solid var(--border);
font-size:.8rem;
background:#fff;
}
.top-bar-right .btn-primary{
padding:8px 14px;
min-height:36px;
box-shadow:0 4px 12px rgba(220,38,38,.2);
}


/* ======= Layout 3 columnas ======= */
.dashboard-3col{
min-height: 100svh;
display:grid;
grid-template-columns: 320px 1fr 380px;  /* IZQ / CENTRO / DER */
grid-template-rows: auto 1fr;
gap:16px;
padding:
max(clamp(12px, 2vw, 28px), env(safe-area-inset-top))
max(clamp(12px, 2vw, 28px), env(safe-area-inset-right))
max(clamp(12px, 2vw, 28px), env(safe-area-inset-bottom))
max(clamp(12px, 2vw, 28px), env(safe-area-inset-left));
}
header{ grid-column: 1 / -1; }
.col-left, .col-middle, .col-right{
min-height:0;
overflow:auto;
display:flex;
flex-direction:column;
gap:20px;
-webkit-overflow-scrolling:touch;
overscroll-behavior:contain;
}

/* Widgets / tarjetas */
.widget,.card{
background:var(--bg-card);
border:1px solid var(--border);
border-radius:12px;
box-shadow: 0 6px 18px rgba(17,24,39,.06);
padding:16px;
position:relative;
}
.widget-title{
font-size:1.05rem;
font-weight:700;
margin:0 0 12px;
display:flex; align-items:center; justify-content:space-between;
}
.widget-title-icon{ width:16px; height:16px; color:var(--text-muted); }

/* Kanban / Kaizen */
.board-container{ display:grid; gap:12px; }
.board-container.kanban{ grid-template-columns: repeat(4, minmax(0,1fr)); }
.board-container.kaizen{ grid-template-columns: repeat(3, minmax(0,1fr)); }
.board-container.kaizen.compact{ grid-template-columns: repeat(3, minmax(0,1fr)); }

.kanban-column{ display:flex; flex-direction:column; min-width:0; }
.column-title{
display:flex; justify-content:space-between; align-items:baseline;
font-size:.85rem; font-weight:600; color:var(--text-muted);
margin:0 0 6px; padding-bottom:8px; border-bottom:2px solid #e9ecef;
}
.column-title .count{
background:#eef1f4; color:var(--text-muted);
padding:2px 6px; border-radius:6px; font-size:.8rem;
}
.cards-container{
min-height:120px;
max-height: clamp(280px, 48svh, 70vh);
overflow:auto;
padding-top:4px;
-webkit-overflow-scrolling:touch;
overscroll-behavior:contain;
}

.card{
margin-bottom:8px;
padding:10px 12px;
display:flex; align-items:center; justify-content:space-between; gap:10px;
cursor:grab;
}
.card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06); }
.card-content{ flex:1 1 auto; min-width:0; }
.card-title{
font-weight:600; font-size:.95rem; margin:0 0 4px; line-height:1.25;
overflow:hidden; max-height:2.5em;
}
.card-details,.card-assignee{
font-size:.8rem; color:var(--text-muted);
}
.card-assignee{ margin-top:4px; }

.card-actions .icon{ width:14px; height:14px; }
.delete-card-btn{
background:none; border:none; color:#9ca3af;
display:none; cursor:pointer;
}
.card:hover .delete-card-btn{ display:block; }

.sortable-ghost{ opacity:.4; background:#dee2e6; }
.sortable-drag{
opacity:1 !important;
transform:rotate(2deg);
box-shadow:0 8px 24px rgba(0,0,0,.15);
}

/* Asa de arrastre */
/* Asa de arrastre MEJORADA PARA ANDROID */
.drag-handle {
    align-self: stretch;
    display: flex; 
    align-items: center; 
    justify-content: center;
    padding: 12px; 
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--bg-card);
    cursor: grab;
    opacity: .7;
    
    /* ESTA ES LA CLAVE PARA ANDROID: */
    touch-action: none;           /* Evita que Android haga scroll al tocar aqu√≠ */
    -webkit-user-select: none;    /* Evita que se seleccione texto al mantener pulsado */
    user-select: none;
}
.card:active .drag-handle{ cursor:grabbing; opacity:1; }
.drag-handle svg{ width:14px; height:14px; }

/* Chips de categor√≠a */
.cat-chip{
display:inline-block; margin-left:8px; font-size:.7rem; font-weight:700;
padding:2px 6px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
vertical-align:middle; background:rgba(255,255,255,.7);
}

/* KANBAN: fondo por categor√≠a */
#kanban-widget .card.cat-seguridad       { background: var(--cat-seg); }
#kanban-widget .card.cat-incidencias     { background: var(--cat-inc); }
#kanban-widget .card.cat-mantenimiento { background: var(--cat-man); }
#kanban-widget .card.cat-calidad         { background: var(--cat-cal); }
#kanban-widget .card.cat-servicio        { background: var(--cat-ser); }

#kanban-widget .cat-chip{ font-weight:800; }
#kanban-widget .cat-chip.is-seguridad    { background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }
#kanban-widget .cat-chip.is-incidencias { background:#fff1e6; color:#7a3800; border-color:#ffd7b5; }
#kanban-widget .cat-chip.is-mantenimiento{background:#eaf8f0; color:#065f46; border-color:#b7f0d3; }
#kanban-widget .cat-chip.is-calidad      { background:#fce7ff; color:#6b21a8; border-color:#f0abfc; }
#kanban-widget .cat-chip.is-servicio     { background:#fef9c3; color:#854d0e; border-color:#fde68a; }

/* 5S & GW */
.checkbox-item{ display:flex; align-items:center; gap:8px; margin-bottom:8px; font-size:.9rem; }
.gw-task-item{
display:flex; align-items:center; gap:8px;
padding:6px 4px;
font-size:.9rem;
border-bottom:1px solid var(--border);
cursor:pointer;
}
.gw-task-item:last-child{ border-bottom:none; }
.gw-task-item.completed label{
color:var(--text-muted);
text-decoration:line-through;
}
.gw-note{
font-size:.85rem;
width:100%; margin-top:4px;
padding:6px 8px;
border:1px solid var(--border);
border-radius:6px;
}
.gw-note:disabled{
background:#f8f9fa;
color:var(--text-muted);
}
.highlight-gw{ animation: highlight-gw 2s ease-out; }
@keyframes highlight-gw {
from{ background:#dbe4ff; }
to{ background:transparent; }
}

/* 5S compacto */
.s5-compact{
display:flex; gap:6px; flex-wrap:wrap; align-items:center;
}
.s5-pill{
display:inline-flex; align-items:center; gap:6px;
border:1px solid var(--border); background:#fff;
border-radius:999px; padding:6px 10px;
font-size:.8rem; line-height:1;
cursor:pointer; user-select:none;
transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
}
.s5-pill:hover{ transform:translateY(-1px); }
.s5-pill:active{ transform:translateY(0); }
.s5-dot{
width:8px; height:8px; border-radius:50%; background:#d1d5db;
}
.s5-pill.on{
background:linear-gradient(135deg, #ecfdf5, #ffffff);
border-color: rgba(16,185,129,.55);
box-shadow: inset 0 0 0 2px rgba(16,185,129,.08);
}
.s5-pill.on .s5-dot{ background:#10b981; }
@keyframes s5-bump{
0%{transform:scale(1);}
50%{transform:scale(1.05);}
100%{transform:scale(1);}
}
.s5-pill.bump{ animation:s5-bump .18s ease-out; }
#s5-meta{ margin-top:4px; font-size:.78rem; }

/* EHS simple */
#ehs-widget{ display:flex; flex-direction:column; gap:8px; }
#ehs-month{ color:var(--text-muted); font-size:.95rem; }
.ehs-controls{
display:flex; align-items:center; gap:14px;
border:1px solid var(--border); border-radius:12px; padding:8px 10px;
}
.ehs-btn{
width:42px; height:42px; border:none; border-radius:10px; cursor:pointer;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff; font-size:1.3rem; line-height:1;
display:flex; align-items:center; justify-content:center;
}
.ehs-big{
font-size: clamp(2rem, 2.2vw + .8rem, 3rem);
font-weight:800; line-height:1;
color:var(--brand-red-600);
min-width:3ch; text-align:center;
}

/* KPI Costes */
#kpi-costes .kpi-value.large{
font-size: clamp(2.1rem, 2.3vw + 1rem, 3.2rem);
line-height:1; font-weight:700;
}
#kpi-total-cost{
color:var(--brand-red-600); font-weight:800;
}
.kpi-text{
color:var(--text-muted); margin:0; font-size:.9rem;
}
.kpi-currency{
font-size:1rem; font-weight:600;
margin-left:4px; vertical-align:super;
color:var(--brand-red-600);
}
.flash{ animation: flash-kpi 900ms ease-out; }
@keyframes flash-kpi{
from{ background:#fff3cd; }
to{ background:transparent; }
}

/* KPIs grid */
.kpi-grid{
display:grid;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
gap:12px;
}
.kpi-tile{
border:1px solid var(--border);
border-radius:12px;
background:#fff;
padding:14px;
box-shadow:0 6px 18px rgba(17,24,39,.06);
}
.kpi-label{
font-weight:700;
font-size:.9rem;
color:var(--text-muted);
margin-bottom:4px;
}
.kpi-value{
font-family:"Space Grotesk", Inter, system-ui, sans-serif;
font-weight:800;
font-size: clamp(1.6rem, 2.6vw + .4rem, 2.6rem);
line-height:1;
color:var(--brand-red-600);
}

/* Planificaci√≥n / tablas */
.table-scroll{
overflow-x:auto;
max-width:100%;
padding-bottom:8px;
}
#planif-table, #incidentes-table, #incidentes-pdf-table{
width:100%;
border-collapse:collapse;
font-size:.9rem;
}
#planif-table thead th,
#incidentes-table thead th,
#incidentes-pdf-table thead th{
position:sticky; top:0;
background:#fafafa;
border-bottom:1px solid var(--border);
text-align:left;
padding:8px;
z-index:2;
}
#planif-table tbody td,
#incidentes-table tbody td,
#incidentes-pdf-table tbody td{
padding:8px;
border-bottom:1px solid var(--border);
white-space:nowrap;
}

/* Fullscreen helpers */
.fs-toggle{
position:absolute; top:10px; right:10px;
border:1px solid var(--border);
background:rgba(255,255,255,.95);
border-radius:12px;
padding:10px;
cursor:pointer; line-height:0; opacity:.8;
display:inline-flex; align-items:center; justify-content:center;
transition: opacity .15s, transform .15s, box-shadow .15s;
box-shadow:0 4px 12px rgba(0,0,0,.10);
min-width:44px; min-height:44px;
}
.fs-toggle:hover{ opacity:1; transform:scale(1.06); }
.fs-toggle svg{ width:18px; height:18px; display:block; }

.widget:fullscreen, .card:fullscreen{
background:#fff; border-radius:0; box-shadow:none; padding:24px;
}
:fullscreen{ overflow:auto; }
html.fs-zoom{ font-size:18px; }
@media (min-width:1280px){ html.fs-zoom{ font-size:20px; } }

/* Spotlight checklist */
#brief-check{
position: sticky;
top: 0;
z-index: 5;
border: 2px solid rgba(239,68,68,.45);
box-shadow:
0 14px 36px rgba(239,68,68,.18),
0 2px 0 rgba(255,255,255,.9) inset;
background:
radial-gradient(1200px 200px at 50% -60px, rgba(239,68,68,.06), transparent),
#fff;
animation: brief-pop .25s ease-out;
backdrop-filter: saturate(105%) blur(2px);
}
#brief-check .widget-title{
font-size: 1.25rem;
color: var(--brand-red-700);
}
#brief-check .check-grid{
display:grid; gap:8px;
grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}
#brief-check .check-card{
display:flex; flex-direction:column;
align-items:flex-start; gap:10px;
padding:14px 16px;
min-height:96px;
border:1px solid var(--border);
box-shadow:0 6px 16px rgba(17,24,39,.06);
}
.check-title{
font-weight:600;
font-size:.95rem;
line-height:1.25;
word-break:break-word;
}
.check-actions{
width:100%;
display:flex; flex-wrap:wrap;
gap:8px;
}
.check-actions label{
padding:6px 12px;
border-radius:999px;
font-size:.78rem;
border:1px solid var(--border);
cursor:pointer;
}
.check-actions input{ display:none; }
.check-actions input:checked + label{
background:#ecfdf5;
border-color:rgba(16,185,129,.6);
box-shadow: inset 0 0 0 2px rgba(16,185,129,.08);
}
#brief-check .shift-chip{
margin:6px auto 10px;
}

/* Caja explicaci√≥n */
#brief-check .br-explain{
display:flex; align-items:center; gap:8px;
margin: 8px 0 12px;
padding: 10px 12px;
background:#fff;
color: var(--brand-red-700);
border: 2px solid var(--brand-red-600);
border-radius: 12px;
box-shadow: 0 6px 16px rgba(239,68,68,.12);
font-size: .95rem;
line-height: 1.35;
min-height: 44px;
}
#brief-check .br-explain-ico{
display:inline-flex; align-items:center; justify-content:center;
width: 26px; height: 26px; border-radius: 999px;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff;
box-shadow: 0 4px 10px rgba(239,68,68,.25);
}
#brief-check .br-explain-label{
font-weight: 800; letter-spacing:.2px;
}
#brief-check .br-explain-text{
font-weight: 600;
}

/* Spotlight parpadeo */
.spotlight-blink{
position: relative;
border-color: rgba(239,68,68,.6) !important;
box-shadow:
0 0 0 3px rgba(239,68,68,.20),
0 14px 36px rgba(239,68,68,.12);
animation: blink-glow 1.2s ease-in-out infinite;
}
@keyframes blink-glow{
0%,100%{
box-shadow:
0 0 0 2px rgba(239,68,68,.18),
0 8px 22px rgba(239,68,68,.10);
transform: scale(1);
}
50%{
box-shadow:
0 0 0 5px rgba(239,68,68,.28),
0 18px 44px rgba(239,68,68,.18);
transform: scale(1.01);
}
}

/* Incidentes BCN */
#incidentes-widget .incident-remember{
margin:6px 0 8px;
padding:10px 12px;
background:#fff !important;
color: var(--brand-red-700) !important;
border: 2px solid var(--brand-red-600) !important;
border-radius: 12px;
box-shadow:none !important;
font-weight:800;
letter-spacing:.2px;
}
#incidentes-widget .title-bullets{
list-style:none; margin:0 0 10px; padding:0;
display:flex; gap:8px; align-items:center; flex-wrap:wrap;
}
#incidentes-widget .title-chip{
display:inline-flex; align-items:center;
padding:6px 12px;
border-radius:999px;
font-size:.8rem; font-weight:700;
background:#fff !important;
color:var(--brand-red-700) !important;
border:2px solid var(--brand-red-600) !important;
box-shadow:none !important;
}
#incidentes-widget .title-chip:hover{
box-shadow:0 0 0 3px rgba(239,68,68,.12);
}

/* Equipo / presencia */
.presence-toggle{
display:inline-flex; align-items:center;
border:1px solid var(--border);
border-radius:10px;
overflow:hidden;
background:#fff;
}
.presence-toggle input{ display:none; }
.presence-toggle label{
padding:6px 10px;
font-size:.82rem; font-weight:700;
cursor:pointer; user-select:none;
display:inline-flex; align-items:center; gap:6px;
}
.presence-toggle label + input + label{
border-left:1px solid var(--border);
}
.presence-toggle .yes{ color:#166534; }
.presence-toggle .no { color:#991b1b; }
.presence-toggle input[value="yes"]:checked + label.yes{
background:#e3f9e5; box-shadow: inset 0 0 0 2px rgba(16,185,129,.12);
}
.presence-toggle input[value="no"]:checked + label.no{
background:#ffe3e3; box-shadow: inset 0 0 0 2px rgba(239,68,68,.12);
}
.team-right .zone-select{
padding:6px 10px; border:1px solid var(--border);
border-radius:8px; background:#fff; font-size:.85rem;
}
.chip-zone{
display:inline-block; margin-left:6px; padding:2px 8px;
border-radius:999px; font-size:.72rem; font-weight:700;
color:#3730a3; background:#eef2ff; border:1px solid #c7d2fe;
}

/* Split Kaizen + 5S/GW */
.actions-split{
display:grid;
grid-template-columns: 1.2fr 1fr;
gap:20px;
align-items:start;
}
@media (max-width:1100px){
.actions-split{ grid-template-columns:1fr; }
}

/* Responsive layout ajustes */
@media (min-width:980px) and (max-width:1280px){
.dashboard-3col{
grid-template-columns:
clamp(260px, 28vw, 320px)
minmax(0, 1fr);
grid-template-rows:auto 1fr auto;
gap:16px;
}
.col-left{ order:1; grid-column:1; }
.col-middle{ order:2; grid-column:2; }
.col-right{
order:3; grid-column:1 / -1;
display:grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap:16px;
}
}

@media (max-width:960px){
.dashboard-3col{
grid-template-columns:1fr;
grid-template-rows:auto auto auto auto;
}
.col-left,.col-right{ order:2; }
.col-middle{ order:1; }
#brief-check{
position:static !important;
max-height:none !important;
overflow:visible !important;
}
#brief-check .check-grid{
grid-template-columns:1fr;
}
}

/* iOS: evita zoom en inputs */
@supports (-webkit-touch-callout: none) {
input, select, textarea {
font-size:16px !important;
}
}

/* T√°ctil */
* { -webkit-tap-highlight-color: rgba(0,0,0,0); }
button, .btn, .s5-pill, .ehs-btn, .presence-toggle label {
touch-action: manipulation;
min-height:44px;
}

/* Accesibilidad / motion */
@media (prefers-reduced-motion: reduce){
* { animation:none !important; transition:none !important; }
}

.widget--zoomed{
position:fixed;
inset: max(env(safe-area-inset-top), 8px)
max(env(safe-area-inset-right), 8px)
max(env(safe-area-inset-bottom), 8px)
max(env(safe-area-inset-left), 8px);
z-index:40;
background:#ffffff;
border-radius:16px;
box-shadow:0 18px 60px rgba(15,23,42,.32);
overflow:auto;
}
.widget--zoomed .fs-toggle{
z-index:41;
}

/* Placeholders para contenteditable */
[contenteditable][data-placeholder]:empty:before {
content: attr(data-placeholder);
color: var(--text-muted);
pointer-events: none;
}

/* Campos editables de incidentes */
#incidentes-widget .incident-input,
#incidentes-widget #incident-remember {
min-height: 84px;
padding: 10px 12px;
border: 1px solid var(--border);
border-radius: 10px;
background: #fff;
line-height: 1.4;
box-shadow: 0 6px 16px rgba(17,24,39,.04);
outline: none;
}
#incidentes-widget .incident-field {
display: grid;
gap: 6px;
margin: 10px 0 12px;
}
#incidentes-widget .incident-field label {
font-weight: 700;
font-size: .9rem;
color: var(--text-muted);
}

/* Tarjetas editables de Incidentes */
#incidentes-widget .incident-card-grid{
display:grid;
grid-template-columns: repeat(3, minmax(220px, 1fr));
gap:12px;
margin:10px 0 4px;
}
@media (max-width:1100px){
#incidentes-widget .incident-card-grid{
grid-template-columns: 1fr;
}
}
#incidentes-widget .incident-card{
background:#fff;
border:1px solid var(--border);
border-radius:12px;
box-shadow:0 6px 16px rgba(17,24,39,.06);
padding:12px;
display:flex;
flex-direction:column;
gap:8px;
}
#incidentes-widget .incident-card-title{
font-weight:800;
font-size:.95rem;
color:var(--brand-red-700);
display:flex; align-items:center; gap:8px;
}
#incidentes-widget .incident-card-body{
min-height:84px;
padding:10px 12px;
border:1px solid var(--border);
border-radius:10px;
background:#fff;
line-height:1.4;
outline:none;
}
#incidentes-widget .incident-card-body:focus{
border-color: var(--brand-red-500);
box-shadow: 0 0 0 3px rgba(239,68,68,.12);
}
/* Placeholder para contenteditable */
[contenteditable][data-placeholder]:empty:before{
content: attr(data-placeholder);
color: var(--text-muted);
pointer-events:none;
}

/* === Actualizaciones operativas === */
#ops-updates-widget .ops-actions{
display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;
}
#ops-updates-widget .ops-actions .btn{
border:1px solid var(--border); background:#fff; border-radius:10px;
padding:8px 12px; cursor:pointer; font-weight:700; font-size:.85rem;
}
#ops-updates-widget .ops-grid{
display:grid; gap:12px;
grid-template-columns: 1fr 1fr;
}
@media (max-width:1100px){
#ops-updates-widget .ops-grid{ grid-template-columns: 1fr; }
}

/* Tarjeta tipo secciones (reusa est√©tica de incidentes) */
#ops-updates-widget .ops-card{
background:#fff; border:1px solid var(--border); border-radius:12px;
box-shadow:0 6px 16px rgba(17,24,39,.06); padding:12px; display:flex; flex-direction:column; gap:10px;
}
#ops-updates-widget .ops-section{
border:1px solid var(--border); border-radius:10px; background:#fff; padding:10px; display:grid; gap:8px;
}
#ops-updates-widget .ops-section-title{
font-weight:800; color:var(--brand-red-700);
border:1px solid var(--border); border-radius:8px; padding:8px; outline:none;
}
#ops-updates-widget .ops-section-body{
min-height:84px; line-height:1.4; outline:none;
border:1px solid var(--border); border-radius:8px; padding:10px 12px; background:#fff;
}
/* Lista r√°pida por l√≠neas */
#ops-updates-widget .ops-quicklines{
min-height:120px; line-height:1.45; outline:none;
border:1px solid var(--border); border-radius:10px; padding:12px; background:#fff;
}

/* Placeholder contenteditable */
#ops-updates-widget [contenteditable][data-placeholder]:empty:before{
content: attr(data-placeholder);
color: var(--text-muted);
pointer-events:none;
}

/* === Seguridad y protecci√≥n (diario + manual) === */
#safety-daily-widget .safety-grid{
display:grid; gap:12px;
grid-template-columns: 1fr 1fr;
}
@media (max-width:1100px){
#safety-daily-widget .safety-grid{ grid-template-columns: 1fr; }
}
#safety-daily-widget .safety-card{
background:#fff; border:1px solid var(--border); border-radius:12px;
box-shadow:0 6px 16px rgba(17,24,39,.06); padding:12px; display:flex; flex-direction:column; gap:10px;
}
#safety-daily-widget .tips{
display:flex; flex-direction:column; gap:8px;
}
#safety-daily-widget .tip{
border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff;
font-weight:600; line-height:1.35;
}
#safety-daily-widget .controls{ display:flex; gap:8px; flex-wrap:wrap; }
#safety-daily-widget .btn{
border:1px solid var(--border); background:#fff; border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700; font-size:.85rem;
}

#safety-daily-widget .incident-form{
display:grid; gap:8px; grid-template-columns: 1fr;
}
#safety-daily-widget .incident-form input,
#safety-daily-widget .incident-form textarea{
padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:.95rem;
}
#safety-daily-widget .incident-list{
display:flex; flex-direction:column; gap:8px; margin-top:6px;
}
#safety-daily-widget .incident-item{
border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff;
}
#safety-daily-widget .incident-head{
display:flex; justify-content:space-between; align-items:center; gap:8px; font-weight:700;
}
#safety-daily-widget .incident-meta{ color:var(--text-muted); font-size:.85rem; }
#safety-daily-widget .danger{ color:#991b1b; cursor:pointer; }
/* === Actualizaciones operativas === */
#ops-updates-widget .ops-form{
display:grid; gap:8px; grid-template-columns: 1fr 1fr auto;
}
#ops-updates-widget .ops-form input,
#ops-updates-widget .ops-form select{
padding:10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:.95rem;
}
#ops-updates-widget .ops-form .wide{ grid-column: 1 / -1; }
#ops-updates-widget .ops-list{
display:flex; flex-direction:column; gap:10px; margin-top:10px;
}
.ops-item{
border:1px solid var(--border);
border-left:6px solid var(--brand-red-500);
border-radius:12px; background:#fff;
box-shadow:0 6px 16px rgba(17,24,39,.06);
padding:10px 12px;
}
.ops-head{
display:flex; justify-content:space-between; align-items:center; gap:8px;
}
.ops-title{ font-weight:800; }
.ops-meta{ color:var(--text-muted); font-size:.82rem; display:flex; gap:10px; flex-wrap:wrap; }
.ops-badge{
display:inline-block; padding:2px 8px; border-radius:999px; font-size:.72rem; font-weight:800;
background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
}
.ops-body{ margin-top:6px; line-height:1.35; }
.ops-actions{ display:flex; gap:8px; margin-top:8px; }
.ops-btn{
border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:700; font-size:.85rem;
}

/* Colores por prioridad */
.ops-item[data-priority="Alta"]    { border-left-color:#ef4444; }
.ops-item[data-priority="Media"]   { border-left-color:#f59e0b; }
.ops-item[data-priority="Baja"]    { border-left-color:#10b981; }

/* Animaci√≥n al crear */
@keyframes ops-pop {
0% { transform: translateY(-4px); box-shadow:0 0 0 rgba(0,0,0,0); }
100% { transform: translateY(0);   box-shadow:0 6px 16px rgba(17,24,39,.10); }
}
.ops-item.highlight-new{
animation: ops-pop .25s ease-out, blink-glow 1.1s ease-in-out 1;
}

/* --- OPS: Toolbar, filtros y tarjetas de l√≠neas --- */
#ops-updates-widget .ops-toolbar{
display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 4px;
}
#ops-updates-widget .ops-search{
flex:1; min-width:200px; padding:8px 10px; border:1px solid var(--border);
border-radius:10px; background:#fff; font-size:.9rem;
}
#ops-updates-widget .ops-filter{ padding:8px 10px; border:1px solid var(--border);
border-radius:10px; background:#fff; font-size:.85rem;
}

#ops-lines-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.ops-line-card{
border:1px solid var(--border); border-left:6px solid var(--brand-red-500);
border-radius:12px; background:#fff; box-shadow:0 6px 16px rgba(17,24,39,.06);
padding:10px 12px;
}
.ops-line-card[aria-selected="true"]{ box-shadow:0 0 0 3px rgba(239,68,68,.12); }
.ops-line-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
.ops-line-title{ font-weight:800; }
.ops-line-meta{ color:var(--text-muted); font-size:.82rem; display:flex; gap:10px; flex-wrap:wrap; }
.ops-badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.72rem; font-weight:800;
background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
}
.ops-badge.prio-high{ background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }
.ops-badge.prio-med { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
.ops-badge.prio-low { background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }

.ops-line-actions{ display:flex; gap:8px; margin-top:8px; }
.ops-line-btn{
border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px;
cursor:pointer; font-weight:700; font-size:.85rem;
}

.ops-line-card[data-priority="Alta"]   { border-left-color:#ef4444; }
.ops-line-card[data-priority="Media"] { border-left-color:#f59e0b; }
.ops-line-card[data-priority="Baja"]   { border-left-color:#10b981; }

.ops-line-card.is-archived{
opacity:.65; background:#fafafa; border-style:dashed;
}

/* Foco y animaci√≥n alta */
@keyframes ops-pop2 { 0%{transform:translateY(-2px);} 100%{transform:translateY(0);} }
.ops-line-card.highlight-new{ animation: ops-pop2 .2s ease-out, blink-glow 1.1s ease-in-out 1; }

/* ===== Fixes & Polish ===== */

/* Bot√≥n compacto usado en Kanban/Ops */
.btn-compact{
border:1px solid var(--border);
background:#fff;
border-radius:10px;
padding:6px 10px;
font-weight:700;
font-size:.82rem;
cursor:pointer;
transition:transform .1s, box-shadow .15s, border-color .15s;
}
.btn-compact:hover{ transform:translateY(-1px); box-shadow:0 4px 12px rgba(17,24,39,.08); }
.btn-compact:focus-visible{ outline:2px solid var(--brand-red-500); outline-offset:2px; }

/* Cron√≥metro header (faltaban estilos) */
.header-timer{
display:flex; align-items:center; gap:10px;
border:1px solid var(--border); border-radius:12px; background:#fff; padding:8px 10px;
}
.timer-face{ position:relative; display:flex; align-items:center; gap:8px; }
/* CRON√ìMETRO GRANDE Y ALERTA */
.header-timer .timer-display {
    /* Tama√±o aumentado significativamente */
    font-size: clamp(3rem, 5vw, 6rem); 
    font-family: "Space Grotesk", sans-serif;
    font-weight: 800;
    line-height: 1;
    color: var(--brand-red-900);
    font-variant-numeric: tabular-nums;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s, transform 0.2s;
    text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
}

/* Clase de alerta (rojo parpadeante) */
.timer-display.alert-mode {
    color: #dc2626 !important; /* Rojo intenso */
    animation: timer-pulse 1s infinite;
}

@keyframes timer-pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; text-shadow: 0 0 10px rgba(220, 38, 38, 0.4); }
    100% { transform: scale(1); opacity: 1; }
}
.timer-dot{
width:8px; height:8px; border-radius:50%; background:#d1d5db;
transition: background .2s;
}
.timer-reset{
border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px;
font-weight:700; font-size:.82rem; cursor:pointer;
}
.timer-running .timer-dot{ background:var(--brand-red-500); }

/* Scrollbar suave (Chromium/Edge/Firefox) */
*{ scrollbar-width:thin; scrollbar-color:#cbd5e1 transparent; }
*::-webkit-scrollbar{ height:8px; width:8px; }
*::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:10px; }
*::-webkit-scrollbar-track{ background:transparent; }

/* Snap en columnas para listas largas */
.cards-container{ scroll-snap-type:y proximity; }
.card{ scroll-snap-align:start; }

/* Kanban: refuerzo de contraste por categor√≠a (borde izq.) */
#kanban-widget .card.cat-seguridad       { border-left:6px solid #ef4444; }
#kanban-widget .card.cat-incidencias     { border-left:6px solid #f59e0b; }
#kanban-widget .card.cat-mantenimiento { border-left:6px solid #10b981; }
#kanban-widget .card.cat-calidad         { border-left:6px solid #a855f7; }
#kanban-widget .card.cat-servicio        { border-left:6px solid #eab308; }

/* P√≠ldora de categor√≠a coherente (por si no hay chip en t√≠tulo) */
#kanban-widget .card .cat-chip{ background:#fff; border-color:#e5e7eb; }
#kanban-widget .card.cat-seguridad  .cat-chip{ background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }
#kanban-widget .card.cat-incidencias .cat-chip{ background:#fff1e6; color:#7a3800; border-color:#ffd7b5; }
#kanban-widget .card.cat-mantenimiento .cat-chip{ background:#eaf8f0; color:#065f46; border-color:#b7f0d3; }
#kanban-widget .card.cat-calidad .cat-chip{ background:#fce7ff; color:#6b21a8; border-color:#f0abfc; }
#kanban-widget .card.cat-servicio .cat-chip{ background:#fef9c3; color:#854d0e; border-color:#fde68a; }

/* Top-bar sombra sutil al hacer scroll */
.top-bar{ box-shadow:0 1px 0 rgba(0,0,0,.04); }
@supports(selector(:has(*))){
.top-bar:has(+ .dashboard-3col .col-middle:where(:not(:hover))) { box-shadow:0 1px 0 rgba(0,0,0,.06); }
}

/* Imprimir: oculta cromo y deja contenido clave limpio */
@media print{
.top-bar, .fs-toggle, #present-btn, .new-item-form, .ops-toolbar, .ops-actions { display:none !important; }
body{ background:white !important; }
.widget, .kpi-tile{ break-inside:avoid; box-shadow:none; border-color:#ddd; }
}

/* Dark mode manteniendo la marca */
@media (prefers-color-scheme: dark){
:root{
--bg-page:#0f172a; --bg-card:#0b1220; --border:#1f2937; --text:#e5e7eb; --text-muted:#94a3b8;
}
.btn-primary{ box-shadow:0 6px 16px rgba(239,68,68,.25); }
.kpi-tile, .widget, .card{ box-shadow:0 6px 18px rgba(0,0,0,.35); }
.presence-toggle{ background:#0b1220; }
.table-scroll thead th{ background:#0f172a; }
.fs-toggle{ background:rgba(15,23,42,.85); }
}

/* Placeholders contenteditable (unificados) */
[contenteditable][data-placeholder]:empty:before{
content: attr(data-placeholder);
color: var(--text-muted);
pointer-events: none;
}
/* === Navegaci√≥n Guiada en Widgets === */
.widget-nav-bar {
    display: none;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border);
    margin: -16px -16px 16px -16px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.widget:fullscreen .widget-nav-bar,
.widget.widget--zoomed .widget-nav-bar { display: flex; }

.nav-group { display: flex; gap: 10px; align-items: center; }

.btn-nav {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #d1d5db;
    background: #f8fafc;
    color: #334155;
}
.btn-nav:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.btn-nav:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.btn-nav.home { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
.btn-nav.next-ok { background: #dcfce7; color: #166534; border-color: #86efac; }
.btn-nav.next-ok:hover { background: #bbf7d0; }

/* === PANTALLA MODO INFO (POST-BRIEFING) === */
#post-briefing-screen {
    display: none; position: fixed; inset: 0;
    background-color: #f8fafc; z-index: 99999;
    padding: 20px; flex-direction: column;
}
#post-briefing-screen.active { display: flex; }

.pb-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;
}
.pb-title { font-size: 1.8rem; font-weight: 800; color: var(--brand-red-700); font-family: "Space Grotesk", sans-serif; }
.pb-close-btn {
    background: #334155; color: white; border: none; padding: 10px 20px;
    border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;
}
.pb-grid {
    display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
    gap: 20px; flex: 1; overflow: hidden;
}
.pb-card {
    background: white; border: 1px solid #cbd5e1; border-radius: 16px;
    padding: 20px; display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}
.pb-card-title {
    font-size: 1.4rem; font-weight: 700; color: #475569; margin-bottom: 15px;
    border-bottom: 4px solid var(--brand-red-500); padding-bottom: 5px; width: fit-content;
}
.pb-content { flex: 1; overflow-y: auto; font-size: 1.1rem; line-height: 1.6; }
.pb-content ul { padding-left: 20px; margin: 0; }
.pb-kpi-box { display: flex; justify-content: space-around; align-items: center; height: 100%; }
.pb-kpi-item { text-align: center; padding: 20px; background: #f1f5f9; border-radius: 12px; min-width: 150px; }
.pb-kpi-val { font-size: 3rem; font-weight: 800; color: var(--brand-red-600); display: block; }

@media (max-width: 1000px) {
    .pb-grid { grid-template-columns: 1fr; grid-template-rows: auto; overflow-y: auto; }
    #post-briefing-screen { overflow-y: auto; }
}

/* Asa de arrastre MEJORADA PARA T√ÅCTIL */
.drag-handle{
    align-self:stretch;
    display:flex; align-items:center; justify-content:center;
    padding: 12px; /* AUMENTADO de 6px a 12px para dedos gordos */
    border:1px solid var(--border);
    border-radius:10px;
    background:var(--bg-card);
    cursor:grab;
    opacity:.7;
    
    /* ESTA ES LA CLAVE PARA ANDROID/IOS: */
    touch-action: none; /* Evita que el navegador intente hacer scroll al tocar aqu√≠ */
    -webkit-user-select: none;
    user-select: none;
}
.card:active .drag-handle{ cursor:grabbing; opacity:1; background: #f3f4f6; }
.drag-handle svg{ width:20px; height:20px; } /* Icono un poco m√°s grande */
/* Tarjetas OPS con Ribbon Lateral */
.ops-card-item {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 16px 16px 20px; /* Espacio para el ribbon */
    position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.ops-card-item::before {
    content: "";
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 6px;
}

/* Colores por prioridad */
.ops-card-item[data-prio="Alta"]::before  { background: #ef4444; }
.ops-card-item[data-prio="Media"]::before { background: #f59e0b; }
.ops-card-item[data-prio="Baja"]::before  { background: #10b981; }

.ops-card-title { font-weight: 800; font-size: 1rem; color: #1e293b; line-height: 1.3; }
.ops-card-meta { display: flex; gap: 10px; align-items: center; font-size: 0.75rem; color: #64748b; font-weight: 600; }
.ops-card-badge { padding: 2px 8px; border-radius: 6px; background: #eef2ff; color: #3730a3; text-transform: uppercase; }

.ops-card-actions { 
    margin-top: auto; 
    display: flex; 
    gap: 8px; 
    padding-top: 10px; 
    border-top: 1px solid #f1f5f9; 
}
</style>
    <!-- Importar la librer√≠a de gr√°ficos Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="top-bar" role="banner">
<div class="top-bar-left">
<label for="scale-select" class="top-label">Escala</label>
<select id="scale-select" aria-label="Escala UI">
<option value="1">100%</option>
<option value="1.15" selected>115%</option>
<option value="1.3">130%</option>
<option value="1.5">150%</option>
</select>
</div>
<div class="top-bar-right">
<button id="present-btn" class="btn-primary" type="button" title="Pantalla completa">
Modo presentaci√≥n
</button>
</div>
</div>


<div class="dashboard-3col">
<header>
<div class="header-left">
<h1>Factory Floor Dashboard - BCN OPS</h1>
<div id="now-header">‚Äî</div>
<span id="shift-badge-header" class="shift-chip">‚Äî</span>
</div>

<div class="header-timer" id="timer-widget" aria-label="Cron√≥metro">
<div class="timer-face" id="timer-face">
<div class="timer-display" id="timer-display" title="Toca para iniciar/pausar">00:00:00</div>
<span class="timer-dot" aria-hidden="true"></span>
</div>
<button type="button" class="timer-reset" id="timer-reset">Reiniciar</button>
<!-- Bot√≥n de soporte en el Header -->
<button onclick="openSupportModal()" style="border:none; background:none; color:#64748b; cursor:pointer; font-size:0.8rem; text-decoration:underline; margin-top:10px;">
    üîß Reportar fallo en el Dashboard
</button>
<dialog id="support-modal" style="border:none; border-radius:12px; padding:20px; width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
    <div id="support-form">
        <h3 style="margin-top:0; font-family: 'Space Grotesk', sans-serif;">Soporte T√©cnico Dashboard</h3>
        <label style="font-size:0.8rem; font-weight:700;">¬øQu√© falla?</label>
        <select id="issue-type" style="width:100%; padding:8px; margin:8px 0 15px; border-radius:6px; border:1px solid #ddd; font-family: inherit;">
            <option>No carga el personal (Roster)</option>
            <option>Los KPIs no se actualizan</option>
            <option>Error al guardar resumen</option>
            <option>Error en los datos de Fiix</option>
            <option>Otro problema t√©cnico</option>
        </select>
        
        <label style="font-size:0.8rem; font-weight:700;">Describe el error:</label>
        <textarea id="issue-details" placeholder="Ej: Los costes de Fiix salen en 0..." style="width:100%; height:80px; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #ddd; font-family: inherit; resize: none;"></textarea>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="document.getElementById('support-modal').close()" style="flex:1; border:none; padding:10px; border-radius:6px; cursor:pointer; background: #f1f5f9; font-weight: 700;">Cancelar</button>
            <button onclick="sendDashboardIssue()" id="btn-submit-support" style="flex:1; border:none; padding:10px; border-radius:6px; cursor:pointer; background:#334155; color:white; font-weight:700;">AVISAR A SOPORTE</button>
        </div>
    </div>

    <!-- Pantalla de confirmaci√≥n (Se activa tras el env√≠o) -->
    <div id="support-thanks" style="display:none; text-align:center; padding: 10px 0;">
        <div style="font-size:3rem; margin-bottom: 10px;">üõ†Ô∏è</div>
        <h3 style="color:#334155; margin-bottom: 5px;">Aviso Recibido</h3>
        <p style="font-size:0.9rem; line-height:1.4; color: #475569;">
            Se ha notificado al equipo t√©cnico sobre el fallo en:<br>
            <strong id="display-station-name" style="color: #1e293b;">‚Äî</strong>
        </p>
        <p style="color:#64748b; font-size:0.8rem; background: #f8fafc; padding: 10px; border-radius: 8px;">
            <strong>No es necesario enviar correos ni tickets adicionales.</strong>
        </p>
        <button onclick="document.getElementById('support-modal').close()" class="btn-primary" style="width:100%; margin-top:15px;">Entendido</button>
    </div>
</dialog>
</div>

<div class="header-controls">
    <input type="text" id="briefing-supervisor" placeholder="Nombre Supervisor" 
           style="padding: 8px 12px; border: 1px solid #e6e8ec; border-radius: 8px; font-size: 0.9rem; min-width: 200px;">
     <button type="button" class="btn-mic" data-target="briefing-supervisor" title="Dictar nombre">
        üéôÔ∏è
    </button>


<button class="btn-primary" type="button">Generar Resumen</button>
</div>
</header>

<section class="col-left">
<div class="widget" id="team-widget">
<h2 class="widget-title">1) Equipo / Turno BCN</h2>
<small class="kpi-text" id="team-meta">‚Äî</small>

<form id="team-form" class="team-form" autocomplete="off"
style="display:flex; gap:8px; align-items:center; margin:8px 0;">
<input type="text" id="team-name" placeholder="A√±adir persona‚Ä¶" required
style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;"/>
<button type="submit" class="btn-primary" style="padding:8px 12px;">+</button>
</form>

<form id="roster-upload-form"
style="display:flex; gap:8px; align-items:center; margin:8px 0;">
<input type="file" id="roster-file" accept=".xlsx,.xls" required
style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;">
<button class="btn-primary" type="submit">Subir Excel</button>
</form>
<small id="roster-upload-result" class="kpi-text">‚Äî</small>

<div id="team-list"
class="team-list"
style="display:flex; flex-direction:column; gap:6px;"></div>
</div>
</section>

<section class="col-middle">
<div class="widget" id="brief-check">
<div id="brief-check-explain" class="br-explain" aria-live="polite">
<span class="br-explain-ico" aria-hidden="true">
<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
<path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
</svg>
</span>
<strong class="br-explain-label">Gu√≠a</strong>
<span class="br-explain-text">Pasa el rat√≥n o toca cada punto para ver qu√© revisar.</span>
</div>

<h2 class="widget-title"><span>Checklist</span></h2>
<span id="shift-badge" class="shift-chip">‚Äî</span>

<div class="check-grid">
<div class="check-card" tabindex="0"
data-help="Revisa incidencias y puntos clave del turno anterior (BCN)."
data-target="prev-shift-widget">
<span class="check-title">1) Highlights del turno anterior</span>
<div class="check-actions" role="group" aria-label="Bloque 1">
<input id="c1ok" type="radio" name="c1" value="OK"><label for="c1ok">OK</label>
<input id="c1no" type="radio" name="c1" value="NO"><label for="c1no">NO</label>
</div>
</div>

<div class="check-card" tabindex="0"
data-help="Revisar objetivos y carga de trabajo, cambios en los procedimientos y actualizaciones en equipos"
data-target="ops-updates-widget">
<span class="check-title">2) Actualizaciones operativas</span>
<div class="check-actions" role="group" aria-label="Bloque 2">
<input id="c2ok" type="radio" name="c2" value="OK"><label for="c2ok">OK</label>
<input id="c2no" type="radio" name="c2" value="NO"><label for="c2no">NO</label>

</div>
</div>

<div class="check-card" tabindex="0"
data-help="Dotaci√≥n, ausencias y zonas BCN."
data-target="team-widget">
<span class="check-title">3) Dotaci√≥n y recursos</span>
<div class="check-actions" role="group" aria-label="Bloque 3">
<input id="c3ok" type="radio" name="c3" value="OK"><label for="c3ok">OK</label>
<input id="c3no" type="radio" name="c3" value="NO"><label for="c3no">NO</label>

</div>
</div>

<div class="check-card" tabindex="0"
data-help="Seguridad: EPIs, accesos, consignas espec√≠ficas BCN."
data-target="safety-daily-widget">
<span class="check-title">4) Seguridad y protecci√≥n</span>
<div class="check-actions" role="group" aria-label="Bloque 4">
<input id="c4ok" type="radio" name="c4" value="OK"><label for="c4ok">OK</label>
<input id="c4no" type="radio" name="c4" value="NO"><label for="c4no">NO</label>

</div>
</div>

<div class="check-card" tabindex="0"
data-help="Procedimiento de incidentes / PULSE / Enablon."
data-target="incidentes-widget">
<span class="check-title">5) Preparaci√≥n/reportes incidentes</span>
<div class="check-actions" role="group" aria-label="Bloque 5">
<input id="c5ok" type="radio" name="c5" value="OK"><label for="c5ok">OK</label>
<input id="c5no" type="radio" name="c5" value="NO"><label for="c5no">NO</label>

</div>
</div>

<div class="check-card" tabindex="0"
data-help="KPIs BCN: flujos, mantenimiento, servicio."
data-target="kpi-center">
<span class="check-title">6) Revisi√≥n KPIs BCN</span>
<div class="check-actions" role="group" aria-label="Bloque 6">
<input id="c6ok" type="radio" name="c6" value="OK"><label for="c6ok">OK</label>
<input id="c6no" type="radio" name="c6" value="NO"><label for="c6no">NO</label>

</div>
</div>

<div class="check-card" tabindex="0"
data-help="Feedback del equipo BCN ‚Üí acciones Kanban r√°pida."
data-target="kanban-widget">
<span class="check-title">7) Feedback ‚Üí Acciones</span>
<div class="check-actions" role="group" aria-label="Bloque 7">
<input id="c7ok" type="radio" name="c7" value="OK"><label for="c7ok">OK</label>
<input id="c7no" type="radio" name="c7" value="NO"><label for="c7no">NO</label>

</div>
</div>
</div>

<small class="kpi-text" id="brief-check-meta">‚Äî</small>
</div>

<div class="widget vivid" id="ops-updates-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">üöß</span><span>2) Actualizaciones Operativas</span>
    <span class="hero-badge">VIVO</span>
  </h2>

  <!-- Toolbar de Filtros y Acci√≥n -->
  <div class="ops-toolbar" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:15px;">
    <input id="ops-q" type="search" placeholder="Buscar actualizaci√≥n..." 
           style="flex:1; min-width:200px; padding:10px; border:1px solid var(--border); border-radius:10px;">
    
    <select id="ops-filter-prio-select" style="padding:10px; border-radius:10px; border:1px solid var(--border); background:#fff;">
      <option value="">Todas las prioridades</option>
      <option value="Alta">Alta (!!)</option>
      <option value="Media">Media (!)</option>
      <option value="Baja">Baja</option>
    </select>

    <button type="button" class="btn-primary" id="ops-btn-new" style="padding:10px 20px;">+ Nueva Ficha</button>
  </div>

  <!-- Contenedor de Tarjetas -->
  <div id="ops-cards-container" class="ops-list" 
       style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px; max-height:500px; overflow-y:auto; padding-right:5px;">
    <!-- Las tarjetas se cargan aqu√≠ -->
  </div>

  <!-- Modal para Nueva/Editar Actualizaci√≥n -->
  <dialog id="ops-modal" style="border:none; border-radius:16px; padding:0; width:450px; box-shadow:0 20px 50px rgba(0,0,0,0.3);">
    <form method="dialog" id="ops-form" style="padding:24px; display:flex; flex-direction:column; gap:16px;">
      <h3 style="margin:0; font-family:'Space Grotesk';">Actualizaci√≥n Operativa</h3>
      
      <input type="hidden" id="ops-edit-id">

      <div style="display:flex; flex-direction:column; gap:6px;">
        <label style="font-weight:700; font-size:0.85rem;">T√≠tulo / Cambio detectado</label>
        <input type="text" id="ops-input-title" required placeholder="Ej: Cambio en muelle export..." style="padding:10px; border-radius:8px; border:1px solid #ddd;">
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label style="font-weight:700; font-size:0.85rem;">Prioridad</label>
          <select id="ops-input-prio" style="padding:10px; border-radius:8px; border:1px solid #ddd;">
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label style="font-weight:700; font-size:0.85rem;">Zona/√Åmbito</label>
          <select id="ops-input-scope" style="padding:10px; border-radius:8px; border:1px solid #ddd;">
            <option>General</option>
            <option>Isla</option>
            <option>Muelle</option>
            <option>Oficina</option>
          </select>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:6px;">
        <label style="font-weight:700; font-size:0.85rem;">Vigente hasta (opcional)</label>
        <input type="date" id="ops-input-date" style="padding:10px; border-radius:8px; border:1px solid #ddd;">
      </div>

      <div style="display:flex; gap:10px; margin-top:10px;">
        <button type="button" onclick="document.getElementById('ops-modal').close()" style="flex:1; padding:12px; border-radius:10px; border:1px solid #ddd; background:#f8fafc; cursor:pointer;">Cancelar</button>
        <button type="submit" class="btn-primary" style="flex:1;">Guardar Cambios</button>
      </div>
    </form>
  </dialog>
</div>





<div class="widget" id="safety-daily-widget">
<h2 class="widget-title">4) Seguridad y protecci√≥n ‚Äî Diario</h2>

<div class="safety-grid">
<div class="safety-card">
<strong>Recordatorios de hoy</strong>
<div id="safety-tips" class="tips"></div>
<div class="controls">
<button type="button" class="btn" id="safety-refresh">Regenerar hoy</button>
<button type="button" class="btn" id="safety-history">Historial</button>
</div>
<small class="kpi-text" id="safety-meta">‚Äî</small>
</div>

<div class="safety-card">
<strong>Alta manual de incidentes</strong>
<form id="safety-form" class="incident-form" autocomplete="off">
    <input type="text" id="safety-title" placeholder="T√≠tulo / resumen del incidente" required>
    <textarea id="safety-desc" rows="3" placeholder="Descripci√≥n breve..." required></textarea>
    
    <label style="font-size:0.85rem; color:var(--text-muted); display:flex; align-items:center; gap:8px; margin:5px 0;">
        Vigente hasta:
        <input type="date" id="safety-valid-until" style="padding:6px; border:1px solid var(--border); border-radius:8px;">
    </label>

    <div class="controls">
        <button type="submit" class="btn">Guardar incidente</button>
        <button type="button" class="btn" id="safety-clear">Vaciar lista</button>
    </div>
</form>
<div id="safety-list" class="incident-list" aria-live="polite"></div>
<small class="kpi-text" id="safety-inc-meta">‚Äî</small>
</div>
</div>
</div>


<div class="widget vivid" id="incidentes-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">‚ö†Ô∏è</span><span>5) Incidentes & Aprendizaje</span>
    <span class="hero-badge danger">MANUAL</span>
  </h2>

  <!-- BANNER RECORDATORIO (Se mantiene) -->
  <div class="incident-remember">
    RECORDAR: Reportar cualquier incidente inmediatamente en ENABLON.
  </div>

  <!-- PROTOCOLO (Se mantiene editable) -->
  <details style="margin-bottom:15px; border:1px solid var(--border); border-radius:8px; padding:8px; background:#fff;">
    <summary style="font-weight:700; cursor:pointer; color:var(--text-muted);">üìÇ Ver Protocolo de Actuaci√≥n</summary>
    <form id="incidents-protocol-form" class="inline-form" autocomplete="off" style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px;">
      <div class="ops-item">
        <label style="font-weight:700;">Qu√© hacer si algo sale mal</label>
        <textarea id="ip-what-to-do" rows="2" placeholder="Procedimiento..." style="width:100%;border:1px solid var(--border);border-radius:8px;padding:8px;"></textarea>
      </div>
      <div class="ops-item">
        <label style="font-weight:700;">A qui√©n informar</label>
        <input id="ip-contacts" type="text" placeholder="Tel√©fonos..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;">
      </div>
      <div class="meta-row">
        <button class="btn-compact" type="submit">Guardar Protocolo</button>
        <small id="incidents-protocol-status" class="kpi-text">‚Äî</small>
      </div>
    </form>
  </details>

  <!-- === NUEVO SISTEMA: ALTA MANUAL DE INCIDENTES / LECCIONES === -->
  
  <!-- Formulario de Alta -->
  <form id="manual-inc-form" style="background:#fff5f5; padding:12px; border-radius:10px; border:1px dashed #fecaca; margin-bottom:15px;">
    <div style="display:grid; grid-template-columns: 140px 1fr auto; gap:8px; margin-bottom:8px;">
      <select id="new-inc-type" style="padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-weight:bold;">
        <option value="incident">üî¥ Incidente</option>
        <option value="lesson">üí° Lecci√≥n</option>
      </select>
      <input type="text" id="new-inc-title" placeholder="T√≠tulo corto..." required 
             style="padding:8px; border-radius:8px; border:1px solid #e5e7eb;">
      <button type="submit" class="btn-primary" style="padding:8px 16px;">A√±adir</button>
    </div>
    <textarea id="new-inc-desc" rows="2" placeholder="Descripci√≥n detallada o aprendizaje..." 
              style="width:100%; padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-size:0.9rem;"></textarea>
  </form>

  <!-- Lista de Tarjetas -->
  <div id="incidents-list-container" class="ops-list" style="max-height:400px; overflow-y:auto; padding-right:4px;">
    <!-- Se llena con JS -->
  </div>
</div>

<div class="widget kpi-widget" id="kpi-center">
  <h2 class="widget-title">6) KPIs Operativos & Est√°ndares</h2>

  <div class="kpi-grid">
    <div class="kpi-tile">
      <div class="kpi-label">Uniwin</div>
      <div class="kpi-value" id="kpi-uph">‚Äî</div>
      <small class="kpi-text" id="kpi-uph-meta">Actualizado: ‚Äî</small>
    </div>

    <div class="kpi-tile">
      <div class="kpi-label">DG Autocheck</div>
      <div class="kpi-value" id="kpi-otif">‚Äî</div>
      <small class="kpi-text" id="kpi-otif-meta">Actualizado: ‚Äî</small>
    </div>

    <div class="kpi-tile">
      <div class="kpi-label">CargoMobile</div>
      <div class="kpi-value" id="kpi-backlog">‚Äî</div>
      <small class="kpi-text" id="kpi-backlog-meta">Actualizado: ‚Äî</small>
    </div>
</div>

    <!-- SEPARADOR -->
  <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">

  <!-- FILA 2: MANTENIMIENTO BARCELONA (FIIX) -->
  <h3 style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px; margin-top:20px; text-transform:uppercase; letter-spacing:1px;">
      Mantenimiento (BCN)
  </h3>
  
  <div class="kpi-grid">
    <!-- Disponibilidad Cr√≠tica -->
    <div class="kpi-tile" id="tile-fiix-availability" style="border-left: 6px solid #10b981;">
        <div class="kpi-label">Disponibilidad Carretillas</div>
        <div class="kpi-value"><span id="fiix-availability">--</span>%</div>
        <small class="kpi-text" id="fiix-broken-text">Analizando flota...</small>
    </div>

    <!-- Da√±os del d√≠a -->
    <div class="kpi-tile" style="border-left: 6px solid #f59e0b;">
        <div class="kpi-label">Da√±os Reportados (24h)</div>
        <div class="kpi-value" id="fiix-damage-24h">--</div>
        <small class="kpi-text">Aver√≠as/Golpes</small>
    </div>
</div>

<!-- Gr√°fico de Acumulados -->
<div class="widget vivid" style="grid-column: 1 / -1; margin-top:15px;">
    <h3 style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">
        üìä Acumulado Semanal de Da√±os
    </h3>
    <div style="height: 200px;"><canvas id="fiixWeeklyChart"></canvas></div>
</div>
  <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
    
    <div style="background: #fafafa; border-radius: 10px; padding: 12px; border: 1px solid var(--border);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <strong style="font-size:0.95rem;">Estado 5S</strong>
        <small id="s5-meta" class="kpi-text">‚Äî</small>
      </div>
      
      <div id="s5-strip" class="s5-compact" role="group" aria-label="Estado 5S" style="justify-content: center;">
        <button type="button" class="s5-pill" data-key="seiri" title="1S ¬∑ Seiri"><span class="s5-dot"></span>1S</button>
        <button type="button" class="s5-pill" data-key="seiton" title="2S ¬∑ Seiton"><span class="s5-dot"></span>2S</button>
        <button type="button" class="s5-pill" data-key="seiso" title="3S ¬∑ Seiso"><span class="s5-dot"></span>3S</button>
        <button type="button" class="s5-pill" data-key="seiketsu" title="4S ¬∑ Seiketsu"><span class="s5-dot"></span>4S</button>
        <button type="button" class="s5-pill" data-key="shitsuke" title="5S ¬∑ Shitsuke"><span class="s5-dot"></span>5S</button>
      </div>
    </div>

    <div style="background: #fafafa; border-radius: 10px; padding: 12px; border: 1px solid var(--border);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong style="font-size:0.95rem;">Gemba Walk (GW)</strong>
      </div>

      <form id="gw-upload-form" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <input type="file" id="gw-file" accept=".xlsx,.xls" style="flex:1; font-size:0.8rem; padding:4px; width:0;">
        <button class="btn-primary" type="submit" style="padding:4px 8px; font-size:0.8rem;">Subir</button>
      </form>
      <small id="gw-upload-status" class="kpi-text" style="display:block; margin-bottom:6px;">‚Äî</small>

    </div>
  </div>
</div>

<div class="widget" id="kanban-widget">
<h2 class="widget-title">7) Feedback directo BCN</h2>
<div class="board-container kanban">
<div class="kanban-column">
<h3 class="column-title"><span>Abiertas</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-Abiertas" data-status="Abiertas"></div>
</div>
<div class="kanban-column">
<h3 class="column-title"><span>En Curso</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-En-Curso" data-status="En Curso"></div>
</div>
<div class="kanban-column">
<h3 class="column-title"><span>Cerradas</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-Cerradas" data-status="Cerradas"></div>
</div>
<div class="kanban-column">
<h3 class="column-title"><span>Vencidas</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-Vencidas" data-status="Vencidas"></div>
</div>
</div>

<form class="new-item-form" id="new-kanban-form"
style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);
                display:grid; grid-template-columns: 1fr 1fr auto 1fr auto;
                gap:8px; align-items:center;">
<select id="problem-category" name="category" required>
<option value="" disabled selected>Selecciona categor√≠a‚Ä¶</option>
<option value="seguridad">Seguridad</option>
<option value="incidencias">Incidencias</option>
<option value="mantenimiento">Mantenimiento</option>
<option value="calidad">Calidad</option>
<option value="servicio">Servicio</option>
</select>
<input type="text" name="title" placeholder="Tipo de problema" required>
<input type="date" name="due_date" required>
<select name="assigned_to" required title="Equipo de soporte">
<option value="" disabled selected>Equipo de soporte‚Ä¶</option>
<option>Mantenimiento</option>
<option>IT</option>
<option>Calidad</option>
<option>Compras</option>
<option>CI</option>
<option>QHSSE</option>
<option>Ops</option>
</select>
<button type="submit" class="btn-primary">A√±adir</button>
</form>
</div>

<div class="widget" id="kaizen-widget" style="margin-top: 20px;">
  <h2 class="widget-title">KAIZEN (Proyectos de mejora)</h2>
  
  <form class="new-item-form" id="new-kaizen-form" autocomplete="off" style="display:grid; grid-template-columns: 1fr 1fr auto auto; gap:8px; align-items:center;">
    <input type="text" name="title" placeholder="Proyecto de mejora‚Ä¶" required>
    <input type="text" name="assigned_to" placeholder="Responsable‚Ä¶">
    <input type="date" name="due_date" aria-label="Fecha m√°xima">
    <button type="submit" class="btn-primary">A√±adir</button>
  </form>

  <div class="board-container kaizen" style="margin-top:12px;">
    <div class="kanban-column">
      <h3 class="column-title"><span>Proyectos</span><span class="count">(0)</span></h3>
      <div class="cards-container" id="kaizen-Proyectos" data-status="Proyectos"></div>
    </div>
    <div class="kanban-column">
      <h3 class="column-title"><span>En Progreso</span><span class="count">(0)</span></h3>
      <div class="cards-container" id="kaizen-En-Progreso" data-status="En Progreso"></div>
    </div>
    <div class="kanban-column">
      <h3 class="column-title"><span>Hecho</span><span class="count">(0)</span></h3>
      <div class="cards-container" id="kaizen-Hecho" data-status="Hecho"></div>
    </div>
  </div>
</div>


</section>

<section class="col-right">
<div class="widget" id="prev-shift-widget">
  <h2 class="widget-title">
      3) Informaci√≥n Turno Anterior BCN
      <button type="button" class="btn-mic" data-target="prev-shift-note" title="Dictar nota">
          üéôÔ∏è
      </button>
  </h2>
<div id="prev-shift-note" class="editable-note" contenteditable="true"
role="textbox" aria-multiline="true"
aria-label="Escribe la informaci√≥n del turno anterior"
spellcheck="true"
style="min-height:96px; padding:10px 12px; border:1px solid var(--border);
               border-radius:10px; background:#fff; line-height:1.4;"
data-placeholder="Escribe aqu√≠ lo m√°s relevante del turno anterior‚Ä¶"></div>
<small class="kpi-text" id="prev-shift-saved-hint"></small>
</div>

<div class="widget" id="ehs-widget">
  <h2 class="widget-title">D√≠as sin incidentes</h2>
  <div class="ehs-month" id="ehs-month">‚Äî</div>
  
  <div id="ehs-spin" class="ehs-controls" role="spinbutton" style="justify-content: center;">
      <div class="ehs-big" id="ehs-days" title="Doble clic para reiniciar a 0 si hubo incidente" style="cursor:pointer;">0</div>
  </div>
</div>
</section>
</div>


<div id="post-briefing-screen">
    <div class="pb-header">
        <div class="pb-title">üöÄ MODO OPERATIVO - BCN INFORMACI√ìN</div>
        <button class="pb-close-btn" onclick="closePostBriefingMode()">‚úñ Volver al Dashboard</button>
    </div>

    <div class="pb-grid">
        <div class="pb-card">
            <div class="pb-card-title">‚Ü©Ô∏è Highlights Turno Anterior</div>
            <div id="pb-prev-content" class="pb-content"></div>
        </div>
        <div class="pb-card">
            <div class="pb-card-title">üöß Actualizaciones Operativas</div>
            <div id="pb-ops-content" class="pb-content"></div>
        </div>
        <div class="pb-card">
            <div class="pb-card-title">üìä KPIs del Turno</div>
            <div id="pb-kpi-content" class="pb-content">
                <div class="pb-kpi-box">
                    <div class="pb-kpi-item">
                        <span style="font-size:1.2rem;font-weight:600;color:#64748b">UPH</span>
                        <span id="pb-val-uph" class="pb-kpi-val">-</span>
                    </div>
                    <div class="pb-kpi-item">
                        <span style="font-size:1.2rem;font-weight:600;color:#64748b">Costes</span>
                        <span id="pb-val-cost" class="pb-kpi-val">-</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="pb-card">
            <div class="pb-card-title">üõ°Ô∏è Seguridad y Riesgos</div>
            <div id="pb-sec-content" class="pb-content"></div>
        </div>
    </div>
</div>
    
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
/* Estaci√≥n actual (BCN por t√≠tulo o ?station=) */
const STATIONS_KNOWN = ['MAD','BCN','VLC','SVQ'];
// FORZAR BCN SI NO VIENE EN URL
const STATION_CODE = (
(new URLSearchParams(location.search).get('station') || '')
.toUpperCase() || 'BCN'
);


function opsKey(base){ return `${base}_${STATION_CODE}`; }

const OPS_SECTIONS_KEY = opsKey('ops_updates_sections_v1');
const OPS_LINES_KEY    = opsKey('ops_updates_lines_v1');

/* ==========================
Utilidades b√°sicas
========================== */
function esc(s){
return String(s ?? '')
.replace(/&/g,'&amp;')
.replace(/</g,'&lt;')
.replace(/>/g,'&gt;')
.replace(/"/g,'&quot;')
.replace(/'/g,"&#39;");
}
function $$(sel){ return Array.from(document.querySelectorAll(sel)); }

/* ==========================
Seguridad y protecci√≥n ‚Äî diario + manual
========================== */
const SAFETY_TIPS_KEY = 'safety_daily_tips_history_v1';
const SAFETY_INC_KEY  = 'safety_manual_incidents_v1';

// Lista completa de frases (tal cual la facilitaste)
const SAFETY_TIPS_MASTER = [
"Temas de seguridad de actualidad (noticias, redes sociales, cambios de nivel de amenaza, etc.).",
"Incidentes o no conformidades en tu estaci√≥n u otras.",
"Resultados de auditor√≠as (aerol√≠neas, autoridades, autoauditor√≠as).",
"Pr√≥ximas auditor√≠as o visitas.",
"Mantener puertas cerradas cuando no se usen.",
"Reportar comportamientos sospechosos.",
"Retar a personas sin acreditaci√≥n o acompa√±amiento.",
"Acompa√±ar a todos los visitantes en todo momento.",
"Llevar chaleco de alta visibilidad en almac√©n y zona aire.",
"Saber d√≥nde est√°n los contactos de emergencia.",
"Segregar carga segura e insegura.",
"Revisar signos de manipulaci√≥n en paquetes.",
"Llevar la acreditaci√≥n visible en todo momento.",
"No llevar mochilas ni bolsas a zonas seguras.",
"Guardar cintas, precintos y elementos de seguridad de forma segura.",
"No permitir el acceso de personas no autorizadas.",
"Preguntar si no se conoce un procedimiento.",
"No dar informaci√≥n de seguridad a externos.",
"No permitir personas no autorizadas cerca de carga segura.",
"No saltarse procedimientos.",
"Si una carga no es segura, no cargarla y revisarla.",
"Leer todos los avisos de seguridad y pedir aclaraciones.",
"Si ves algo, dilo.",
"Informar si las normas no son pr√°cticas o seguras.",
"Escalar errores o riesgos de seguridad a la direcci√≥n.",
"Mantener la informaci√≥n sensible segura.",
"Cumplir siempre las normas y procedimientos de seguridad.",
"No seguir instrucciones que comprometan la seguridad.",
"No cargar mercanc√≠a con etiquetas de parada o retenci√≥n.",
"Animar a los compa√±eros a cumplir las normas.",
"Revisar la validez de la acreditaci√≥n y avisar si va a caducar.",
"Si no sabes, pregunta; si sabes, ense√±a.",
"Pensar en las consecuencias de no cumplir las normas.",
"Identificar a la persona con la que hablas.",
"Comparar la foto de la acreditaci√≥n con la persona.",
"Registrar entrada y salida de visitantes.",
"Si ves conductores deambulando, ind√≠cale la zona designada.",
"Mantener puertas de zona aire cerradas.",
"No interferir con los controles de seguridad.",
"Al controlar, centrarse en la tarea.",
"Rechazar o revisar carga da√±ada.",
"No aceptar carga sin identificaci√≥n o documentaci√≥n.",
"Revisar que los camiones est√©n sellados.",
"Comprobar la identificaci√≥n de quien recoge la carga.",
"Contar todas las piezas de un env√≠o.",
"Comparar el nombre del visitante con el registro.",
"Comprobar la validez en bases de datos oficiales.",
"Verificar acuerdos de subcontratistas.",
"No prestar acreditaciones.",
"Avisar si se pierde la acreditaci√≥n.",
"Comprobar identificaci√≥n y estatus en cada ocasi√≥n.",
"No permitir acceso no autorizado a zonas restringidas.",
"Asistir y prestar atenci√≥n a la reuni√≥n de turno.",
"Presentar la acreditaci√≥n en lectores de proximidad.",
"Informar de errores a supervisores.",
"Todos pueden pulsar el bot√≥n de parada de emergencia por seguridad.",
"Mejor prevenir que curar.",
"Cooperar en los controles de seguridad.",
"Avisar si algo no parece correcto.",
"No manipular ni poner en riesgo sistemas de seguridad.",
"Sospechar de precintos diferentes en paquetes.",
"Las fechas l√≠mite no justifican saltarse la seguridad.",
"Dejar trabajar a los perros de seguridad.",
"Asegurarse de que la carga ha sido revisada.",
"La seguridad es responsabilidad de todos.",
"Informar de puertas, ventanas o vallas da√±adas.",
"Retar a desconocidos en el almac√©n.",
"Ayudar a los controladores en el escaneo de env√≠os.",
"Usar cinta de seguridad para cerrar paquetes revisados.",
"Usar sellos correctos para indicar el estado de seguridad.",
"Llamar a la polic√≠a si es necesario.",
"Leer los boletines de seguridad y pedir aclaraciones.",
"Ayudar a nuevos empleados a cumplir las normas.",
"Informar de da√±os en carga, puertas, ventanas, se√±alizaci√≥n.",
"Transferir la carga segura inmediatamente a la zona segura.",
"Guardar carga valiosa en √°reas designadas y bajo CCTV.",
"Asegurarse de que los visitantes devuelvan su acreditaci√≥n.",
"Dejar pertenencias personales en la taquilla.",
"No entregar carga a conductores no autorizados.",
"Comprobar que los controles de seguridad est√©n registrados.",
"Asegurarse de que los archivos de vuelo est√©n completos.",
"Comprobar que cada env√≠o tenga el CSD correcto.",
"La seguridad es para proteger a todos, incluidos tus seres queridos.",
"Todos deben estar formados seg√∫n su funci√≥n.",
"Adaptar los procedimientos a la seguridad, no al rev√©s.",
"No tomar fotos en zonas seguras.",
"No publicar informaci√≥n de seguridad en redes sociales.",
"No permitir que los clientes decidan el m√©todo de control.",
"No permitir que clientes/conductores usen ba√±os sin acompa√±amiento.",
"Mantener cerradas las puertas de zonas restringidas.",
"Informar siempre de carga da√±ada.",
"Informar de carga manipulada o posible robo.",
"Informar de comportamientos extra√±os de compa√±eros.",
"Conocer el cartel de ‚Äúwhistle blower‚Äù.",
"Concienciaci√≥n sobre amenazas internas.",
"No asumir riesgos innecesarios con la seguridad.",
"No dejar carga segura desatendida fuera de la instalaci√≥n.",
"Mantenerse siempre alerta.",
"No dejar puertas abiertas sin vigilancia.",
"No compartir procesos de seguridad del sector.",
"La seguridad es tu responsabilidad."
];

// ‚Äî‚Äî helpers persistencia
function loadJson(key, fallback){
try{ return JSON.parse(localStorage.getItem(key) || 'null') ?? fallback; }catch{ return fallback; }
}
function saveJson(key, val){
try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
}

(function ensureUniqueQuicklines(){
const nodes = document.querySelectorAll('#ops-quicklines');
if (nodes.length > 1){
nodes.forEach((n,i)=>{ if(i>0) n.remove(); });
}
})();


// ‚Äî‚Äî tips diarios
function todayKey(){
const d = new Date();
const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
return `${y}-${m}-${dd}`;
}
function hashStr(s){
let h=0; for(let i=0;i<s.length;i++){ h = (h*31 + s.charCodeAt(i))|0; } return Math.abs(h);
}
function pickTwoDistinct(arr, seedStr){
if(arr.length<2) return arr.slice(0,2);
const h = hashStr(seedStr);
const i1 = h % arr.length;
const i2 = (Math.floor(h/7) + 1) % arr.length;
return i1===i2 ? [arr[i1], arr[(i2+1)%arr.length]] : [arr[i1], arr[i2]];
}

function renderSafetyTips(){
const host = document.getElementById('safety-tips');
const meta = document.getElementById('safety-meta');
if(!host) return;
const day = todayKey();
let hist = loadJson(SAFETY_TIPS_KEY, {}); // { 'YYYY-MM-DD': [tip1, tip2], ... }

if(!Array.isArray(hist[day]) || hist[day].length!==2){
hist[day] = pickTwoDistinct(SAFETY_TIPS_MASTER, day + '|' + STATION_CODE);
saveJson(SAFETY_TIPS_KEY, hist);
}

host.innerHTML = '';
hist[day].forEach(t=>{
const el = document.createElement('div');
el.className = 'tip';
el.textContent = t;
host.appendChild(el);
});
if(meta){
meta.textContent = `Fecha: ${new Date().toLocaleDateString('es-ES')} ‚Ä¢ Guardado local`;
}
}

function setupSafetyDaily(){
renderSafetyTips();
document.getElementById('safety-refresh')?.addEventListener('click', ()=>{
// Fuerza nueva selecci√≥n para hoy: usa un "seed" alterno con la hora
const day = todayKey();
const hist = loadJson(SAFETY_TIPS_KEY, {});
hist[day] = pickTwoDistinct(SAFETY_TIPS_MASTER, day + '|' + Date.now());
saveJson(SAFETY_TIPS_KEY, hist);
renderSafetyTips();
});
document.getElementById('safety-history')?.addEventListener('click', ()=>{
const hist = loadJson(SAFETY_TIPS_KEY, {});
const entries = Object.entries(hist).sort(([a],[b])=>a.localeCompare(b));
alert(entries.map(([d,v])=>`${d}:\n‚Ä¢ ${v?.[0]||''}\n‚Ä¢ ${v?.[1]||''}`).join('\n\n') || 'Sin historial');
});
}

// ‚Äî‚Äî incidentes manuales
function loadIncidents(){ return loadJson(SAFETY_INC_KEY, []); }
function saveIncidents(list){ saveJson(SAFETY_INC_KEY, list); }

function renderIncidents(){
    const listEl = document.getElementById('safety-list');
    const meta = document.getElementById('safety-inc-meta');
    if(!listEl) return;
    const data = loadIncidents();
    listEl.innerHTML = '';
    
    data.slice().reverse().forEach((it)=>{
        const card = document.createElement('div');
        card.className = 'incident-item';
        const ts = new Date(it.ts||Date.now());
        
        // A√ëADIDO: Mostrar fecha de vigencia si existe
        const validHtml = it.valid_until ? 
            `<div style="color:#d97706; font-weight:700; font-size:0.85rem; margin-top:4px;">üìÖ Vigente hasta: ${new Date(it.valid_until).toLocaleDateString('es-ES')}</div>` 
            : '';

        card.innerHTML = `
           <div class="incident-head">
             <span>${esc(it.title||'')}</span>
             <span class="danger" data-del="${it.id}" title="Eliminar" style="cursor:pointer">üóë</span>
           </div>
           <div class="incident-meta">${ts.toLocaleString('es-ES')} ‚Äî ${esc(it.station||STATION_CODE)}</div>
           ${validHtml}
           <div style="margin-top:4px;">${esc(it.desc||'')}</div>
         `;
        listEl.appendChild(card);
    });
    
    if(meta) meta.textContent = `Incidentes guardados: ${data.length}`;

    listEl.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const id = btn.getAttribute('data-del');
            const cur = loadIncidents().filter(x=>String(x.id)!==String(id));
            saveIncidents(cur);
            renderIncidents();
        });
    });
}

function setupSafetyIncidents(){
    const form = document.getElementById('safety-form');
    const title = document.getElementById('safety-title');
    const desc  = document.getElementById('safety-desc');
    const validDate = document.getElementById('safety-valid-until'); // Referencia al nuevo input
    const clear = document.getElementById('safety-clear');

    renderIncidents();

    form?.addEventListener('submit', (e)=>{
        e.preventDefault();
        const t = (title?.value||'').trim();
        const d = (desc?.value||'').trim();
        const v = validDate?.value || null; // Capturar valor fecha

        if(!t || !d) return;
        
        const cur = loadIncidents();
        // Guardamos 'valid_until' en el objeto
        cur.push({ 
            id: Date.now(), 
            title: t, 
            desc: d, 
            valid_until: v, 
            ts: Date.now(), 
            station: STATION_CODE 
        });
        
        saveIncidents(cur);
        
        // Limpiar campos
        title.value=''; 
        desc.value=''; 
        if(validDate) validDate.value=''; 
        
        renderIncidents();
    });

    clear?.addEventListener('click', ()=>{
        if(!confirm('¬øVaciar todos los incidentes guardados?')) return;
        saveIncidents([]); renderIncidents();
    });
}

function initSafetyDailyWidget(){
setupSafetyDaily();
setupSafetyIncidents();

// Accesibilidad: Enter en textarea -> salto de l√≠nea normal; ya OK por defecto.
}



/* Acepta tareas sin estaci√≥n o con station = STATION_CODE */
function isForThisStation(obj){
const st = (obj && obj.station ? String(obj.station) : '').toUpperCase();
return !st || st === STATION_CODE;
}

/* Ajusta H1 si el t√≠tulo no lleva c√≥digo correcto */
(function(){
try{
const h1 = document.querySelector('header h1');
if (h1 && !h1.textContent.toUpperCase().includes(STATION_CODE)){
h1.textContent = `Factory Floor Dashboard - ${STATION_CODE}`;
}
}catch(e){}
})();

/* ==========================
Cron√≥metro Header
========================== */
/* ==========================
   Cron√≥metro Header (CORREGIDO)
   ========================== */
(function(){
    const KEY='header_big_timer_v1';
    // 4 minutos en milisegundos para la alerta roja
    const ALERT_MS = 4 * 60 * 1000; 
    let running=false, startedAt=0, elapsed=0, tick=null;

    // Referencias tard√≠as (se buscan al iniciar initHeaderTimer)
    let display, resetBtn, host;

    function fmt(ms){
        const t = Math.floor(ms/1000);
        const h = Math.floor(t/3600);
        const m = Math.floor((t%3600)/60);
        const s = t%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function paint(){
        if(!display) return;
        const nowMs = running ? (Date.now() - startedAt) : elapsed;
        
        // 1. Pintar tiempo
        display.textContent = fmt(nowMs);

        // 2. Alerta Roja si pasa de 4 minutos
        if (nowMs >= ALERT_MS) {
            display.classList.add('alert-mode'); // Requiere CSS de alerta
            display.style.color = '#dc2626';     // Fallback directo
        } else {
            display.classList.remove('alert-mode');
            display.style.color = '';
        }
    }

    function save(){
        try{ localStorage.setItem(KEY, JSON.stringify({running, startedAt, elapsed})); }catch(e){}
    }

    function load(){
        try{
            const s = JSON.parse(localStorage.getItem(KEY)||'null');
            if(!s) return;
            running = !!s.running;
            elapsed = Number(s.elapsed)||0;
            startedAt = Number(s.startedAt)||0;
            if (running){
                const now=Date.now();
                elapsed = Math.max(elapsed, now-startedAt);
                startedAt = now - elapsed;
            }
        }catch(e){}
    }

    function start(){
        if (running) return;
        running = true;
        startedAt = Date.now() - elapsed;
        if(!tick) tick = setInterval(paint, 250);
        paint(); save();
    }

    function pause(){
        if (!running) return;
        running = false;
        elapsed = Date.now() - startedAt;
        clearInterval(tick); tick=null;
        paint(); save();
    }

    function reset(){
        running = false; startedAt = 0; elapsed = 0;
        clearInterval(tick); tick=null;
        paint(); save();
        if(display) display.style.color = ''; // Quitar rojo
    }

    // Inicializador p√∫blico seguro
    window.initHeaderTimer = function(){
        host = document.getElementById('timer-widget');
        display = document.getElementById('timer-display');
        resetBtn = document.getElementById('timer-reset');

        if(display) {
            // Limpiamos eventos previos para no duplicar
            const newDisplay = display.cloneNode(true);
            display.parentNode.replaceChild(newDisplay, display);
            display = newDisplay;

            // Asignar click para iniciar/pausar
            display.addEventListener('click', () => {
                running ? pause() : start();
            });
            display.style.cursor = 'pointer';
        }

        // Exponer reset globalmente para el bot√≥n de reinicio de turno
        window.resetFactoryTimer = reset;

        load(); 
        paint();
        if (running) tick = setInterval(paint, 250);
    };
})();

/* ==========================
Escala UI
========================== */
(function initUIScaling(){
const KEY='ui_scale_v1';
function apply(v){
document.documentElement.style.setProperty('--ui-scale', v);
}
const sel = document.getElementById('scale-select');
if (!sel) return;
const saved = localStorage.getItem(KEY) || sel.value || '1.15';
apply(saved);
sel.value = saved;
sel.addEventListener('change', e=>{
const v = e.target.value;
localStorage.setItem(KEY, v);
apply(v);
});
})();

/* ==========================
Fullscreen helpers
========================== */
const FS_ICONS = {
on:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 9H5V5"/><path d="M15 9h4V5"/><path d="M9 15H5v4"/><path d="M15 15h4v4"/></svg>',
off:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4"/><path d="M15 3h4a2 2 0 0 1 2 2v4"/><path d="M9 21H5a2 2 0 0 1-2-2v-4"/><path d="M15 21h4a2 2 0 0 0 2-2v-4"/></svg>'
};
function ensureFullscreenBtn(host){
if (!host || host.querySelector('.fs-toggle')) return;
const btn = document.createElement('button');
btn.className='fs-toggle';
btn.type='button';
btn.setAttribute('aria-label','Ver a pantalla completa');
btn.innerHTML = FS_ICONS.off;
btn.addEventListener('mousedown', e=>e.stopPropagation(), true);
btn.addEventListener('click', async e=>{
e.preventDefault(); e.stopPropagation();
try{
if (document.fullscreenElement === host){
await document.exitFullscreen?.();
}else{
await (host.requestFullscreen?.({navigationUI:'hide'}) ?? host.requestFullscreen?.());
}
}catch(err){ console.warn('Fullscreen error', err); }
});
host.appendChild(btn);
}
function initFullscreenToggles(){
document.querySelectorAll('.widget, .card').forEach(ensureFullscreenBtn);
document.addEventListener('fullscreenchange', ()=>{
const cur = document.fullscreenElement;
document.querySelectorAll('.fs-toggle').forEach(btn=>{
const owner = btn.closest('.widget, .card');
const isOn = cur === owner;
btn.innerHTML = isOn ? FS_ICONS.on : FS_ICONS.off;
btn.setAttribute('aria-label', isOn ? 'Salir de pantalla completa' : 'Ver a pantalla completa');
btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
});
document.documentElement.classList.toggle('fs-zoom', !!cur);
});


document.getElementById('present-btn')?.addEventListener('click', async ()=>{
const host = document.querySelector('.dashboard-3col') || document.body;
try{
await (host.requestFullscreen?.({navigationUI:'hide'}) ?? host.requestFullscreen?.());
}catch(e){ console.warn('Fullscreen fail', e); }
});
}

/* ==========================
Fecha / hora / turno
========================== */
function computeShift(d=new Date()){
const m=d.getHours()*60+d.getMinutes();
if (m>=360 && m<840)   return {name:'Ma√±ana',from:'06:00',to:'14:00'};
if (m>=840 && m<1320)  return {name:'Tarde', from:'14:00',to:'22:00'};
return {name:'Noche',from:'22:00',to:'06:00'};
}
function paintDateTimeAndShift(){
const now = new Date();
const dt = now.toLocaleString('es-ES',{
weekday:'long', day:'2-digit', month:'long', year:'numeric',
hour:'2-digit', minute:'2-digit'
});
const head = document.getElementById('now-header');
if (head) head.textContent = dt;

const shift = computeShift(now);
const paint = el=>{
if (!el) return;
el.textContent = `Turno: ${shift.name} (${shift.from}‚Äì${shift.to})`;
el.dataset.shift = shift.name;
};
paint(document.getElementById('shift-badge'));
paint(document.getElementById('shift-badge-header'));
}
function initDateTimeAndShift(){
paintDateTimeAndShift();
const now = new Date();
const ms = (60-now.getSeconds())*1000 - now.getMilliseconds();
setTimeout(()=>{
paintDateTimeAndShift();
setInterval(paintDateTimeAndShift, 60000);
}, Math.max(0, ms));
}

/* ==========================
EHS simple
========================== */
function initEhsSimple(){
    const daysEl = document.getElementById('ehs-days');
    const monthEl = document.getElementById('ehs-month');
    if (!daysEl) return;
    
    // Mes actual
    const now = new Date();
    if(monthEl) monthEl.textContent = now.toLocaleDateString('es-ES',{month:'long',year:'numeric'});

    const KEY_LAST_INCIDENT = 'ehs_last_incident_date_bcn_v1';

    function render() {
        const lastDateStr = localStorage.getItem(KEY_LAST_INCIDENT);
        // Si no hay fecha guardada, asumimos hoy (0 d√≠as)
        let lastDate = lastDateStr ? new Date(lastDateStr) : new Date();
        
        // Resetear horas para comparar solo d√≠as naturales
        const today = new Date();
        today.setHours(0,0,0,0);
        lastDate.setHours(0,0,0,0);

        // Diferencia en milisegundos a d√≠as
        const diffTime = today - lastDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
        
        daysEl.textContent = Math.max(0, diffDays);
    }

    // Doble clic para reportar un incidente hoy (Reinicia a 0)
    daysEl.addEventListener('dblclick', () => {
        if(confirm("¬øReportar incidente hoy? El contador se reiniciar√° a 0.")) {
            localStorage.setItem(KEY_LAST_INCIDENT, new Date().toISOString());
            render();
        }
    });

    // Inicializar fecha si es la primera vez que se usa
    if(!localStorage.getItem(KEY_LAST_INCIDENT)){
        localStorage.setItem(KEY_LAST_INCIDENT, new Date().toISOString());
    }

    render();
    // Revisar cada hora si ha cambiado el d√≠a sin recargar
    setInterval(render, 3600000);
}

/* ==========================
5S (localStorage)
========================== */
const S5_STATE_KEY='s5_state_v1';
function loadS5State(){
try{ return JSON.parse(localStorage.getItem(S5_STATE_KEY)||'{}'); }
catch{ return {}; }
}
function saveS5State(s){
try{ localStorage.setItem(S5_STATE_KEY, JSON.stringify(s)); }
catch(e){}
}
function render5S(){
const strip=document.getElementById('s5-strip');
if (!strip) return;
const state=loadS5State();
let done=0;
strip.querySelectorAll('.s5-pill').forEach(btn=>{
const k=btn.dataset.key;
const on=!!state[k];
btn.classList.toggle('on', on);
if (on) done++;
});
const meta=document.getElementById('s5-meta');
if (meta){
const ts=state.updated_at ? new Date(state.updated_at).toLocaleString('es-ES') : null;
meta.textContent = `${done}/5 completadas${ts?` ‚Ä¢ Actualizado: ${ts}`:''}`;
}
}
function toggle5S(key, el){
const s=loadS5State();
s[key]=!s[key];
s.updated_at=new Date().toISOString();
saveS5State(s);
render5S();
if (el){
el.classList.add('bump');
setTimeout(()=>el.classList.remove('bump'),220);
}
}
function init5S(){
const strip=document.getElementById('s5-strip');
if (!strip) return;
strip.addEventListener('click', e=>{
const pill=e.target.closest('.s5-pill');
if (!pill) return;
const key=pill.dataset.key;
if (!key) return;
toggle5S(key, pill);
});
render5S();
}

/* ==========================
Roster / Equipo
========================== */
let TEAM_STATE = null;

function countPresent(att){ return Object.values(att||{}).filter(Boolean).length; }

async function fetchServerRoster(){
try{
const r = await fetch('api/roster/current', {
cache:'no-store',
headers:{'Accept':'application/json'}
});
if (!r.ok) return null;
return await r.json();
}catch(e){
console.error('Roster error', e);
return null;
}
}

function updateTeamMeta(state){
const meta=document.getElementById('team-meta');
if (!meta || !state) return;
const total=(state.people||[]).length;
const present=countPresent(state.attendance||{});
const shift=state.shift || '‚Äî';
const win=state.window ? `${state.window.from}‚Äì${state.window.to}` : '‚Äî';
meta.textContent = `${shift} ‚Ä¢ ${win} ‚Ä¢ Presentes ${present}/${total}`;
}

async function updatePresenceOnServer(person, present){
try{
await fetch('api/roster/presence',{
method:'PUT',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
person, present,
date: TEAM_STATE?.sheet_date || null,
shift: TEAM_STATE?.shift || null
})
});
}catch(e){ console.error(e); }
}
async function updateZoneOnServer(person, zone){
try{
await fetch('api/roster/zone',{
method:'PUT',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
person, zone,
date: TEAM_STATE?.sheet_date || null,
shift: TEAM_STATE?.shift || null
})
});
}catch(e){ console.error(e); }
}

let weeklyFiixChart = null;

async function renderFiixWeeklyHistory() {
    try {
        const res = await fetch('api/fiix/history');
        const data = await res.json();

        const ctx = document.getElementById('fiixWeeklyChart').getContext('2d');
        if (weeklyFiixChart) weeklyFiixChart.destroy();

        weeklyFiixChart = new Chart(ctx, {
            type: 'bar', // Cambiado a barras para que se vea mejor el volumen
            data: {
                labels: data.map(d => d.week),
                datasets: [
                    {
                        label: 'N√∫mero de Incidencias',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)', // Azul Vivid
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        borderRadius: 6, // Esquinas redondeadas para estilo moderno
                        barPercentage: 0.6 // Barras un poco m√°s delgadas y elegantes
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false } // Ocultamos leyenda porque solo hay un dato
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Cant. Aver√≠as', font: { weight: 'bold' } },
                        ticks: { stepSize: 1 } // Solo n√∫meros enteros (no hay media aver√≠a)
                    },
                    x: {
                        grid: { display: false } // Limpiamos el fondo del gr√°fico
                    }
                }
            }
        });
    } catch (e) {
        console.error("Error cargando hist√≥rico semanal:", e);
    }
}

// Ejecutar al cargar
document.addEventListener('DOMContentLoaded', renderFiixWeeklyHistory);
    
    function renderRoster(listEl, people, state) {
    if (!listEl) return;
    
    // 1. Inicializaci√≥n de Estado Global
    if (!window.TEAM_STATE) {
        window.TEAM_STATE = { attendance: {}, zones: {}, allPeopleRaw: [], people: [] };
    }
    
    if (people && people.length > 0) window.TEAM_STATE.allPeopleRaw = people;
    const masterList = window.TEAM_STATE.allPeopleRaw;

    if (!masterList || masterList.length === 0) {
        listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">Cargando personal de Operaciones...</div>';
        return;
    }

    // --- 2. L√ìGICA DE TURNOS CORREGIDA (Anticipaci√≥n 2h) ---
    const hNow = new Date().getHours();
    let currentShiftLabel = "Noche";

    if (hNow >= 4 && hNow < 12) {
        currentShiftLabel = "Ma√±ana";
    } 
    else if (hNow >= 12 && hNow < 20) {
        currentShiftLabel = "Tarde";
    }

    const extractHours = (str) => {
        const times = (str || "").match(/(\d{1,2}):(\d{2})/g);
        if (!times) return [];
        return times.map(t => parseInt(t.split(':')[0]));
    };

    // --- 3. FILTRADO MEJORADO (Exclusi√≥n por Nombre + Categor√≠a + Horquilla) ---
    const CATEGORIAS_OPS = [ "OPS", "DGR", "01-SUPERVISORES-OPS", "AF/KL", "US Carriers"];

    const filteredPeople = masterList.filter(p => {
        // --- A. REGLA DE EXCLUSI√ìN POR NOMBRE (NUEVO) ---
        const nombreUpper = (p.nombre_completo || "").toUpperCase();
        if (nombreUpper.includes("CUSTOMER/TRACING OPS")) {
            return false;
        }

        // B. Filtro Categor√≠a
        const infoCategoria = (p.observaciones || p.grupo || "").toUpperCase();
        const cumpleCategoria = CATEGORIAS_OPS.some(cat => infoCategoria.includes(cat));
        if (!cumpleCategoria) return false;

        // C. Filtro Horquilla Horaria
        const hours = extractHours(p.horario);
        if (hours.length === 0) return true; 
        
        const hInicio = hours[0];
        const hFin = hours.length > 1 ? hours[1] : hInicio;
        
        if (currentShiftLabel === "Ma√±ana") return (hInicio >= 6 && hInicio < 14) || (hFin > 6 && hFin <= 14);
        if (currentShiftLabel === "Tarde")  return (hInicio >= 14 && hInicio < 22) || (hFin > 14 && hFin <= 22);
        if (currentShiftLabel === "Noche")  return (hInicio >= 22 || hInicio < 6) || (hFin >= 22 || hFin <= 6);
        return false;
    });

    window.TEAM_STATE.people = filteredPeople;

    // --- 4. SECCIONAMIENTO VISUAL (Categorizaci√≥n Vivid) ---
    const groups = {
        "SUPERVISI√ìN OPS": [],
        "DGR": [],
        "OPERARIOS": []
    };

    filteredPeople.forEach(p => {
        const cat = (p.observaciones || p.grupo || "").toUpperCase();
        if (cat.includes("01-SUPERVISORES-OPS")) {
            groups["SUPERVISI√ìN OPS"].push(p);
        } else if (cat.includes("DGR")) {
            groups["DGR"].push(p);
        } else if (cat.includes("OPS")) {
            groups["OPERARIOS"].push(p);
        }
         else if (cat.includes("US Carriers")) {
            groups["OPERARIOS"].push(p);
        } else if (cat.includes("AF/KL")) {
            groups["OPERARIOS"].push(p);
        }else if (cat.includes("LEADS")) {
            groups["OPERARIOS"].push(p);
        }
    });

    listEl.innerHTML = '';
    const ZONES = ['Isla', 'Dorada', 'Muelle Imp', 'Muelle Exp', 'Import', 'Export'];

    // --- 5. RENDERIZADO POR BLOQUES ---
    Object.keys(groups).forEach(groupName => {
        const groupPeople = groups[groupName];
        if (groupPeople.length === 0) return;

        const header = document.createElement('div');
        header.style.cssText = "background:#f1f5f9; padding:8px 12px; margin:15px 0 8px 0; font-weight:700; font-size:0.85rem; color:#475569; border-radius:8px; text-transform:uppercase; border-bottom:2px solid #cbd5e1;";
        header.textContent = `${groupName} (${groupPeople.length})`;
        listEl.appendChild(header);

        groupPeople.forEach((p) => {
            const name = p.nombre_completo;
            const isIncidencia = p.is_incidencia === true;
            const hVisual = (p.horario.match(/(\d{1,2}):(\d{2})/g) || []).join(' - ');
            const safeId = name.replace(/[^a-z0-9]/gi, '_');

            let currentAtt = window.TEAM_STATE.attendance[name]; 
            if (currentAtt === undefined) currentAtt = "undefined";

            const currentZone = window.TEAM_STATE.zones[name] || '';

            let colorVivid = "#3b82f6"; 
            if (groupName === "SUPERVISI√ìN ALMAC√âN") colorVivid = "#fbbf24"; 
            if (groupName === "CAPATACES / EPAs") colorVivid = "#8b5cf6"; 

            const row = document.createElement('div');
            row.className = 'team-row';
            row.style.cssText = `display:flex; flex-direction:column; padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid ${isIncidencia ? '#dc2626' : '#e2e8f0'}; border-left:6px solid ${colorVivid}; background:${isIncidencia ? '#fff1f2' : '#fff'}; box-shadow:0 2px 4px rgba(0,0,0,0.04);`;

            row.innerHTML = `
                <div>
                    <div style="font-weight:800; font-size:0.95rem; color:#1e293b;">${isIncidencia ? '‚ö†Ô∏è ' : ''}${esc(name)}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                        <span style="font-size:0.75rem; color:#64748b; font-weight:700;">üïí ${esc(hVisual)}</span>
                        <span style="font-size:0.65rem; background:#eef2ff; color:#3730a3; padding:2px 6px; border-radius:4px; font-weight:800; text-transform:uppercase;">${esc(p.observaciones || "ALMAC√âN")}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid #f1f5f9;">
                    <div class="presence-toggle">
                        <input type="radio" name="att_${safeId}" id="u_${safeId}" value="undefined" ${currentAtt === "undefined" ? 'checked' : ''}>
                        <label for="u_${safeId}" style="padding:4px 10px; font-size:0.75rem;">‚ûñ</label>
                        <input type="radio" name="att_${safeId}" id="y_${safeId}" value="yes" ${currentAtt === true ? 'checked' : ''}>
                        <label for="y_${safeId}" class="yes" style="padding:4px 10px; font-size:0.75rem;">‚úÖ</label>
                        <input type="radio" name="att_${safeId}" id="n_${safeId}" value="no" ${currentAtt === false ? 'checked' : ''}>
                        <label for="n_${safeId}" class="no" style="padding:4px 10px; font-size:0.75rem;">‚ùå</label>
                    </div>
                    <select class="zone-select" style="flex:1; padding:6px; border-radius:8px; border:1px solid #cbd5e1; font-size:0.8rem; font-weight:700; background:#fff;">
                        <option value="" disabled ${!currentZone ? 'selected' : ''}>Zona...</option>
                        ${ZONES.map(z => `<option value="${esc(z)}" ${z === currentZone ? 'selected' : ''}>${esc(z)}</option>`).join('')}
                    </select>
                </div>
            `;

            row.querySelectorAll('input[type="radio"]').forEach(r => {
                r.addEventListener('click', () => {
                    let val = (r.value === 'yes') ? true : (r.value === 'no' ? false : undefined);
                    window.TEAM_STATE.attendance[name] = val;
                    if (typeof updatePresenceOnServer === 'function') updatePresenceOnServer(name, val);
                    updateTeamMeta(window.TEAM_STATE);
                });
            });

            listEl.appendChild(row);
        });
    });
    updateTeamMeta(window.TEAM_STATE);
}


async function initTeamRoster(){
    const listEl = document.getElementById('team-list');
    if(!listEl) return;
    
    const data = await fetchServerRoster();
    if (data && data.people) {
        renderRoster(listEl, data.people, data);
    }
}

async function syncServerAdd(name){
    const payload = {
        person: name,
        station: STATION_CODE,
        date: TEAM_STATE?.sheet_date || null,
        shift: TEAM_STATE?.shift || computeShift().name
    };
    const res = await fetch('api/roster/add', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    });
    if (res.ok) {
        const cur = await fetchServerRoster();
        if (cur) renderRoster(document.getElementById('team-list'), cur.people||[], cur);
        return true;
    }
    return false;
}

/* Upload roster Excel */
(function initRosterUpload(){
const form=document.getElementById('roster-upload-form');
const input=document.getElementById('roster-file');
const status=document.getElementById('roster-upload-result');
if (!form) return;
form.addEventListener('submit', async e=>{
e.preventDefault();
const f=input.files?.[0];
if(!f){ status.textContent='Selecciona un .xlsx/.xls'; return; }
const fd=new FormData();
fd.append('file', f);
status.textContent='Subiendo‚Ä¶';
try{
const res=await fetch('api/roster/upload',{method:'POST',body:fd});
const data=await res.json().catch(()=>({}));
if(!res.ok) throw new Error(data.detail||'Error al subir');
status.textContent = `OK: ${data.people_count||'-'} personas ‚Ä¢ Hoja: ${data.sheet_loaded||'‚Äî'} ‚Ä¢ Fecha: ${data.sheet_date||'‚Äî'}`;
const cur = await fetchServerRoster();
if (cur) renderRoster(document.getElementById('team-list'), cur.people||[], cur);
}catch(err){
status.textContent=`Error: ${err.message||err}`;
}finally{
input.value='';
}
});
})();



/* ==========================
Prev shift note (local)
========================== */
(function(){
const KEY='prev_shift_note_bcn_v1';
const KEY_WHEN='prev_shift_note_bcn_saved_v1';
const el=document.getElementById('prev-shift-note');
const hint=document.getElementById('prev-shift-saved-hint');
if (!el) return;
try{
const txt=localStorage.getItem(KEY);
if(txt!==null) el.textContent=txt;
const when=localStorage.getItem(KEY_WHEN);
if(when && hint) hint.textContent=`Guardado: ${new Date(when).toLocaleString('es-ES')}`;
}catch(e){}
let t;
const save=()=>{
try{
const plain=el.textContent||'';
localStorage.setItem(KEY, plain);
const now=new Date().toISOString();
localStorage.setItem(KEY_WHEN, now);
if (hint) hint.textContent=`Guardado: ${new Date(now).toLocaleString('es-ES')}`;
}catch(e){}
};
el.addEventListener('input', ()=>{
clearTimeout(t);
t=setTimeout(save, 400);
});
el.addEventListener('blur', save);
})();

/* ==========================
GW Top-3
========================== */
const GW_MAP = new Map();
function gwGetDate(t){
const cand = t.gw_date || t.last_date || t.last_done_at || t.updated_at || t.due_date || t.created_at || t.date;
const d = cand ? new Date(cand) : null;
return (d && !isNaN(d)) ? d.getTime() : -Infinity;
}
function renderGwTask(task, elementId){
const container=document.getElementById('gw-tasks-dynamic-container');
if(!container) return;
let el=document.getElementById(elementId);
const chkId=`gw-check-${task.id}`;
const noteId=`gw-note-${task.id}`;
if(!el){
el=document.createElement('div');
el.id=elementId;
container.prepend(el);
}
el.className='gw-task-item';
el.innerHTML=`
 <input type="checkbox" id="${chkId}" ${task.is_completed?'checked':''}>
 <label for="${chkId}">${esc(task.title||'')}</label>
 <input type="text" class="gw-note" id="${noteId}"
        placeholder="A√±adir nota (opcional)"
        ${task.is_completed?'':'disabled'}
        value="${task.note?esc(task.note):''}">
`;
el.classList.toggle('completed', !!task.is_completed);
el.classList.add('highlight-gw');
setTimeout(()=>el.classList.remove('highlight-gw'),2000);

const chk=el.querySelector('#'+chkId);
const note=el.querySelector('#'+noteId);
chk.addEventListener('change', async ()=>{
const done=chk.checked;
note.disabled = !done;
try{
await updateTaskCompletion(task.id, done);
el.classList.toggle('completed', done);
}catch(e){
chk.checked = !done;
note.disabled = chk.checked ? false : true;
}
});
note.addEventListener('blur', async ()=>{
try{ await updateTaskNote(task.id, note.value); }catch(e){}
});
}
function renderGwTop3(){
const cont=document.getElementById('gw-tasks-dynamic-container');
if(!cont) return;
cont.innerHTML='';
const top3=[...GW_MAP.values()]
.sort((a,b)=>gwGetDate(b)-gwGetDate(a))
.slice(0,3);
top3.slice().reverse().forEach(t=>renderGwTask(t, `task-${t.id}`));
}

/* ==========================
Incidentes / PDF
========================== */
const INC_CACHE_KEY='incidents_cache_bcn_v1';
function cacheIncidentes(state){
try{ localStorage.setItem(INC_CACHE_KEY, JSON.stringify(state)); }catch(e){}
}
function getCachedIncidentes(){
try{ return JSON.parse(localStorage.getItem(INC_CACHE_KEY)||'null'); }
catch{ return null; }
}

function renderIncidentes(state, targetId){
const tbl = document.getElementById(targetId || 'incidentes-table');
const meta= document.getElementById('incidentes-meta');
if (!tbl) return;

const cols = Array.isArray(state?.columns) ? state.columns : [];
const rows = Array.isArray(state?.rows) ? state.rows : [];
const ts   = state?.fetched_at ? new Date(state.fetched_at).toLocaleString('es-ES') : '‚Äî';

const rowsAreObjects = rows[0] && typeof rows[0]==='object' && !Array.isArray(rows[0]);
const norm = s=>String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'')
.replace(/\s+/g,' ').trim().toLowerCase();

const candidateCols = rowsAreObjects
? Array.from(new Set(rows.flatMap(r=>Object.keys(r||{}))))
: cols.slice();
const colNameByNorm = new Map(candidateCols.map(c=>[norm(c), c]));

const pick = (...aliases)=>{
for(const a of aliases){
const k=norm(a);
if (rowsAreObjects && colNameByNorm.has(k))
return {name:colNameByNorm.get(k), idx:cols.indexOf(colNameByNorm.get(k))};
if (!rowsAreObjects){
const i=cols.findIndex(c=>norm(c)===k);
if(i!==-1) return {name:cols[i], idx:i};
}
}
return null;
};

let selected = [
pick('Id','ID','Incident Id','IncidentId','Number','Reference','Incident No'),
pick('Accidente','Accident Title','incident_title','Title','Subject','Summary'),
pick('Status','State','Workflow Status','Current Status'),
pick('Priority','Severity','Risk Level','Criticality'),
pick('Category','Type','Incident Type','Classification','event_type'),
pick('Site','Location','Area','Department','Plant'),
pick('Created','Creation Date','Date','Reported On','Report Date','Start Date'),
pick('Due Date','Target Date','Deadline'),
pick('Owner','Assigned To','Assignee','Responsible','Manager')
].filter(Boolean);

if (!selected.length && candidateCols.length){
const base=candidateCols.slice(0,6);
selected = base.map(n=>({name:n, idx:cols.indexOf(n)}));
}

if (!selected.length){
tbl.innerHTML='<tbody><tr><td>Sin columnas reconocibles.</td></tr></tbody>';
if (meta) meta.textContent = `Filas: ${rows.length} ‚Ä¢ Actualizado: ${ts}`;
return;
}

let thead='<thead><tr>'+selected.map(c=>`<th>${esc(c.name)}</th>`).join('')+'</tr></thead>';
const MAX_ROWS = targetId ? 6 : 4;
const slice = rows.slice(0,MAX_ROWS);
let tbody='<tbody>';
for(const r of slice){
if (rowsAreObjects){
tbody+='<tr>'+selected.map(c=>`<td>${r?.[c.name]!=null?esc(String(r[c.name])):''}</td>`).join('')+'</tr>';
}else{
tbody+='<tr>'+selected.map(c=>`<td>${r?.[c.idx]!=null?esc(String(r[c.idx])):''}</td>`).join('')+'</tr>';
}
}
if (rows.length>MAX_ROWS){
tbody+=`<tr><td colspan="${selected.length}" style="color:var(--text-muted)">Mostrando ${MAX_ROWS} de ${rows.length}‚Ä¶</td></tr>`;
}
tbody+='</tbody>';
tbl.innerHTML = thead+tbody;
if (meta && !targetId){
meta.textContent = `Columnas: ${candidateCols.length} ‚Ä¢ Filas: ${rows.length} ‚Ä¢ Actualizado: ${ts}`;
}
}

async function loadIncidentes(){
const cached = getCachedIncidentes();
if (cached) renderIncidentes(cached);

try{
const r = await fetch('api/incidents-table',{cache:'no-store'});
if (!r.ok) throw new Error('GET /api/incidents-table');
const data = await r.json();
if (data.columns && data.rows){
renderIncidentes(data);
cacheIncidentes(data);
}
}catch(e){
console.warn('Incidentes error', e);
if (cached){
renderIncidentes(cached);
}
}
}

/* Upload PDF incidentes */
(function initIncidentsPdfUpload(){
const form=document.getElementById('incidents-pdf-form');
const input=document.getElementById('incidents-pdf-file');
const status=document.getElementById('incidents-pdf-status');
const wrap=document.getElementById('incidentes-pdf-wrap');
const tbl=document.getElementById('incidentes-pdf-table');
if (!form || !input || !status || !wrap || !tbl) return;

form.addEventListener('submit', async e=>{
e.preventDefault();
const f=input.files?.[0];
if (!f){ status.textContent='Selecciona un PDF'; return; }
const fd=new FormData();
fd.append('file', f);
status.textContent='Subiendo‚Ä¶';
try{
const res=await fetch('api/incidents-table',{method:'POST',body:fd});
const data=await res.json().catch(()=>({}));
if(!res.ok) throw new Error(data.detail||'Error al subir');
status.textContent=`OK: ${Array.isArray(data.rows)?data.rows.length:'-'} filas`;
wrap.style.display='block';
if (data.columns && data.rows){
renderIncidentes(data, 'incidentes-pdf-table');
}
}catch(err){
status.textContent=`Error: ${err.message||err}`;
}finally{
input.value='';
}
});
})();

/* ==========================
Incidentes (edici√≥n local)
========================== */
(function initIncidentEditableFields(){
const FIELDS = [
['incident-remember', 'inc_bcn_remember_v1'],
['incident-what',      'inc_bcn_what_v1'],
['incident-who',       'inc_bcn_who_v1'],
['incident-where',     'inc_bcn_where_v1']
];

FIELDS.forEach(([id, key])=>{
const el = document.getElementById(id);
if (!el) return;

// Carga inicial
try{
const saved = localStorage.getItem(key);
if (saved !== null) el.textContent = saved;
}catch(e){}

// Guardado (debounce)
let t;
const save = ()=>{
try{
localStorage.setItem(key, el.textContent || '');
}catch(e){}
};
el.addEventListener('input', ()=>{
clearTimeout(t);
t = setTimeout(save, 350);
});
el.addEventListener('blur', save);

// Accesibilidad: Enter inserta salto de l√≠nea (y no dispara nada extra√±o)
el.addEventListener('keydown', (e)=>{
if (e.key === 'Enter') {
document.execCommand?.('insertLineBreak');
e.preventDefault();
}
});
});
})();


function opsLoad(){
let sections = [];
let lines = '';
try{
sections = JSON.parse(localStorage.getItem(OPS_SECTIONS_KEY) || '[]');
}catch{}
try{
lines = localStorage.getItem(OPS_LINES_KEY) || '';
}catch{}
if (!Array.isArray(sections) || !sections.length){
sections = [{title:'Cambios turno', body:''}];
}
return {sections, lines};
}
function opsSave({sections, lines}){
try{ localStorage.setItem(OPS_SECTIONS_KEY, JSON.stringify(sections||[])); }catch{}
try{ localStorage.setItem(OPS_LINES_KEY, String(lines??'')); }catch{}
}

function opsSerializeFromDOM(){
    const cont = document.getElementById('ops-sections');
    const quick = document.getElementById('ops-quicklines');
    
    const sections = [...(cont?.querySelectorAll('.ops-section')||[])].map(sec=>{
        const t = sec.querySelector('.ops-section-title')?.textContent || '';
        const b = sec.querySelector('.ops-section-body')?.textContent || '';
        // NUEVO: Leer la fecha del input
        const d = sec.querySelector('.ops-section-date')?.value || ''; 
        
        return {title:t.trim(), body:b.trim(), date: d};
    });
    
    const lines = (quick?.textContent||'').trim();
    return {sections, lines};
}

function opsRender(data){
    const cont = document.getElementById('ops-sections');
    const quick = document.getElementById('ops-quicklines');
    if (!cont) return;

    cont.innerHTML = '';
    (data.sections||[]).forEach((s, idx)=>{
        const el = document.createElement('div');
        el.className = 'ops-section';
        
        // NUEVO HTML: Incluye el input type="date"
        el.innerHTML = `
           <div class="ops-section-title"
                role="textbox" aria-label="T√≠tulo de secci√≥n" contenteditable="true"
                data-placeholder="T√≠tulo de secci√≥n‚Ä¶">${esc(s.title||'')}</div>
                
           <div style="margin: 5px 0;">
               <label style="font-size:0.75rem; color:#6b7280; font-weight:700;">Vigente hasta:</label>
               <input type="date" class="ops-section-date" value="${s.date||''}" 
                      style="border:1px solid #e6e8ec; border-radius:6px; padding:4px; font-size:0.85rem;">
           </div>

           <div class="ops-section-body"
                role="textbox" aria-label="Contenido de secci√≥n" contenteditable="true"
                data-placeholder="Escribe las actualizaciones (una por l√≠nea)‚Ä¶">${esc(s.body||'')}</div>
                
           <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
             <button type="button" class="btn-compact" data-act="addline">+ L√≠nea</button>
             <button type="button" class="btn-compact" data-act="delete">Eliminar secci√≥n</button>
           </div>
         `;
        cont.appendChild(el);
    });

    if (quick){
        quick.textContent = data.lines || '';
    }
    
    // (El resto de la funci√≥n con los listeners se mantiene igual, 
    //  o puedes copiarla completa si prefieres asegurar)
    
    // ... listeners de edici√≥n y botones (addline/delete) ...
    let t;
    const scheduleSave = ()=>{
        clearTimeout(t);
        t = setTimeout(()=>{
            const state = opsSerializeFromDOM();
            opsSave(state);
        }, 300);
    };

    cont.addEventListener('input', scheduleSave);
    // Tambi√©n guardamos si cambia la fecha
    cont.addEventListener('change', (e) => {
        if(e.target.classList.contains('ops-section-date')) scheduleSave();
    });
    
    quick?.addEventListener('input', scheduleSave);

    cont.querySelectorAll('.ops-section').forEach(sec=>{
        sec.addEventListener('click', e=>{
            const btn = e.target.closest('[data-act]');
            if (!btn) return;
            const act = btn.getAttribute('data-act');
            if (act === 'addline'){
                const body = sec.querySelector('.ops-section-body');
                if (body){
                    body.focus();
                    document.execCommand?.('insertLineBreak');
                    scheduleSave();
                }
            }
            if (act === 'delete'){
                sec.remove();
                scheduleSave();
            }
        });
    });
}
function parseOpsLine(raw){
// Sintaxis:  "Texto libre #Etiqueta @Nombre >2025-11-18 !!"
const line=(raw||'').trim().replace(/\s+/g,' ');
if(!line) return null;

// Prioridad
let priority='Baja';
if(/\B!!\b/.test(line)) priority='Alta';
else if(/\B!\b/.test(line)) priority='Media';

// Etiquetas (#)
const tags=[...line.matchAll(/#([\p{L}\d_-]+)/gu)].map(m=>m[1]);

// Asignado (@)
const assigned=([...line.matchAll(/@([\p{L}\d][\p{L}\d._ -]{0,40})/gu)].pop()||[])[1]||null;

// Vencimiento (>)
const dueMatch= line.match(/>(\d{4}-\d{2}-\d{2})/);
const dueISO= dueMatch ? dueMatch[1] : null;

// T√≠tulo limpio (sin tokens)
const title=line
.replace(/\B!!\b|\B!\b/g,'')
.replace(/#[\p{L}\d_-]+/gu,'')
.replace(/@[\p{L}\d][\p{L}\d._ -]{0,40}/gu,'')
.replace(/>\d{4}-\d{2}-\d{2}/,'')
.trim();

// Secci√≥n por primera #Etiqueta si existe, si no "General"
const section = tags.length ? tags[0] : 'General';

return {
id: Date.now() + Math.random(),
raw: line,
title: title || line,
section,
tags,
priority,
assigned,
due_date: dueISO,
ts: Date.now(),
station: STATION_CODE,
archived: false,
};
}

function parseQuickLinesToList(){
const quick = document.getElementById('ops-quicklines');
const text = (quick?.textContent||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
return text.map(parseOpsLine).filter(Boolean);
}

function renderOpsLines(list){
const host = document.getElementById('ops-lines-list');
const search = document.getElementById('ops-search')?.value.trim().toLowerCase() || '';
const fPrio  = document.getElementById('ops-filter-prio')?.value || '';
if(!host) return;

// Filtrado
let data = list.slice();
if (fPrio) data = data.filter(x=>x.priority===fPrio);
if (search){
data = data.filter(x=>{
const hay = [
x.title, x.section, x.assigned, (x.tags||[]).join(' ')
].filter(Boolean).join(' ').toLowerCase();
return hay.includes(search);
});
}

// Orden: Alta‚ÜíMedia‚ÜíBaja y luego m√°s recientes
const orderPrio={Alta:0,Media:1,Baja:2};
data.sort((a,b)=> (orderPrio[a.priority]-orderPrio[b.priority]) || (b.ts - a.ts));

host.innerHTML='';
data.forEach(it=>{
const card = document.createElement('div');
card.className='ops-line-card';
card.setAttribute('role','listitem');
card.dataset.priority = it.priority;
card.innerHTML = `
   <div class="ops-line-head">
     <div class="ops-line-title">${esc(it.title)}</div>
     <div class="ops-line-meta">
       <span class="ops-badge ${it.priority==='Alta'?'prio-high':it.priority==='Media'?'prio-med':'prio-low'}">${esc(it.priority)}</span>
       ${it.section ? `<span class="ops-badge">#${esc(it.section)}</span>` : ''}
       ${it.assigned ? `<span>@${esc(it.assigned)}</span>` : ''}
       ${it.due_date ? `<span>‚è≤ ${new Date(it.due_date).toLocaleDateString('es-ES')}</span>` : ''}
       <span>${new Date(it.ts).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</span>
     </div>
   </div>
   <div class="ops-line-actions">
     <button class="ops-line-btn" data-act="kanban">Mandar al Kanban</button>
     <button class="ops-line-btn" data-act="pin">${it.archived?'Quitar pin':'Pin/Archivar'}</button>
     <button class="ops-line-btn" data-act="del">Eliminar</button>
   </div>
 `;
if (it.archived) card.classList.add('is-archived');
host.appendChild(card);

// acciones
card.querySelector('[data-act="kanban"]')?.addEventListener('click', async ()=>{
try{
await createTaskOnServer({
task_type:'kanban_rapida',
status:'Abiertas',
category:(it.section||'').toLowerCase(), // mapea con tu CAT_LABELS
title: it.title,
due_date: it.due_date || null,
assigned_to: it.assigned || null,
station: STATION_CODE
});
card.setAttribute('aria-selected','true');
setTimeout(()=>card.removeAttribute('aria-selected'), 1000);
}catch(e){ alert('No se pudo crear en Kanban.'); }
});

card.querySelector('[data-act="pin"]')?.addEventListener('click', ()=>{
it.archived = !it.archived;
saveRenderedOpsLines(list);
renderOpsLines(list);
});

card.querySelector('[data-act="del"]')?.addEventListener('click', ()=>{
const idx = list.findIndex(x=>x.id===it.id);
if (idx>-1){ list.splice(idx,1); saveRenderedOpsLines(list); renderOpsLines(list); }
});
});
}

const OPS_LINES_RENDER_KEY = opsKey('ops_lines_render_v1');
function loadRenderedOpsLines(){
try{ return JSON.parse(localStorage.getItem(OPS_LINES_RENDER_KEY)||'[]'); }catch{ return []; }
}
function saveRenderedOpsLines(list){
try{ localStorage.setItem(OPS_LINES_RENDER_KEY, JSON.stringify(list||[])); }catch{}
}


function initOpsUpdates() {
    const container = document.getElementById('ops-cards-container');
    const modal = document.getElementById('ops-modal');
    const form = document.getElementById('ops-form');
    
    // Funci√≥n para renderizar una tarjeta individual
    window.renderOpsCard = function(task) {
        if (task.task_type !== 'ops_update') return;
        
        // Eliminar si ya existe para actualizar
        const existing = document.getElementById(`task-${task.id}`);
        if (existing) existing.remove();

        const card = document.createElement('div');
        card.className = 'ops-card-item';
        card.id = `task-${task.id}`;
        card.dataset.prio = task.category || 'Baja'; // Usamos category para la prio

        const dateStr = task.due_date ? `üìÖ Hasta: ${new Date(task.due_date).toLocaleDateString()}` : 'Indefinido';

        card.innerHTML = `
            <div class="ops-card-title">${esc(task.title)}</div>
            <div class="ops-card-meta">
                <span class="ops-card-badge">${esc(task.assigned_to || 'General')}</span>
                <span>${dateStr}</span>
            </div>
            <div class="ops-card-actions">
                <button onclick="editOpsTask('${task.id}')" class="btn-compact">Editar</button>
                <button onclick="deleteTaskOnServer('${task.id}', 'ops_update')" class="btn-compact" style="color:#dc2626">Borrar</button>
            </div>
        `;
        container.prepend(card); // M√°s reciente arriba
    };

    // Abrir modal para nueva tarjeta
    document.getElementById('ops-btn-new').onclick = () => {
        form.reset();
        document.getElementById('ops-edit-id').value = '';
        modal.showModal();
    };

    // Guardar cambios (POST/PUT a la API de tareas)
    form.onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('ops-edit-id').value;
        
        const taskData = {
            task_type: 'ops_update',
            title: document.getElementById('ops-input-title').value,
            category: document.getElementById('ops-input-prio').value, // Prioridad
            assigned_to: document.getElementById('ops-input-scope').value, // Zona
            due_date: document.getElementById('ops-input-date').value || null,
            station: STATION_CODE
        };

        try {
            if (id) {
                await updateTaskOnServer(id, taskData);
            } else {
                await createTaskOnServer(taskData);
            }
            modal.close();
        } catch (err) {
            alert("Error al guardar la actualizaci√≥n operativa");
        }
    };

    // Carga inicial desde el servidor
    loadOpsInitial();
}

async function loadOpsInitial() {
    try {
        const res = await fetch(`api/tasks?task_type=ops_update&station=${STATION_CODE}`);
        const tasks = await res.json();
        const container = document.getElementById('ops-cards-container');
        container.innerHTML = tasks.length ? '' : '<div style="color:#94a3b8; text-align:center; padding:20px;">Sin actualizaciones pendientes.</div>';
        tasks.forEach(renderOpsCard);
    } catch (e) { console.error("Error cargando OPS:", e); }
}

// Global para editar
window.editOpsTask = async (id) => {
    // Aqu√≠ puedes implementar el fetch del objeto y rellenar el modal
    // Por brevedad, puedes buscarlo en el DOM o re-solicitar a la API
    const res = await fetch(`api/tasks/${id}`);
    const t = await res.json();
    document.getElementById('ops-edit-id').value = t.id;
    document.getElementById('ops-input-title').value = t.title;
    document.getElementById('ops-input-prio').value = t.category;
    document.getElementById('ops-input-scope').value = t.assigned_to;
    document.getElementById('ops-input-date').value = t.due_date || '';
    document.getElementById('ops-modal').showModal();
};


function reorderChecklist(){
    const grid = document.querySelector('#brief-check .check-grid');
    if(!grid) return;

    // Identificamos las tarjetas clave por su data-target
    const cardTeam = grid.querySelector('[data-target="team-widget"]');       // Dotaci√≥n
    const cardOps  = grid.querySelector('[data-target="ops-updates-widget"]');// Ops
    const cardPrev = grid.querySelector('[data-target="prev-shift-widget"]'); // Turno Anterior

    // ORDEN DESEADO: 1) Team, 2) Prev, 3) Ops
    // Insertamos en orden INVERSO al inicio para que queden apiladas correctamente:
    
    // Tu c√≥digo actual hace esto:
    if(cardPrev) grid.insertBefore(cardPrev, grid.firstElementChild); // 1. Pone Prev primero
    if(cardOps)  grid.insertBefore(cardOps,  grid.firstElementChild); // 2. Pone Ops primero (empuja Prev a 2¬∫)
    if(cardTeam) grid.insertBefore(cardTeam, grid.firstElementChild); // 3. Pone Team primero (empuja Ops a 2¬∫ y Prev a 3¬∫)

    // Resultado final en pantalla: Team -> Prev -> Ops -> [El resto]

    // Renumerar t√≠tulos para que coincidan (1), 2), 3)...)
    [...grid.children].forEach((c, idx)=>{
        const t = c.querySelector('.check-title');
        if(!t) return;
        // Limpiamos n√∫mero anterior y ponemos el nuevo √≠ndice
        const raw = t.textContent.replace(/^\s*\d+\)\s*/,''); 
        t.textContent = `${idx+1}) ${raw}`;
    });
}


/* ==========================
KPI Costes
========================== */
function formatEuro(n){
if (n==null || Number.isNaN(n)) return '‚Äî';
return new Intl.NumberFormat('es-ES',{
minimumFractionDigits:2,
maximumFractionDigits:2
}).format(n);
}
function updateKpiTotalCost(value, ts){
const v=document.getElementById('kpi-total-cost');
const m=document.getElementById('kpi-costes-meta');
const tile=document.getElementById('kpi-costes');
if (!v || !tile) return;
v.textContent = formatEuro(value);
if (m && ts){
m.textContent = `Actualizado: ${new Date(ts).toLocaleString('es-ES')}`;
}
tile.classList.remove('flash'); void tile.offsetWidth; tile.classList.add('flash');
}
function hydrateKpiTotalCost(){
try{
const cached = JSON.parse(localStorage.getItem('kpi_total_cost_'+STATION_CODE) || 'null');
if (cached && Number.isFinite(cached.value)){
updateKpiTotalCost(cached.value, cached.timestamp);
}
}catch(e){}
}

function formatPercent(n){
if (n==null || Number.isNaN(n)) return '‚Äî';
return new Intl.NumberFormat('es-ES',{minimumFractionDigits:1,maximumFractionDigits:1}).format(n);
}
function flash(el){
if(!el) return;
el.classList.remove('flash');
void el.offsetWidth;
el.classList.add('flash');
}
function setKpiValue(idValue, idMeta, valueText){
const v=document.getElementById(idValue);
const m=document.getElementById(idMeta);
if (!v) return;
v.textContent = valueText;
if (m) m.textContent = `Actualizado: ${new Date().toLocaleString('es-ES')}`;
const tile=v.closest('.kpi-tile');
if (tile) flash(tile);
}

/* ==========================
Tasks API helpers
========================== */
async function createTaskOnServer(data){
const r=await fetch('api/tasks',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(data)
});
if (!r.ok) throw new Error('create failed');
const task=await r.json();
processTaskUpdate(task);
return task;
}
async function updateTaskOnServer(id,data){
const r=await fetch(`api/tasks/${id}`,{
method:'PUT',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(data)
});
if (!r.ok) throw new Error('update failed');
const task=await r.json();
processTaskUpdate(task);
return task;
}
async function deleteTaskOnServer(id, taskType){
const r=await fetch(`api/tasks/${id}`,{method:'DELETE'});
if (!r.ok) throw new Error('delete failed');
processTaskUpdate({id,action:'delete',task_type:taskType||'kanban_rapida'});
}
async function updateTaskCompletion(id,done){
const r=await fetch(`api/tasks/${id}/complete`,{
method:'PUT',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({is_completed:done})
});
if (!r.ok) throw new Error('tick failed');
}
async function updateTaskNote(id,note){
const r=await fetch(`api/tasks/${id}/note`,{
method:'PUT',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({note:note??''})
});
if (!r.ok) throw new Error('note failed');
}

/* ==========================
Render tarjetas (Kanban, Kaizen, GW)
========================== */
const GRIP =
'<div class="drag-handle" aria-hidden="true" title="Arrastrar">'+
'<svg viewBox="0 0 24 24" fill="currentColor">'+
'<circle cx="7" cy="7" r="1.5"/><circle cx="7" cy="12" r="1.5"/><circle cx="7" cy="17" r="1.5"/>'+
'<circle cx="12" cy="7" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="17" r="1.5"/>'+
'</svg></div>';

function renderBoardCard(task, elementId){
const safeStatus=(task.status||'Abiertas').replace(/\s+/g,'-');
const columnId=`${task.task_type}-${safeStatus}`;
const col=document.getElementById(columnId);
if (!col) return;

let card=document.getElementById(elementId);
if (!card){
card=document.createElement('div');
card.id=elementId;
}
card.className='card';
card.dataset.status=safeStatus;
card.dataset.taskType='kanban_rapida';

const createdAt = task.created_at ? new Date(task.created_at) : null;
const creationDate = (createdAt && !isNaN(createdAt)) ? createdAt.toLocaleDateString('es-ES'): '‚Äî';
const dueISO = task.due_date || null;
const dueDate = dueISO ? new Date(dueISO) : null;
const dueHuman = (dueDate && !isNaN(dueDate)) ? dueDate.toLocaleDateString('es-ES'): '';

const catKey = String(task.category||'').toLowerCase();
const CAT_LABELS={
seguridad:'Seguridad',
incidencias:'Incidencias',
mantenimiento:'Mantenimiento',
calidad:'Calidad',
servicio:'Servicio'
};
const catLabel = CAT_LABELS[catKey] || 'General';

card.classList.remove('cat-seguridad','cat-incidencias','cat-mantenimiento','cat-calidad','cat-servicio');
if (['seguridad','incidencias','mantenimiento','calidad','servicio'].includes(catKey)){
card.classList.add(`cat-${catKey}`);
}

card.innerHTML=`
 ${GRIP}
 <div class="card-content">
   <div class="card-title" data-edit="title">${esc(task.title||'')}</div>
   <div class="card-details">
     Alta: ${creationDate} ‚Ä¢ Objetivo:
     <button class="btn-compact" data-edit="due">${dueHuman || '‚Äî'}</button>
   </div>
   <div class="card-assignee">
     Responsable:
     <span class="assignee" data-edit="assigned_to">${esc(task.assigned_to || 'Sin asignar')}</span>
   </div>
   <div style="margin-top:6px;">
     <button class="btn-compact" data-edit="category">${catLabel}</button>
   </div>
 </div>
 <div class="card-actions">
   <button class="delete-card-btn" title="Eliminar">
     <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
       <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
       <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
     </svg>
   </button>
 </div>
`;
// en renderBoardCard(), tras construir innerHTML:
const content = card.querySelector('.card-content');
if (content && !content.querySelector('.cat-chip')) {
const chip = document.createElement('span');
chip.className = 'cat-chip';
chip.textContent = catLabel;
content.querySelector('.card-title')?.appendChild(chip);
}

ensureFullscreenBtn(card);
if (card.parentElement !== col) col.prepend(card);

const id=task.id;

// Ediciones r√°pidas
card.querySelector('[data-edit="title"]')?.addEventListener('click', async()=>{
const prev=task.title||'';
const next=(prompt('Nuevo t√≠tulo', prev)||'').trim();
if(next && next!==prev){
try{ await updateTaskOnServer(id,{title:next}); }catch(e){ alert('No se pudo actualizar'); }
}
});
const asg=card.querySelector('[data-edit="assigned_to"]');
asg?.addEventListener('click', async()=>{
const prev=task.assigned_to||'';
const next=(prompt('Responsable', prev)||'').trim();
if(next!==prev){
try{ await updateTaskOnServer(id,{assigned_to:next||null}); }catch(e){ alert('No se pudo actualizar'); }
}
});
const dueBtn=card.querySelector('[data-edit="due"]');
dueBtn?.addEventListener('click', ()=>{
const input=document.createElement('input');
input.type='date';
input.value=dueISO||'';
input.style.position='fixed';
input.style.opacity='0';
document.body.appendChild(input);
input.addEventListener('change', async()=>{
const newISO=input.value||null;
document.body.removeChild(input);
if (newISO!==dueISO){
try{ await updateTaskOnServer(id,{due_date:newISO}); }catch(e){ alert('No se pudo actualizar'); }
}
},{once:true});
input.click();
});
const catBtn=card.querySelector('[data-edit="category"]');
catBtn?.addEventListener('click', async()=>{
const opts=['Seguridad','Incidencias','Mantenimiento','Calidad','Servicio','General'];
const prev=catLabel;
const next=(prompt(`Categor√≠a (${opts.join(' / ')})`, prev)||prev).trim();
const map={
Seguridad:'seguridad',Incidencias:'incidencias',Mantenimiento:'mantenimiento',
Calidad:'calidad',Servicio:'servicio',General:''
};
const val = map[next] ?? map[prev];
if (val !== (task.category||'')){
try{ await updateTaskOnServer(id,{category:val}); }catch(e){ alert('No se pudo actualizar'); }
}
});
}

function renderKaizenCard(task, elementId){
const safeStatus=(task.status||'Proyectos').replace(/\s+/g,'-');
const columnId=`kaizen-${safeStatus}`;
const col=document.getElementById(columnId);
if (!col) return;
let card=document.getElementById(elementId);
if (!card){
card=document.createElement('div');
card.id=elementId;
}
card.className='card';
card.dataset.status=safeStatus;
card.dataset.taskType='kaizen';

const dueISO = task.due_date || null;
const dueDate = dueISO ? new Date(dueISO) : null;
const dueHuman = (dueDate && !isNaN(dueDate)) ? dueDate.toLocaleDateString('es-ES'): '';

card.innerHTML=`
 ${GRIP}
 <div class="card-content">
   <div class="card-title">${esc(task.title||'')}</div>
   <div class="card-details">
     ${task.assigned_to ? 'Responsable: '+esc(task.assigned_to) : 'Responsable: ‚Äî'}
     ${dueHuman ? ' ‚Ä¢ Fecha m√°x: '+dueHuman : ''}
   </div>
 </div>
 <div class="card-actions">
   <button class="delete-card-btn" title="Eliminar">
     <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
       <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
       <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
     </svg>
   </button>
 </div>
`;
ensureFullscreenBtn(card);
if (card.parentElement !== col) col.prepend(card);
}

/* ==========================
Column counts / Sortable
========================== */
function updateAllColumnCounts(){
document.querySelectorAll('#kanban-widget .kanban-column').forEach(col=>{
const c=col.querySelector('.column-title .count');
const cards=col.querySelector('.cards-container');
if(c&&cards) c.textContent = `(${cards.children.length})`;
});
document.querySelectorAll('#kaizen-widget .kanban-column').forEach(col=>{
const c=col.querySelector('.column-title .count');
const cards=col.querySelector('.cards-container');
if(c&&cards) c.textContent = `(${cards.children.length})`;
});
}
function makeColumnsSortable(){
    const common = {
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        handle: '.drag-handle', // Solo se mueve si tocan el icono del grip
        
        // --- CONFIGURACI√ìN CR√çTICA PARA TABLETS ANDROID ---
        forceFallback: true,      // Forzar el arrastre por JS (ignora el nativo de Chrome que falla)
        fallbackTolerance: 3,     // P√≠xeles que debe moverse el dedo para considerar que es un arrastre
        delay: 0,                 // Respuesta inmediata al tocar
        delayOnTouchOnly: false,
        touchStartThreshold: 3,   // Sensibilidad al tacto
        // --------------------------------------------------
        
        onEnd: handleDragEnd
    };

    // Aplicar a las columnas de Kanban
    document.querySelectorAll('#kanban-widget .cards-container')
        .forEach(c => new Sortable(c, { group:'kanban-board', ...common }));

    // Aplicar a las columnas de Kaizen
    document.querySelectorAll('#kaizen-widget .cards-container')
        .forEach(c => new Sortable(c, { group:'kaizen-board', ...common }));
}
async function handleDragEnd(evt){
const {item,to,from,oldIndex} = evt;
if(to===from){ updateAllColumnCounts(); return; }
const id=item.id.replace('task-','');
const st=to.dataset.status;
try{
await updateTaskOnServer(id,{status:st});
}catch(e){
from.insertBefore(item, from.children[oldIndex] || null);
alert('No se pudo actualizar el estado en servidor.');
}finally{
updateAllColumnCounts();
}
}

/* ==========================
Formularios Kanban/Kaizen
========================== */
function setupEventListeners() {
    // Formularios Kanban y Kaizen
    document.getElementById('new-kanban-form')?.addEventListener('submit', handleKanbanSubmit);
    document.getElementById('new-kaizen-form')?.addEventListener('submit', handleKaizenSubmit);
    
    // Click global (para borrar tarjetas)
    document.addEventListener('click', handleDeleteClick);

    // --- CORRECCI√ìN CR√çTICA PARA GW (Gemba Walk) ---
    // Ya no buscamos el ID 'rotativas-widget' porque lo borramos.
    // Usamos delegaci√≥n de eventos en el documento.
    
    // 1. Checkbox de completado
    document.addEventListener('change', (e) => {
        // La funci√≥n handleGwTick ya verifica si es un checkbox v√°lido
        if (typeof handleGwTick === 'function') {
            handleGwTick(e);
        }
    });

    // 2. Notas (Enter y Escape)
    document.addEventListener('keydown', (e) => {
        const note = e.target.closest('.gw-note') ? e.target : null;
        if (!note) return;

        if (e.key === 'Enter') {
            e.preventDefault();
            const id = note.id.replace('gw-note-', '');
            // Verificamos que la funci√≥n exista antes de llamar
            if(typeof updateTaskNote === 'function') updateTaskNote(id, note.value).catch(console.error);
            note.blur();
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            note.blur();
        }
    });

    // 3. Notas (Al perder el foco / Blur)
    document.addEventListener('blur', (e) => {
        if (e.target.classList && e.target.classList.contains('gw-note')) {
            const id = e.target.id.replace('gw-note-', '');
            if(typeof updateTaskNote === 'function') updateTaskNote(id, e.target.value).catch(console.error);
        }
    }, true); 
}

const gwContainer=document.getElementById('gw-tasks-dynamic-container');
gwContainer?.addEventListener('change', e=>{
if (e.target.classList.contains('gw-note')) return;
});

async function handleKanbanSubmit(e){
e.preventDefault();
const f=e.target;
const taskData={
task_type:'kanban_rapida',
status:'Abiertas',
category:(f.elements.category?.value||'').trim().toLowerCase(),
title:(f.elements.title?.value||'').trim(),
due_date:f.elements.due_date?.value || null,
assigned_to:(f.elements.assigned_to?.value||'').trim() || null,
station:STATION_CODE
};
if (!taskData.category || !taskData.title || !taskData.due_date) return;
try{
await createTaskOnServer(taskData);
f.reset();
document.getElementById('problem-category').selectedIndex = 0;
updateAllColumnCounts();
}catch(err){
console.error(err);
alert('No se pudo crear la tarjeta.');
}
}
async function handleKaizenSubmit(e){
e.preventDefault();
const f=e.target;
const taskData={
task_type:'kaizen',
status:'Proyectos',
title:(f.elements.title?.value||'').trim(),
assigned_to:(f.elements.assigned_to?.value||'').trim(),
due_date:f.elements.due_date?.value || null,
station:STATION_CODE
};
if (!taskData.title) return;
try{
await createTaskOnServer(taskData);
f.reset();
updateAllColumnCounts();
}catch(err){
alert('No se pudo crear el KAIZEN.');
}
}
function handleDeleteClick(e){
const btn=e.target.closest('.delete-card-btn');
if (!btn) return;
const card=btn.closest('.card');
if (!card) return;
const id=card.id.replace('task-','');
const type=card.dataset.taskType || 'kanban_rapida';
if (confirm('¬øEliminar esta tarjeta?')){
deleteTaskOnServer(id, type).catch(()=>alert('No se pudo eliminar.'));
}
}

/* ==========================
WebSocket + processTaskUpdate
========================== */
function connectWebSocket(){
const wsUrl = `${location.protocol==='https:'?'wss:':'ws:'}//${location.host}/ws`;
const socket = new WebSocket(wsUrl);
socket.onopen = ()=>console.log('WS conectado');
socket.onmessage = ev=>{
try{
const data = JSON.parse(ev.data);
processTaskUpdate(data);
}catch(e){ console.error('WS parse', e); }
};
socket.onclose = ()=> setTimeout(connectWebSocket, 3000);
socket.onerror = err=>{
console.error('WS error', err);
socket.close();
};
}

/* processTaskUpdate central BCN+MAD */
function processTaskUpdate(data){
if (!data) return;

// Filtrado por estaci√≥n
if (!isForThisStation(data)) return;

if (data.task_type === 'ops_update') {
        if (data.action === 'delete') {
            document.getElementById(`task-${data.id}`)?.remove();
        } else {
            window.renderOpsCard(data);
        }
        return;
    }

// Actualizaciones roster
if (data.type === 'roster_update'){
renderRoster(document.getElementById('team-list'), data.people||[], data);
return;
}

// GW / tablas / etc
if (data.type === 'table_ping' || data.type === 'table_state'){
if (data.table === 'incidents'){
loadIncidentes();
}
return;
}

if (data.type === 'kpi_update') {
        const keys = Object.keys(data);
        // Si el paquete contiene claves de BCN, las procesamos
        if (keys.some(k => k.includes('bcn'))) {
            keys.forEach(k => {
                if (k.startsWith('fiix_')) updateFiixDisplay(k, data[k]);
            });
            return; // Detener aqu√≠
        }
    }
    // -

// Delete
if (data.action === 'delete' && data.id != null){
const el=document.getElementById(`task-${data.id}`);
if (el) el.remove();
if (data.task_type === 'gw_task'){
GW_MAP.delete(data.id);
renderGwTop3();
}
updateAllColumnCounts();
return;
}

// Render seg√∫n tipo
if (data.task_type === 'gw_task'){
GW_MAP.set(data.id, data);
renderGwTop3();
return;
}
if (data.task_type === 'kanban_rapida'){
renderBoardCard(data, `task-${data.id}`);
updateAllColumnCounts();
return;
}
if (data.task_type === 'kaizen'){
renderKaizenCard(data, `task-${data.id}`);
updateAllColumnCounts();
return;
}
}

/* ==========================
Checklist compact (persist)
========================== */
(function(){
const host=document.getElementById('brief-check');
if (!host) return;
const meta=document.getElementById('brief-check-meta');
const KEY='brief_check_bcn_v1';

function save(){
const data={};
host.querySelectorAll('.check-actions input:checked')
.forEach(i=> data[i.name]=i.value);
try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){}
}
function load(){
try{
const data=JSON.parse(localStorage.getItem(KEY)||'{}');
Object.entries(data).forEach(([n,v])=>{
const el=host.querySelector(`input[name="${n}"][value="${v}"]`);
if (el) el.checked=true;
});
}catch(e){}
}
function recalc(){
const groups=[...new Set([...host.querySelectorAll('.check-actions input')]
.map(i=>i.name))];
const ok=groups.filter(n=>{
const sel=host.querySelector(`input[name="${n}"]:checked`);
return sel && sel.value==='OK';
}).length;
const cov = groups.length ? Math.round(ok/groups.length*100) : 0;
if (meta) meta.textContent=`Bloques OK: ${ok}/${groups.length} ¬∑ Cobertura: ${cov}%`;
}

function bump(){
save();
recalc();
updateSpotlightRouting?.();
}

load();
recalc();
updateSpotlightRouting?.();

host.addEventListener('change', e=>{
if (e.target.matches('.check-actions input')) bump();
});
})();

/* ==========================
Spotlight routing
========================== */
function rosterComplete(){
const total=(TEAM_STATE?.people||[]).length;
if (!total) return false;
const att=TEAM_STATE?.attendance||{};
return TEAM_STATE.people.every(p=>{
const k=p.nombre_completo || '‚Äî';
return att[k] === true || att[k] === false;
});
}
function readC(name){
const sel=document.querySelector(`#brief-check input[name="${name}"]:checked`);
return sel ? sel.value : null;
}
function setSpotlight(ids){
const ALL=['team-widget','prev-shift-widget','rotativas-widget','incidentes-widget','kanban-widget','kpi-costes','ops-updates-widget','safety-daily-widget'];
ALL.forEach(id=>{
const el=document.getElementById(id);
if (!el) return;
el.classList.toggle('spotlight-blink', ids.includes(id));
});
}
function updateSpotlightRouting(){
if (!rosterComplete()) return setSpotlight(['team-widget']);
if (readC('c1')!=='OK') return setSpotlight(['ops-updates-widget']);
if (readC('c2')!=='OK') return setSpotlight(['prev-shift-widget']);
if (readC('c3')!=='OK') return setSpotlight(['team-widget']);
if (readC('c4')!=='OK') return setSpotlight(['safety-daily-widget']);
if (readC('c5')!=='OK') return setSpotlight(['incidentes-widget']);
if (readC('c6')!=='OK') return setSpotlight(['kpi-costes']);
if (readC('c7')!=='OK') return setSpotlight(['kanban-widget']);
setSpotlight([]);
}
window.updateSpotlightRouting = updateSpotlightRouting;

/* Checklist ‚Üí abrir widgets */
function openWidgetFromChecklist(targetId){
if (!targetId) return;
const el = document.getElementById(targetId);
if (!el) {
console.warn('Checklist target no encontrado:', targetId);
return;
}

// Llevarlo a la vista
el.scrollIntoView({ behavior:'smooth', block:'center' });

// Asegurar bot√≥n de fullscreen
try { ensureFullscreenBtn(el); } catch {}

// Intentar fullscreen real
if (el.requestFullscreen) {
el.requestFullscreen({ navigationUI: 'hide' }).catch(() => {
// Fallback visual si el navegador bloquea fullscreen
el.classList.add('widget--zoomed');
setTimeout(()=> el.classList.remove('widget--zoomed'), 120000);
});
} else {
// Fallback en navegadores sin API
el.classList.add('widget--zoomed');
setTimeout(()=> el.classList.remove('widget--zoomed'), 120000);
}
}

/* =========================================================
   2. TARJETA 5: INCIDENTES (SOLUCI√ìN RECARGA Y CLAVE UNIFICADA)
   ========================================================= */
/* =========================================================
   L√ìGICA FIIX BARCELONA (Visualizaci√≥n)
   ========================================================= */

function updateFiixDisplay(metric, value) {
    const mapping = {
        'fiix_bcn_availability': 'fiix-availability',
        'fiix_bcn_damage_count_24h': 'fiix-damage-24h'
    };

    // Actualizar el texto descriptivo de qu√© m√°quinas est√°n rotas
    if (metric === 'fiix_bcn_broken_text') {
        const el = document.getElementById('fiix-broken-text');
        if (el) {
            el.textContent = value;
            // Si el texto contiene la se√±al de peligro, ponerlo en rojo y negrita
            if (value.includes('‚ö†Ô∏è')) {
                el.style.color = "#dc2626";
                el.style.fontWeight = "800";
            } else {
                el.style.color = "var(--text-muted)";
                el.style.fontWeight = "400";
            }
        }
        return;
    }

    const targetId = mapping[metric];
    const el = document.getElementById(targetId);
    if (el) {
        el.textContent = value;
        
        // Cambio de color din√°mico del porcentaje
        if (metric === 'fiix_bcn_availability') {
            const tile = el.closest('.kpi-tile');
            if (tile) {
                // Si la disponibilidad de carretillas baja del 90%, borde rojo
                tile.style.borderLeftColor = value < 90 ? '#ef4444' : '#10b981';
                tile.style.backgroundColor = value < 90 ? '#fef2f2' : '#fff';
            }
        }
    }
}
    
    

// Carga inicial
async function initFiixDashboard() {
    try {
        console.log("üîÑ [BCN] Cargando Fiix...");
        const res = await fetch('api/fiix/current'); 
        if (!res.ok) return;
        
        const data = await res.json();
        console.log("üì• [BCN] Fiix Data:", data);

        // Si el objeto est√° vac√≠o, reintenta
        if (Object.keys(data).length === 0) {
            setTimeout(initFiixDashboard, 3000);
            return;
        }

        Object.keys(data).forEach(key => {
            updateFiixDisplay(key, data[key]);
        });
    } catch (e) {
        console.error("Error cargando Fiix BCN:", e);
    }
}


    
(function initManualIncidents() {
    // Usamos una clave consistente para que el generador de resumen la encuentre
    const KEY = 'safety_manual_incidents_v1'; 
    const listEl = document.getElementById('incidents-list-container');
    const form = document.getElementById('manual-inc-form');
    
    if (!listEl || !form) return;

    const load = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch (e) { return []; } };
    const save = (data) => { localStorage.setItem(KEY, JSON.stringify(data)); };
    
    const render = () => {
        const items = load();
        listEl.innerHTML = items.length ? '' : '<div style="text-align:center;padding:20px;color:#9ca3af;">No hay incidentes registrados hoy.</div>';
        items.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
            const card = document.createElement('div');
            const typeClass = item.type === 'incident' ? 'type-incident' : 'type-lesson';
            const badgeText = item.type === 'incident' ? 'üî¥ INCIDENTE' : 'üí° LECCI√ìN';
            card.className = `inc-card ${typeClass}`;
            card.style.marginBottom = "10px";
            card.innerHTML = `
                <div class="inc-header">
                    <div>
                        <span class="inc-badge" style="font-weight:800; font-size:0.7rem; padding:2px 6px; border-radius:4px;">${badgeText}</span>
                        <div class="inc-title" style="margin-top:4px; font-weight:700;">${esc(item.title)}</div>
                    </div>
                    <button type="button" class="inc-del-btn" data-id="${item.id}" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button>
                </div>
                <div class="inc-desc" style="font-size:0.9rem; color:#4b5563; margin-top:5px; white-space:pre-wrap;">${esc(item.desc)}</div>`;
            listEl.appendChild(card);
        });
    };

    // FIX: Capturar el submit correctamente
    form.addEventListener('submit', function(e) {
        e.preventDefault(); 
        e.stopPropagation();

        const typeVal = document.getElementById('new-inc-type').value;
        const titleVal = document.getElementById('new-inc-title').value.trim();
        const descVal = document.getElementById('new-inc-desc').value.trim();

        if (!titleVal) return;

        const items = load();
        items.push({ 
            id: Date.now().toString(), 
            type: typeVal, 
            title: titleVal, 
            desc: descVal, 
            date: new Date().toISOString() 
        });
        
        save(items);
        form.reset();
        render();
        console.log("‚úÖ Incidente guardado en memoria local");
    });

    listEl.onclick = function(e) {
        const btn = e.target.closest('.inc-del-btn');
        if (btn && confirm("¬øBorrar registro?")) {
            save(load().filter(i => i.id !== btn.dataset.id));
            render();
        }
    };
    render();
})();
    
(function initBriefExplain(){
const host   = document.getElementById('brief-check');
if (!host) return;

const targetText = host.querySelector('#brief-check-explain .br-explain-text');
const DEFAULT_MSG = 'Pasa el rat√≥n o toca para ver la gu√≠a. Haz clic para abrir el bloque correspondiente.';

const setText = (t)=> {
if (targetText) targetText.textContent = t || DEFAULT_MSG;
};

host.querySelectorAll('.check-card').forEach(card => {
const msg =
card.getAttribute('data-help') ||
card.querySelector('.check-title')?.textContent ||
'';
// Soportar tanto data-target como el posible typo data-targer
const targetId =
card.getAttribute('data-target') ||
card.getAttribute('data-targer') ||
'';
if (targetId) {
card.setAttribute('role', 'button');
card.setAttribute('aria-controls', targetId);
}


// Hover / foco: texto explicativo
card.addEventListener('mouseenter', ()=> setText(msg));
card.addEventListener('mouseleave', ()=> setText());
card.addEventListener('focusin',    ()=> setText(msg));
card.addEventListener('focusout',   ()=> setText());

// Click en la tarjeta ‚Üí abrir widget en fullscreen
card.addEventListener('click', (e)=>{
// No interceptar clics en radios/labels
if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
if (targetId) {
e.preventDefault();
openWidgetFromChecklist(targetId);
}
});

// Teclado: Enter o Space con foco en la tarjeta
card.addEventListener('keydown', (e)=>{
if (e.key === 'Enter' || e.key === ' ') {
if (targetId) {
e.preventDefault();
openWidgetFromChecklist(targetId);
}
}
});
});

setText();
})();


/* ==========================
Carga inicial
========================== */
async function loadBoardsInitial(){
try{
const qs = 'station='+encodeURIComponent(STATION_CODE);
const [kanRes,kaiRes,gwRes] = await Promise.all([
fetch('api/tasks?task_type=kanban_rapida&'+qs,{cache:'no-store'}),
fetch('api/tasks?task_type=kaizen&'+qs,{cache:'no-store'}),
fetch('api/tasks?task_type=gw_task&'+qs,{cache:'no-store'})
]);
const [kan,kai,gw] = await Promise.all([
kanRes.json().catch(()=>[]),
kaiRes.json().catch(()=>[]),
gwRes.json().catch(()=>[])
]);
(Array.isArray(kan)?kan:[]).filter(isForThisStation)
.forEach(t=>processTaskUpdate(t));
(Array.isArray(kai)?kai:[]).filter(isForThisStation)
.forEach(t=>processTaskUpdate(t));
(Array.isArray(gw)?gw:[]).filter(isForThisStation)
.forEach(t=>{
if (t.task_type==='gw_task'){
GW_MAP.set(t.id,t);
}
});
renderGwTop3();
updateAllColumnCounts();
}catch(e){
console.error('loadBoardsInitial', e);
}
}
 // 4. SISTEMA DE VOZ (MICR√ìFONO)
function openSupportModal() {
    document.getElementById('support-form').style.display = 'block';
    document.getElementById('support-thanks').style.display = 'none';
    document.getElementById('issue-details').value = '';
    document.getElementById('support-modal').showModal();
}

async function sendDashboardIssue() {
    const typeEl = document.getElementById('issue-type');
    const detailsEl = document.getElementById('issue-details');
    const supervisorEl = document.getElementById('briefing-supervisor');
    const btn = document.getElementById('btn-submit-support');

    const type = typeEl ? typeEl.value : "No especificado";
    const details = detailsEl ? detailsEl.value.trim() : "";
    
    if (!details) return alert("Por favor, describe el error.");

    // Identificaci√≥n autom√°tica muy espec√≠fica
    const stationIdentity = `${document.title} (Ruta: ${window.location.pathname})`;

    btn.disabled = true;
    btn.textContent = "Enviando...";

    try {
        const payload = {
            estacion: String(stationIdentity),
            supervisor: supervisorEl ? String(supervisorEl.value) : "Supervisor Almac√©n",
            tipo_fallo: String(type),
            detalles: String(details)
        };

        // Log para que veas en la consola del navegador qu√© est√°s enviando
        console.log("üì¶ Payload enviado a soporte:", payload);

        const res = await fetch('api/report-dashboard-issue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.status === 422) {
            const errorJson = await res.json();
            console.error("‚ùå Error de validaci√≥n 422:", errorJson);
            alert("Error de formato de datos. Revisa la consola.");
        } else if (res.ok) {
            document.getElementById('display-station-name').textContent = stationIdentity;
            document.getElementById('support-form').style.display = 'none';
            document.getElementById('support-thanks').style.display = 'block';
        } else {
            alert("Error en el env√≠o. C√≥digo: " + res.status);
        }
    } catch (e) {
        alert("Fallo de conexi√≥n con el servidor.");
    } finally {
        btn.disabled = false;
        btn.textContent = "AVISAR A SOPORTE";
    }
}
    (function initVoiceSystem() {
        console.log("üé§ Inicializando sistema de voz...");
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        // Comprobaciones de seguridad y soporte
        const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
        if (!SpeechRecognition) return console.warn("‚ùå API de voz no soportada.");
        
        const recognition = new SpeechRecognition();
        recognition.lang = 'es-ES';
        recognition.continuous = false;
        recognition.interimResults = false;

        let activeBtn = null;
        let activeTarget = null;

        recognition.onstart = () => { if (activeBtn) activeBtn.classList.add('listening'); };
        recognition.onend = () => { 
            if (activeBtn) activeBtn.classList.remove('listening'); 
            activeBtn = null; 
            activeTarget = null; 
        };

        recognition.onresult = (event) => {
            if (!activeTarget) return;
            const transcript = event.results[0][0].transcript;
            const isInput = activeTarget.tagName === 'INPUT' || activeTarget.tagName === 'TEXTAREA';
            
            // Obtener texto actual para no borrar lo anterior
            let currentText = isInput ? activeTarget.value : activeTarget.innerText;
            currentText = currentText || "";
            
            // A√±adir espacio si ya hay texto
            const prefix = (currentText.length > 0 && !currentText.endsWith(' ')) ? ' ' : '';
            const finalText = prefix + transcript.charAt(0).toUpperCase() + transcript.slice(1);

            if (isInput) activeTarget.value = currentText + finalText;
            else activeTarget.innerText = currentText + finalText;

            // Disparar evento para que se guarde autom√°ticamente
            activeTarget.dispatchEvent(new Event('input', { bubbles: true }));
        };

        recognition.onerror = (event) => {
            if (activeBtn) activeBtn.classList.remove('listening');
            if (event.error === 'not-allowed') alert("‚ö†Ô∏è Permiso denegado. Pulsa el candado üîí de la URL.");
        };

        // Delegaci√≥n de eventos para los botones .btn-mic
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-mic');
            if (!btn) return;
            e.preventDefault(); e.stopPropagation();

            if (!isSecure) { alert("‚ö†Ô∏è El micr√≥fono requiere HTTPS."); return; }
            if (btn.classList.contains('listening')) { recognition.stop(); return; }

            const targetId = btn.getAttribute('data-target');
            const targetEl = document.getElementById(targetId);

            if (targetEl) {
                activeBtn = btn;
                activeTarget = targetEl;
                try { recognition.start(); } catch (err) { recognition.stop(); }
            } else {
                alert("Error: No encuentro el campo de texto destino.");
            }
        });
    })();
/* =========================================================
   MEJORAS BCN: Navegaci√≥n, Reset y Modo Info
   ========================================================= */

// --- 1. FUNCIONES GLOBALES DE NAVEGACI√ìN Y PANTALLA INFO ---

window.navTo = function(targetId) {
    if (!targetId) return;
    if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
    document.querySelectorAll('.widget--zoomed').forEach(el => el.classList.remove('widget--zoomed'));

    setTimeout(() => {
        const el = document.getElementById(targetId);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            if (el.requestFullscreen) {
                el.requestFullscreen({ navigationUI: 'hide' }).catch(() => el.classList.add('widget--zoomed'));
            } else {
                el.classList.add('widget--zoomed');
            }
        }
    }, 100);
};

window.exitFlow = function() {
    if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
    document.querySelectorAll('.widget--zoomed').forEach(el => el.classList.remove('widget--zoomed'));
    if(window.updateSpotlightRouting) window.updateSpotlightRouting();
};

window.markOkAndNext = function(checkName, nextId) {
    // 1. Marcar OK
    if (checkName) {
        const radio = document.querySelector(`input[name="${checkName}"][value="OK"]`);
        if (radio) {
            radio.checked = true;
            radio.dispatchEvent(new Event('change', { bubbles: true }));
            radio.dispatchEvent(new Event('input', { bubbles: true }));
        }
    }
    // 2. Navegar
    if (nextId) {
        navTo(nextId);
    } else {
        exitFlow();
        document.querySelector('header').scrollIntoView({behavior:'smooth'});
        setTimeout(() => alert("üéâ Checklist completado. Puedes generar el resumen."), 300);
    }
};

window.openPostBriefingMode = function() {
    const screen = document.getElementById('post-briefing-screen');
    if (!screen) return;

    // Rellenar datos
    const prev = document.getElementById('prev-shift-note')?.innerText || "Sin novedades.";
    document.getElementById('pb-prev-content').innerHTML = `<p>${prev.replace(/\n/g,'<br>')}</p>`;

    // Ops (clonar lista visual)
    const opsList = document.getElementById('ops-lines-list');
    const opsDest = document.getElementById('pb-ops-content');
    opsDest.innerHTML = '';
    if(opsList && opsList.children.length > 0){
        Array.from(opsList.children).forEach(c => {
            const clone = c.cloneNode(true);
            const actions = clone.querySelector('.ops-line-actions');
            if(actions) actions.remove(); // quitar botones
            clone.style.boxShadow = "none";
            clone.style.border = "1px solid #e2e8f0";
            clone.style.marginBottom = "10px";
            opsDest.appendChild(clone);
        });
    } else {
        opsDest.innerHTML = '<p style="color:#94a3b8">Sin actualizaciones operativas.</p>';
    }

    // KPIs
    const uph = document.getElementById('kpi-uph')?.innerText || "-";
    const cost = document.getElementById('kpi-total-cost')?.innerText || "-";
    document.getElementById('pb-val-uph').textContent = uph;
    document.getElementById('pb-val-cost').textContent = cost + ' ‚Ç¨';

    // Seguridad
    const tips = document.getElementById('safety-tips')?.innerHTML || "";
    const manualInc = document.getElementById('safety-list')?.innerHTML || "";
    let secHtml = `<div style="margin-bottom:15px">${tips}</div>`;
    if(manualInc.trim()){
        secHtml += `<strong style="color:#b91c1c;display:block;margin-bottom:5px;">Incidentes Manuales:</strong>${manualInc}`;
    }
    const secDest = document.getElementById('pb-sec-content');
    secDest.innerHTML = secHtml;
    // Limpiar botones de borrado en la vista info
    secDest.querySelectorAll('.danger').forEach(b => b.remove());

    // Mostrar
    screen.classList.add('active');
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(()=>{});
    }
};

window.closePostBriefingMode = function() {
    document.getElementById('post-briefing-screen').classList.remove('active');
    if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
};


// =========================================================
// INICIALIZACI√ìN PRINCIPAL (DOM READY)
// =========================================================
function forceLoadFiix() {
    initFiixDashboard().catch(console.error);
}
document.addEventListener('DOMContentLoaded', () => {
    forceLoadFiix();
    
    // 1. Inyectar Navegaci√≥n Guiada (Orden: Team -> Ops -> Prev -> Resto)
    // 1. Inyectar Navegaci√≥n Guiada (Orden: Team -> Prev -> Ops -> Resto)
    const WIDGET_MAP = [
        { id: 'team-widget',        check: 'c3', label: '1. Equipo / Dotaci√≥n' },
        { id: 'ops-updates-widget', check: 'c2', label: '2. Actualizaciones' },
        { id: 'prev-shift-widget',  check: 'c1', label: '3. Turno Anterior' },   // Ahora es el paso 2
        
        
        // El resto se queda igual
        { id: 'safety-daily-widget',check: 'c4', label: '4. Seguridad' },
        { id: 'incidentes-widget',  check: 'c5', label: '5. Incidentes' },
        { id: 'kpi-center',         check: 'c6', label: '6. KPIs' },
        { id: 'kanban-widget',      check: 'c7', label: '7. Feedback' }
    ];;

    WIDGET_MAP.forEach((step, index) => {
        const widget = document.getElementById(step.id);
        if (!widget || widget.querySelector('.widget-nav-bar')) return;

        const prevStep = index > 0 ? WIDGET_MAP[index - 1] : null;
        const nextStep = index < WIDGET_MAP.length - 1 ? WIDGET_MAP[index + 1] : null;

        const navBar = document.createElement('div');
        navBar.className = 'widget-nav-bar';
        navBar.innerHTML = `
            <div class="nav-group">
                <button class="btn-nav" onclick="navTo('${prevStep ? prevStep.id : ''}')" ${!prevStep?'disabled':''}>‚¨Ö Anterior</button>
            </div>
            <div class="nav-group" style="font-size:0.9rem;color:#64748b;">
                ${step.label} (${index + 1}/${WIDGET_MAP.length})
            </div>
            <div class="nav-group">
                <button class="btn-nav home" onclick="exitFlow()">Salir ‚úñ</button>
                <button class="btn-nav next-ok" onclick="markOkAndNext('${step.check}', '${nextStep ? nextStep.id : ''}')">
                    ‚úÖ OK y Siguiente ‚û°
                </button>
            </div>
        `;
        widget.prepend(navBar);
    });

    // 2. Bot√≥n Reiniciar (Cron√≥metro + Checks)
    const resetBtn = document.getElementById('timer-reset');
    if (resetBtn) {
        // MODIFICACI√ìN: No clonamos el bot√≥n para no perder la referencia del script del cron√≥metro
        // const newBtn = resetBtn.cloneNode(true);
        // resetBtn.parentNode.replaceChild(newBtn, resetBtn);
        
        // Usamos el bot√≥n original (resetBtn)
        resetBtn.addEventListener('click', (e) => {
            // Evitamos comportamientos duplicados
            e.preventDefault();

            if (!confirm("¬øReiniciar turno BCN? Se borrar√°n los checks y el tiempo.")) return;
            
            // MODIFICACI√ìN: Llamamos a la funci√≥n real del cron√≥metro
            if (window.resetFactoryTimer) {
                window.resetFactoryTimer();
            } else {
                // Fallback visual por si acaso
                document.getElementById('timer-display').textContent = "00:00:00";
            }
            
            document.getElementById('timer-display').classList.remove('is-red');

            document.querySelectorAll('#brief-check input[type="radio"]').forEach(r => r.checked = false);
            
            // Resto del c√≥digo de limpieza igual...
            Object.keys(localStorage).forEach(k => {
                if(k.includes('brief_check')) localStorage.removeItem(k);
            });
            
            const meta = document.getElementById('brief-check-meta');
            if(meta) meta.textContent = "Checklist reiniciado";
            
            if(window.updateSpotlightRouting) window.updateSpotlightRouting();
            console.log("‚ôªÔ∏è Turno BCN reiniciado.");
        });
    }
    

    // 3. Bot√≥n Generar Resumen
   // 3. Bot√≥n Generar Resumen
     const btnGen = document.querySelector('header .header-controls .btn-primary');
    if (btnGen) {
        const newBtnGen = btnGen.cloneNode(true);
        btnGen.parentNode.replaceChild(newBtnGen, btnGen);
        
        newBtnGen.addEventListener('click', async () => {
            // --- VALIDACI√ìN DE SUPERVISOR ---
            const supInput = document.getElementById('briefing-supervisor');
            const supVal = supInput?.value.trim();

            if (!supVal) {
                alert("‚ö†Ô∏è El campo 'Supervisor' es obligatorio.\nPor favor, escribe tu nombre o usa el micr√≥fono.");
                supInput?.focus(); 
                supInput.style.borderColor = "red";
                setTimeout(() => supInput.style.borderColor = "", 2000);
                return; 
            }

            newBtnGen.textContent = 'Guardando...';
            newBtnGen.disabled = true;

            try {
                const team = window.TEAM_STATE || { people: [], attendance: {} };
                const rosterList = (team.people || []).map(p => {
                    const name = p.nombre_completo;
                    const isPresent = team.attendance[name];
                    let statusIcon = "‚ûñ"; 
                    if (isPresent === true) statusIcon = "‚úÖ";
                    if (isPresent === false) statusIcon = "‚ùå";
                    return `${name} (${statusIcon})`;
                }).join(", ") || "Sin personal registrado.";

                // Kanban
                const kanbanItems = [];
                ['Abiertas','En-Curso','Cerradas','Vencidas'].forEach(st => {
                    const col = document.getElementById(`kanban_rapida-${st}`);
                    if(col) col.querySelectorAll('.card').forEach(c => 
                        kanbanItems.push(`[${st}] ${c.querySelector('.card-title')?.innerText}`));
                });

                // Ops
                let opsData = [];
                const opsCards = document.querySelectorAll('.ops-card-item');
                opsCards.forEach(card => {
                    opsData.push({
                        title: card.querySelector('.ops-card-title').innerText,
                        impact: card.dataset.prio,
                        scope: card.querySelector('.ops-card-badge').innerText
                    });
                });

                // Incidentes Seguridad
                const safetyTips = Array.from(document.querySelectorAll('#safety-tips .tip')).map(tip => ({
                    title: "RECORDATORIO DIARIO", 
                    desc: tip.innerText
                }));
                
                let manualEntries = []; 
                try {
                    // Ambas tarjetas usan la misma clave de localStorage: 'safety_manual_incidents_v1'
                    const rawManual = localStorage.getItem('safety_manual_incidents_v1') || '[]';
                    const parsedManual = JSON.parse(rawManual);
                    
                    manualEntries = parsedManual.map(i => {
                        // Card 5 usa 'type' (incident/lesson), Card 4 no. 
                        // Normalizamos el prefijo para el Excel.
                        let prefix = "INCIDENCIA";
                        if (i.type === 'lesson') prefix = "LECCI√ìN/APRENDIZAJE";
                        
                        return {
                            title: `${prefix}: ${i.title || 'Sin t√≠tulo'}`,
                            desc: i.desc || ''
                        };
                    });
                } catch (e) {
                    console.warn("Error leyendo datos manuales de seguridad", e);
                }

                // C. UNIR TODO EL CONTENIDO DE SEGURIDAD
                const totalSafetyPayload = [...safetyTips, ...manualEntries];
                const payload = {
                    station: "BCN",
                    date: (() => {
                        const d = new Date();
                        const day = String(d.getDate()).padStart(2, '0');
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const year = d.getFullYear(); 
                        return `${day}/${month}/${year}`;
                    })(),
                    
                    briefing_time: new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}),

                    shift: document.getElementById('shift-badge-header')?.innerText || 'General',
                    timer: document.getElementById('timer-display')?.innerText || '00:00:00',
                    supervisor: supVal,
                    checklist: {}, 
                    kpis: {
                        "UPH": document.getElementById('kpi-uph')?.innerText,
                        "Costes": document.getElementById('kpi-total-cost')?.innerText
                    },
                    roster_details: rosterList,
                    prev_shift_note: document.getElementById('prev-shift-note')?.innerText || '',
                    kanban_details: kanbanItems.join(" | "),
                    ops_updates: opsData,
                    safety_incidents: totalSafetyPayload 
                };

                const res = await fetch('api/briefing/summary', {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(payload)
                });

                if(!res.ok) throw new Error('Error del servidor');
                
                alert("‚úÖ Resumen BCN guardado.\nEntrando en modo informaci√≥n...");
                window.openPostBriefingMode();

                // --- ACCIONES TRAS GUARDAR ---
                
                // 1. Limpiar Supervisor
                if(supInput) supInput.value = ""; 

                // 2. Resetear Cron√≥metro a 00:00:00 (NUEVO)
                if(window.resetFactoryTimer) {
                    window.resetFactoryTimer();
                }
                // -----------------------------

            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                newBtnGen.textContent = "Generar Resumen";
                newBtnGen.disabled = false;
            }
        });
    }

    // 4. Inicializadores heredados (try/catch para robustez)
    try { initHeaderTimer(); } catch(e){}
    try { initDateTimeAndShift(); } catch(e){}
    try { initFullscreenToggles(); } catch(e){}
    try { init5S(); } catch(e){}
    try { initEhsSimple(); } catch(e){}
    try { initTeamRoster(); } catch(e){}
    try { setupEventListeners(); } catch(e){}
    try { makeColumnsSortable(); } catch(e){}
    try { hydrateKpiTotalCost(); } catch(e){}
    try { loadBoardsInitial(); } catch(e){}
    try { loadIncidentes(); } catch(e){}
    try { connectWebSocket(); } catch(e){}
    try { initOpsUpdates(); } catch(e){}
    try { reorderChecklist(); } catch(e){}
    try { initSafetyDailyWidget(); } catch(e){}
    try { updateSpotlightRouting(); } catch(e){}
    
    console.log("Dashboard BCN inicializado correctamente.");
    setInterval(() => forceLoadFiix(), 10000);

// Disparo de emergencia por si el DOM ya estaba cargado
if (document.readyState === "complete") forceLoadFiix();
});
</script>
</body>
</html>
