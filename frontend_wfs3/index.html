<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operativo WFS3 MAD</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .header-bar { background-color: #2c3e50; color: white; padding: 15px; }
        .timer-box { font-size: 1.5rem; font-family: monospace; font-weight: bold; background: #000; color: #0f0; padding: 5px 15px; border-radius: 5px; }
        .manual-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-weight: bold; display: flex; align-items: center; }
        .manual-warning span { margin-left: 10px; }
        .card-custom { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
        .station-badge { background-color: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold; }
    </style>
    <script>
        // IDENTIDAD WFS3
        window.STATION_OVERRIDE = 'WFS3';
    </script>
</head>
<body>

    <!-- Header -->
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <h3 class="m-0">MAD <span class="station-badge">WFS3</span></h3>
            <div class="input-group input-group-sm" style="width: 250px;">
                <span class="input-group-text">Supervisor:</span>
                <input type="text" id="supervisorName" class="form-control" placeholder="Tu nombre aquÃ­...">
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div id="currentDate">--/--/----</div>
            <div id="shiftTimer" class="timer-box">00:00:00</div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Columna Izquierda: Roster y Checklist -->
            <div class="col-md-4">
                
                <!-- ROSTER MANUAL -->
                <div class="card card-custom">
                    <div class="card-header bg-primary text-white d-flex justify-content-between">
                        <h5 class="m-0">ðŸ‘¥ Equipo (Roster)</h5>
                        <button class="btn btn-sm btn-light" onclick="openManualAddModal()">+ AÃ±adir</button>
                    </div>
                    <div class="card-body">
                        <div class="manual-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                            </svg>
                            <span>PROCEDIMIENTO MANUAL ACTIVADO</span>
                        </div>
                        <ul id="rosterList" class="list-group list-group-flush small">
                            <li class="list-group-item text-muted text-center">Cargando o vacÃ­o...</li>
                        </ul>
                    </div>
                </div>

                <!-- CHECKLIST -->
                <div class="card card-custom">
                    <div class="card-header bg-success text-white">
                        <h5 class="m-0">âœ… Checklist Inicio Turno</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input briefing-check" type="checkbox" id="chk_clean">
                            <label class="form-check-label" for="chk_clean">Limpieza de zona (5S)</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input briefing-check" type="checkbox" id="chk_equip">
                            <label class="form-check-label" for="chk_equip">Equipos (PDAs/Radios) OK</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input briefing-check" type="checkbox" id="chk_safety">
                            <label class="form-check-label" for="chk_safety">Charla Seguridad impartida</label>
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-outline-success btn-sm" id="btnConfirmCheck">Confirmar RevisiÃ³n</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Columna Central/Derecha: Tareas y Resumen -->
            <div class="col-md-8">
                <div class="card card-custom">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="m-0">ðŸ“‹ GestiÃ³n del Turno</h5>
                        <button class="btn btn-primary" onclick="generateSummary()">ðŸ“¤ Generar y Enviar Resumen</button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            Conectado a WFS3. Las tareas aparecerÃ¡n aquÃ­ en tiempo real.
                        </div>
                        <div id="tasksContainer">
                            <!-- Tareas inyectadas por JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + "/ws";
        let socket;
        let shiftStartTime = new Date(); // Reinicia al cargar pÃ¡gina o guardar lÃ³gica

        // 1. CRONÃ“METRO
        function updateTimer() {
            const now = new Date();
            const diff = now - shiftStartTime;
            const hh = String(Math.floor(diff / 3600000)).padStart(2, '0');
            const mm = String(Math.floor((diff % 3600000) / 60000)).padStart(2, '0');
            const ss = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
            document.getElementById('shiftTimer').innerText = `${hh}:${mm}:${ss}`;
            
            // Fecha
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            document.getElementById('currentDate').innerText = now.toLocaleDateString('es-ES', options);
        }
        setInterval(updateTimer, 1000);

        // 2. WEBSOCKET
        function connectWS() {
            socket = new WebSocket(WS_URL);
            socket.onopen = () => console.log("ðŸ”Œ WS Conectado WFS3");
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if(data.type === 'roster_manual_upsert' || data.type === 'roster_manual_delete') {
                    loadRoster();
                }
                // AquÃ­ irÃ­a lÃ³gica extra para tareas
            };
            socket.onclose = () => setTimeout(connectWS, 3000);
        }
        connectWS();

        // 3. CARGAR ROSTER (Manual)
        async function loadRoster() {
            try {
                const res = await fetch('/api/roster/persons');
                const people = await res.json();
                const list = document.getElementById('rosterList');
                list.innerHTML = '';
                
                if(people.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-muted">Sin personal asignado.</li>';
                    return;
                }

                people.forEach(p => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `
                        <div>
                            <strong>${p.nombre} ${p.apellidos}</strong><br>
                            <small class="text-muted">${p.horario} - ${p.observaciones || ''}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePerson('${p.id}')">X</button>
                    `;
                    list.appendChild(li);
                });
            } catch(e) { console.error("Error loading roster", e); }
        }
        // Cargar al inicio
        loadRoster();

        async function deletePerson(id) {
            if(!confirm("Â¿Eliminar?")) return;
            await fetch(`/api/roster/persons/${id}`, { method: 'DELETE' });
        }

        // 4. GENERAR RESUMEN
        async function generateSummary() {
            const supervisor = document.getElementById('supervisorName').value.trim();
            if (!supervisor) {
                alert("âš ï¸ Debes introducir el NOMBRE DEL SUPERVISOR.");
                document.getElementById('supervisorName').focus();
                return;
            }

            const timerValue = document.getElementById('shiftTimer').innerText;
            
            // Recopilar Checklist
            const checks = {};
            document.querySelectorAll('.briefing-check').forEach(chk => {
                const label = document.querySelector(`label[for="${chk.id}"]`).innerText;
                checks[label] = chk.checked ? "OK" : "NO";
            });

            // Obtener detalles del roster actual para el texto
            const rosterItems = [];
            document.querySelectorAll('#rosterList li div strong').forEach(el => rosterItems.push(el.innerText));
            const rosterText = rosterItems.length > 0 ? rosterItems.join(", ") : "Sin equipo registrado";

            const payload = {
                station: "WFS3",
                date: new Date().toLocaleDateString('es-ES'),
                shift: (new Date().getHours() >= 14 && new Date().getHours() < 22) ? "Tarde" : "MaÃ±ana", // Simplificado
                timer: timerValue,
                supervisor: supervisor,
                checklist: checks,
                roster_details: rosterText
            };

            try {
                const res = await fetch('/api/briefing/summary', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if(result.saved) {
                    alert("âœ… Resumen WFS3 Generado y Enviado a Excel.");
                } else {
                    alert("âŒ Error al guardar: " + result.error);
                }
            } catch(e) {
                alert("Error de red al enviar resumen.");
            }
        }

        // Mock modal function for simplicity in this snippet
        function openManualAddModal() {
            const name = prompt("Nombre y Apellidos:");
            if(name) {
                fetch('/api/roster/persons', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        nombre: name, apellidos: "", 
                        fecha: new Date().toLocaleDateString('es-ES'), // Formato simple
                        turno: "MaÃ±ana" // Simplificado, deberÃ­as detectar turno real
                    })
                });
            }
        }
    </script>
</body>
</html>
