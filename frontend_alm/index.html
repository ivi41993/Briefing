
<!DOCTYPE html>
<html lang="es">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta charset="UTF-8" />
<title>Dashboard - WFS4 MAD WH</title>

<!-- Fuentes -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root{ --ui-scale: 1; }                  /* 1 = 100% */
html{ font-size: calc(16px * var(--ui-scale)); }
@media (min-width: 1600px){
:root{ --ui-scale: 1.15; }             /* TVs grandes: sube ligeramente por defecto */
}

:root{
--brand-red-900:#7f1d1d; --brand-red-800:#991b1b; --brand-red-700:#b91c1c;
--brand-red-600:#dc2626; --brand-red-500:#ef4444; --brand-red-400:#f87171;

--bg-page:#f7f8fa;
--bg-card:#ffffff;
--border:#e6e8ec;
--text:#1f2937;
--text-muted:#6b7280;

/* Categorías Kanban (fondo completo) */
--cat-seg:#fee2e2;
--cat-inc:#fff1e6;
--cat-man:#eaf8f0;
--cat-cal:#EE27F5;
--cat-ser:#F5EE27;  
}

/* Base */
html,body{ background:var(--bg-page); color:var(--text); height:100%; }
body{ margin:0; font:14px "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
h1,h2,h3,.widget-title,.column-title .count{ font-family:"Space Grotesk", Inter, system-ui, sans-serif; letter-spacing:.2px; }

/* Header */
header{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
header h1{ margin:0; color:var(--brand-red-600); font-weight:700; font-size: clamp(1.6rem, 1vw + 1rem, 2.2rem); }
.header-controls{ display:flex; gap:12px; align-items:center; }
.header-controls input{ padding:6px 10px; border:1px solid var(--border); border-radius:8px; font-size:.9rem; background:#fff; }
.btn-primary{
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff; border:none; border-radius:10px; padding:10px 16px;
box-shadow:0 6px 16px rgba(220,38,38,.25);
transition:.15s transform,.2s box-shadow,.2s filter; cursor:pointer;
}
.btn-primary:hover{ transform:translateY(-1px); filter:saturate(110%); }

/* ======= Layout 3 columnas ======= */
.dashboard-3col{
min-height: 100svh;   /* respeta barra/gestos iPad */
height: auto;
display:grid;
grid-template-columns: 320px 1fr 380px;  /* IZQ / CENTRO / DER */
grid-template-rows: auto 1fr;
gap:20px; padding:20px;
}
header{ grid-column: 1 / -1; }
.col-left, .col-middle, .col-right{
min-height:0; overflow:auto; display:flex; flex-direction:column; gap:20px;
}

/* Widgets / tarjetas */
.widget,.card{
background:var(--bg-card);
border:1px solid var(--border);
border-radius:12px;
box-shadow: 0 6px 18px rgba(17,24,39,.06);
padding:16px;
}
.widget-title{ font-size:1.05rem; font-weight:700; margin:0 0 12px; display:flex; align-items:center; justify-content:space-between; }
.widget-title-icon{ width:16px; height:16px; color:var(--text-muted); }

/* Kanban / Kaizen */
.board-container{ display:grid; gap:12px; }
.board-container.kanban{ grid-template-columns: repeat(4, minmax(0,1fr)); }
.board-container.kaizen{ grid-template-columns: repeat(3, minmax(0,1fr)); }
.board-container.kaizen.compact{ grid-template-columns: repeat(2, minmax(0,1fr)); }

.kanban-column{ display:flex; flex-direction:column; min-width:0; }
.column-title{
display:flex; justify-content:space-between; align-items:baseline;
font-size:.85rem; font-weight:600; color:var(--text-muted);
margin:0 0 6px; padding-bottom:8px; border-bottom:2px solid #e9ecef;
}
.column-title .count{ background:#eef1f4; color:var(--text-muted); padding:2px 6px; border-radius:6px; font-size:.8rem; }
.cards-container{ min-height:120px; max-height: clamp(280px, 48svh, 70vh);
overscroll-behavior: contain;
-webkit-overflow-scrolling: touch; overflow:auto; padding-top:4px; }

.card{
position:relative;
margin-bottom:8px;
padding:10px 12px;
display:flex; align-items:center; justify-content:space-between; gap:8px;
cursor:grab;
}
.card:hover{ box-shadow:0 2px 8px rgba(0,0,0,.06); }
.card-content{ flex:1 1 auto; min-width:0; }
.card-title{
font-weight:600; font-size:.95rem; margin:0 0 4px; line-height:1.25;
overflow:hidden; max-height:2.5em; display:inline-block;
transform:scale(1.12); transform-origin:left top;
}
.card-details,.card-assignee{ font-size:.8rem; color:var(--text-muted); }
.card-assignee{ margin-top:4px; }
.card-actions .icon{ width:14px; height:14px; }
.delete-card-btn{ background:none; border:none; color:#9ca3af; display:none; cursor:pointer; }
.card:hover .delete-card-btn{ display:block; }

.sortable-ghost{ opacity:.4; background:#dee2e6; }
.sortable-drag{ opacity:1 !important; transform:rotate(2deg); box-shadow:0 8px 24px rgba(0,0,0,.15); }

/* Chips de categoría */
.cat-chip{
display:inline-block; margin-left:8px; font-size:.7rem; font-weight:700;
padding:2px 6px; border-radius:999px; border:1px solid rgba(0,0,0,.08);
vertical-align:middle; background:rgba(255,255,255,.7);
}

/* === KANBAN: teñido completo por categoría (scoped) === */
#kanban-widget .card.cat-seguridad     { background: var(--cat-seg); }
#kanban-widget .card.cat-incidencias   { background: var(--cat-inc); }
#kanban-widget .card.cat-mantenimiento { background: var(--cat-man); }
#kanban-widget .card.cat-calidad { background: var(--cat-cal); }
#kanban-widget .card.cat-servicio { background: var(--cat-ser); }  

/* 5S & GW */
.checkbox-item{ display:flex; align-items:center; gap:8px; margin-bottom:8px; font-size:.9rem; }
.gw-task-item{
display:flex; align-items:center; gap:8px; padding:6px 4px;
font-size:.9rem; border-bottom:1px solid var(--border); cursor:pointer;
}
.gw-task-item:last-child{ border-bottom:none; }
.gw-task-item.completed label{ color:var(--text-muted); text-decoration:line-through; }
.gw-note{
font-size:.85rem; width:100%; margin-top:4px; padding:6px 8px;
border:1px solid var(--border); border-radius:6px;
}
.gw-note:disabled{ background:#f8f9fa; color:var(--text-muted); }
.highlight-gw{ animation: highlight-gw 2s ease-out; }
@keyframes highlight-gw { from{ background:#dbe4ff; } to{ background:transparent; } }

/* ===== 5S gestionable ===== */

.s5-compact{
display:flex; gap:6px; flex-wrap:wrap; align-items:center;
}
.s5-pill{
display:inline-flex; align-items:center; gap:6px;
border:1px solid var(--border); background:#fff;
border-radius:999px; padding:6px 10px; font-size:.8rem; line-height:1;
cursor:pointer; user-select:none;
transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.s5-pill:hover{ transform:translateY(-1px); }
.s5-pill:active{ transform:translateY(0); }
.s5-dot{ width:8px; height:8px; border-radius:50%; background:#d1d5db; }

/* Estado activado (OK) */
.s5-pill.on{
background:linear-gradient(135deg, #ecfdf5, #ffffff);
border-color: rgba(16,185,129,.55);
box-shadow: inset 0 0 0 2px rgba(16,185,129,.08);
}
.s5-pill.on .s5-dot{ background:#10b981; }

/* Micro-animación al cambiar */
@keyframes s5-bump{ 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
.s5-pill.bump{ animation:s5-bump .18s ease-out; }

/* Meta compacta */
#s5-meta{ margin-top:4px; font-size:.78rem; }


/* EHS simple */
#ehs-widget{ display:flex; flex-direction:column; gap:8px; }
#ehs-month{ color:var(--text-muted); font-size:.95rem; }
.ehs-controls{
display:flex; align-items:center; gap:14px;
border:1px solid var(--border); border-radius:12px; padding:8px 10px;
}
.ehs-btn{
width:42px; height:42px; border:none; border-radius:10px; cursor:pointer;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color:#fff; font-size:1.3rem; line-height:1; display:flex; align-items:center; justify-content:center;
}
.ehs-big{ font-size: clamp(2rem, 2.2vw + .8rem, 3rem); font-weight:800; line-height:1; color:var(--brand-red-600); min-width:3ch; text-align:center; }

/* KPI Costes */
#kpi-costes .kpi-value.large{ font-size: clamp(2.1rem, 2.3vw + 1rem, 3.2rem); line-height:1; font-weight:700; }
#kpi-total-cost{ color:var(--brand-red-600); font-weight:800; }
.kpi-text{ color:var(--text-muted); margin:0; font-size:.9rem; }
.kpi-currency{ font-size:1rem; font-weight:600; margin-left:4px; vertical-align:super; color:var(--brand-red-600); }
.flash{ animation: flash-kpi 900ms ease-out; }
@keyframes flash-kpi{ from{ background:#fff3cd; } to{ background:transparent; } }

/* Estado LEAN */
.lean-status-container{ display:flex; flex-direction:column; gap:8px; }
.lean-status-item{ display:flex; justify-content:space-between; align-items:center; font-size:.9rem; }
.status-tag{ font-size:.75rem; font-weight:700; padding:2px 8px; border-radius:12px; }
.status-tag.status-ok{ color:#166534; background:#e3f9e5; }
.status-tag.status-alert{ color:#991b1b; background:#ffe3e3; }

/* Carga / Planificación */
.table-scroll,
.col-left, .col-middle, .col-right{
-webkit-overflow-scrolling: touch;
overscroll-behavior: contain;
scroll-padding-bottom: 40px; /* evita que la barra/bottom-safe tape lo último */
}
#planif-table{ width:100%; border-collapse:collapse; font-size:.9rem; }
#planif-table thead th{
position:sticky; top:0; background:#fafafa; border-bottom:1px solid var(--border);
text-align:left; padding:8px; z-index:1;
}
#planif-table tbody td{ padding:8px; border-bottom:1px solid var(--border); white-space:nowrap; }
/* iOS/iPadOS: evita zoom al enfocar inputs */
@supports (-webkit-touch-callout: none) {
input, select, textarea {
font-size: 16px !important;
}
}
/* sensaciones táctiles */
* { -webkit-tap-highlight-color: rgba(0,0,0,0); }
button, .btn, .s5-pill, .ehs-btn, .presence-toggle label {
touch-action: manipulation;
}

/* selects y botones en cabecera: que no se corten en iPad */
.header-controls input,
.header-controls .btn-primary {
min-height: 44px;
}
/* asegura que sticky tome como contenedor la propia columna central */
.col-middle { position: relative; }

/* Fullscreen helpers */
.widget, .card{ position:relative; }
.fs-toggle{
  position:absolute; top:10px; right:10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.95);
  border-radius:12px;
  padding:10px;                 /* antes ~6px */
  cursor:pointer; line-height:0; opacity:.8;
  display:inline-flex; align-items:center; justify-content:center;
  transition: opacity .15s, transform .15s, box-shadow .15s;
  box-shadow:0 4px 12px rgba(0,0,0,.10);
  min-width:44px; min-height:44px;   /* objetivo táctil recomendado */
}
.fs-toggle:hover{ opacity:1; transform:scale(1.06); }
.fs-toggle svg{ width:18px; height:18px; display:block; }  /* antes 14px */

.widget:fullscreen, .card:fullscreen{ background:#fff; border-radius:0; box-shadow:none; padding:24px; }
:fullscreen{ overflow:auto; }
html.fs-zoom{ font-size:18px; }
@media (min-width:1280px){ html.fs-zoom{ font-size:20px; } }

/* ======= Split Kaizen + 5S/GW en la columna central ======= */
.actions-split{
display:grid;
grid-template-columns: 1.2fr 1fr; /* Kaizen algo más ancho */
gap:20px;
align-items:start;
}
@media (max-width: 1100px){
.actions-split{ grid-template-columns: 1fr; }
}

/* Responsive mínimo */
@media (max-width: 1200px){
.dashboard-3col{ grid-template-columns: 280px 1fr 320px; }
}
@media (max-width: 980px){
.dashboard-3col{ grid-template-columns: 1fr; grid-template-rows: auto auto auto auto; }
.col-left,.col-right{ order:2; }
.col-middle{ order:1; }
}
/* Objetivos táctiles cómodos */
@media (hover:none) and (pointer:coarse){
.btn-primary, .ehs-btn, .btn-compact, .delete-card-btn, .s5-pill { min-width:44px; min-height:44px; }
.new-item-form input, .new-item-form select { padding:12px; }
}

/* Asa de arrastre */
.card { gap:10px; }
/* Asa de arrastre MEJORADA PARA TÁCTIL */
.drag-handle{
    align-self:stretch;
    display:flex; align-items:center; justify-content:center;
    padding: 12px; /* AUMENTADO de 6px a 12px para dedos gordos */
    border:1px solid var(--border);
    border-radius:10px;
    background:var(--bg-card);
    cursor:grab;
    opacity:.7;
    
    /* ESTA ES LA CLAVE PARA ANDROID: */
    touch-action: none; /* Evita que el navegador intente hacer scroll al tocar aquí */
    -webkit-user-select: none;
    user-select: none;
}
.card:active .drag-handle{ cursor:grabbing; opacity:1; background: #f3f4f6; }
.drag-handle svg{ width:20px; height:20px; } /* Icono un poco más grande */
.dashboard{
padding: clamp(12px, 2vw, 28px);
padding-left:  max(clamp(12px, 2vw, 28px), env(safe-area-inset-left));
padding-right: max(clamp(12px, 2vw, 28px), env(safe-area-inset-right));
padding-top:   max(clamp(12px, 2vw, 28px), env(safe-area-inset-top));
padding-bottom:max(clamp(12px, 2vw, 28px), env(safe-area-inset-bottom));
}

/* === Cronómetro (más pequeño) === */
.header-timer { min-height: 56px; }
.header-timer .timer-face{ gap:8px; }
.header-timer .timer-display{
/* antes: clamp(2.2rem, 6.5vw, 6.5rem) */
font-size: clamp(1.8rem, 5vw, 5rem);
}
.header-timer .timer-dot{
width:10px; height:10px;
}
.header-timer .timer-reset{
min-width:40px; min-height:40px; padding:6px 10px; font-weight:600;
}

/* En móviles, un pelín más compacto aún */
@media (max-width:700px){
.header-timer .timer-display{ font-size: clamp(1.4rem, 7.5vw, 2.6rem); }
}

/* === Briefing / Checklist === */
#briefing-widget .grid{
display:grid; gap:10px; grid-template-columns: repeat(12, minmax(0,1fr));
}
#briefing-widget .row{ display: contents; }
#briefing-widget .field{ grid-column: span 12; display:flex; align-items:center; gap:8px; }
#briefing-widget .field > label{ min-width:140px; color:var(--text-muted); font-size:.9rem; }

#briefing-header .h-inline{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
#briefing-header input[type="text"], #briefing-header input[type="number"]{
padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff;
}
#briefing-header .chip{
display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border);
border-radius:999px; background:#fff; font-size:.85rem; cursor:pointer; user-select:none;
}
#briefing-header .chip input{ margin:0; }

.br-section{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; }
.br-section h4{ margin:0 0 8px; font-size:1rem; }
.br-status{ display:flex; gap:8px; margin:6px 0 10px; }
.br-status .opt{
border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-weight:600; font-size:.85rem; cursor:pointer; user-select:none;
}
.br-status input{ display:none; }
.br-status .opt[data-v="OK"].on{ background:#e3f9e5; color:#166534; border-color:#a7f3d0; }
.br-status .opt[data-v="NO"].on{ background:#ffe3e3; color:#991b1b; border-color:#fecaca; }

.br-criteria{ margin:6px 0 8px; padding-left:6px; }
.br-criteria .checkbox-item{ margin:6px 0; }
.br-notes{
width:100%; min-height:56px; border:1px solid var(--border); border-radius:8px; padding:8px; background:#fff; font-size:.9rem;
}

#briefing-result{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; padding:10px; border:1px dashed var(--border); border-radius:10px; background:#fafafa; }
#briefing-result .big{ font-weight:800; font-size:1.2rem; color:var(--brand-red-600); }
#briefing-save-hint{ color:var(--text-muted); font-size:.8rem; }
/* === Checklist en cuadrícula (responsive) === */
/* === Checklist compacto === */
.check-grid{
display:grid; gap:8px;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
/* —— Ajuste vertical de tarjetas del checklist —— */
.check-card{
/* antes: row + space-between */
display:flex;
flex-direction:column;        /* título arriba, botones debajo */
align-items:flex-start;
justify-content:flex-start;
gap:10px;                     /* separación título/botones */
padding:14px 16px;            /* un poco más de aire */
min-height:84px;              /* sube la “altura base” */
}

/* El título ahora envuelve líneas (nada de cortar con ellipsis) */
.check-title{
font-weight:600;
font-size:.95rem;
line-height:1.25;
white-space:normal;
overflow:visible;
text-overflow:unset;
word-break:break-word;
}

/* Botonera en una fila debajo del título (se puede partir en dos líneas si no cabe) */
.check-actions{
width:100%;
display:flex;
flex-wrap:wrap;
gap:8px;
}

/* Botones un poco más cómodos para tocar */
.check-actions label{
padding:6px 12px;             /* más alto */
border-radius:999px;
font-size:.78rem;
}

.check-actions input:checked + label{
background:#ecfdf5; border-color:rgba(16,185,129,.6);
box-shadow: inset 0 0 0 2px rgba(16,185,129,.08);
}
.header-left{ display:flex; flex-direction:column; gap:2px; }
#now-header{ font-size:.95rem; color:var(--text-muted); }


.shift-chip{
display:inline-flex; align-items:center; gap:6px;
padding:4px 10px; border:1px solid var(--border);
border-radius:999px; background:#fff; font-weight:600; font-size:.85rem;
}
/* === Spotlight Checklist === */
#brief-check{
position: sticky;           /* siempre visible al hacer scroll en la columna central */
top: 0;
z-index: 5;
border: 2px solid rgba(239,68,68,.45);  /* brand red */
box-shadow:
0 14px 36px rgba(239,68,68,.18),
0 2px 0 rgba(255,255,255,.9) inset;
background:
radial-gradient(1200px 200px at 50% -60px, rgba(239,68,68,.06), transparent),
#fff;
animation: brief-pop .25s ease-out;
}
#brief-check .widget-title{
font-size: 1.25rem;
color: var(--brand-red-700);
}
#brief-check .check-grid{
grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); /* tarjetas un pelín más grandes */
}
#brief-check .check-card{
border: 1px solid var(--border);
box-shadow: 0 6px 16px rgba(17,24,39,.06);
min-height: 96px;
}
@keyframes brief-pop { from { transform: scale(.985); opacity:.96; } to { transform: scale(1); opacity:1; } }

/* Chip de turno con color semántico */
#shift-badge{ border-color: rgba(0,0,0,.06); }
#shift-badge[data-shift="Mañana"]{
background:#ecfdf5; color:#065f46; border-color:#a7f3d0;
}
#shift-badge[data-shift="Tarde"]{
background:#fff7ed; color:#9a3412; border-color:#fed7aa;
}
#shift-badge[data-shift="Noche"]{
background:#eef2ff; color:#3730a3; border-color:#c7d2fe;
}

/* Suaviza el resto de widgets para que el ojo vaya al checklist */
.col-middle .widget:not(#brief-check){
filter: saturate(.92);
opacity: .96;
transition: filter .2s ease, opacity .2s ease, transform .2s ease;
}
.col-middle .widget:not(#brief-check):hover{
filter: none;
opacity: 1;
}

/* Bullets del título en Incidentes */
#incidentes-widget .title-bullets{
list-style:none; margin:0; padding:0;
display:flex; gap:8px; align-items:center; flex-wrap:wrap;
}
#incidentes-widget .title-chip{
display:inline-flex; align-items:center;
padding:4px 10px; border:1px solid var(--border);
border-radius:999px; background:#fff; font-size:.8rem; font-weight:600;
white-space:nowrap;
}
/* Compactar en pantallas muy pequeñas */
@media (max-width: 520px){
#incidentes-widget .title-bullets{ gap:6px; }
#incidentes-widget .title-chip{ font-size:.75rem; padding:3px 8px; }
}
/* Banner de recordatorio dentro de Incidentes (Enablon) */
#incidentes-widget .incident-remember{
margin: 6px 0 10px;
padding: 10px 12px;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color: #fff;
border-radius: 10px;
font-weight: 800;
letter-spacing: .2px;
}

/* Bullets del título (rojo con texto blanco) */
#incidentes-widget .title-bullets{
list-style: none; margin: 0; padding: 0;
display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
}
#incidentes-widget .title-chip{
display: inline-flex; align-items: center;
padding: 6px 12px;
border-radius: 999px;
font-size: .8rem; font-weight: 700;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color: #fff; border: none;
box-shadow: 0 6px 14px rgba(220,38,38,.22);
}
#incidentes-widget .title-chip:hover{
filter: saturate(110%);
transform: translateY(-1px);
}

/* Compacto en pantallas pequeñas */
@media (max-width: 520px){
#incidentes-widget .title-chip{ font-size: .75rem; padding: 4px 10px; }
#incidentes-widget .title-bullets{ gap: 6px; }
}

/* Banner RECORDAR en Incidentes */
#incidentes-widget .incident-remember{
margin: 6px 0 8px;
padding: 10px 12px;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color: #fff;
border-radius: 10px;
font-weight: 800;
letter-spacing: .2px;
}

/* Bullets rojos con texto blanco */
#incidentes-widget .title-bullets{
list-style: none; margin: 0 0 10px; padding: 0;
display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
}
#incidentes-widget .title-chip{
display: inline-flex; align-items: center;
padding: 6px 12px;
border-radius: 999px;
font-size: .8rem; font-weight: 700;
background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
color: #fff; border: none;
box-shadow: 0 6px 14px rgba(220,38,38,.22);
}
#incidentes-widget .title-chip:hover{
filter: saturate(110%);
transform: translateY(-1px);
}
@media (max-width: 520px){
#incidentes-widget .title-chip{ font-size: .75rem; padding: 4px 10px; }
#incidentes-widget .title-bullets{ gap: 6px; }
}
/* Selector de zona y chip visual */
.team-right .zone-select{
padding:6px 10px; border:1px solid var(--border);
border-radius:8px; background:#fff; font-size:.85rem;
}
.chip-zone{
display:inline-block; margin-left:6px; padding:2px 8px;
border-radius:999px; font-size:.72rem; font-weight:700;
color:#3730a3; background:#eef2ff; border:1px solid #c7d2fe;
}
/* —— Spotlight / Parpadeo guiado —— */
.spotlight-blink{
position: relative;
border-color: rgba(239,68,68,.6) !important;      /* rojo marca */
box-shadow:
0 0 0 3px rgba(239,68,68,.20),
0 14px 36px rgba(239,68,68,.12);
animation: blink-glow 1.2s ease-in-out infinite;
}
@keyframes blink-glow{
0%, 100% { box-shadow:
0 0 0 2px rgba(239,68,68,.18),
0 8px 22px rgba(239,68,68,.10);
transform: translateZ(0) scale(1); }
50%      { box-shadow:
0 0 0 5px rgba(239,68,68,.28),
0 18px 44px rgba(239,68,68,.18);
transform: translateZ(0) scale(1.01); }
}
/* === Incidentes: estilo blanco + borde rojo + texto rojo === */
#incidentes-widget .incident-remember{
background:#fff !important;
color: var(--brand-red-700) !important;
border: 2px solid var(--brand-red-600) !important;
border-radius: 12px;
box-shadow: none !important;
}

#incidentes-widget .title-chip{
background:#fff !important;
color: var(--brand-red-700) !important;
border: 2px solid var(--brand-red-600) !important;
box-shadow: none !important;
}

/* Hover suave (opcional) */
#incidentes-widget .title-chip:hover{
transform: none;
filter: none;
box-shadow: 0 0 0 3px rgba(239,68,68,.12);
}

/* === Control de presencia con ✓ y ✕ === */
.presence-toggle{
display:inline-flex; align-items:center;
border:1px solid var(--border); border-radius:10px; overflow:hidden;
background:#fff;
}
.presence-toggle input{ display:none; }
.presence-toggle label{
padding:6px 10px; font-size:.82rem; font-weight:700; cursor:pointer; user-select:none;
display:inline-flex; align-items:center; gap:6px;
}
.presence-toggle label + input + label{ border-left:1px solid var(--border); } /* separador */

.presence-toggle .yes{ color:#166534; }   /* verde */
.presence-toggle .no { color:#991b1b; }   /* rojo  */

.presence-toggle input[value="yes"]:checked + label.yes{
background:#e3f9e5; box-shadow: inset 0 0 0 2px rgba(16,185,129,.12);
}
.presence-toggle input[value="no"]:checked + label.no{
background:#ffe3e3; box-shadow: inset 0 0 0 2px rgba(239,68,68,.12);
}
/* Base fluid */
html, body { height: 100%; }
body {
margin: 0;
/* tipografía que se adapta a tablet/TV */
font-size: clamp(14px, 1.8vw, 18px);
-webkit-text-size-adjust: 100%;
}

/* Contenedor general */
.app, .container, main {
max-width: 100vw;
padding: 8px;
overflow-x: hidden;   /* evita scroll horizontal accidental */
}

/* Layout de tarjetas y paneles en grid fluido */
.cards, .panels, .grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 12px;
}

/* Tarjetas/paneles no rompan el grid */
.card, .panel, .widget { min-width: 0; }

/* Tablas: scroll horizontal elegante en pantallas pequeñas */
.table-wrap { overflow-x: auto; max-width: 100%; }
.table-wrap > table {
width: 100%;
border-collapse: collapse;
}
table th, table td { padding: .5rem; }

/* Gráficas/canvas responsive */
.chart, canvas, svg {
display: block;
width: 100%;
max-width: 100%;
height: auto;
/* si tu librería necesita altura fija, usa aspect-ratio: */
aspect-ratio: 16 / 9;
}

/* Imágenes */
img, video { max-width: 100%; height: auto; }

/* Cabecera y pie pegados sin “cortar” contenido en tablet */
header, footer { position: relative; }

/* Evita 100vh “roto” en móviles; usa *vh modernos */
.fullscreen, .fill {
min-height: 100svh; /* soportado en navegadores modernos */
}

/* Breakpoints suaves por si tienes columnas rígidas */
@media (max-width: 1200px) {
.only-desktop { display: none !important; }
}
@media (max-width: 1024px) {
.sidebar { width: 280px; }       /* o colapsa si la tienes fija */
}
@media (max-width: 900px) {
.cards, .panels, .grid { grid-template-columns: 1fr; }  /* una columna */
}

/* Botones y targets táctiles cómodos */
button, .btn, .click {
min-height: 44px;
padding: .6rem .9rem;
}
/* === FIX TABLET: la checklist no tapa la columna central === */

/* 1) Tablet y abajo: quitar sticky y pasar a 1 columna */
@media (max-width:1100px){
.dashboard-3col{
grid-template-columns: 1fr;
grid-template-rows: auto auto auto auto;
}
.col-left, .col-right{ order: 2; }
.col-middle{ order: 1; }

/* checklist normal (no pegajosa) */
#brief-check{
position: static !important;
top: auto !important;
max-height: none !important;
}

/* tarjetas del checklist un pelín más compactas */
#brief-check .check-grid{ grid-template-columns: 1fr; }
#brief-check .check-card{ min-height: auto; padding: 12px; }
}

/* 2) Escritorio: mantener sticky pero sin monopolizar la vista */
@media (min-width:1101px){
#brief-check{
position: sticky;
top: 0;
max-height: 48vh;   /* deja ~medio alto para que se vean los demás widgets */
overflow: auto;
}
}
/* --- Tablet landscape (≈980–1366px): central más ancha, laterales con clamp --- */
@media (min-width: 980px) and (max-width: 1366px){
.dashboard-3col{
/* IZQ        CENTRO                     DER */
grid-template-columns:
clamp(230px, 22vw, 280px)
minmax(0, 1.7fr)
clamp(220px, 24vw, 300px);
gap: 16px;
padding: 16px;
}
}

/* --- Portátiles/“tablets grandes” (1367–1599px): derecha capada, centro manda --- */
@media (min-width: 1367px) and (max-width: 1599px){
.dashboard-3col{
grid-template-columns:
clamp(260px, 21vw, 300px)
minmax(0, 1.6fr)
clamp(240px, 23vw, 340px);
}
}

/* Opcional: si quieres que el medio tenga siempre mínimo decente */
.col-middle{ min-width: 0; } /* (ya lo tienes) */
/* ===== iPad / tablets en horizontal: 2 columnas (der. abajo) ===== */
@media (min-width: 980px) and (max-width: 1280px){
.dashboard-3col{
/* IZQ más contenida + CENTRO ancho */
grid-template-columns: clamp(260px, 28vw, 320px) minmax(0, 1fr);
grid-template-rows: auto 1fr auto;
gap: 16px;
padding: 16px;
}

/* Orden claro: izquierda | centro | derecha debajo a todo el ancho */
.col-left   { order: 1; grid-column: 1; }
.col-middle { order: 2; grid-column: 2; }
.col-right  {
order: 3;
grid-column: 1 / -1;                 /* ocupa el ancho completo debajo */
display: grid;                        /* dos tarjetitas si cabe */
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 16px;
}
}

/* ===== Móvil / tablet estrecha: 1 columna (sube breakpoint) ===== */
@media (max-width: 960px){
.dashboard-3col{
grid-template-columns: 1fr;
grid-template-rows: auto auto auto auto;
}
.col-left,.col-right{ order: 2; }
.col-middle{ order: 1; }
}

/* Tamaños de tipografía un pelín más contenidos en tablet */
@media (min-width: 980px) and (max-width: 1280px){
#kpi-costes .kpi-value.large{ font-size: clamp(1.6rem, 3.8vw, 2.6rem); }
header h1{ font-size: clamp(1.4rem, 0.9vw + 1rem, 1.9rem); }
}

.dashboard-3col{
padding:
max(clamp(12px, 2vw, 28px), env(safe-area-inset-top))
max(clamp(12px, 2vw, 28px), env(safe-area-inset-right))
max(clamp(12px, 2vw, 28px), env(safe-area-inset-bottom))
max(clamp(12px, 2vw, 28px), env(safe-area-inset-left));
gap: 16px;
}
/* iPad portrait ~768x1024 */
@media (min-width: 768px) and (max-width: 979.98px){
.dashboard-3col{
grid-template-columns: 1fr;               /* 1 columna */
grid-template-rows: auto auto auto;
}
#brief-check .check-grid{ grid-template-columns: 1fr; }
header h1{ font-size: clamp(1.2rem, 1.6vw + 1rem, 1.6rem); }
}

/* iPad landscape ~1024x1366 */
@media (min-width: 980px) and (max-width: 1366px){
.dashboard-3col{
grid-template-columns:
clamp(240px, 26vw, 300px)  /* izq */
minmax(0, 1fr);            /* centro */
grid-template-rows: auto 1fr auto;
}
.col-right{
grid-column: 1 / -1;         /* derecha debajo a todo el ancho */
display: grid;
grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
gap: 16px;
}
}
/* encabezados pegados por debajo de barra de Safari */
#planif-table thead th, #incidentes-table thead th{
position: sticky; top: 0;
z-index: 2;
}
.table-scroll{ padding-bottom: 8px; } /* evita corte del último tr */
/* evita subpixel shake al hacer zoom a UI scale */
html{ -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }

/* títulos que no “salten” por el scale del kanban */
.card-title{ transform: none; }
/* Placeholder visual para la nota del turno anterior */
.editable-note[contenteditable="true"]:empty:before{
content: attr(data-placeholder);
color: var(--text-muted);
}

/* Turno centrado dentro del checklist */
#brief-check .shift-chip{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: #fff;
  font-weight: 600;
  font-size: .9rem;
  margin: 6px auto 10px;   /* <- lo centra horizontalmente */
}

/* Colores semánticos por turno (aplican a cualquier .shift-chip con data-shift) */
.shift-chip[data-shift="Mañana"]{
  background:#ecfdf5; color:#065f46; border-color:#a7f3d0;
}
.shift-chip[data-shift="Tarde"]{
  background:#fff7ed; color:#9a3412; border-color:#fed7aa;
}
.shift-chip[data-shift="Noche"]{
  background:#eef2ff; color:#3730a3; border-color:#c7d2fe;
}
@media (prefers-reduced-motion: reduce){
  * { animation: none !important; transition: none !important; }
}
#brief-check { backdrop-filter: saturate(105%) blur(2px); }
/* === KPIs centro === */
.kpi-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap:12px;
}
.kpi-tile{
  border:1px solid var(--border);
  border-radius:12px;
  background:#fff;
  padding:14px;
  box-shadow:0 6px 18px rgba(17,24,39,.06);
}
.kpi-label{
  font-weight:700;
  font-size:.9rem;
  color:var(--text-muted);
  margin-bottom:4px;
}
.kpi-value{
  font-family:"Space Grotesk", Inter, system-ui, sans-serif;
  font-weight:800;
  font-size: clamp(1.6rem, 2.6vw + .4rem, 2.6rem);
  line-height:1;
  color:var(--brand-red-600);
}
.kpi-tile.flash{ animation: flash-kpi 900ms ease-out; }
/* === FIX: Equipo/Turno – el botón "Subir Excel" se sale de la tarjeta === */
#team-widget #roster-upload-form{
  display: grid !important;          /* pisa el inline style="display:flex" */
  grid-template-columns: 1fr auto;   /* input expansivo + botón al lado */
  gap: 8px;
  align-items: center;
  width: 100%;
}

#team-widget #roster-file{
  min-width: 0;          /* permite que el input encoja sin romper el grid */
  width: 100%;
  overflow: hidden;      /* evita que el texto largo desborde */
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* separa el botón nativo del file input (Safari/Chrome/WebKit) */
#team-widget #roster-file::-webkit-file-upload-button{ margin-right: 8px; }
/* equivalente estándar si está disponible */
@supports selector(::file-selector-button){
  #team-widget #roster-file::file-selector-button{ margin-right: 8px; }
}

/* En móviles, apila: input arriba, botón debajo */
@media (max-width: 520px){
  #team-widget #roster-upload-form{
    grid-template-columns: 1fr;
  }
}

#brief-check .br-explain{
  margin: 6px 0 10px;
  padding: 8px 10px;
  border: 1px dashed var(--border);
  border-radius: 8px;
  background: #fafafa;
  font-size: .9rem;
  min-height: 1.6em;            /* evita “saltos” de altura */
}
#brief-check .check-card:focus{
  outline: 2px solid rgba(239,68,68,.35);
  outline-offset: 2px;
  border-radius: 10px;
}

/* Caja de explicación con alto contraste */
#brief-check .br-explain{
  display:flex; align-items:center; gap:8px;
  margin: 8px 0 12px;
  padding: 10px 12px;
  background:#fff;                               /* fondo blanco para legibilidad */
  color: var(--brand-red-700);                   /* texto rojo oscuro */
  border: 2px solid var(--brand-red-600);        /* borde rojo marca */
  border-radius: 12px;
  box-shadow: 0 6px 16px rgba(239,68,68,.12);    /* leve sombra rojiza */
  font-size: .95rem;
  line-height: 1.35;
  min-height: 44px;                              /* cómodo táctil */
}

/* Icono dentro de una píldora */
#brief-check .br-explain-ico{
  display:inline-flex; align-items:center; justify-content:center;
  width: 26px; height: 26px; border-radius: 999px;
  background: linear-gradient(135deg, var(--brand-red-600), var(--brand-red-700));
  color:#fff;
  box-shadow: 0 4px 10px rgba(239,68,68,.25);
  flex: 0 0 26px;
}

#brief-check .br-explain-label{
  font-weight: 800; letter-spacing:.2px;
}

#brief-check .br-explain-text{
  font-weight: 600;
}

/* Mejoras de foco/teclado */
#brief-check .check-card:focus,
#brief-check .check-card:focus-visible{
  outline: 2px solid rgba(239,68,68,.5);
  outline-offset: 3px;
  border-radius: 10px;
}

/* === Chips de categoría con color distinto === */
#kanban-widget .cat-chip{ font-weight:800; }
#kanban-widget .cat-chip.is-seguridad   { background:#fee2e2; color:#7f1d1d; border-color:#fecaca; }
#kanban-widget .cat-chip.is-incidencias { background:#fff1e6; color:#7a3800; border-color:#ffd7b5; }
#kanban-widget .cat-chip.is-mantenimiento{background:#eaf8f0; color:#065f46; border-color:#b7f0d3; }
#kanban-widget .cat-chip.is-calidad     { background:#fce7ff; color:#6b21a8; border-color:#f0abfc; }
#kanban-widget .cat-chip.is-servicio    { background:#fef9c3; color:#854d0e; border-color:#fde68a; }

/* (opcional) fondo completo por categoría ya existente, añade faltantes */
#kanban-widget .card.cat-calidad  { background: var(--cat-cal); }
#kanban-widget .card.cat-servicio { background: var(--cat-ser); }

/* Compact buttons usados en tarjetas */
.btn-compact{
  display:inline-flex; align-items:center; justify-content:center;
  padding:4px 10px; border:1px solid var(--border);
  border-radius:999px; background:#fff; font-size:.8rem; cursor:pointer;
}
.btn-compact:hover{ filter:saturate(108%); transform:translateY(-1px); }

/* Base del cronómetro (si no está) */
.header-timer{ display:flex; align-items:center; gap:10px; }
.header-timer .timer-face{ display:flex; align-items:center; gap:10px; }
.header-timer .timer-display{ font-family:"Space Grotesk", Inter, system-ui, sans-serif; font-weight:800; }
.header-timer .timer-dot{ width:10px; height:10px; border-radius:50%; background: var(--brand-red-600); opacity:.75; }
.header-timer .timer-reset{ border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer; }

/* Chips rojas en Incidentes (versión borde rojo + fondo blanco) — deja solo una */
#incidentes-widget .incident-remember{
  margin: 6px 0 8px; padding: 10px 12px;
  background:#fff; color: var(--brand-red-700);
  border: 2px solid var(--brand-red-600); border-radius: 12px; box-shadow:none;
  font-weight:800; letter-spacing:.2px;
}
#incidentes-widget .title-bullets{
  list-style:none; margin:0 0 10px; padding:0; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
#incidentes-widget .title-chip{
  display:inline-flex; align-items:center; padding:6px 12px; border-radius:999px;
  font-size:.8rem; font-weight:700; background:#fff; color: var(--brand-red-700);
  border: 2px solid var(--brand-red-600); box-shadow:none;
}
#incidentes-widget .title-chip:hover{ box-shadow:0 0 0 3px rgba(239,68,68,.12); transform:none; filter:none; }

/* ===== Actualizaciones Operativas + Seguridad & Protección ===== */
.ops-list, .sec-list{
  display:flex; flex-direction:column; gap:10px;
}
.ops-item, .sec-item{
  border:1px solid var(--border); border-radius:10px; background:#fff; padding:10px 12px;
  display:flex; flex-direction:column; gap:6px;
}
.meta-row{ color:var(--text-muted); font-size:.82rem; display:flex; gap:10px; flex-wrap:wrap; }
.badge{
  display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border);
  border-radius:999px; background:#fff; font-weight:700; font-size:.78rem;
}

/* Form compacto dentro de tarjeta */
.inline-form{ display:grid; grid-template-columns: 1fr 1fr auto; gap:8px; align-items:center; }
.inline-form input, .inline-form select{ padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#fff; }
@media (max-width:700px){
  .inline-form{ grid-template-columns: 1fr; }
}

/* Píldoras de riesgo/estado en Seguridad */
.risk-pill{
  display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border);
  border-radius:999px; background:#fff; font-size:.82rem; font-weight:700; cursor:pointer; user-select:none;
}
.risk-pill.on{ background:#ffe3e3; color:#991b1b; border-color:#fecaca; }

/* Nota de seguridad */
.sec-note{
  width:100%; min-height:60px; border:1px solid var(--border); border-radius:8px; padding:8px; background:#fff; font-size:.9rem;
}

/* —— Distribución checklist “como BCN”: 3 columnas en desktop —— */
#brief-check .check-grid{
  grid-template-columns: repeat(3, minmax(260px, 1fr));
}
@media (max-width:1100px){
  #brief-check .check-grid{ grid-template-columns: 1fr; }
}
#incidentes-widget .incident-remember.filled{
  background:#fff;
  color: var(--brand-red-700);
  border: 3px solid var(--brand-red-600);
}
/* === OPS: tarjetas ricas, prioridad, estados === */
.ops-item{
  border:1px solid var(--border); border-radius:12px; background:#fff;
  padding:12px; display:flex; flex-direction:column; gap:8px;
}
.ops-head{ display:flex; align-items:center; gap:8px; justify-content:space-between; }
.ops-title{ font-weight:800; font-size:1rem; }
.ops-flags{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

.ops-impact{ font-weight:800; font-size:.75rem; padding:4px 10px; border-radius:999px; border:2px solid transparent; }
.ops-impact.Alto  { color:#991b1b; background:#ffe3e3; border-color:#fecaca; }
.ops-impact.Medio { color:#854d0e; background:#fff7ed; border-color:#fed7aa; }
.ops-impact.Bajo  { color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }

.ops-scope{ font-size:.75rem; padding:3px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }

.ops-meta{ color:var(--text-muted); font-size:.82rem; display:flex; gap:10px; flex-wrap:wrap; }

.ops-actions{ display:flex; gap:8px; flex-wrap:wrap; }
.ops-btn{
  border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 10px; font-size:.8rem; cursor:pointer;
}
.ops-btn:hover{ filter:saturate(108%); transform:translateY(-1px); }
.ops-pin.on{ background:#fffbea; border-color:#fde68a; }

.ops-ack{
  display:flex; align-items:center; gap:8px; flex-wrap:wrap; 
  background:#fafafa; border:1px dashed var(--border); border-radius:10px; padding:8px;
}
.ops-ack-bar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; width:160px; }
.ops-ack-bar > span{ display:block; height:100%; width:0; background:linear-gradient(90deg,#34d399,#10b981); }

.ops-stale{ opacity:.6; }
.ops-expired{ opacity:.5; text-decoration:line-through; }
#ops-updates-widget .ops-grid{
  display:grid; gap:12px;
  grid-template-columns: 1fr;   /* antes: 1fr 1fr */
}
@media (max-width:1100px){
  #ops-updates-widget .ops-grid{ grid-template-columns: 1fr; }
}
.ops-impact.Alto  { color:#991b1b; background:#ffe3e3; border-color:#fecaca; }
.ops-impact.Medio { color:#854d0e; background:#fff7ed; border-color:#fed7aa; }
.ops-impact.Bajo  { color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }

  /* ===== Estética viva para OPS, Seguridad e Incidentes ===== */
:root{
  --vivid-pink:#ff4d8d; --vivid-orange:#ff7a18; --vivid-yellow:#ffd43b;
  --vivid-green:#10b981; --vivid-blue:#3b82f6; --vivid-violet:#8b5cf6;
  --vivid-red:#ef4444; --vivid-amber:#f59e0b;
}

/* Cabecera hero: gradiente con “badge” */
.widget.vivid .widget-title.hero{
  position: relative;
  display:flex; align-items:center; gap:10px;
  padding:12px 14px;
  margin:-16px -16px 12px;                 /* ocupa ancho completo de la tarjeta */
  border-radius:12px 12px 0 0;
  color:#0b1220;
  background:
    radial-gradient(1200px 200px at 10% -140px, rgba(255,255,255,.7), transparent),
    linear-gradient(135deg, #fff 0%, #ffe9f2 40%, #fff5e6 100%);
  border-bottom: 2px solid rgba(0,0,0,.05);
}
.widget.vivid .hero-ico{ font-size:1.15rem; transform: translateY(1px); }
.widget.vivid .hero-badge{
  margin-left:auto;
  font-size:.72rem; font-weight:900; letter-spacing:.3px;
  padding:6px 10px; border-radius:999px;
  background:linear-gradient(135deg, var(--vivid-blue), var(--vivid-violet));
  color:#fff; box-shadow:0 6px 14px rgba(59,130,246,.25);
}
.widget.vivid .hero-badge.warn{
  background:linear-gradient(135deg, var(--vivid-amber), var(--vivid-yellow));
  color:#2b1800;
  box-shadow:0 6px 14px rgba(245,158,11,.25);
}
.widget.vivid .hero-badge.danger{
  background:linear-gradient(135deg, #ff8a8a, var(--vivid-red));
  color:#fff;
}

/* Tarjeta base con borde vivo */
.widget.vivid{
  border:1.5px solid rgba(0,0,0,.06);
  box-shadow: 0 10px 28px rgba(17,24,39,.10);
  overflow:hidden;
}

/* ===== OPS: tarjetas con “ribbon” de prioridad y acción más visual ===== */
#ops-updates-widget.vivid .ops-item{
  position:relative;
  border:1px solid rgba(0,0,0,.06);
  background:#fff;
  border-radius:14px;
  padding:12px 12px 10px 12px;
  box-shadow:0 8px 22px rgba(17,24,39,.08);
  overflow:hidden;
}
#ops-updates-widget.vivid .ops-item::before{
  content:"";
  position:absolute; inset:0 0 0 auto; width:8px;
  background: var(--ops-ribbon, linear-gradient(180deg, var(--vivid-blue), var(--vivid-violet)));
  opacity:.85;
}

#ops-updates-widget.vivid .ops-item .ops-impact{
  border:0; font-weight:900;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
#ops-updates-widget.vivid .ops-item .ops-impact.Alto{
  background:linear-gradient(135deg,#ffb3b3, var(--vivid-red)); color:#611818;
}
#ops-updates-widget.vivid .ops-item .ops-impact.Medio{
  background:linear-gradient(135deg,#ffe7b3, var(--vivid-amber)); color:#663a00;
}
#ops-updates-widget.vivid .ops-item .ops-impact.Bajo{
  background:linear-gradient(135deg,#bff0da, var(--vivid-green)); color:#0b4a37;
}
#ops-updates-widget.vivid .ops-item .ops-scope{
  background:#eef2ff; color:#1f2a73; border-color:#c7d2fe;
  font-weight:800;
}

/* Botones estilo “sticker” */
#ops-updates-widget.vivid .ops-btn{
  border:0; font-weight:800;
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  border-radius:999px; padding:6px 12px;
}
#ops-updates-widget.vivid .ops-pin.on{
  background:linear-gradient(135deg,#fff7cc,#ffe083); border:0;
}

/* Barra de acuses con rayas diagonales cuando <100% */
#ops-updates-widget.vivid .ops-ack{
  background:#fffdf5; border:1px dashed #ffe08a;
}
#ops-updates-widget.vivid .ops-ack-bar{
  background:#f2f4f7;
}
#ops-updates-widget.vivid .ops-ack-bar > span{
  background-image:
    repeating-linear-gradient(45deg, rgba(16,185,129,.85) 0 10px, rgba(16,185,129,.55) 10px 20px);
  transition:width .3s ease;
}

/* Estados caducado/antiguo más evidentes */
#ops-updates-widget.vivid .ops-expired{ filter:grayscale(.3); opacity:.55; }
#ops-updates-widget.vivid .ops-stale{  box-shadow:0 0 0 3px rgba(255,196,0,.18) inset; }

/* ===== Seguridad: “chips” toggle con icono e indicadores claros ===== */
#seguridad-widget.vivid .risk-pill{
  border:0; font-weight:900;
  background:#fff;
  box-shadow:0 6px 16px rgba(17,24,39,.08);
}
#seguridad-widget.vivid .risk-pill[data-risk="EPIs"]{    background:linear-gradient(135deg,#e0fffb,#8be8ff); }
#seguridad-widget.vivid .risk-pill[data-risk="Permisos"]{background:linear-gradient(135deg,#e9ffd8,#a8ff78); }
#seguridad-widget.vivid .risk-pill[data-risk="Accesos"]{ background:linear-gradient(135deg,#ffe3ee,#ffc0cb); }
#seguridad-widget.vivid .risk-pill[data-risk="Cargas"]{  background:linear-gradient(135deg,#fff0d1,#ffd43b); }
#seguridad-widget.vivid .risk-pill[data-risk="Vehículos"]{background:linear-gradient(135deg,#e6e8ff,#b7c2ff); }

#seguridad-widget.vivid .risk-pill.on{
  outline: 3px solid rgba(0,0,0,.08);
  transform: translateY(-1px);
}

#seguridad-widget.vivid .sec-note{
  border:2px dashed rgba(0,0,0,.08);
  background:
    radial-gradient(800px 120px at 20% -80px, rgba(255,255,255,.8), transparent),
    #fff;
  box-shadow:0 8px 20px rgba(17,24,39,.06);
}

/* “Tips” del día con colorines */
#seguridad-widget.vivid .sec-list .sec-item{
  border:0; border-left:6px solid #a7f3d0;
  background:#f6fffb; border-radius:12px; padding:10px 12px;
}

/* ===== Incidentes: table candy + chips rojas con relieve ===== */
#incidentes-widget.vivid .incident-remember{
  background:
    linear-gradient(135deg,#fff,#ffe7ea 60%),
    repeating-linear-gradient(45deg, rgba(239,68,68,.06) 0 8px, rgba(239,68,68,.12) 8px 16px);
  border: 2px solid var(--brand-red-600);
  color: var(--brand-red-700);
  box-shadow:0 10px 24px rgba(239,68,68,.12);
}

#incidentes-widget.vivid .title-chip{
  background:linear-gradient(135deg,#fff,#ffe6e6);
  color:var(--brand-red-700);
  border:2px solid var(--brand-red-600);
  box-shadow:0 6px 14px rgba(239,68,68,.18);
  font-weight:900;
}

/* Tabla con zebra + cabecera “sticky” con fondo cálido */
#incidentes-widget.vivid .table-scroll table{
  border:1px solid #ffe0e0; border-radius:12px; overflow:hidden;
}
#incidentes-widget.vivid table thead th{
  background: linear-gradient(180deg,#fff1f1,#ffe5e5);
  border-bottom:1px solid #ffd0d0;
  font-weight:800;
}
#incidentes-widget.vivid table tbody tr:nth-child(odd){ background:#fffafa; }
#incidentes-widget.vivid table tbody tr:hover{ background:#fff2f2; }

/* Etiquetas de estado (si las pintas en celdas) */
#incidentes-widget.vivid .tag-ok{
  background:#e3f9e5; color:#166534; font-weight:800; padding:3px 8px; border-radius:999px;
}
#incidentes-widget.vivid .tag-warn{
  background:#fff7ed; color:#9a3412; font-weight:800; padding:3px 8px; border-radius:999px;
}
#incidentes-widget.vivid .tag-danger{
  background:#ffe3e3; color:#991b1b; font-weight:800; padding:3px 8px; border-radius:999px;
}
/* Estado de alerta del cronómetro */
.header-timer .timer-display {
  transition: color .2s ease, text-shadow .2s ease;
}
.header-timer .timer-display.is-red{
  color: var(--brand-red-600);
  text-shadow: 0 0 0 rgba(0,0,0,0); /* suave, opcional */
}

/* —— TOKENS VISUALES (sobrios, consistentes) —— */
:root{
  /* Neutros más calmados */
  --bg-page:#F5F6F8;
  --bg-card:#FFFFFF;
  --border:#E5E7EB;
  --text:#111827;
  --text-muted:#6B7280;

  /* Marca (un solo rojo protagonista) */
  --brand:#EF4444;
  --brand-600:#EF4444;
  --brand-700:#DC2626;

  /* Estados semánticos (suaves) */
  --ok:#10B981; --warn:#F59E0B; --danger:#EF4444; --info:#3B82F6;

  /* Elevaciones (3 niveles) */
  --elev-1: 0 4px 12px rgba(17,24,39,.06);
  --elev-2: 0 8px 20px rgba(17,24,39,.08);
  --elev-3: 0 12px 28px rgba(17,24,39,.10);

  /* Radios */
  --radius:12px;
  --radius-lg:16px;
}
.widget,.card{ border-radius: var(--radius); box-shadow: var(--elev-1); }
.widget:hover{ box-shadow: var(--elev-2); }
.btn-primary{
  background: linear-gradient(135deg, var(--brand-600), var(--brand-700));
  border-radius: 10px; box-shadow: 0 6px 16px rgba(239,68,68,.22);
}
/* Header más limpio */
header{
  background:#fff; border:1px solid var(--border);
  padding:14px 16px; border-radius: var(--radius);
  box-shadow: var(--elev-1);
}
header .header-left{ gap:6px; }
header h1{ color:#0F172A; letter-spacing:.1px; }
#now-header, #shift-badge-header{
  font-size:.85rem; color:var(--text-muted);
}
.header-controls input, .header-controls .btn-primary{ height:40px; }
/* Tarjeta con ribbon lateral (categoria) */
#kanban-widget .card{
  background:#fff; border:1px solid var(--border); position:relative;
  padding-left:14px; /* deja sitio visual al ribbon */
}
#kanban-widget .card::before{
  content:""; position:absolute; left:0; top:8px; bottom:8px; width:4px; border-radius:8px;
  background:#E5E7EB; /* default */
}
/* Mapea categorías a ribbon */
#kanban-widget .card.cat-seguridad::before   { background:#FCA5A5; }  /* rojo suave */
#kanban-widget .card.cat-incidencias::before { background:#FCD34D; }  /* ámbar */
#kanban-widget .card.cat-mantenimiento::before{background:#86EFAC;}  /* verde */
#kanban-widget .card.cat-calidad::before     { background:#C4B5FD; }  /* violeta suave */
#kanban-widget .card.cat-servicio::before    { background:#FDE68A; }  /* amarillo */
#kanban-widget .cat-chip{ background:#F9FAFB; font-weight:700; }
/* Títulos pegados y consistentes */
#kanban-widget .kanban-column{ gap:8px; }
#kanban-widget .column-title{
  position: sticky; top: 0; z-index: 2;
  background: #fff; border:1px solid var(--border);
  padding:10px 12px; border-radius: 10px; box-shadow: var(--elev-1);
}
/* Contenido con padding uniforme */
.cards-container{ padding: 6px 2px 8px 2px; }
.card{ gap:10px; min-height:58px; }
.card-title{ font-weight:700; font-size:.95rem; }
.card-details, .card-assignee{ font-size:.8rem; color:var(--text-muted); }
.kpi-grid{ gap:14px; }
.kpi-tile{
  border:1px solid var(--border); border-radius: var(--radius);
  background:#fff; box-shadow: var(--elev-1); padding:16px;
}
.kpi-label{ color:#6B7280; font-weight:700; margin-bottom:4px; }
.kpi-value{ color:#0F172A; font-weight:800; }
.kpi-value .neg{ color:var(--danger); } .kpi-value .pos{ color:var(--ok); }
.kpi-text{ color:#6B7280; }
/* Solo una versión sobria */
#incidentes-widget .incident-remember{
  background:#fff; color: var(--brand-700);
  border: 2px solid var(--brand-600); border-radius: 12px; box-shadow:none;
  font-weight:800; letter-spacing:.2px; padding:10px 12px; margin:6px 0 8px;
}
#incidentes-widget .title-bullets{ display:flex; gap:8px; flex-wrap:wrap; margin:0 0 10px; }
#incidentes-widget .title-chip{
  background:#fff; color: var(--brand-700);
  border: 2px solid var(--brand-600); border-radius:999px; font-weight:800;
  padding:6px 12px; box-shadow:none;
}
#incidentes-widget .table-scroll table{
  border:1px solid #FEE2E2; border-radius:12px; overflow:hidden;
}
#incidentes-widget table thead th{
  background:#FFF1F2; border-bottom:1px solid #FECACA; font-weight:800;
}
#incidentes-widget table tbody tr:nth-child(odd){ background:#FFF7F7; }
#incidentes-widget table tbody tr:hover{ background:#FFEFEF; }
:root{ --density: 1; } /* 1=por defecto, .9=compacto, 1.1=cómodo */
:root{
  --pad-1: calc(6px * var(--density));
  --pad-2: calc(10px * var(--density));
  --gap-1: calc(8px * var(--density));
  --gap-2: calc(12px * var(--density));
}
.widget{ padding: var(--pad-2); }
.cards-container{ padding-top: calc(4px * var(--density)); }
@media (prefers-color-scheme: dark){
  :root{
    --bg-page:#0B1220; --bg-card:#0F172A; --border:#1F2937;
    --text:#E5E7EB; --text-muted:#9CA3AF;
  }
  .widget,.card{ box-shadow:none; }
  .btn-primary{ box-shadow:0 8px 18px rgba(239,68,68,.18); }
}
/* === Navegación dentro de Widgets (Fullscreen) === */
/* === Navegación dentro de Widgets (Fullscreen) === */
.widget-nav-bar {
    display: none; /* Oculto por defecto */
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border);
    /* Margen negativo para pegar a los bordes de la tarjeta */
    margin: -20px -20px 20px -20px; 
    position: sticky;
    top: 0;
    /* Z-Index superior al contenido de la tarjeta */
    z-index: 50; 
}

/* Mostrar solo cuando está en pantalla completa o zoomed */
.widget:fullscreen .widget-nav-bar,
/* === TARJETA EN PANTALLA COMPLETA (CORREGIDO) === */
.widget.widget--zoomed {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    
    /* Usamos 100% en lugar de 100vw para evitar scroll horizontal por la barra vertical */
    width: 100% !important;
    height: 100% !important; /* Fallback */
    height: 100dvh !important; /* Altura dinámica real en móviles */
    
    z-index: 20000 !important;
    background: #ffffff !important;
    
    /* ESTA LÍNEA ES LA CLAVE: Hace que el padding no aumente el ancho total */
    box-sizing: border-box !important;
    
    /* Padding inferior grande para que el cronómetro no tape el final */
    padding: 0 0 160px 0 !important; 
    
    overflow-y: auto !important; /* Scroll vertical permitido */
    overflow-x: hidden !important; /* Prohibido scroll horizontal */
    
    margin: 0 !important;
    border-radius: 0 !important;
    border: none !important;
    display: block !important;
}

/* Ajuste para que el contenido interno tenga margen lateral en modo zoom */
.widget.widget--zoomed > *:not(.widget-nav-bar) {
    margin-left: 20px;
    margin-right: 20px;
}

/* Ajuste de la barra de navegación en modo zoom para que quede pegada arriba */
.widget.widget--zoomed .widget-nav-bar {
    margin: 0 !important;
    width: 100% !important;
    border-radius: 0 !important;
    border-left: none;
    border-right: none;
    border-top: none;
    box-sizing: border-box !important;
    position: sticky !important;
    top: 0 !important;
}

.nav-group { display: flex; gap: 10px; }

.btn-nav {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    color: #374151;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
}
.btn-nav:hover { background: #e5e7eb; transform: translateY(-1px); }

.btn-nav.home {
    background: #fee2e2;
    color: #991b1b;
    border-color: #fca5a5;
}
.btn-nav.home:hover { background: #fecaca; }
/* =============================================
   PANTALLA MODO INFO (POST-BRIEFING)
   ============================================= */
#post-briefing-screen {
    display: none; /* Oculto por defecto */
    position: fixed;
    inset: 0; /* Ocupa toda la pantalla */
    background-color: #f8fafc;
    z-index: 99999; /* Por encima de todo */
    padding: 20px;
    flex-direction: column;
}

#post-briefing-screen.active {
    display: flex;
}

/* Cabecera del modo info */
.pb-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e2e8f0;
}

.pb-title {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--brand-red-700);
    font-family: "Space Grotesk", sans-serif;
}

.pb-close-btn {
    background: #334155;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: background 0.2s;
}
.pb-close-btn:hover { background: #1e293b; }

/* Grid 2x2 para los contenidos */
.pb-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    flex: 1;
    overflow: hidden; /* Evita scroll global */
}

.pb-card {
    background: white;
    border: 1px solid #cbd5e1;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.pb-card-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #475569;
    margin-bottom: 15px;
    border-bottom: 4px solid var(--brand-red-500);
    padding-bottom: 5px;
    display: inline-block;
    width: fit-content;
}

.pb-content {
    flex: 1;
    overflow-y: auto;
    font-size: 1.1rem; /* Texto más grande para leer de lejos */
    line-height: 1.6;
}

/* Estilos específicos para listas clonadas */
.pb-content ul { padding-left: 20px; margin: 0; }
.pb-content li { margin-bottom: 8px; }
.pb-kpi-box {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 100%;
}
.pb-kpi-item {
    text-align: center;
    padding: 20px;
    background: #f1f5f9;
    border-radius: 12px;
    min-width: 150px;
}
.pb-kpi-val { font-size: 3rem; font-weight: 800; color: var(--brand-red-600); display: block; }
.pb-kpi-lbl { font-size: 1.2rem; color: #64748b; font-weight: 600; }

/* Responsive para tablet vertical */
@media (max-width: 1000px) {
    .pb-grid { grid-template-columns: 1fr; grid-template-rows: auto; overflow-y: auto; }
    #post-briefing-screen { overflow-y: auto; }
}

/* === Navegación Guiada en Widgets === */
.widget-nav-bar {
    display: none; /* Oculto por defecto */
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 10px 15px;
    border-bottom: 1px solid var(--border);
    margin: -16px -16px 16px -16px; /* Contrarresta padding del widget */
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

/* Mostrar solo cuando está en pantalla completa o zoomed */
.widget:fullscreen .widget-nav-bar,
.widget.widget--zoomed .widget-nav-bar {
    display: flex;
}

.nav-group { display: flex; gap: 10px; align-items: center; }

.btn-nav {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #d1d5db;
    background: #f8fafc;
    color: #334155;
}
.btn-nav:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.btn-nav:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-nav.home { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
.btn-nav.next-ok { background: #dcfce7; color: #166534; border-color: #86efac; }
.btn-nav.next-ok:hover { background: #bbf7d0; }
/* =========================================
   ESTILOS PARA CAMBIO DE TURNO AUTOMÁTICO
   ========================================= */

/* Clase que se añade al widget de Checklist para forzar pantalla completa (Fake Fullscreen) */
.widget.shift-focus {
    position: fixed !important;
    inset: 0 !important; /* Top, right, bottom, left: 0 */
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9990 !important; /* Muy alto, tapa todo */
    margin: 0 !important;
    border-radius: 0 !important;
    overflow-y: auto !important;
    background: rgba(255, 255, 255, 0.98) !important;
    padding: 40px 20px 120px 20px !important; /* Padding inferior extra para el cronómetro */
    display: block !important; /* Asegura que sea visible */
    box-shadow: none !important;
    animation: zoom-in-shift 0.4s ease-out forwards;
}

/* Animación de entrada */
@keyframes zoom-in-shift {
    from { transform: scale(0.95); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

/* Título más grande en modo cambio de turno */
.widget.shift-focus .widget-title {
    font-size: 2rem;
    text-align: center;
    margin-bottom: 30px;
    color: var(--brand-red-700);
}

/* Tarjetas del checklist más grandes para facilitar el toque */
.widget.shift-focus .check-grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
    max-width: 1200px;
    margin: 0 auto;
}

.widget.shift-focus .check-card {
    padding: 20px;
    border: 2px solid var(--border);
}

/* === CRONÓMETRO FLOTANTE === */
/* Cuando el body tiene la clase 'shift-active', movemos el cronómetro */
body.shift-active #timer-widget {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000; /* Por encima del checklist */
    background: #fff;
    padding: 15px 40px;
    border-radius: 50px;
    box-shadow: 0 10px 40px rgba(220, 38, 38, 0.25); /* Sombra roja suave */
    border: 3px solid var(--brand-red-600);
    display: flex !important;
    gap: 20px;
}

body.shift-active .timer-display {
    font-size: 3rem; /* Números gigantes */
    font-variant-numeric: tabular-nums;
}

/* Botón para salir manualmente si es necesario */
/* Botón para salir manualmente si es necesario */
#exit-shift-mode-btn {
    display: none; /* Oculto por defecto */
    position: fixed;
    top: 20px;
    right: 20px;
    /* Z-INDEX MÁXIMO para que nada lo tape */
    z-index: 2147483647 !important; 
    padding: 12px 24px;
    background: #334155;
    color: white;
    border: 2px solid #fff;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 800;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Mostrar botón tanto si la clase es shift-active como shift-mode */
body.shift-active #exit-shift-mode-btn,
body.shift-mode #exit-shift-mode-btn {
    display: block !important;
}


/* =================================================
   CRONÓMETRO FLOTANTE (FIX)
   ================================================= */

/* Solo se activa cuando el body tiene la clase 'shift-active' */
body.shift-active #timer-widget {
    position: fixed !important;
    bottom: 30px !important;
    left: 50% !important;
    transform: translateX(-50%) !important; /* Centrado perfecto */
    
    /* VISIBILIDAD Y CAPA */
    z-index: 10000 !important; /* MÁS ALTO que el checklist (9990) */
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    
    /* ESTÉTICA */
    background-color: #ffffff !important;
    padding: 15px 50px !important;
    border-radius: 50px !important;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4) !important;
    border: 4px solid #dc2626 !important;
    gap: 20px !important;
    width: auto !important;
    height: auto !important;
}

/* Texto del cronómetro gigante */
body.shift-active #timer-display {
    font-size: 4rem !important;
    font-family: 'Space Grotesk', monospace !important;
    font-weight: 800 !important;
    color: #1f2937 !important;
    line-height: 1 !important;
}

/* Botón de reset un poco más grande */
body.shift-active #timer-reset {
    width: 60px !important;
    height: 60px !important;
    font-size: 24px !important;
    border-radius: 50% !important;
    background: #f3f4f6 !important;
    cursor: pointer !important;
}

/* Botón de SALIDA DE EMERGENCIA (Arriba derecha) */
#exit-shift-btn {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10001 !important;
    background: #333;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}
body.shift-active #exit-shift-btn {
    display: block;
}
/* =========================================================
   JERARQUÍA VISUAL PARA MODO CAMBIO DE TURNO
   ========================================================= */

/* 1. EL CRONÓMETRO: SIEMPRE ENCIMA DE TODO */
body.shift-active #timer-widget {
    position: fixed !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 20000 !important; /* Capa Suprema */
    
    /* Diseño Gigante y Claro */
    display: flex !important;
    background: #fff !important;
    padding: 10px 40px !important;
    border-radius: 50px !important;
    border: 4px solid #dc2626 !important;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5) !important;
    width: auto !important;
    height: auto !important;
}

body.shift-active #timer-display {
    font-size: 3.5rem !important;
    font-weight: 800 !important;
    color: #1f2937 !important;
    font-variant-numeric: tabular-nums;
}

/* 2. EL CHECKLIST (Pantalla Base del Modo Turno) */
.widget.shift-focus {
    position: fixed !important;
    inset: 0 !important;
    z-index: 10000 !important; /* Capa Base */
    background: #f8fafc !important;
    padding-bottom: 140px !important; /* Espacio para el crono */
    overflow-y: auto !important;
    border: none !important;
    margin: 0 !important;
}

/* 3. LAS TARJETAS INDIVIDUALES (Cuando navegas: Dotación, Ops, etc.) */
body.shift-active .widget.widget--zoomed {
    position: fixed !important;
    inset: 0 !important;
    z-index: 15000 !important; /* Capa Media (Encima del checklist, debajo del crono) */
    background: #ffffff !important;
    padding: 20px 20px 140px 20px !important; /* Espacio inferior vital para el crono */
    overflow-y: auto !important;
    margin: 0 !important;
    border-radius: 0 !important;
    display: block !important;
}

/* Asegurar que la barra de navegación (Siguiente/Anterior) se vea bien arriba */
body.shift-active .widget-nav-bar {
    position: sticky !important;
    top: 0 !important;
    z-index: 15001 !important; /* Encima del contenido de la tarjeta */
    background: #f1f5f9 !important;
    border-bottom: 2px solid #e2e8f0;
    padding: 15px !important;
}

/* Botones de navegación más grandes en este modo */
body.shift-active .btn-nav {
    padding: 12px 24px !important;
    font-size: 1.1rem !important;
}
/* =========================================================
   ESTILOS MODIFICADOS: MODO TURNO Y CRONÓMETRO
   ========================================================= */

/* --- 1. EL CRONÓMETRO FLOTANTE (Siempre encima de todo) --- */
body.shift-mode #timer-widget {
    position: fixed !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 20000 !important; /* Por encima de cualquier widget abierto */
    
    display: flex !important;
    background: #fff !important;
    padding: 10px 40px !important;
    border-radius: 50px !important;
    border: 4px solid #dc2626 !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4) !important;
    
    /* Asegura que se vea si estaba oculto */
    visibility: visible !important;
    opacity: 1 !important;
    width: auto !important;
    height: auto !important;
}

body.shift-mode #timer-display {
    font-size: 4rem !important; /* Números muy grandes */
    font-weight: 800 !important;
    color: #1f2937 !important;
    font-variant-numeric: tabular-nums;
    line-height: 1 !important;
}

body.shift-mode #timer-reset {
    width: 50px !important; height: 50px !important;
    font-size: 20px !important;
}

/* --- 2. WIDGETS EN "FALSO FULLSCREEN" (Para que el crono se vea encima) --- */
/* Esta clase se aplica al widget que estemos viendo en ese momento */
.widget.shift-focus {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 10000 !important; /* Debajo del cronómetro */
    
    background: #f8fafc !important; /* Fondo gris muy suave */
    overflow-y: auto !important;    /* Scroll interno si hace falta */
    padding: 30px 30px 140px 30px !important; /* Padding inferior grande para el crono */
    
    border-radius: 0 !important;
    margin: 0 !important;
    border: none !important;
    box-shadow: none !important;
}

/* --- 3. ARREGLO DEL CHECKLIST (Contenedor grande, tarjetas normales) --- */

/* Título en modo pantalla completa */
.widget.shift-focus .widget-title {
    font-size: 2rem !important;
    text-align: center;
    margin-bottom: 30px !important;
    color: #b91c1c;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 10px;
}

/* Grid: Usamos más columnas para aprovechar el ancho de la pantalla */
.widget.shift-focus .check-grid {
    display: grid !important;
    /* Mínimo 240px, caben 4 o 5 en una pantalla grande */
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)) !important; 
    gap: 15px !important;
    max-width: 1400px; /* No estirar al infinito */
    margin: 0 auto;
}

/* Tarjetas: Volvemos al diseño compacto y limpio */
.widget.shift-focus .check-card {
    padding: 15px !important;
    min-height: auto !important; /* Altura automática según contenido */
    background: #fff;
    border: 1px solid #cbd5e1;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.widget.shift-focus .check-title {
    font-size: 1.1rem !important;
    font-weight: 700;
    color: #334155;
    margin: 0 !important;
}

/* Botones dentro de la tarjeta: tamaño normal pero cómodos */
.widget.shift-focus .check-actions label {
    padding: 8px 16px !important;
    font-size: 0.95rem !important;
    width: 100%;
    text-align: center;
    background: #f1f5f9;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
}

.widget.shift-focus .check-actions input:checked + label {
    background: #dcfce7;
    color: #166534;
    border-color: #86efac;
    font-weight: 700;
}

/* --- 4. BARRA DE NAVEGACIÓN (Siguiente/Anterior) --- */
/* Asegurar que se pegue arriba cuando una tarjeta específica está abierta */
.widget.shift-focus .widget-nav-bar {
    position: sticky !important;
    top: 0 !important;
    z-index: 10001 !important;
    background: #fff;
    border-bottom: 1px solid #ddd;
    padding: 10px 20px;
    margin: -30px -30px 20px -30px !important; /* Compensar padding del widget */
}

/* === CRONÓMETRO SUPREMO (Nivel más alto) === */
body.shift-mode #timer-widget {
    /* Posición fija respecto a la ventana, ignorando el header */
    position: fixed !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    
    /* Z-INDEX MÁXIMO: Asegura que esté encima de cualquier tarjeta abierta */
    z-index: 2147483647 !important; 
    
    /* Estilo visual */
    display: flex !important;
    visibility: visible !important;
    background: #ffffff !important;
    padding: 10px 40px !important;
    border-radius: 50px !important;
    border: 4px solid #dc2626 !important;
    box-shadow: 0 10px 100px rgba(0,0,0,0.5) !important;
    width: auto !important;
    height: auto !important;
}

/* === TARJETA EN PANTALLA COMPLETA (Nivel medio) === */
/* Esta clase se aplica a la tarjeta (ej: Dotación) cuando pulsas en ella */
.widget.widget--zoomed {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    
    /* Z-INDEX MENOR QUE EL CRONÓMETRO (2147483647) pero mayor que el resto */
    z-index: 20000 !important; 
    
    background: #ffffff !important;
    /* Padding inferior de 180px OBLIGATORIO para que el crono no tape el contenido */
    padding: 20px 20px 180px 20px !important; 
    overflow-y: auto !important;
    margin: 0 !important;
    display: block !important;
}

/* =========================================================
   CORRECCIÓN DEFINITIVA: CAPAS Z-INDEX
   ========================================================= */

/* 1. EL CRONÓMETRO (Capa Suprema) */
body.shift-mode #timer-widget {
    position: fixed !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    
    /* El número más alto posible en CSS para asegurar que NADA lo tape */
    z-index: 2147483647 !important; 
    
    display: flex !important;
    background: #ffffff !important;
    padding: 10px 40px !important;
    border-radius: 50px !important;
    border: 4px solid #dc2626 !important;
    box-shadow: 0 10px 100px rgba(0,0,0,0.5) !important;
    
    visibility: visible !important;
    opacity: 1 !important;
    width: auto !important;
    height: auto !important;
}

/* 2. TARJETA ABIERTA EN GRANDE (Capa Media) */
.widget.widget--zoomed {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    
    /* Z-index alto (20000), pero MENOR que el cronómetro */
    z-index: 20000 !important; 
    
    background: #ffffff !important;
    /* Padding inferior gigante (180px) para que el contenido no se esconda detrás del crono */
    padding: 20px 20px 180px 20px !important; 
    overflow-y: auto !important;
    margin: 0 !important;
    border-radius: 0 !important;
    display: block !important;
}

/* 3. CHECKLIST DE FONDO (Capa Base) */
.widget.shift-focus {
    z-index: 10000 !important;
}

/* === CRONÓMETRO SUPREMO (Siempre visible abajo) === */
/* AÑADIMOS "body.card-open #timer-widget" AL SELECTOR */
body.shift-mode #timer-widget,
body.card-open #timer-widget { 
    position: fixed !important;
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    z-index: 2147483647 !important; /* Encima de todo */
    
    display: flex !important;
    background: #ffffff !important;
    padding: 10px 40px !important;
    border-radius: 50px !important;
    border: 4px solid #dc2626 !important;
    box-shadow: 0 10px 100px rgba(0,0,0,0.5) !important;
    
    visibility: visible !important;
    opacity: 1 !important;
    width: auto !important;
    height: auto !important;
}

/* Texto grande */
body.shift-mode #timer-display,
body.card-open #timer-display {
    font-size: 4rem !important;
    font-weight: 800 !important;
    color: #1f2937 !important;
    line-height: 1 !important;
    font-variant-numeric: tabular-nums;
}

/* Botón reset */
body.shift-mode #timer-reset,
body.card-open #timer-reset {
    width: 50px !important; height: 50px !important;
    font-size: 20px !important;
    border-radius: 50% !important;
    background: #f3f4f6 !important;
}
  /* === FIX: Checklist Compacto Auto-adaptable (Sin Scroll) === */
#brief-check {
    position: relative; /* Ya no sticky para dejar fluir */
    height: auto !important;
    max-height: none !important;
    overflow: visible !important; /* Prohibido scroll interno */
    padding-bottom: 10px;
}

#brief-check .check-grid {
    display: grid;
    /* Columnas dinámicas: mínimo 160px, caben 3 o 4 en pantallas normales */
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
    gap: 8px; /* Hueco pequeño */
}

#brief-check .check-card {
    /* Diseño súper compacto */
    min-height: auto;
    padding: 8px 10px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 6px;
}

#brief-check .check-title {
    font-size: 0.85rem; /* Texto ajustado */
    line-height: 1.2;
    margin: 0;
    white-space: normal;
}

#brief-check .check-actions {
    margin-top: 0;
    justify-content: flex-start;
}

#brief-check .check-actions label {
    padding: 2px 8px; /* Botones más finos */
    font-size: 0.75rem;
}

/* Ocultar la ayuda grande para ganar espacio */
#brief-check .br-explain {
    display: none;
}
/* === NUEVOS ESTILOS === */

/* Botón Comenzar en el Cronómetro */
.timer-start-btn {
    background: #10b981; /* Verde */
    color: white; border: none; border-radius: 8px;
    padding: 6px 12px; font-weight: 700; font-size: 0.9rem;
    cursor: pointer; box-shadow: 0 4px 10px rgba(16,185,129,0.3);
}
.timer-start-btn:active { transform: scale(0.98); }
.header-timer { gap: 12px; } /* Un poco más de espacio */

/* Scroll en Incidentes (Tablet) */
#incidentes-widget .table-scroll {
    max-height: 300px; /* Altura máxima fija */
    overflow-y: auto;  /* Scroll vertical */
    -webkit-overflow-scrolling: touch; /* Suavidad en iOS/Android */
    border-bottom: 1px solid var(--border);
}

/* Tarjetas de Turno Anterior (Estilo fila) */
.prev-item {
    background: #fff;
    border: 1px solid var(--border);
    border-left: 4px solid #f59e0b; /* Naranja */
    border-radius: 8px;
    padding: 8px 10px;
    margin-bottom: 6px;
    display: flex; justify-content: space-between; align-items: center; gap: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}
.prev-text { flex: 1; font-size: 0.9rem; word-break: break-word; }
.prev-actions { display: flex; gap: 6px; }
.prev-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 4px 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-muted);
}
.prev-btn:hover { background: #f9fafb; color: var(--text); }
/* Scroll en Incidentes (Tablet) */
#incidentes-widget .table-scroll {
    max-height: 300px; /* Altura máxima fija */
    overflow-y: auto;  /* Scroll vertical activado */
    -webkit-overflow-scrolling: touch; /* Suavidad en iOS */
    border-bottom: 1px solid var(--border);
}
/* Estilos específicos para tarjetas de Incidentes/Lecciones */
.inc-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    display: flex; 
    flex-direction: column; 
    gap: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.04);
    transition: transform 0.1s;
}
.inc-card:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }

/* Estilo Rojo para Incidentes */
.inc-card.type-incident {
    border-left: 5px solid #dc2626;
}
.inc-card.type-incident .inc-badge {
    background: #fef2f2; color: #991b1b; border: 1px solid #fecaca;
}

/* Estilo Azul/Bombilla para Lecciones */
.inc-card.type-lesson {
    border-left: 5px solid #8b5cf6;
}
.inc-card.type-lesson .inc-badge {
    background: #f5f3ff; color: #5b21b6; border: 1px solid #ddd6fe;
}

.inc-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
.inc-badge { 
    font-size: 0.75rem; font-weight: 800; padding: 2px 8px; border-radius: 6px; 
    text-transform: uppercase; letter-spacing: 0.5px;
}
.inc-title { font-weight: 700; font-size: 0.95rem; color: #1f2937; }
.inc-desc { font-size: 0.9rem; color: #4b5563; white-space: pre-wrap; margin-top: 4px; }
.inc-meta { font-size: 0.75rem; color: #9ca3af; margin-top: 6px; display: flex; justify-content: space-between; align-items: center; }
.inc-del-btn { 
    background: none; border: none; cursor: pointer; opacity: 0.6; font-size: 1rem; 
}
.inc-del-btn:hover { opacity: 1; transform: scale(1.1); }
  /* Botones pequeños para editar/borrar personas */
.btn-tiny {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 2px 6px;
    font-size: 0.85rem;
    cursor: pointer;
    margin-left: 4px;
    line-height: 1;
    transition: background 0.2s;
}
.btn-tiny:hover { background: #f3f4f6; }
.btn-tiny.del-person:hover { background: #fee2e2; border-color: #fca5a5; }
</style>
  <!-- Cargar Chart.js antes de los scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
</head>
<body>

<button id="exit-shift-mode-btn" onclick="exitShiftMode()">Cerrar Vista Turno ✖</button>


<select id="scale-select" aria-label="Escala UI">
<option value="1">100%</option>
<option value="1.15" selected>115%</option>
<option value="1.3">130%</option>
<option value="1.5">150%</option>
</select>
<button id="present-btn" class="btn-primary" type="button" title="Pantalla completa">Presentar</button>



<div class="dashboard-3col">
<!-- HEADER -->
<header>
<div class="header-left">
<h1>Factory Floor Dashboard - WFS4 MAD WH</h1>
<div id="now-header" role="status" aria-live="polite">—</div>
<span id="shift-badge-header" class="shift-chip">—</span>
</div>

<!-- Cronómetro Modificado -->
<div class="header-timer" id="timer-widget" aria-label="Cronómetro">
    <div class="timer-face" id="timer-face">
        <div class="timer-display" id="timer-display">00:00:00</div>
        <span class="timer-dot" aria-hidden="true"></span>
    </div>
    <!-- NUEVO BOTÓN -->
    <button type="button" id="timer-start-btn" class="timer-start-btn">Comenzar</button>
    <button type="button" class="timer-reset" id="timer-reset">Reiniciar</button>
    <!-- Botón de soporte en el Header -->
<button onclick="openSupportModal()" style="border:none; background:none; color:#64748b; cursor:pointer; font-size:0.8rem; text-decoration:underline; margin-top:10px;">
    🔧 Reportar fallo en el Dashboard
</button>
<dialog id="support-modal" style="border:none; border-radius:12px; padding:20px; width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
    <div id="support-form">
        <h3 style="margin-top:0; font-family: 'Space Grotesk', sans-serif;">Soporte Técnico Dashboard</h3>
        <label style="font-size:0.8rem; font-weight:700;">¿Qué falla?</label>
        <select id="issue-type" style="width:100%; padding:8px; margin:8px 0 15px; border-radius:6px; border:1px solid #ddd; font-family: inherit;">
            <option>No carga el personal (Roster)</option>
            <option>Los KPIs no se actualizan</option>
            <option>Error al guardar resumen</option>
            <option>Error en los datos de Fiix</option>
            <option>Otro problema técnico</option>
        </select>
        
        <label style="font-size:0.8rem; font-weight:700;">Describe el error:</label>
        <textarea id="issue-details" placeholder="Ej: Los costes de Fiix salen en 0..." style="width:100%; height:80px; margin-top:8px; padding:8px; border-radius:6px; border:1px solid #ddd; font-family: inherit; resize: none;"></textarea>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="document.getElementById('support-modal').close()" style="flex:1; border:none; padding:10px; border-radius:6px; cursor:pointer; background: #f1f5f9; font-weight: 700;">Cancelar</button>
            <button onclick="sendDashboardIssue()" id="btn-submit-support" style="flex:1; border:none; padding:10px; border-radius:6px; cursor:pointer; background:#334155; color:white; font-weight:700;">AVISAR A SOPORTE</button>
        </div>
    </div>

    <!-- Pantalla de confirmación (Se activa tras el envío) -->
    <div id="support-thanks" style="display:none; text-align:center; padding: 10px 0;">
        <div style="font-size:3rem; margin-bottom: 10px;">🛠️</div>
        <h3 style="color:#334155; margin-bottom: 5px;">Aviso Recibido</h3>
        <p style="font-size:0.9rem; line-height:1.4; color: #475569;">
            Se ha notificado al equipo técnico sobre el fallo en:<br>
            <strong id="display-station-name" style="color: #1e293b;">—</strong>
        </p>
        <p style="color:#64748b; font-size:0.8rem; background: #f8fafc; padding: 10px; border-radius: 8px;">
            <strong>No es necesario enviar correos ni tickets adicionales.</strong>
        </p>
        <button onclick="document.getElementById('support-modal').close()" class="btn-primary" style="width:100%; margin-top:15px;">Entendido</button>
    </div>
</dialog>

</div>

<!-- Busca esto en tu header y reemplázalo o modifícalo -->
<div class="header-controls">
    <!-- El date-picker lo quitamos antes por JS, así que pon esto: -->
    <input type="text" id="briefing-supervisor" placeholder="Supervisor" style="min-width: 140px; padding: 8px; border-radius: 8px; border: 1px solid #ccc;">
    <button type="button" class="btn-mic" data-target="briefing-supervisor" title="Dictar nombre">
        🎙️
    </button>
    <button id="btn-generate-summary" class="btn-primary" type="button" disabled style="opacity: 0.5; cursor: not-allowed;">Generar Resumen</button>
</div>
</header>


<!-- IZQUIERDA: EQUIPO -->
<section class="col-left">
<div class="widget" id="team-widget">
<h2 class="widget-title">1) Equipo / Turno</h2>
<small class="kpi-text" id="team-meta">—</small>

<form id="team-form" class="team-form" autocomplete="off" style="display:flex; gap:8px; align-items:center; margin:8px 0;">
<input type="text" id="team-name" placeholder="Añadir persona…" required style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;"/>
<button type="submit" class="btn-primary" style="padding:8px 12px;">+</button>
</form>

<!-- 👇 Subida de Excel ahora dentro de la tarjeta del equipo -->
<!-- 👇 Subida de Excel dentro de la tarjeta del equipo -->
<form id="roster-upload-form" style="display:flex; gap:8px; align-items:center; margin:8px 0;">
  <input type="file" id="roster-file" accept=".xlsx,.xls" required
         style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;">
  <button class="btn-primary" type="submit">Subir Excel</button>
</form>
<small id="roster-upload-result" class="kpi-text">—</small>

<!-- ☝️ mantiene los mismos IDs que usa tu JS -->

<div id="team-list" class="team-list" style="display:flex; flex-direction:column; gap:6px;"></div>
</div>





</section>

<!-- CENTRO: ACCIONES -->
<section class="col-middle">
<!-- CHECKLIST DE BRIEFING -->
<div class="widget" id="brief-check">
  <div id="brief-check-explain" class="br-explain" aria-live="polite">
  <span class="br-explain-ico" aria-hidden="true">
    <!-- icono info -->
    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
      <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
    </svg>
  </span>
  <strong class="br-explain-label">Guía</strong>
  <span class="br-explain-text">Pasa el ratón por cada punto para ver una explicación.</span>
</div>


<h2 class="widget-title">
<span>Checklist</span>
</h2>
<span id="shift-badge" class="shift-chip">—</span>
  
<div class="check-grid">
  <!-- 1) Dotación y recursos (antes era el 3) -->
  <div class="check-card" tabindex="0"
       data-help="Dotación: presentes/ausentes, zonas asignadas y coberturas; pedir refuerzos si falta."
       data-target="team-widget">
    <span class="check-title">1) Dotación y recursos</span>
    <div class="check-actions" role="group" aria-label="Bloque 1">
      <input id="c1ok" type="radio" name="c1" value="OK"><label for="c1ok">OK</label>
    </div>
  </div>

  <!-- 2) Actualizaciones operativas -->
  <div class="check-card" tabindex="0"
       data-help="Cambios operativos: revisar CQC o WWM"
       data-target="ops-updates-widget">
    <span class="check-title">2) Actualizaciones operativas</span>
    <div class="check-actions" role="group" aria-label="Bloque 2">
      <input id="c2ok" type="radio" name="c2" value="OK"><label for="c2ok">OK</label>
    </div>
  </div>

  <!-- 3) Highlights del turno anterior (antes era el 1) -->
  <div class="check-card" tabindex="0"
       data-help="Repasa incidencias, bloqueos y aprendizajes clave del turno anterior del bloque de Información del turno anterior."
       data-target="prev-shift-widget">
    <span class="check-title">3) Highlights del turno anterior</span>
    <div class="check-actions" role="group" aria-label="Bloque 3">
      <input id="c3ok" type="radio" name="c3" value="OK"><label for="c3ok">OK</label>
    </div>
  </div>

  <!-- 4) Seguridad y protección -->
  <div class="check-card" tabindex="0"
       data-help="Seguridad: riesgos del día, EPIs, permisos, control de accesos y brief de seguridad."
       data-target="seguridad-widget">
    <span class="check-title">4) Safety, Security, Quality & PRL</span>
    <div class="check-actions" role="group" aria-label="Bloque 4">
      <input id="c4ok" type="radio" name="c4" value="OK"><label for="c4ok">OK</label>
    </div>
  </div>

  <!-- 5) Preparación/reportes incidentes -->
  <div class="check-card" tabindex="0"
       data-help="Cómo reportar incidentes: canales, tiempos, responsables y material de emergencia."
       data-target="incidentes-widget">
    <span class="check-title">5) Preparación/reportes incidentes</span>
    <div class="check-actions" role="group" aria-label="Bloque 5">
      <input id="c5ok" type="radio" name="c5" value="OK"><label for="c5ok">OK</label>
    </div>
  </div>

  <div class="check-card" tabindex="0"
       data-help="KPIs del día: Ocupaciones de Uniwing, DG Autocheck, CargoMobile; revisar tendencia vs objetivo."
       data-target="kpi-center">
    <span class="check-title">6) Revisión Kpis</span>
    <div class="check-actions" role="group" aria-label="Bloque 6">
      <input id="c6ok" type="radio" name="c6" value="OK"><label for="c6ok">OK</label>
    </div>
  </div>

  <!-- 7) Feedback → Acciones -->
  <div class="check-card" tabindex="0"
       data-help="Recoge feedback del equipo y tradúcelo en acciones claras en el Kanban."
       data-target="kanban-widget">
    <span class="check-title">7) Feedback → Acciones</span>
    <div class="check-actions" role="group" aria-label="Bloque 7">
      <input id="c7ok" type="radio" name="c7" value="OK"><label for="c7ok">OK</label>
    </div>
  </div>
</div>


<small class="kpi-text" id="brief-check-meta">—</small>
</div>


<!-- ACTUALIZACIONES OPERATIVAS (mejorado) -->
<!-- ACTUALIZACIONES OPERATIVAS (sin lista rápida) -->
<div class="widget vivid" id="ops-updates-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">🚧</span><span>2) Actualizaciones operativas</span>
    <span class="hero-badge">EN VIVO</span>
  </h2>

  <!-- Toolbar mínima -->
  <div class="ops-toolbar" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
    <input id="ops-q" type="search" placeholder="Buscar…" 
           style="flex:1;min-width:220px;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;">
    <select id="ops-prio" style="padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;">
      <option value="">Todas</option><option>Alto</option><option>Medio</option><option>Bajo</option>
    </select>
    <select id="ops-scope" style="padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;">
      <option value="">Ámbito</option>
      <option>General</option><option>Isla</option><option>Dorada</option>
      <option>Muelle Imp</option><option>Muelle Exp</option><option>Import</option><option>Export</option>
    </select>
    <button type="button" class="btn-compact" id="ops-add" aria-label="Crear actualización operativa">+ Nueva</button>

  </div>

  <!-- Lista de tarjetas -->
  <div id="ops-list" class="ops-list" role="list" aria-label="Actualizaciones"></div>

  <!-- Diálogo alta/edición (simple) -->
  <dialog id="ops-dialog" style="border:1px solid var(--border);border-radius:12px;padding:12px;max-width:520px;width:clamp(280px,90vw,520px);">
    <form method="dialog" id="ops-form" style="display:grid;gap:8px;">
      <h3 style="margin:0;">Actualizar</h3>
      <input type="hidden" id="ops-id">
      <label>Título
        <input id="ops-title" type="text" required
               style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;">
      </label>
      <label>Prioridad
        <select id="ops-impact" required
                style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;">
          <option>Alto</option><option>Medio</option><option>Bajo</option>
        </select>
      </label>
      <label>Ámbito
        <select id="ops-scope-field"
                style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;">
          <option>General</option><option>Isla</option><option>Dorada</option>
          <option>Muelle Imp</option><option>Muelle Exp</option><option>Import</option><option>Export</option>
        </select>
      </label>
      <label>Responsable (opcional)
        <input id="ops-owner" type="text" placeholder="Ej.: @juan">
      </label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <label>Desde <input id="ops-from" type="date"></label>
        <label>Hasta  <input id="ops-to"   type="date"></label>
      </div>
      <menu style="display:flex;gap:8px;justify-content:flex-end;margin:0;padding-top:8px;">
  <button type="button" class="btn-compact" value="cancel" formnovalidate>Cancelar</button>
  <button type="submit"  class="btn-primary" id="ops-save" value="default">Guardar</button>
</menu>

    </form>
  </dialog>
</div>

 





<div class="widget vivid" id="seguridad-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">🛡️</span><span>4) Safety, Security, Quality & PRL</span>
    <span class="hero-badge warn">PRIORIDAD</span>
  </h2>

  <!-- 1. RECORDATORIOS (MOVIDO ARRIBA) -->
  <div class="ops-item" id="sec-random-tips" style="margin-bottom:12px; background:#ffffff; border-left:4px solid #f59e0b;">
    <div class="ops-head">
      <div class="ops-title">Recordatorio del día</div>
      <span class="ops-scope" id="sec-random-scope">Turno —</span>
    </div>
    <ul id="sec-random-list" style="margin:6px 0 0 18px; padding:0; list-style:disc;"></ul>
  </div>

  <!-- 2. FORMULARIO Y TARJETAS -->
  <form id="sec-form" class="inline-form" autocomplete="off" style="margin-bottom:8px;">
    <input type="text" id="sec-title" placeholder="Añadir riesgo / tarjeta..." required>
    <input type="text" id="sec-owner" placeholder="Responsable">
    <button type="submit" class="btn-primary">Añadir</button>
  </form>

  <div id="sec-cards" class="sec-list" role="list"></div>
  <small class="kpi-text" id="sec-meta">—</small>
</div>


  
<!-- INCIDENTES (ENABLON) + LECCIONES APRENDIDAS -->
<div class="widget vivid" id="incidentes-widget">
  <h2 class="widget-title hero">
    <span class="hero-ico">⚠️</span><span>5) Incidentes & Aprendizaje</span>
    <span class="hero-badge danger">MANUAL</span>
  </h2>

  <!-- BANNER RECORDATORIO (Se mantiene) -->
  <div class="incident-remember">
    RECORDAR: Reportar cualquier incidente inmediatamente en ENABLON.
  </div>

  <!-- PROTOCOLO (Se mantiene editable) -->
  <details style="margin-bottom:15px; border:1px solid var(--border); border-radius:8px; padding:8px; background:#fff;">
    <summary style="font-weight:700; cursor:pointer; color:var(--text-muted);">📂 Ver Protocolo de Actuación</summary>
    <form id="incidents-protocol-form" class="inline-form" autocomplete="off" style="display:grid;grid-template-columns:1fr;gap:8px;margin-top:10px;">
      <div class="ops-item">
        <label style="font-weight:700;">Qué hacer si algo sale mal</label>
        <textarea id="ip-what-to-do" rows="2" placeholder="Procedimiento..." style="width:100%;border:1px solid var(--border);border-radius:8px;padding:8px;"></textarea>
      </div>
      <div class="ops-item">
        <label style="font-weight:700;">A quién informar</label>
        <input id="ip-contacts" type="text" placeholder="Teléfonos..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;">
      </div>
      <div class="meta-row">
        <button class="btn-compact" type="submit">Guardar Protocolo</button>
        <small id="incidents-protocol-status" class="kpi-text">—</small>
      </div>
    </form>
  </details>

  <!-- === NUEVO SISTEMA: ALTA MANUAL DE INCIDENTES / LECCIONES === -->
  
  <!-- Formulario de Alta -->
  <form id="manual-inc-form" style="background:#fff5f5; padding:12px; border-radius:10px; border:1px dashed #fecaca; margin-bottom:15px;">
    <div style="display:grid; grid-template-columns: 140px 1fr auto; gap:8px; margin-bottom:8px;">
      <select id="new-inc-type" style="padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-weight:bold;">
        <option value="incident">🔴 Incidente</option>
        <option value="lesson">💡 Lección</option>
      </select>
      <input type="text" id="new-inc-title" placeholder="Título corto..." required 
             style="padding:8px; border-radius:8px; border:1px solid #e5e7eb;">
      <button type="submit" class="btn-primary" style="padding:8px 16px;">Añadir</button>
    </div>
    <textarea id="new-inc-desc" rows="2" placeholder="Descripción detallada o aprendizaje..." 
              style="width:100%; padding:8px; border-radius:8px; border:1px solid #e5e7eb; font-size:0.9rem;"></textarea>
  </form>

  <!-- Lista de Tarjetas -->
  <div id="incidents-list-container" class="ops-list" style="max-height:400px; overflow-y:auto; padding-right:4px;">
    <!-- Se llena con JS -->
  </div>
</div>



<!-- 6) KPIs Operativos & Estándares (AHORA CON 5S Y GW INTEGRADO) -->
<div class="widget kpi-widget" id="kpi-center">
  <h2 class="widget-title">6) KPIs Operativos & Mantenimiento</h2>

  <!-- FILA 1: OPERACIONES (WFS) -->
  <div class="kpi-grid" style="margin-bottom: 15px;">
    <div class="kpi-tile">
      <div class="kpi-label">UPH (Prod)</div>
      <div class="kpi-value" id="kpi-uph">—</div>
    </div>
    <div class="kpi-tile">
      <div class="kpi-label">DG Autocheck</div>
      <div class="kpi-value" id="kpi-otif">—</div>
    </div>
    <div class="kpi-tile">
      <div class="kpi-label">Costes Daños</div>
      <div class="kpi-value" style="color:var(--brand-red-600)">
        <span id="kpi-total-cost">—</span><span class="kpi-currency">€</span>
      </div>
    </div>
  </div>

  <hr style="border:0; border-top:1px solid var(--border); margin: 10px 0;">

  <!-- FILA 2: MANTENIMIENTO (FIIX) -->
  <h3 style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">Mantenimiento (Fiix)</h3>
  
 <div class="kpi-grid">
    <!-- Disponibilidad Crítica -->
    <div class="kpi-tile" id="tile-fiix-availability" style="border-left: 6px solid #10b981;">
        <div class="kpi-label">Disponibilidad Carretillas</div>
        <div class="kpi-value"><span id="fiix-availability">--</span>%</div>
        <small class="kpi-text" id="fiix-broken-text">Analizando flota...</small>
    </div>

    <!-- Daños del día -->
    <div class="kpi-tile" style="border-left: 6px solid #f59e0b;">
        <div class="kpi-label">Daños Reportados (24h)</div>
        <div class="kpi-value" id="fiix-damage-24h">--</div>
        <small class="kpi-text">Averías/Golpes</small>
    </div>
</div>

<!-- Gráfico de Acumulados -->
<div class="widget vivid" style="grid-column: 1 / -1; margin-top:15px;">
    <h3 style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">
        📊 Acumulado Semanal de Daños
    </h3>
    <div style="height: 200px;"><canvas id="fiixWeeklyChart"></canvas></div>
</div>

  <!-- SEPARADOR -->
  <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">

  <!-- PARTE INFERIOR: 5S y GW -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
    
    <!-- COLUMNA 5S -->
    <div style="background: #fafafa; border-radius: 10px; padding: 12px; border: 1px solid var(--border);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <strong style="font-size:0.95rem;">Estado 5S</strong>
        <small id="s5-meta" class="kpi-text">—</small>
      </div>
      
      <!-- Botones 5S -->
      <div id="s5-strip" class="s5-compact" role="group" aria-label="Estado 5S" style="justify-content: center;">
        <button type="button" class="s5-pill" data-key="seiri" title="1S · Seiri"><span class="s5-dot"></span>1S</button>
        <button type="button" class="s5-pill" data-key="seiton" title="2S · Seiton"><span class="s5-dot"></span>2S</button>
        <button type="button" class="s5-pill" data-key="seiso" title="3S · Seiso"><span class="s5-dot"></span>3S</button>
        <button type="button" class="s5-pill" data-key="seiketsu" title="4S · Seiketsu"><span class="s5-dot"></span>4S</button>
        <button type="button" class="s5-pill" data-key="shitsuke" title="5S · Shitsuke"><span class="s5-dot"></span>5S</button>
      </div>
    </div>

    <!-- COLUMNA GW -->
    <div style="background: #fafafa; border-radius: 10px; padding: 12px; border: 1px solid var(--border);">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <strong style="font-size:0.95rem;">Gemba Walk (GW)</strong>
      </div>

      <!-- Formulario GW -->
      <form id="gw-upload-form" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <input type="file" id="gw-file" accept=".xlsx,.xls" style="flex:1; font-size:0.8rem; padding:4px; width:0;">
        <button class="btn-primary" type="submit" style="padding:4px 8px; font-size:0.8rem;">Subir</button>
      </form>
      <small id="gw-upload-status" class="kpi-text" style="display:block; margin-bottom:6px;">—</small>

      <!-- Lista GW -->
      <div id="gw-tasks-dynamic-container"></div>
    </div>
  </div>
</div>


 
<!-- KANBAN -->
<div class="widget" id="kanban-widget">
<h2 class="widget-title">7) Feedback directo</h2>
<div class="board-container kanban">
<div class="kanban-column">
<h3 class="column-title"><span>Abiertas</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-Abiertas" data-status="Abiertas"></div>
</div>
<div class="kanban-column">
<h3 class="column-title"><span>En Curso</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-En-Curso" data-status="En Curso"></div>
</div>
<div class="kanban-column">
<h3 class="column-title"><span>Cerradas</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-Cerradas" data-status="Cerradas"></div>
</div>
<div class="kanban-column">
<h3 class="column-title"><span>Vencidas</span><span class="count">(0)</span></h3>
<div class="cards-container" id="kanban_rapida-Vencidas" data-status="Vencidas"></div>
</div>

  
</div>

<form class="new-item-form" id="new-kanban-form" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border); display:grid; grid-template-columns: 1fr 1fr auto 1fr auto; gap:8px; align-items:center;">
<select id="problem-category" name="category" required>
<option value="" disabled selected>Selecciona categoría…</option>
<option value="seguridad">Seguridad</option>
<option value="incidencias">Incidencias</option>
<option value="mantenimiento">Mantenimiento</option>
<option value="calidad">Calidad</option>
<option value="servicio">Servicio</option>
</select>
<input type="text" name="title" placeholder="Tipo de problema" required>
<input type="date" name="due_date" required>
<select name="assigned_to" required title="Equipo de soporte">
  <option value="" disabled selected>Equipo de soporte…</option>
  <option>Mantenimiento</option>
  <option>IT</option>
  <option>Calidad</option>
  <option>Compras</option>
  <option>CI</option>
  <option>QHSSE</option>
  <option>Ops</option>
</select>

<button type="submit" class="btn-primary">Añadir</button>
</form>
</div>


<!-- KAIZEN (Ahora fuera del split, ocupa todo el ancho) -->
<div class="widget" id="kaizen-widget" style="margin-top: 20px;">
  <h2 class="widget-title">KAIZEN (Proyectos de mejora)</h2>
  
  <form class="new-item-form" id="new-kaizen-form" autocomplete="off" style="display:grid; grid-template-columns: 1fr 1fr auto auto; gap:8px; align-items:center;">
    <input type="text" name="title" placeholder="Proyecto de mejora…" required>
    <input type="text" name="assigned_to" placeholder="Responsable…">
    <input type="date" name="due_date" aria-label="Fecha máxima">
    <button type="submit" class="btn-primary">Añadir</button>
  </form>

  <!-- Le quitamos la clase 'compact' si quieres ver 3 columnas anchas -->
  <div class="board-container kaizen" style="margin-top:12px;">
    <div class="kanban-column">
      <h3 class="column-title"><span>Proyectos</span><span class="count">(0)</span></h3>
      <div class="cards-container" id="kaizen-Proyectos" data-status="Proyectos"></div>
    </div>
    <div class="kanban-column">
      <h3 class="column-title"><span>En Progreso</span><span class="count">(0)</span></h3>
      <div class="cards-container" id="kaizen-En-Progreso" data-status="En Progreso"></div>
    </div>
    <div class="kanban-column">
      <h3 class="column-title"><span>Hecho</span><span class="count">(0)</span></h3>
      <div class="cards-container" id="kaizen-Hecho" data-status="Hecho"></div>
    </div>
  </div>
</div>



</section>

<!-- DERECHA: RESULTADOS -->
<section class="col-right">


  <div class="widget" id="prev-shift-widget">
  <h2 class="widget-title">3) Turno Anterior</h2>
  
  <!-- Formulario de alta rápida -->
  <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input type="text" id="prev-input" placeholder="Añadir highlight..." 
             style="flex:1; padding:8px; border:1px solid var(--border); border-radius:8px;">
      <button id="prev-add-btn" class="btn-primary" style="padding:0 12px;">+</button>
      <button type="button" class="btn-mic" data-target="prev-input">🎙️</button>
  </div>

  <!-- Contenedor de tarjetas (filas) -->
  <div id="prev-list" style="display:flex; flex-direction:column; gap:8px; max-height:400px; overflow-y:auto;">
      <!-- Se llenará con JS -->
  </div>
</div>
<div class="widget" id="ehs-widget">
  <h2 class="widget-title">Días sin accidentes de trabajo</h2>
  <div class="ehs-month" id="ehs-month">—</div>
  
  <!-- CAMBIO: Eliminados botones manuales, añadido title explicativo -->
  <div id="ehs-spin" class="ehs-controls" role="spinbutton" 
       style="justify-content: center; cursor: pointer;" 
       title="Doble clic para reportar incidente (Reset a 0)">
      <div class="ehs-big" id="ehs-days">0</div>
  </div>
</div>
</section>
</div>

<!-- PANTALLA MODO INFO (Post-Briefing) -->
<div id="post-briefing-screen">
    <div class="pb-header">
        <div class="pb-title">🚀 MODO OPERATIVO - INFORMACIÓN ACTIVA</div>
        <button class="pb-close-btn" onclick="closePostBriefingMode()">✖ Volver al Dashboard (Edición)</button>
    </div>

    <div class="pb-grid">
        <!-- 1. Highlights Turno Anterior -->
        <div class="pb-card">
            <div class="pb-card-title">↩️ Highlights Turno Anterior</div>
            <div id="pb-prev-content" class="pb-content"></div>
        </div>

        <!-- 2. Actualizaciones Operativas -->
        <div class="pb-card">
            <div class="pb-card-title">🚧 Actualizaciones Operativas</div>
            <div id="pb-ops-content" class="pb-content"></div>
        </div>

        <!-- 3. KPIs -->
        <div class="pb-card">
            <div class="pb-card-title">📊 KPIs del Turno</div>
            <div id="pb-kpi-content" class="pb-content">
                <div class="pb-kpi-box">
                    <div class="pb-kpi-item">
                        <span class="pb-kpi-lbl">UPH</span>
                        <span id="pb-val-uph" class="pb-kpi-val">-</span>
                    </div>
                    <div class="pb-kpi-item">
                        <span class="pb-kpi-lbl">Costes</span>
                        <span id="pb-val-cost" class="pb-kpi-val">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Seguridad -->
        <div class="pb-card">
            <div class="pb-card-title">🛡️ Seguridad y Riesgos</div>
            <div id="pb-sec-content" class="pb-content"></div>
        </div>
    </div>
</div>
<script>
  window.STATION_OVERRIDE = 'ALM';
</script>

  
<!-- SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>

(function() {
    let path = window.location.pathname;
    if (!path.endsWith('/')) path += '/';
    const BASE_PATH = path; 

    // Interceptar fetch para que /api siempre use el prefijo de la ciudad
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
        if (typeof url === 'string' && (url.startsWith('api/') || url.startsWith('/api/'))) {
            const cleanUrl = url.startsWith('/') ? url.substring(1) : url;
            url = BASE_PATH + cleanUrl;
        }
        return originalFetch(url, options);
    };

    // Corregir WebSockets automáticamente
    const OriginalWebSocket = window.WebSocket;
    window.WebSocket = function(url) {
        if (url.includes('/ws') && !url.includes(BASE_PATH)) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            url = `${protocol}//${window.location.host}${BASE_PATH}ws`;
        }
        return new OriginalWebSocket(url);
    };
})();

// Función de escape HTML (faltaba definición)
function esc(s){ 
return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,"&#39;"); 
}
// Normaliza IDs que vengan como id | task_id | _id (string/number)
// Si no hay ID (respuestas antiguas), genera uno prefijado "client-"
function getTaskId(obj){
  if(!obj) return null;
  const raw = obj.id ?? obj.task_id ?? obj._id ?? null;
  if (raw === null || raw === undefined || raw === '') {
    // client-only id: permite editar/borrar en UI hasta que el backend asigne ID real
    return `client-${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
  }
  return String(raw);
}
(function colorizeOpsRibbons(){
  const host = document.getElementById('ops-updates-widget');
  if(!host) return;
  const colorMap = {
    'Alto':  'linear-gradient(180deg,#ff8a8a,#ef4444)',
    'Medio': 'linear-gradient(180deg,#ffd37a,#f59e0b)',
    'Bajo':  'linear-gradient(180deg,#9ff0c9,#10b981)'
  };
  const paint = () => {
    host.querySelectorAll('.ops-item').forEach(card=>{
      const imp = card.querySelector('.ops-impact')?.textContent?.trim();
      const v = colorMap[imp] || 'linear-gradient(180deg,#c7d2fe,#8b5cf6)';
      card.style.setProperty('--ops-ribbon', v);
      // usa la variable si prefieres:
      card.style.setProperty('background-clip','padding-box');
      card.style.setProperty('box-shadow','0 8px 22px rgba(17,24,39,.08)');
      const before = card; // CSS ::before ya está definido
      card.style.setProperty('--ops-ribbon', v);
      // gracias al CSS: .ops-item::before usa un color por defecto;
      // si quieres, cambia su background a var(--ops-ribbon) y aquí no haces nada más
    });
  };
  const mo = new MutationObserver(paint);
  mo.observe(host, {childList:true, subtree:true});
  paint();
})();


(function initGwUpload(){
  const form   = document.getElementById('gw-upload-form');
  const input  = document.getElementById('gw-file');
  const status = document.getElementById('gw-upload-status');
  if (!form) return;

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const f = input.files?.[0];
    if (!f){
      status.textContent = 'Selecciona un Excel de GW';
      return;
    }

    const fd = new FormData();
    fd.append('file', f);

    status.textContent = 'Subiendo…';
    try{
      const res  = await fetch('/api/gw/import-xlsx', {
        method: 'POST',
        body: fd,
        // si lo proteges con API_KEY:
        // headers: { 'x-api-key': 'EstE-eS-mI_s3cr3t0-Sup3r-L4rg0-y-c0mpl3j0-p4r4-eL-d4shb04rd"' }
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data.detail || res.statusText || 'Error al importar');

      status.textContent = `OK: ${data.inserted || 0} Gemba Walks cargados`;
      // recarga GW desde tareas
      GW_MAP.clear();
      await loadAllTasks();
    }catch(err){
      console.error(err);
      status.textContent = `Error: ${err.message || err}`;
    }finally{
      input.value = '';
    }
  });
})();


// === PDF Incidentes: subida y render ===
  


(function initRosterUpload(){
const form   = document.getElementById('roster-upload-form');
const input  = document.getElementById('roster-file');
const status = document.getElementById('roster-upload-result');
if (!form) return;

form.addEventListener('submit', async (e)=>{
e.preventDefault();
const f = input.files?.[0];
if (!f) { status.textContent = 'Selecciona un .xlsx/.xls'; return; }

const fd = new FormData();
fd.append('file', f); // debe llamarse "file"

status.textContent = 'Subiendo…';
try {
const res = await fetch('/api/roster/upload', { method:'POST', body: fd });
if (!res.ok) {
const err = await res.json().catch(()=>({detail: res.statusText}));
throw new Error(err.detail || 'Error al subir');
}
const data = await res.json();
status.textContent =
`OK: ${data.people_count} personas cargadas • Hoja: ${data.sheet_loaded || '—'} • Fecha hoja: ${data.sheet_date || '—'}`;

// refresca la tarjeta de equipo inmediatamente
try {
const r   = await fetch('/api/roster/current', { cache:'no-store' });
const cur = await r.json();
const listEl = document.getElementById('team-list');
renderRoster(listEl, cur.people || [], cur);
} catch (e) {
console.warn('No se pudo refrescar roster tras subir:', e);
}

} catch (err) {
status.textContent = `Error: ${err.message || err}`;
} finally {
input.value = '';
}
});
})();



// === Contexto de estación (MAD por defecto; puedes pasar ?station=MAD/BCN en la URL) ===
const STATIONS_KNOWN = ['MAD','BCN','VLC','SVQ'];

const STATION_CODE =
  (window.STATION_OVERRIDE || new URLSearchParams(location.search).get('station') || '')
    .toUpperCase()
  || ((document.title.match(/\b(MAD|BCN|VLC|SVQ)\b/i) || [,'MAD'])[1]).toUpperCase();


function isForThisStation(obj){
const st = (obj && obj.station ? String(obj.station) : '').toUpperCase();
// si el objeto no trae estación, lo aceptamos; si trae, debe coincidir
return !st || st === STATION_CODE;
}

// pinta la estación en el H1 si hace falta
try {
const h1 = document.querySelector('header h1');
if (h1 && !h1.textContent.toUpperCase().includes(STATION_CODE)) {
h1.textContent = h1.textContent.replace(/(MAD|BCN|VLC|SVQ)/i, STATION_CODE);
}
} catch {}



// Función $$ ya existe, mantenerla
function $$(selector) { return Array.from(document.querySelectorAll(selector)); }
  /* ===== Cronómetro Header (Con botón Comenzar) ===== */
/* ===== Cronómetro Header (Con botón Comenzar) ===== */
(function(){
    const KEY = 'header_big_timer_v1';
    let running = false, startedAt = 0, elapsed = 0, tick = null;

    // Elementos
    const display = document.getElementById('timer-display');
    const resetBtn = document.getElementById('timer-reset');
    const startBtn = document.getElementById('timer-start-btn');
    const summaryBtn = document.getElementById('btn-generate-summary'); // El botón que queremos bloquear

    function fmt(ms){
        const t = Math.floor(ms/1000);
        const h = Math.floor(t/3600);
        const m = Math.floor((t%3600)/60);
        const s = t%60;
        return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function updateSummaryButton(hasTime) {
        if (!summaryBtn) return;
        if (hasTime) {
            summaryBtn.disabled = false;
            summaryBtn.style.opacity = "1";
            summaryBtn.style.cursor = "pointer";
        } else {
            summaryBtn.disabled = true;
            summaryBtn.style.opacity = "0.5";
            summaryBtn.style.cursor = "not-allowed";
        }
    }

    function paint(){
        const currentTime = running ? Date.now() - startedAt : elapsed;
        display.textContent = fmt(currentTime);
        
        // Si hay tiempo contado (> 0), habilitamos el botón de resumen
        if (currentTime > 0) updateSummaryButton(true);
    }

    function save(){ try{ localStorage.setItem(KEY, JSON.stringify({running, startedAt, elapsed})); }catch(e){} }
    
    function load(){
        try{
            const s = JSON.parse(localStorage.getItem(KEY)||'null');
            if(!s) return;
            running = !!s.running;
            elapsed = Number(s.elapsed)||0;
            startedAt = Number(s.startedAt)||0;
            if (running){
                const now=Date.now();
                elapsed = Math.max(elapsed, now-startedAt);
                startedAt = now - elapsed;
            }
            if (elapsed > 0 || running) updateSummaryButton(true);
        }catch(e){}
    }

    function start(){
        if (running) return;
        running = true;
        startedAt = Date.now() - elapsed;
        tick = setInterval(paint, 250);
        if(startBtn) startBtn.style.display = 'none';
        updateSummaryButton(true); // Habilitar al comenzar
        save();
    }

    function pause(){
        if (!running) return;
        running = false;
        elapsed = Date.now() - startedAt;
        clearInterval(tick); tick=null;
        if(startBtn) {
            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Continuar';
        }
        save();
    }

    function reset(){
        if(!confirm("¿Reiniciar cronómetro? Esto bloqueará el resumen hasta que vuelvas a comenzar.")) return;
        running = false; startedAt = 0; elapsed = 0;
        clearInterval(tick); tick = null;
        display.textContent = "00:00:00";
        if(startBtn) {
            startBtn.style.display = 'inline-block';
            startBtn.textContent = 'Comenzar';
        }
        updateSummaryButton(false); // Bloquear al reiniciar
        save();
    }

    display?.addEventListener('click', ()=> (running ? pause() : start()));
    resetBtn?.addEventListener('click', reset);
    startBtn?.addEventListener('click', start);

    window.resetFactoryTimer = reset;

    window.initHeaderTimer = function(){
        load(); paint();
        if (running) {
            tick = setInterval(paint, 250);
            if(startBtn) startBtn.style.display = 'none';
        }
    };
})();

const UI_SCALE_KEY='ui_scale_v1';
function applyScale(v){ document.documentElement.style.setProperty('--ui-scale', v); }
// REEMPLAZA la sección completa de escalado:
(function initUIScaling(){
const UI_SCALE_KEY='ui_scale_v1';

function applyScale(v){ 
document.documentElement.style.setProperty('--ui-scale', v); 
}

function initScale(){
const sel = document.getElementById('scale-select');
if (!sel) return;

const saved = localStorage.getItem(UI_SCALE_KEY) || sel.value || '1.15';
applyScale(saved);
sel.value = saved;

sel.addEventListener('change', e => {
const v = e.target.value;
localStorage.setItem(UI_SCALE_KEY, v);
applyScale(v);
});
}

// Ejecutar inmediatamente
initScale();
})();

function isTouch(){ return window.matchMedia('(pointer:coarse)').matches; }



/* ===== GW: mostrar solo TOP-3 por última fecha ===== */
/* ===== GW: mostrar solo TOP-3 por última fecha ===== */
const GW_MAP = new Map();
function gwGetDate(t){
const cand = t.gw_date || t.last_date || t.last_done_at || t.updated_at || t.due_date || t.created_at || t.date;
const d = cand ? new Date(cand) : null;
return (d && !isNaN(d)) ? d.getTime() : -Infinity;
}




function gwUrgency(t){
  // 1) usar columna days_left del backend
  if (t.ap1_days_left != null && !isNaN(t.ap1_days_left)) {
    return Number(t.ap1_days_left);
  }
  if (t.days_left != null && !isNaN(t.days_left)) {
    return Number(t.days_left);
  }

  // 2) si no, calcular desde gw_date / due_date
  const cand = t.gw_date || t.due_date;
  if (cand){
    const d = new Date(cand);
    if (!isNaN(d)) {
      const diff = Math.round((d - new Date()) / 86400000);
      return diff;
    }
  }

  // sin info → lo mandamos al final
  return 99999;
}

function renderGwTop3(){
  const cont = document.getElementById('gw-tasks-dynamic-container');
  if (!cont) return;
  cont.innerHTML = '';

  const all = [...GW_MAP.values()].filter(isForThisStation);

  // ordenar por urgencia (menos días restantes primero)
  all.sort((a,b) => gwUrgency(a) - gwUrgency(b));

  const top = all.slice(0, 3);   // si quieres más, cambia aquí

  top.forEach(t => renderGwTask(t, `task-${t.id}`));
}


/* ===== 5S: estado, render y persistencia local ===== */


/* Fullscreen helpers */
const FS_ICONS = {
on:  '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 9H5V5"/><path d="M15 9h4V5"/><path d="M9 15H5v4"/><path d="M15 15h4v4"/></svg>',
off: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 3H5a2 2 0 0 0-2 2v4"/><path d="M15 3h4a2 2 0 0 1 2 2v4"/><path d="M9 21H5a2 2 0 0 1-2-2v-4"/><path d="M15 21h4a2 2 0 0 0 2-2v-4"/></svg>'
};
function ensureFullscreenBtn(host){
if (!host || host.querySelector('.fs-toggle')) return;
const btn = document.createElement('button');
btn.className = 'fs-toggle'; btn.type = 'button';
btn.setAttribute('aria-label','Ver a pantalla completa');
btn.title = 'Pantalla completa'; btn.innerHTML = FS_ICONS.off;
btn.addEventListener('mousedown', e => e.stopPropagation(), true);
btn.addEventListener('click', async (e) => {
e.preventDefault(); e.stopPropagation();
try {
if (document.fullscreenElement === host) { await document.exitFullscreen?.(); }
else { await (host.requestFullscreen?.({ navigationUI:'hide' }) ?? host.requestFullscreen?.()); }
} catch (err) { console.warn('Fullscreen error:', err); }
});
host.appendChild(btn);
}
function initFullscreenToggles(){
document.querySelectorAll('.widget, .card').forEach(ensureFullscreenBtn);
document.addEventListener('fullscreenchange', () => {
const current = document.fullscreenElement;
document.querySelectorAll('.fs-toggle').forEach(btn => {
const owner = btn.closest('.widget, .card');
const isOn  = current === owner;
btn.innerHTML = isOn ? FS_ICONS.on : FS_ICONS.off;
btn.setAttribute('aria-label', isOn ? 'Salir de pantalla completa' : 'Ver a pantalla completa');
btn.title = isOn ? 'Salir de pantalla completa (Esc)' : 'Pantalla completa';
});
document.documentElement.classList.toggle('fs-zoom', !!current);
});
document.getElementById('present-btn')?.addEventListener('click', async ()=>{
  const host = document.querySelector('.dashboard-3col') || document.body;
  try { await (host.requestFullscreen?.({navigationUI:'hide'}) ?? host.requestFullscreen?.()); }
  catch(e){ console.warn('Fullscreen fail', e); }
});
}

function openWidgetFromChecklist(targetId){
  // Redirigir siempre a la navegación CSS (navTo)
  // Esto evita el conflicto de capas "dobles" y hace que los botones funcionen siempre.
  if (window.navTo) {
      window.navTo(targetId);
  } else {
      console.error("La función navTo no está definida todavía.");
      const el = document.getElementById(targetId);
      if(el) el.scrollIntoView({ behavior:'smooth', block:'center' });
  }
}


  
/* Formatos / KPI */
function formatEuro(n){ if (n==null || Number.isNaN(n)) return '—'; return new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n); }
function updateKpiTotalCost(value, ts){
const v=document.getElementById('kpi-total-cost'); const m=document.getElementById('kpi-costes-meta'); const c=document.getElementById('kpi-costes');
if(!v || !c) return; v.textContent = formatEuro(value); if(m){ const t=ts?new Date(ts).toLocaleString('es-ES'):''; m.textContent = t?`Actualizado: ${t}`:''; }
c.classList.remove('flash'); void c.offsetWidth; c.classList.add('flash');
}
function hydrateKpiTotalCost(){
try{ const cached = JSON.parse(localStorage.getItem('kpi_total_cost')||'null'); if(cached && Number.isFinite(cached.value)){ updateKpiTotalCost(cached.value, cached.timestamp); } }catch{}
}

/* EHS simple */
/* EHS Automático (Días desde último incidente) */
function initEhsSimple(){
    const daysEl = document.getElementById('ehs-days');
    const monthEl = document.getElementById('ehs-month');
    const container = document.getElementById('ehs-spin');
    
    if (!daysEl) return;
    
    // Mes actual visual
    const now = new Date();
    if(monthEl) monthEl.textContent = now.toLocaleDateString('es-ES',{month:'long',year:'numeric'});

    // Clave única para MAD
    const KEY_LAST_INCIDENT = 'ehs_last_incident_date_mad_v1';

    function render() {
        const lastDateStr = localStorage.getItem(KEY_LAST_INCIDENT);
        // Si no hay fecha guardada, asumimos hoy (0 días)
        let lastDate = lastDateStr ? new Date(lastDateStr) : new Date();
        
        // Resetear horas para comparar solo días naturales
        const today = new Date();
        today.setHours(0,0,0,0);
        lastDate.setHours(0,0,0,0);

        // Diferencia en milisegundos a días
        const diffTime = today - lastDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
        
        daysEl.textContent = Math.max(0, diffDays);
    }

    // Doble clic para reportar un incidente hoy (Reinicia a 0)
    container.addEventListener('dblclick', () => {
        if(confirm("¿Reportar incidente en MAD hoy? El contador se reiniciará a 0.")) {
            localStorage.setItem(KEY_LAST_INCIDENT, new Date().toISOString());
            render();
        }
    });

    // Inicializar fecha si es la primera vez que se usa
    if(!localStorage.getItem(KEY_LAST_INCIDENT)){
        localStorage.setItem(KEY_LAST_INCIDENT, new Date().toISOString());
    }

    render();
}

window.TEAM_STATE = window.TEAM_STATE || { 
    attendance: {}, 
    zones: {}, 
    allPeopleRaw: [], 
    people: [], 
    shift: "Cargando...", 
    sheet_date: new Date().toISOString().slice(0,10)
};


function countPresent(att){ return Object.values(att||{}).filter(Boolean).length; }
async function fetchTasksBootstrap(){
  let items = await (await fetch('/api/tasks?fresh_only=true')).json();
  if (!items || items.length === 0) {
    // primer arranque o backend recién levantado
    items = await (await fetch('/api/tasks')).json();
  }
  return items;
}
async function createCard(card) {
  const res = await fetch('/api/tasks', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      // mínimos recomendados
      task_type: card.task_type || 'kanban_rapida',
      title: card.title,
      status: card.status || 'todo',     // o columna inicial
      assigned_to: card.assigned_to || null,
      due_date: card.due_date || null,   // “14/11/2025” o ISO; se normaliza en backend
      category: card.category || null
    })
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function editCard(id, partial) {
  const res = await fetch(`/api/tasks/${id}`, {
    method: 'PATCH',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(partial)   // p.ej. { title: 'Nuevo título', status: 'doing' }
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}
async function moveCard(id, newStatus) {
  return await editCard(id, { status: newStatus });
}
async function deleteCard(id) {
  const res = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
  if (!res.ok && res.status !== 204) throw new Error(await res.text());
  // el WS emitirá { id, action: 'delete', task_type }
}

function updateTeamMeta(state){
const meta = document.getElementById('team-meta');
if(!meta || !state) return;
const total = (state.people||[]).length;
const present = countPresent(state.attendance||{});
const shift = state.shift || '—';
const win = state.window ? `${state.window.from}–${state.window.to}` : '—';
meta.textContent = `${shift} • ${win} • Presentes ${present}/${total}`;
}

async function updatePresenceOnServer(person, present){
try{
await fetch('/api/roster/presence', {
method:'PUT',
headers:{'Content-Type':'application/json'},
body: JSON.stringify({
person, present,
date: TEAM_STATE?.sheet_date || null,
shift: TEAM_STATE?.shift || null
})
});
}catch(e){
console.error('PUT /api/roster/presence falló', e);
}
}

async function updateZoneOnServer(person, zone){
try{
await fetch('/api/roster/zone', {
method:'PUT',
headers:{'Content-Type':'application/json'},
body: JSON.stringify({
person, zone,
date: TEAM_STATE?.sheet_date || null,
shift: TEAM_STATE?.shift || null
})
});
}catch(e){
console.error('PUT /api/roster/zone falló', e);
}
}


function renderRoster(listEl, people, state) {
    if (!listEl) return;

    // --- BLOQUE DE DEFENSA DE MEMORIA (Evita el error de Cristina Pimentel) ---
    if (!window.TEAM_STATE) window.TEAM_STATE = {};
    if (!window.TEAM_STATE.attendance) window.TEAM_STATE.attendance = {};
    if (!window.TEAM_STATE.zones) window.TEAM_STATE.zones = {};
    if (!window.TEAM_STATE.allPeopleRaw) window.TEAM_STATE.allPeopleRaw = [];

    // Fusión inteligente: Añadir gente nueva de la API a la lista global sin duplicados
    if (people && Array.isArray(people) && people.length > 0) {
        people.forEach(p => {
            const existe = window.TEAM_STATE.allPeopleRaw.some(x => x.nombre_completo === p.nombre_completo);
            if (!existe) window.TEAM_STATE.allPeopleRaw.push(p);
        });
    }

    if (state && state.shift) window.TEAM_STATE.shift = state.shift;

    const masterList = window.TEAM_STATE.allPeopleRaw;

    if (masterList.length === 0) {
        listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;">No hay personal cargado...</div>';
        return;
    }

    // 1. Clasificación por categorías
    const groups = {
        "SUPERVISIÓN MAD N1": [],
        "LEAD AGENT": [],
        "OPERARIOS OPS": [],
        "MOSTRADOR": []
    };

    masterList.forEach(p => {
        const grupo = (p.grupo || "").toUpperCase();
        if (grupo.includes("01-SUPERVISORES-OPS")) groups["SUPERVISIÓN MAD N1"].push(p);
        else if (grupo.includes("LEAD AGENT")) groups["LEAD AGENT"].push(p);
        else if (grupo.includes("MOSTRADOR")) groups["MOSTRADOR"].push(p);
        else groups["OPERARIOS OPS"].push(p);
    });

    listEl.innerHTML = '';
    const ZONES = ['MUELLE', 'ALMACÉN'];

    // 2. Renderizado por Grupos
    Object.keys(groups).forEach(groupName => {
        const groupPeople = groups[groupName];
        if (groupPeople.length === 0) return;

        const header = document.createElement('div');
        header.style.cssText = "background:#f1f5f9; padding:8px 12px; margin:15px 0 8px 0; font-weight:700; font-size:0.8rem; color:#475569; border-radius:8px; border-bottom:2px solid #cbd5e1; text-transform:uppercase;";
        header.textContent = `${groupName} (${groupPeople.length})`;
        listEl.appendChild(header);

        groupPeople.forEach((p) => {
            const name = p.nombre_completo;
            // Generar ID seguro para HTML
            const safeId = btoa(unescape(encodeURIComponent(name))).replace(/[^a-zA-Z0-9]/g, ""); 
            
            // ACCESO SEGURO AL ESTADO
            const currentAtt = window.TEAM_STATE.attendance[name]; // Puede ser true, false o undefined
            const currentZone = window.TEAM_STATE.zones[name] || '';

            let borderColor = "#3b82f6"; // Azul
            if (groupName.includes("SUPERVISIÓN")) borderColor = "#fbbf24"; // Oro
            if (groupName.includes("LEAD")) borderColor = "#8b5cf6"; // Púrpura

            const card = document.createElement('div');
            card.className = 'team-row';
            card.style.cssText = `display:flex; flex-direction:column; padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid #e2e8f0; border-left:6px solid ${borderColor}; background:#fff;`;

            card.innerHTML = `
                <div>
                    <div style="font-weight:800; font-size:0.95rem; color:#1e293b;">${esc(name)}</div>
                    <div style="display:flex; gap:6px; margin-top:4px;">
                        <span style="font-size:0.75rem; color:#64748b; font-weight:700;">🕒 ${esc(p.horario || '—')}</span>
                        <span style="font-size:0.65rem; background:#eef2ff; color:#3730a3; padding:2px 6px; border-radius:4px; font-weight:800;">${esc(p.grupo || 'MANUAL')}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid #f1f5f9;">
                    <div class="presence-toggle">
                        <input type="radio" name="att_${safeId}" id="u_${safeId}" value="und" ${currentAtt === undefined ? 'checked' : ''}>
                        <label for="u_${safeId}" style="padding:4px 8px; font-size:0.75rem; cursor:pointer;">➖</label>

                        <input type="radio" name="att_${safeId}" id="y_${safeId}" value="yes" ${currentAtt === true ? 'checked' : ''}>
                        <label for="y_${safeId}" class="yes" style="padding:4px 8px; font-size:0.75rem; cursor:pointer;">✅</label>
                        
                        <input type="radio" name="att_${safeId}" id="n_${safeId}" value="no" ${currentAtt === false ? 'checked' : ''}>
                        <label for="n_${safeId}" class="no" style="padding:4px 8px; font-size:0.75rem; cursor:pointer;">❌</label>
                    </div>
                    <select class="zone-select" style="flex:1; padding:6px; border-radius:8px; border:1px solid #cbd5e1; font-size:0.8rem; font-weight:700; background:#fff;">
                        <option value="" disabled ${!currentZone ? 'selected' : ''}>ZONA...</option>
                        ${ZONES.map(z => `<option value="${z}" ${currentZone === z ? 'selected' : ''}>${z}</option>`).join('')}
                    </select>
                </div>
            `;

            // EVENTO DE CAMBIO DE ASISTENCIA
            card.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.onchange = (e) => {
                    const val = e.target.value;
                    let finalVal = undefined;
                    if (val === "yes") finalVal = true;
                    if (val === "no") finalVal = false;

                    window.TEAM_STATE.attendance[name] = finalVal;
                    if (finalVal !== undefined) updatePresenceOnServer(name, finalVal);
                    updateTeamMeta(window.TEAM_STATE);
                };
            });

            // EVENTO DE CAMBIO DE ZONA
            card.querySelector('.zone-select').onchange = (e) => {
                const zone = e.target.value;
                window.TEAM_STATE.zones[name] = zone;
                if (typeof updateZoneOnServer === 'function') updateZoneOnServer(name, zone);
            };

            listEl.appendChild(card);
        });
    });
    updateTeamMeta(window.TEAM_STATE);
}



/* ===== Equipo: Inicialización con DATOS DE PRUEBA FIJOS ===== */
/* ===== Equipo: Inicialización MODO MANUAL (Sin datos de prueba) ===== */
/* ===== Equipo: Inicialización MODO MANUAL (Con Editar/Eliminar) ===== */
async function initTeamRoster(){
    const listEl = document.getElementById('team-list');
    if(!listEl) return;
    
    const data = await fetchServerRoster();
    if (data && data.people) {
        renderRoster(listEl, data.people, data);
    }
}

async function syncServerAdd(name){
    const payload = {
        person: name,
        station: STATION_CODE,
        date: TEAM_STATE?.sheet_date || null,
        shift: TEAM_STATE?.shift || computeShift().name
    };
    const res = await fetch('api/roster/add', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
    });
    if (res.ok) {
        const cur = await fetchServerRoster();
        if (cur) renderRoster(document.getElementById('team-list'), cur.people||[], cur);
        return true;
    }
    return false;
}

/* === FIX 1: Eliminar el date-picker estático de cabecera === */
(function removeHeaderStaticDate(){
  document.querySelectorAll('.header-controls .date-picker').forEach(el => el.remove());
})();

/* === FIX 2: Checklist por turno (auto-reset al cambiar) === */
(function checklistPerShift(){
  const PREFIX = 'brief_check_v1';
  const LASTKEY = 'brief_check_lastkey_v1';

  // Descubre turno “actual” si el backend aún no lo envió
  function guessShift(){
    const h = new Date().getHours();
    if (h >= 6 && h < 14) return 'Mañana';
    if (h >= 14 && h < 22) return 'Tarde';
    return 'Noche';
  }

  // Clave de versión: estación + fecha (YYYY-MM-DD) + turno
  function currentKey(){
    const station = (typeof STATION_CODE !== 'undefined' ? STATION_CODE : (window.STATION_OVERRIDE||'MAD')).toUpperCase();
    const date = (window.TEAM_STATE?.sheet_date) || new Date().toISOString().slice(0,10);
    const shift = (window.TEAM_STATE?.shift) || guessShift();
    return `${PREFIX}:${station}:${date}:${shift}`;
  }

  const host = document.getElementById('brief-check');
  if (!host) return;

  const radios = Array.from(host.querySelectorAll('.check-actions input[type="radio"]'));
  if (!radios.length) return;

  function saveState(){
    const key = currentKey();
    const state = {};
    // guardamos por “name” (c1, c2, …)
    radios.forEach(r => { if (r.checked) state[r.name] = r.value; });
    try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
    try { localStorage.setItem(LASTKEY, key); } catch {}
  }

  function loadState(){
    const key = currentKey();
    let state = null;
    try { state = JSON.parse(localStorage.getItem(key) || 'null'); } catch {}
    radios.forEach(r => r.checked = false);
    if (state && typeof state === 'object'){
      radios.forEach(r => {
        if (state[r.name] && state[r.name] === r.value) r.checked = true;
      });
    }
  }

  function clearForNewKey(){
    // limpiar checks visuales
    radios.forEach(r => { r.checked = false; });
    // no copiamos el estado del turno anterior; simplemente guardamos vacío para el nuevo
    saveState();
  }

  // Enganche: cuando cambie el turno en TEAM_STATE, comparamos claves
  function ensureFreshness(){
    const key = currentKey();
    const last = localStorage.getItem(LASTKEY);
    if (last && last !== key){
      clearForNewKey();
    } else {
      loadState();
    }
    try { localStorage.setItem(LASTKEY, key); } catch {}
  }

  // Guardar en cada cambio
  radios.forEach(r => r.addEventListener('change', saveState));

  // 1) Al cargar
  ensureFreshness();

  // 2) Tras cargar/actualizar roster (cuando llega shift/fecha del backend)
  const _renderRoster = window.renderRoster;
  window.renderRoster = function(listEl, people, state){
    const res = _renderRoster ? _renderRoster(listEl, people, state) : undefined;
    // TEAM_STATE ya actualizado en tu renderRoster → clave puede cambiar
    ensureFreshness();
    return res;
  };

  // 3) Por si llega un “roster_update” vía WS que cambie turno/fecha
  const _processTaskUpdate = window.processTaskUpdate;
  window.processTaskUpdate = function(data){
    const out = _processTaskUpdate ? _processTaskUpdate(data) : undefined;
    if (data && data.type === 'roster_update'){
      ensureFreshness();
    }
    return out;
  };

  // 4) Seguridad extra: si cambia el día con la página abierta
  //    (ej.: pasa medianoche), forzamos refresco de clave
  setInterval(() => {
    const key = currentKey();
    const last = localStorage.getItem(LASTKEY);
    if (last !== key) ensureFreshness();
  }, 30 * 1000); // cada 30s es suficiente (barato)
})();


/* Kanban / Kaizen / GW */
/* Kanban / Kaizen / GW Configuración Táctil */
function makeColumnsSortable(){
    const common = {
        animation: 150,
        ghostClass: 'sortable-ghost',
        dragClass: 'sortable-drag',
        
        handle: '.drag-handle', // Solo se mueve si tocan el icono
        
        // --- CONFIGURACIÓN CRÍTICA PARA TABLET ---
        forceFallback: true,    // Usa emulación de drag (más compatible en Android)
        delay: 0,               // SIN RETRASO: respuesta inmediata al tocar el asa
        fallbackTolerance: 3,   // Sensibilidad: empieza a mover tras 3px de deslizamiento
        touchStartThreshold: 3, // Igual para pantallas táctiles
        // -----------------------------------------
        
        onEnd: handleDragEnd
    };

    document.querySelectorAll('#kanban-widget .cards-container')
        .forEach(c => new Sortable(c, { group:'kanban-board', ...common }));

    document.querySelectorAll('#kaizen-widget .cards-container')
        .forEach(c => new Sortable(c, { group:'kaizen-board', ...common }));
}
async function handleDragEnd({item,to,from,oldIndex}){
if(to===from){ updateAllColumnCounts(); return; }
const id=item.id.replace('task-','');
const st=to.dataset.status;
try{
await updateTaskOnServer(id,{status:st});
// nada más; el DOM ya se movió
}catch(e){
// revierte
from.insertBefore(item, from.children[oldIndex] || null);
alert('No se pudo actualizar el estado en el servidor.');
}finally{
updateAllColumnCounts();
}
}

/* ===== Equipo: alta manual segura ===== */
(function initTeamManualAdd(){
  const form = document.getElementById('team-form');
  const input = document.getElementById('team-name');
  const listEl = document.getElementById('team-list');
  if (!form || !input || !listEl) return;

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = (input.value || '').trim();
    if (!name) return;

    // Crear el objeto de persona
    const newPerson = { 
        nombre_completo: name, 
        horario: 'Manual', 
        grupo: 'MANUAL', 
        is_incidencia: false 
    };
    
    // Llamar al render enviando solo la persona nueva (la función se encargará de fusionar)
    renderRoster(listEl, [newPerson], window.TEAM_STATE);
    
    input.value = '';
    console.log("👤 Alta manual procesada:", name);
  });
})();

function setupEventListeners() {
    // Formularios Kanban y Kaizen
    document.getElementById('new-kanban-form')?.addEventListener('submit', handleKanbanSubmit);
    document.getElementById('new-kaizen-form')?.addEventListener('submit', handleKaizenSubmit);
    
    // Click global (para borrar tarjetas)
    document.addEventListener('click', handleDeleteClick);

    // --- CORRECCIÓN CRÍTICA PARA GW (Gemba Walk) ---
    // Ya no buscamos el ID 'rotativas-widget' porque lo borramos.
    // Usamos delegación de eventos en el documento.
    
    // 1. Checkbox de completado
   ('change', (e) => {
        // La función handleGwTick ya verifica si es un checkbox válido
        if (typeof handleGwTick === 'function') {
            handleGwTick(e);
        }
    });

    // 2. Notas (Enter y Escape)
    document.addEventListener('keydown', (e) => {
        const note = e.target.closest('.gw-note') ? e.target : null;
        if (!note) return;

        if (e.key === 'Enter') {
            e.preventDefault();
            const id = note.id.replace('gw-note-', '');
            // Verificamos que la función exista antes de llamar
            if(typeof updateTaskNote === 'function') updateTaskNote(id, note.value).catch(console.error);
            note.blur();
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            note.blur();
        }
    });

    // 3. Notas (Al perder el foco / Blur)
    document.addEventListener('blur', (e) => {
        if (e.target.classList && e.target.classList.contains('gw-note')) {
            const id = e.target.id.replace('gw-note-', '');
            if(typeof updateTaskNote === 'function') updateTaskNote(id, e.target.value).catch(console.error);
        }
    }, true); 
}

async function handleKanbanSubmit(e){
  e.preventDefault();
  const f = e.target;

  const taskData = {
    task_type: 'kanban_rapida',
    status: 'Abiertas',
    category: (f.elements.category?.value || '').trim().toLowerCase(),
    title: (f.elements.title?.value || '').trim(),
    due_date: f.elements.due_date?.value || null,
    assigned_to: (f.elements.assigned_to?.value || '').trim() || null,
    station: STATION_CODE
  };

  if (!taskData.category || !taskData.title || !taskData.due_date) return;

  try {
    await createTaskOnServer(taskData);
    f.reset();
    document.getElementById('problem-category').selectedIndex = 0;
    updateAllColumnCounts();
  } catch (err) {
    console.error(err);
    alert('Error: No se pudo crear la tarjeta.');
  }
}


function handleDeleteClick(e){
  const btn = e.target.closest('.ops-delete-btn, .delete-card-btn');
  if (!btn) return;

  // Prioriza tarjeta OPS o Kanban
  const host = btn.closest('.ops-item, .card');
  if (!host) return;

  // 1. ID seguro desde dataset (lo que hemos añadido en el render)
  let id = btn.dataset.id || host.dataset.id;

  // 2. Si no hay dataset, intentamos limpiar el ID del DOM (task-XXXX -> XXXX)
  if (!id && host.id){
    id = host.id.replace(/^(task-|ops-|sec-|client-)/, ''); 
  }

  if (!id) return;

  const ttype = host.dataset.taskType || btn.dataset.taskType ||
                (host.classList.contains('ops-item') ? 'ops_update' :
                 host.classList.contains('card') ? 'kanban_rapida' : 'ops_update');

  if (!confirm('¿Seguro que quieres eliminar esta tarjeta?')) return;

  // Efecto visual inmediato para mejor UX
  host.style.opacity = '0.5';

  deleteTaskOnServer(id, ttype)
    .then(()=>{
      host.remove();
      updateAllColumnCounts?.();
    })
    .catch((err)=>{
      host.style.opacity = '1'; // Restaurar si falla
      console.error(err);
      alert('Error: No se pudo eliminar la tarjeta.');
    });
}



function handleGwTick(e){
if(e.target.type==='checkbox' && e.target.closest('.gw-task-item')){
const item=e.target.closest('.gw-task-item'); const id=item.id.replace('task-',''); const done=e.target.checked;
const note=item.querySelector('.gw-note'); if(note) note.disabled=!done;
updateTaskCompletion(id,done).catch(err=>{ console.error('tick fail',err); e.target.checked=!done; });
item.classList.toggle('completed',done);
}
}
async function handleKaizenSubmit(e){
e.preventDefault();
const f=e.target;
const taskData={ task_type:'kaizen', status:'Proyectos', title:f.elements.title.value.trim(), assigned_to:f.elements.assigned_to.value.trim(), due_date:f.elements.due_date.value||null };
if(!taskData.title) return;
createTaskOnServer(taskData).then(()=>{ f.reset(); updateAllColumnCounts(); }).catch(()=> alert('No se pudo crear el KAIZEN.'));
}

/* Server I/O */
async function fetchServerRoster(){
try {
const r = await fetch('/api/roster/current', { 
cache: 'no-store',
headers: {'Accept': 'application/json'}
});

if (!r.ok) {
console.warn('Roster fetch failed:', r.status, r.statusText);
return null;
}

const data = await r.json();
console.log('Roster cargado:', data);
return data;

} catch (e) {
console.error('Error fetching roster:', e);
return null;
}
}
async function createTaskOnServer(data){
const r = await fetch('/api/tasks',{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(data)
});
if(!r.ok) throw new Error('create failed');
const task = await r.json();
processTaskUpdate(task);            // pinta ya
return task;
}

/* Función para actualizar tareas en el servidor */
async function updateTaskOnServer(id, data){
  // CAMBIO IMPORTANTE: Usamos PATCH en vez de PUT
  // PUT solo sirve para mover de columna. PATCH sirve para editar contenido.
  const r = await fetch(`/api/tasks/${id}`, {
    method: 'PATCH', 
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  
  if (!r.ok) throw new Error('update failed');
  const task = await r.json();
  processTaskUpdate(task);
  return task;
}


async function updateTaskCompletion(id, done){ const r=await fetch(`/api/tasks/${id}/complete`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({is_completed:done})}); if(!r.ok) throw new Error('tick failed'); }
async function updateTaskNote(id, note){ const r=await fetch(`/api/tasks/${id}/note`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({note:note??''})}); if(!r.ok) throw new Error('note failed'); }

/* Render tarjetas */
function processTaskUpdate(data) {
    if (!data) return;

    // 1. FILTRADO POR ESTACIÓN (Aislamiento Industrial)
    if (data.station && data.station.toUpperCase() !== STATION_CODE.toUpperCase()) {
        return;
    }

    // 2. LÓGICA DE BORRADO (Acción Global)
    if (data.action === 'delete') {
        // Borrar de Kanban/Kaizen
        const elTask = document.getElementById(`task-${data.id}`);
        if (elTask) elTask.remove();

        // Borrar de OPS
        const elOps = document.getElementById(`ops-${data.id}`) || 
                      document.querySelector(`.ops-item[data-id="${data.id}"]`);
        if (elOps) elOps.remove();

        if (typeof updateAllColumnCounts === 'function') updateAllColumnCounts();
        
        if (data.task_type === 'gw_task') {
            if (typeof GW_MAP !== 'undefined') GW_MAP.delete(data.id);
            if (typeof renderGwTop3 === 'function') renderGwTop3();
        }
        return; // Return legal dentro de la función
    }

    // 3. LÓGICA DE KPIs (UPH, OTIF, FIIX)
    // Usamos data.metric y data.value de forma segura
    if (data.type === 'kpi_update' || (data.metric && data.metric.startsWith('fiix_'))) {
        const m = data.metric;
        const v = data.value;

        // Si es métrica de Fiix
        if (m && m.startsWith('fiix_')) {
            if (typeof updateFiixDisplay === 'function') updateFiixDisplay(m, v);
            return;
        }

        // Métricas Operativas (UPH / OTIF / Backlog)
        if (m === 'uph') {
            setKpiValue('kpi-uph', 'kpi-uph-meta', new Intl.NumberFormat('es-ES', { maximumFractionDigits: 1 }).format(v));
        } else if (m === 'otif') {
            setKpiValue('kpi-otif', 'kpi-otif-meta', formatPercent(v) + ' %');
        }
        return;
    }

    // 4. ACTUALIZACIÓN POR TIPO DE TAREA (Kanban, Kaizen, GW, OPS)
    const elementId = `task-${data.id}`;
    
    switch (data.task_type) {
        case 'kanban_rapida':
            if (typeof renderBoardCard === 'function') renderBoardCard(data, elementId);
            if (typeof updateAllColumnCounts === 'function') updateAllColumnCounts();
            break;
        case 'kaizen':
            if (typeof renderKaizenCard === 'function') renderKaizenCard(data, elementId);
            if (typeof updateAllColumnCounts === 'function') updateAllColumnCounts();
            break;
        case 'gw_task':
            if (typeof GW_MAP !== 'undefined') GW_MAP.set(data.id, data);
            if (typeof renderGwTop3 === 'function') renderGwTop3();
            break;
        case 'ops_update':
            if (typeof renderOpsCard === 'function') renderOpsCard(data);
            break;
        case 'presence_update':
            // Manejado en bloque aparte o aquí según backend
            break;
    }
}
const GRIP = '<div class="drag-handle" aria-hidden="true" title="Arrastrar"><svg viewBox="0 0 24 24" fill="currentColor"><circle cx="7" cy="7" r="1.5"/><circle cx="7" cy="12" r="1.5"/><circle cx="7" cy="17" r="1.5"/><circle cx="12" cy="7" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="17" r="1.5"/></svg></div>';



(function wireOpsDialog(){
  const btnAdd = document.getElementById('ops-add');
  const dlg    = document.getElementById('ops-dialog');
  const form   = document.getElementById('ops-form');
  if (!dlg || !form) return;

  function openEmpty(){
    form.reset();
    document.getElementById('ops-id').value = '';
    dlg.showModal();
  }
  function openWith(task){
    const idNorm = getTaskId(task || {});
    document.getElementById('ops-id').value           = idNorm || '';
    document.getElementById('ops-title').value        = (task?.title  || '');
    document.getElementById('ops-impact').value       = (task?.impact || task?.priority || 'Medio');
    document.getElementById('ops-scope-field').value  = (task?.scope  || task?.area || 'General');
    document.getElementById('ops-owner').value        = (task?.owner  || task?.assigned_to || '');
    document.getElementById('ops-from').value         = ((task?.from  || task?.valid_from  || task?.start_date || '').split('T')[0] || '');
    document.getElementById('ops-to').value           = ((task?.to    || task?.valid_to    || task?.end_date   || '').split('T')[0] || '');
    dlg.showModal();
  }

  btnAdd?.addEventListener('click', openEmpty);

  // Editar (delegación en lista)
  document.getElementById('ops-list')?.addEventListener('click', async (e)=>{
    const b = e.target.closest('.ops-edit-btn');
    if (!b) return;
    const id = b.dataset.id;
    try{
      const r = await fetch(`/api/tasks/${id}`, { cache:'no-store' });
      const t = await r.json();
      openWith(t || { id });
    }catch{
      openWith({ id });
    }
  });

  // Guardar
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const payload = {
      task_type: 'ops_update',
      title:  document.getElementById('ops-title').value.trim(),
      impact: document.getElementById('ops-impact').value,
      scope:  document.getElementById('ops-scope-field').value,
      owner:  document.getElementById('ops-owner').value.trim() || null,
      from:   document.getElementById('ops-from').value || null,
      to:     document.getElementById('ops-to').value   || null,
      station: (typeof STATION_CODE!=='undefined' ? STATION_CODE : (window.STATION_OVERRIDE||'MAD'))
    };
    if (!payload.title){ alert('Falta el título'); return; }

    const id = document.getElementById('ops-id').value;
    try{
      if (id){
        const up = await updateTaskOnServer(id, payload);
        renderOpsCard(up);
      }else{
        const created = await createTaskOnServer(payload);
        renderOpsCard(created);
      }
      dlg.close();
    }catch(err){
      alert('No se pudo guardar la actualización operativa.');
      console.error(err);
    }
  });

  // === FIX: Cerrar correctamente el diálogo ===
  const cancelBtn = form.querySelector('button[value="cancel"]');
  cancelBtn?.addEventListener('click', (e)=>{ e.preventDefault(); dlg.close(); });

  // Cerrar con ESC
  dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); dlg.close(); });

  // Cerrar clicando fuera del cuadro
  // Cerrar clicando fuera del cuadro (CORREGIDO)
  dlg.addEventListener('click', (e) => {
    // 1. Si el clic viene de dentro del formulario (inputs, selects, labels), IGNORAR.
    // Esto evita que al pulsar un desplegable se cierre el modal.
    if (e.target.closest('#ops-form')) return;

    // 2. Solo si se hace clic en el fondo gris (backdrop), verificamos coordenadas
    const box = form.getBoundingClientRect();
    const inside = (
      e.clientX >= box.left && e.clientX <= box.right &&
      e.clientY >= box.top  && e.clientY <= box.bottom
    );
    
    // Si realmente fue fuera, cerramos
    if (!inside) dlg.close();
  });
})();


  (function wireOpsFilters(){
  const q     = document.getElementById('ops-q');
  const prio  = document.getElementById('ops-prio');
  const scope = document.getElementById('ops-scope');
  const list  = document.getElementById('ops-list');
  if (!list) return;

  function apply(){
    const qt = (q?.value || '').toLowerCase();
    const pv = (prio?.value || '');
    const sv = (scope?.value || '');

    list.querySelectorAll('.ops-item').forEach(card=>{
      const t  = card.querySelector('.ops-title')?.textContent?.toLowerCase() || '';
      const ip = card.querySelector('.ops-impact')?.textContent?.trim() || '';
      const sc = card.querySelector('.ops-scope')?.textContent?.trim() || '';
      const okText  = !qt || t.includes(qt);
      const okPrio  = !pv || ip === pv;
      const okScope = !sv || sc === sv;
      card.style.display = (okText && okPrio && okScope) ? '' : 'none';
    });
  }

  q?.addEventListener('input', apply);
  prio?.addEventListener('change', apply);
  scope?.addEventListener('change', apply);
})();

  
function renderBoardCard(task, elementId){
  const safeStatus = (task.status || 'Abiertas').replace(/\s+/g,'-');
  const columnId   = `${task.task_type}-${safeStatus}`;
  const column     = document.getElementById(columnId);
  if (!column) return;

  // Fechas seguras
  const createdAt   = task.created_at ? new Date(task.created_at) : null;
  const creationDate= (createdAt && !isNaN(createdAt)) ? createdAt.toLocaleDateString('es-ES') : '—';
  const dueISO      = task.due_date || null;
  const dueDate     = dueISO ? new Date(dueISO) : null;
  const dueHuman    = (dueDate && !isNaN(dueDate)) ? dueDate.toLocaleDateString('es-ES') : '';

  // Elemento tarjeta
  let card = document.getElementById(elementId);
  if (!card){ 
    card = document.createElement('div'); 
    card.id = elementId; 
  }
  card.className = 'card';
  
  // --- CORRECCIÓN: Guardar ID explícito ---
  card.dataset.id = task.id; 
  // ----------------------------------------
  
  card.dataset.status = safeStatus;
  card.dataset.taskType = 'kanban_rapida';

  // Color por categoría + chip
  const catKey = String(task.category || '').toLowerCase();
  card.classList.remove('cat-seguridad','cat-incidencias','cat-mantenimiento','cat-calidad','cat-servicio');
  if (['seguridad','incidencias','mantenimiento','calidad','servicio'].includes(catKey)){
    card.classList.add(`cat-${catKey}`);
  }
  const CAT_LABELS = {
    seguridad: 'Seguridad',
    incidencias: 'Incidencias',
    mantenimiento: 'Mantenimiento',
    calidad: 'Calidad',
    servicio: 'Servicio'
  };
  const catLabel = CAT_LABELS[catKey] || 'General';

  card.innerHTML = `
    ${GRIP}
    <div class="card-content">
      <div class="card-title" data-edit="title" title="Tocar para editar">${esc(task.title || '')}</div>
      <div class="card-details">
        Alta: ${creationDate} • Objetivo:
        <button class="btn-compact" data-edit="due">${dueHuman || '—'}</button>
      </div>
      <div class="card-assignee">Responsable:
        <span class="assignee" data-edit="assigned_to" title="Tocar para editar">${esc(task.assigned_to || 'Sin asignar')}</span>
      </div>
      <div style="margin-top:6px;">
        <button class="btn-compact" data-edit="category">${catLabel}</button>
      </div>
    </div>
    <div class="card-actions">
      <button class="delete-card-btn" title="Eliminar">
        <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
        </svg>
      </button>
    </div>
  `;
  ensureFullscreenBtn(card);

  // Inserta en la columna si aún no está
  if (card.parentElement !== column){
    column.prepend(card);
  }

  // —— Edición rápida —— //
  const id = task.id;

  const titleEl = card.querySelector('[data-edit="title"]');
  titleEl?.addEventListener('click', async ()=>{
    const prev = titleEl.textContent.trim();
    const next = (prompt('Nuevo título', prev) || '').trim();
    if (next && next !== prev){
      try { await updateTaskOnServer(id, { title: next }); } 
      catch { alert('No se pudo actualizar el título'); }
    }
  });

  const asgEl = card.querySelector('[data-edit="assigned_to"]');
  asgEl?.addEventListener('click', async ()=>{
    const prev = asgEl.textContent.trim();
    const next = (prompt('Responsable', prev === 'Sin asignar' ? '' : prev) || '').trim();
    if (next !== prev){
      try { await updateTaskOnServer(id, { assigned_to: next || null }); }
      catch { alert('No se pudo actualizar el responsable'); }
    }
  });

  const dueBtn = card.querySelector('[data-edit="due"]');
  dueBtn?.addEventListener('click', async ()=>{
    const input = document.createElement('input');
    input.type = 'date';
    input.value = dueISO || '';
    input.style.position='fixed'; input.style.opacity='0';
    document.body.appendChild(input);
    input.addEventListener('change', async ()=>{
      const newISO = input.value || null;
      document.body.removeChild(input);
      if ((newISO||'') !== (dueISO||'')){
        try { await updateTaskOnServer(id, { due_date: newISO }); }
        catch { alert('No se pudo actualizar la fecha'); }
      }
    }, { once:true });
    input.click();
  });

  const catBtn = card.querySelector('[data-edit="category"]');
  catBtn?.addEventListener('click', async ()=>{
    const opts = ['Seguridad','Incidencias','Mantenimiento','Calidad','Servicio','General'];
    const prev = catLabel;
    const next = prompt(`Categoría (${opts.join(' / ')})`, prev) || prev;
    const map = { Seguridad:'seguridad', Incidencias:'incidencias', Mantenimiento:'mantenimiento', Calidad:'calidad', Servicio:'servicio', General:'' };
    const val = map[next] ?? map[prev];
    if (val !== (task.category||'')){
      try { await updateTaskOnServer(id, { category: val }); }
      catch { alert('No se pudo actualizar la categoría'); }
    }
  });
}



function renderKaizenCard(task, elementId){
  const safeStatus=(task.status||'Proyectos').replace(/\s+/g,'-');
  const columnId=`kaizen-${safeStatus}`;
  const column=document.getElementById(columnId); if(!column) return;

  let card=document.getElementById(elementId);
  if(!card){ card=document.createElement('div'); card.id=elementId; }
  card.className='card'; 
  
  // --- CORRECCIÓN: Guardar ID explícito ---
  card.dataset.id = task.id; 
  // ----------------------------------------
  
  card.dataset.status=safeStatus;
  card.dataset.taskType='kaizen';  
  if(card.parentElement!==column) column.prepend(card);

  let dueHuman=''; 
  if(task.due_date){ const d=new Date(task.due_date); if(!isNaN(d)) dueHuman=d.toLocaleDateString('es-ES'); }

  card.innerHTML=`
    ${GRIP}
    <div class="card-content">
      <div class="card-title" data-edit="title">${esc(task.title || '')}</div>
      <div class="card-details">
        ${task.assigned_to ? `Responsable: ${esc(task.assigned_to)}` : 'Responsable: —'}
        ${dueHuman ? ` • Fecha máx: ${dueHuman}` : ''}
      </div>
    </div>
    <div class="card-actions">
      <button class="delete-card-btn" title="Eliminar">
        <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
          <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
          <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
        </svg>
      </button>
    </div>
  `;
  ensureFullscreenBtn(card);

  // Edición rápida
  const id = task.id;
  const titleEl = card.querySelector('[data-edit="title"]');
  titleEl?.addEventListener('click', async ()=>{
    const prev = titleEl.textContent.trim();
    const next = (prompt('Nuevo título', prev) || '').trim();
    if (next && next !== prev){
      try { await updateTaskOnServer(id, { title: next }); } 
      catch { alert('No se pudo actualizar el título'); }
    }
  });
}

function renderGwTask(task, elementId){
  const container = document.getElementById('gw-tasks-dynamic-container');
  if (!container) return;

  let el = document.getElementById(elementId);
  if (!el){
    el = document.createElement('div');
    el.id = elementId;
    container.appendChild(el);
  }

  const days = gwUrgency(task);
  const due  = task.gw_date || task.due_date || '';
  const dueTxt = due ? new Date(due).toLocaleDateString('es-ES') : '—';

  let labelDays;
  if (days === 99999){
    labelDays = 'Sin fecha';
  } else if (days === 0){
    labelDays = 'HOY';
  } else if (days > 0){
    labelDays = `Quedan ${days} días`;
  } else {
    labelDays = `Vencido hace ${Math.abs(days)} días`;
  }

  const note = task.note || '';

 el.className = 'gw-task-item';
el.innerHTML = `
  <div class="ops-head">
    <div class="ops-title">${esc(task.title || 'Gemba Walk')}</div>
    <span class="badge">${esc(labelDays)}</span>
  </div>
  <div class="meta-row">Fecha: ${esc(dueTxt)}</div>
  <label class="checkbox-item">
    <input type="checkbox" class="gw-done" ${task.is_completed ? 'checked' : ''}>
    Completado
  </label>
  <textarea id="gw-note-${task.id}" class="gw-note" ${task.is_completed ? '' : 'disabled'}>${esc(note)}</textarea>
`;

}


function updateAllColumnCounts(){
document.querySelectorAll('#kanban-widget .kanban-column').forEach(col=>{
const c=col.querySelector('.column-title .count'); const cards=col.querySelector('.cards-container'); if(c&&cards) c.textContent=`(${cards.children.length})`;
});
document.querySelectorAll('#kaizen-widget .kanban-column').forEach(col=>{
const c=col.querySelector('.column-title .count'); const cards=col.querySelector('.cards-container'); if(c&&cards) c.textContent=`(${cards.children.length})`;
});
}

async function loadAllTasks(){
try{
const r = await fetch('/api/tasks?task_type=gw_task&station=' + encodeURIComponent(STATION_CODE), { cache:'no-store' });
if(!r.ok) throw new Error('GET /api/tasks failed');
const tasks = await r.json();

// Asegura filtrado por estación por si el backend no filtra
const list = Array.isArray(tasks) ? tasks.filter(isForThisStation) : [];

// Pinta todas en memoria y renderiza el TOP3
list.forEach(t => { t.task_type === 'gw_task' && GW_MAP.set(t.id, t); });
renderGwTop3();
}catch(e){
console.error('No se pudieron cargar las GW iniciales:', e);
}
}

// CARGA INICIAL DE KANBAN + KAIZEN (y mantiene GW como ya tienes)
async function loadBoardsInitial(){
  try{
    const qsStation = 'station=' + encodeURIComponent(STATION_CODE);

    const [kanRes, kaiRes, gwRes, opsRes] = await Promise.all([
      fetch('/api/tasks?task_type=kanban_rapida&'+qsStation, {cache:'no-store'}),
      fetch('/api/tasks?task_type=kaizen&'+qsStation, {cache:'no-store'}),
      fetch('/api/tasks?task_type=gw_task&'+qsStation,   {cache:'no-store'}),
      fetch('/api/tasks?task_type=ops_update&'+qsStation,{cache:'no-store'}),
    ]);

    const [kan, kai, gw, ops] = await Promise.all([
      kanRes.json(), kaiRes.json(), gwRes.json(), opsRes.json()
    ]);

    (Array.isArray(kan)?kan:[]).filter(isForThisStation).forEach(t=>processTaskUpdate(t));
    (Array.isArray(kai)?kai:[]).filter(isForThisStation).forEach(t=>processTaskUpdate(t));
    (Array.isArray(ops)?ops:[]).filter(isForThisStation).forEach(t=>processTaskUpdate({...t, task_type:'ops_update'}));

    (Array.isArray(gw)?gw:[]).filter(isForThisStation).forEach(t=>{
      if (t.task_type==='gw_task') GW_MAP.set(t.id, t);
    });
    renderGwTop3();
    updateAllColumnCounts();
  }catch(e){
    console.error('No se pudieron cargar las tarjetas iniciales:', e);
  }
}



/* ===== Seguridad & Protección: tarjetas dinámicas + 2 frases por turno ===== */
(function initSeguridadModule(){
  const LISTA_FRASES = [
    "Temas de seguridad de actualidad (noticias, redes sociales, cambios de nivel de amenaza, etc.).",
    "Incidentes o no conformidades en tu estación u otras.",
    "Resultados de auditorías (aerolíneas, autoridades, autoauditorías).",
    "Próximas auditorías o visitas.",
    "Mantener puertas cerradas cuando no se usen.",
    "Reportar comportamientos sospechosos.",
    "Retar a personas sin acreditación o acompañamiento.",
    "Acompañar a todos los visitantes en todo momento.",
    "Llevar chaleco de alta visibilidad en almacén y zona aire.",
    "Saber dónde están los contactos de emergencia.",
    "Segregar carga segura e insegura.",
    "Revisar signos de manipulación en paquetes.",
    "Llevar la acreditación visible en todo momento.",
    "No llevar mochilas ni bolsas a zonas seguras.",
    "Guardar cintas, precintos y elementos de seguridad de forma segura.",
    "No permitir el acceso de personas no autorizadas.",
    "Preguntar si no se conoce un procedimiento.",
    "No dar información de seguridad a externos.",
    "No permitir personas no autorizadas cerca de carga segura.",
    "No saltarse procedimientos.",
    "Si una carga no es segura, no cargarla y revisarla.",
    "Leer todos los avisos de seguridad y pedir aclaraciones.",
    "Si ves algo, dilo.",
    "Informar si las normas no son prácticas o seguras.",
    "Escalar errores o riesgos de seguridad a la dirección.",
    "Mantener la información sensible segura.",
    "Cumplir siempre las normas y procedimientos de seguridad.",
    "No seguir instrucciones que comprometan la seguridad.",
    "No cargar mercancía con etiquetas de parada o retención.",
    "Animar a los compañeros a cumplir las normas.",
    "Revisar la validez de la acreditación y avisar si va a caducar.",
    "Si no sabes, pregunta; si sabes, enseña.",
    "Pensar en las consecuencias de no cumplir las normas.",
    "Identificar a la persona con la que hablas.",
    "Comparar la foto de la acreditación con la persona.",
    "Registrar entrada y salida de visitantes.",
    "Si ves conductores deambulando, indícale la zona designada.",
    "Mantener puertas de zona aire cerradas.",
    "No interferir con los controles de seguridad.",
    "Al controlar, centrarse en la tarea.",
    "Rechazar o revisar carga dañada.",
    "No aceptar carga sin identificación o documentación.",
    "Revisar que los camiones estén sellados.",
    "Comprobar la identificación de quien recoge la carga.",
    "Contar todas las piezas de un envío.",
    "Comparar el nombre del visitante con el registro.",
    "Comprobar la validez en bases de datos oficiales.",
    "Verificar acuerdos de subcontratistas.",
    "No prestar acreditaciones.",
    "Avisar si se pierde la acreditación.",
    "Comprobar identificación y estatus en cada ocasión.",
    "No permitir acceso no autorizado a zonas restringidas.",
    "Asistir y prestar atención a la reunión de turno.",
    "Presentar la acreditación en lectores de proximidad.",
    "Informar de errores a supervisores.",
    "Todos pueden pulsar el botón de parada de emergencia por seguridad.",
    "Mejor prevenir que curar.",
    "Cooperar en los controles de seguridad.",
    "Avisar si algo no parece correcto.",
    "No manipular ni poner en riesgo sistemas de seguridad.",
    "Sospechar de precintos diferentes en paquetes.",
    "Las fechas límite no justifican saltarse la seguridad.",
    "Dejar trabajar a los perros de seguridad.",
    "Asegurarse de que la carga ha sido revisada.",
    "La seguridad es responsabilidad de todos.",
    "Informar de puertas, ventanas o vallas dañadas.",
    "Retar a desconocidos en el almacén.",
    "Ayudar a los controladores en el escaneo de envíos.",
    "Usar cinta de seguridad para cerrar paquetes revisados.",
    "Usar sellos correctos para indicar el estado de seguridad.",
    "Llamar a la policía si es necesario.",
    "Leer los boletines de seguridad y pedir aclaraciones.",
    "Ayudar a nuevos empleados a cumplir las normas.",
    "Informar de daños en carga, puertas, ventanas, señalización.",
    "Transferir la carga segura inmediatamente a la zona segura.",
    "Guardar carga valiosa en áreas designadas y bajo CCTV.",
    "Asegurarse de que los visitantes devuelvan su acreditación.",
    "Dejar pertenencias personales en la taquilla.",
    "No entregar carga a conductores no autorizados.",
    "Comprobar que los controles de seguridad estén registrados.",
    "Asegurarse de que los archivos de vuelo estén completos.",
    "Comprobar que cada envío tenga el CSD correcto.",
    "La seguridad es para proteger a todos, incluidos tus seres queridos.",
    "Todos deben estar formados según su función.",
    "Adaptar los procedimientos a la seguridad, no al revés.",
    "No tomar fotos en zonas seguras.",
    "No publicar información de seguridad en redes sociales.",
    "No permitir que los clientes decidan el método de control.",
    "No permitir que clientes/conductores usen baños sin acompañamiento.",
    "Mantener cerradas las puertas de zonas restringidas.",
    "Informar siempre de carga dañada.",
    "Informar de carga manipulada o posible robo.",
    "Informar de comportamientos extraños de compañeros.",
    "Conocer el cartel de “whistle blower”.",
    "Concienciación sobre amenazas internas.",
    "No asumir riesgos innecesarios con la seguridad.",
    "No dejar carga segura desatendida fuera de la instalación.",
    "Mantenerse siempre alerta.",
    "No dejar puertas abiertas sin vigilancia.",
    "No compartir procesos de seguridad del sector.",
    "La seguridad es tu responsabilidad."
  ];

  const host = document.getElementById('seguridad-widget');
  if (!host) return;

  const listEl   = document.getElementById('sec-cards');
  const formEl   = document.getElementById('sec-form');
  const titleEl  = document.getElementById('sec-title');
  const ownerEl  = document.getElementById('sec-owner');
  const metaEl   = document.getElementById('sec-meta');
  const scopeEl  = document.getElementById('sec-random-scope');
  const ulTipsEl = document.getElementById('sec-random-list');

  // Persistencia local
  const SEC_KEY = 'sec_cards_v1';

  function loadCards(){
    try { return JSON.parse(localStorage.getItem(SEC_KEY) || '[]'); } catch { return []; }
  }
  function saveCards(arr){
    try { localStorage.setItem(SEC_KEY, JSON.stringify(arr || [])); } catch {}
  }

 

  function renderCards(){
    const data = loadCards().filter(isForThisStation);
    listEl.innerHTML = '';
    data.forEach(item => {
      const div = document.createElement('div');
      div.className = 'ops-item';
      div.id = `sec-${item.id}`;
      div.innerHTML = `
        <div class="ops-head">
          <div class="ops-title">${esc(item.title)}</div>
          <div class="ops-flags">
            ${item.owner ? `<span class="ops-scope">@${esc(item.owner)}</span>` : ''}
            <button type="button" class="ops-btn" data-del="${item.id}">Eliminar</button>
          </div>
        </div>
        <div class="ops-meta">Creado: ${new Date(item.created_at).toLocaleString('es-ES')}</div>
      `;
      listEl.prepend(div);
    });
    metaEl.textContent = `${data.length} tarjetas`;
  }

  function uid(){ return Math.random().toString(36).slice(2,10); }

  formEl?.addEventListener('submit', (e)=>{
    e.preventDefault();
    const title = (titleEl.value || '').trim();
    if (!title) return;
    const owner = (ownerEl.value || '').trim();

    const arr = loadCards();
    arr.push({
      id: uid(),
      station: (window.STATION_OVERRIDE || '').toUpperCase() || (typeof STATION_CODE!=='undefined'?STATION_CODE:''),
      title, owner,
      created_at: new Date().toISOString()
    });
    saveCards(arr);
    titleEl.value = ''; ownerEl.value = '';
    renderCards();
  });

  listEl?.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-del]');
    if (!btn) return;
    const id = btn.getAttribute('data-del');
    const arr = loadCards().filter(x => x.id !== id);
    saveCards(arr);
    document.getElementById(`sec-${id}`)?.remove();
    metaEl.textContent = `${arr.length} tarjetas`;
  });

  // ——— 2 frases aleatorias por turno (persisten por día+turno) ———
  function currentShiftLabel(){
    // Usa el shift del roster si está cargado
    const shift = (window.TEAM_STATE && TEAM_STATE.shift) ? TEAM_STATE.shift : null;
    if (shift) return shift; // p.ej. "Mañana" / "Tarde" / "Noche" si lo pones así

    // Si no hay TEAM_STATE.shift, aproximamos por hora:
    const h = new Date().getHours();
    if (h >= 6 && h < 14) return 'Mañana';
    if (h >= 14 && h < 22) return 'Tarde';
    return 'Noche';
  }

  function pickTwoStable(){
    const shift = currentShiftLabel();
    const day   = new Date().toISOString().slice(0,10);
    const KEY   = `sec_random_${day}_${shift}`;

    // ¿ya seleccionado hoy para este turno?
    try {
      const cached = JSON.parse(localStorage.getItem(KEY) || 'null');
      if (cached && Array.isArray(cached) && cached.length === 2) return {shift, picks: cached};
    } catch {}

    // elige 2 distintos
    const idx1 = Math.floor(Math.random() * LISTA_FRASES.length);
    let idx2 = Math.floor(Math.random() * LISTA_FRASES.length);
    if (idx2 === idx1) idx2 = (idx1 + 1) % LISTA_FRASES.length;

    const picks = [LISTA_FRASES[idx1], LISTA_FRASES[idx2]];
    try { localStorage.setItem(KEY, JSON.stringify(picks)); } catch {}
    return {shift, picks};
  }

  function renderRandomTips(){
    const {shift, picks} = pickTwoStable();
    scopeEl.textContent = `Turno ${shift}`;
    ulTipsEl.innerHTML = picks.map(p => `<li>${esc(p)}</li>`).join('');
  }

  // init
  renderCards();
  renderRandomTips();

  // si más tarde cargan TEAM_STATE.shift vía WebSocket/roster, volvemos a pintar las frases
  document.addEventListener('TEAM_SHIFT_READY', ()=> renderRandomTips());
})();


function connectWebSocket(){
const wsUrl=`${location.protocol==='https:'?'wss:':'ws:'}//${location.host}/ws`;
const socket=new WebSocket(wsUrl);
socket.onopen=()=>console.log('✅ WebSocket conectado');
socket.onmessage=(ev)=>processTaskUpdate(JSON.parse(ev.data));
socket.onclose=()=>setTimeout(connectWebSocket,3000);
socket.onerror=(err)=>{ console.error('WS error:',err); socket.close(); };
}

/* ===== Incidentes (Enablon) usando /api/external-table ===== */
const INC_CACHE_KEY = 'incidents_cache_v1';
function cacheIncidentes(state){ try { localStorage.setItem(INC_CACHE_KEY, JSON.stringify(state)); } catch {} }
function getCachedIncidentes(){ try { return JSON.parse(localStorage.getItem(INC_CACHE_KEY) || 'null'); } catch { return null; } }

// normaliza (espacios, acentos, may/min) para buscar columnas por alias
const norm = (s)=> String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim().toLowerCase();


async function loadIncidentes(){
  const tbl  = document.getElementById('incidentes-table');
  const meta = document.getElementById('incidentes-meta');

  // 1) pinta caché si la tabla está vacía
  const cached = getCachedIncidentes();
  if (cached && (!tbl || !tbl.tBodies || !tbl.tBodies.length)) {
    renderIncidentes(cached);
  }

  // 2) servidor
  try{
    const r = await fetch('/api/incidents-table', { cache:'no-store' });
    if(!r.ok) throw new Error('GET /api/incidents-table failed');
    const state = await r.json();

    if (Array.isArray(state.columns) && state.columns.length){
      renderIncidentes(state);
      cacheIncidentes(state);
    } else if (cached){
      renderIncidentes(cached);
      if (meta) meta.textContent += ' • fuente offline';
    }
  }catch(e){
    console.error('Incidentes load error', e);
    if (cached){
      renderIncidentes(cached);
      if (meta) meta.textContent += ' • fuente offline';
    }
  }
}


function renderIncidentes(state){
  const tbl  = document.getElementById('incidentes-table');
  const meta = document.getElementById('incidentes-meta');
  if (!tbl) return;

  const cols = Array.isArray(state?.columns) ? state.columns : [];
  const rows = Array.isArray(state?.rows) ? state.rows : [];
  const ts   = state?.fetched_at ? new Date(state.fetched_at).toLocaleString('es-ES') : '—';

  const rowsAreObjects = rows[0] && typeof rows[0] === 'object' && !Array.isArray(rows[0]);
  const candidateCols = rowsAreObjects
    ? Array.from(new Set(rows.flatMap(r => Object.keys(r||{}))))
    : cols.slice();

  const norm = (s)=> String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim().toLowerCase();
  const colNameByNorm = new Map(candidateCols.map(c => [norm(c), c]));
  const pick = (...aliases) => {
    for (const a of aliases){
      const key = norm(a);
      if (rowsAreObjects && colNameByNorm.has(key)) return { name: colNameByNorm.get(key), idx: cols.indexOf(colNameByNorm.get(key)) };
      if (!rowsAreObjects){
        const i = cols.findIndex(c => norm(c) === key);
        if (i !== -1) return { name: cols[i], idx: i };
      }
    }
    return null;
  };

  let selected = [
    pick('Id','ID','Incident Id','IncidentId','Number','Reference','Case Number','Incident No'),
    pick('Accidente','Título Accidente','Titulo Accidente','Accident Title','accident_title','incident_title','Title','Name','Short Description','Subject','Summary','Description'),
    pick('Status','State','Workflow Status','Current Status'),
    pick('Priority','Severity','Risk Level','Criticality'),
    pick('Category','Type','Incident Type','SubType','Classification','event_type'),
    pick('Site','Location','Area','Department','Plant'),
    pick('Created','Created At','Creation Date','Date','Reported On','Report Date','Start Date'),
    pick('Due Date','Target Date','Deadline','Expiration Date'),
    pick('Owner','Assigned To','Assignee','Responsible','Manager')
  ].filter(Boolean);

  if (selected.length === 0){
    const base = candidateCols.slice(0, 6);
    selected = base.map(n => ({ name:n, idx: cols.indexOf(n) }));
  }

  if (selected.length === 0){
    tbl.innerHTML = '<tbody><tr><td>No se encontraron columnas para mostrar.</td></tr></tbody>';
    if (meta) meta.textContent = `Columnas: ${cols.length} • Filas: ${rows.length} • Actualizado: ${ts}`;
    return;
  }

  let thead = '<thead><tr>' + selected.map(c => `<th>${esc(c.name)}</th>`).join('') + '</tr></thead>';
  const MAX_ROWS = 4;
  const slice = rows.slice(0, MAX_ROWS);
  let tbody = '<tbody>';
  for (const r of slice){
    if (rowsAreObjects){
      tbody += '<tr>' + selected.map(c => `<td>${r?.[c.name] == null ? '' : esc(String(r[c.name]))}</td>`).join('') + '</tr>';
    } else {
      tbody += '<tr>' + selected.map(c => `<td>${r?.[c.idx] == null ? '' : esc(String(r[c.idx]))}</td>`).join('') + '</tr>';
    }
  }
  if (rows.length > MAX_ROWS){
    tbody += `<tr><td colspan="${selected.length}" style="color:var(--text-muted)">Mostrando ${MAX_ROWS} de ${rows.length} incidentes…</td></tr>`;
  }
  tbody += '</tbody>';

  tbl.innerHTML = thead + tbody;
  if (meta) meta.textContent = `Columnas reales: ${candidateCols.length} • Filas: ${rows.length} • Actualizado: ${ts}`;
}


function formatPercent(n){
  if (n==null || Number.isNaN(n)) return '—';
  return new Intl.NumberFormat('es-ES', { minimumFractionDigits:1, maximumFractionDigits:1 }).format(n);
}
function flash(el){ if(!el) return; el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash'); }

function setKpiValue(idValue, idMeta, valueText){
  const v = document.getElementById(idValue);
  const m = document.getElementById(idMeta);
  if (!v) return;
  v.textContent = valueText;
  if (m) m.textContent = `Actualizado: ${new Date().toLocaleString('es-ES')}`;
  flash(v.closest('.kpi-tile'));
}


/* Turno anterior editable */
/* ===== Turno Anterior: Sistema de Lista por Ubicación ===== */
function initPrevShiftSystem() {
    const btn = document.getElementById('prev-add-btn');
    const input = document.getElementById('prev-input');
    const listEl = document.getElementById('prev-list');
    
    if (!btn || !input || !listEl) return;

    // Llave única por ubicación para evitar mezcla de datos
    const KEY = 'prev_highlights_' + (window.STATION_OVERRIDE || 'GENERIC') + '_v1';

    const loadItems = () => {
        try {
            return JSON.parse(localStorage.getItem(KEY) || '[]');
        } catch (e) { return []; }
    };

    const saveItems = (items) => {
        localStorage.setItem(KEY, JSON.stringify(items));
    };

    const render = () => {
        const items = loadItems();
        listEl.innerHTML = '';
        
        if (items.length === 0) {
            listEl.innerHTML = '<div style="color:#9ca3af; text-align:center; padding:10px;">No hay highlights registrados.</div>';
            return;
        }

        // Renderizar de más nuevo a más viejo
        [...items].reverse().forEach((text, revIdx) => {
            const originalIdx = items.length - 1 - revIdx;
            const div = document.createElement('div');
            div.className = 'prev-item';
            div.innerHTML = `
                <div class="prev-text">${esc(text)}</div>
                <div class="prev-actions">
                    <button class="prev-btn" onclick="removePrevItem(${originalIdx})">🗑️</button>
                </div>
            `;
            listEl.appendChild(div);
        });
    };

    // Función para añadir
    const addItem = () => {
        const val = input.value.trim();
        if (!val) return;
        
        const items = loadItems();
        items.push(val);
        saveItems(items);
        
        input.value = '';
        render();
        input.focus();
    };

    // Click en botón +
    btn.onclick = (e) => {
        e.preventDefault();
        addItem();
    };

    // Enter en el input
    input.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addItem();
        }
    };

    // Exponer función de borrado globalmente
    // Añade esto cerca de initPrevShiftSystem si no lo tienes así
    window.removePrevItem = (idx) => {
        const KEY = 'prev_highlights_' + (window.STATION_OVERRIDE || 'GENERIC') + '_v1';
        try {
            let items = JSON.parse(localStorage.getItem(KEY) || '[]');
            items.splice(idx, 1);
            localStorage.setItem(KEY, JSON.stringify(items));
            
            // Buscamos el initPrevShiftSystem para que repinte la lista
            if (typeof initPrevShiftSystem === 'function') {
                initPrevShiftSystem();
            }
        } catch (e) {
            console.error("Error al borrar highlight:", e);
        }
    };

    render();
}

/* ===== 5S compacto (localStorage) ===== */
const S5_KEYS = [
{ key:'seiri',    label:'1S Seiri' },
{ key:'seiton',   label:'2S Seiton' },
{ key:'seiso',    label:'3S Seiso' },
{ key:'seiketsu', label:'4S Seiketsu' },
{ key:'shitsuke', label:'5S Shitsuke' },
];
const S5_STATE_KEY = 's5_state_v1';

function loadS5State(){
try { return JSON.parse(localStorage.getItem(S5_STATE_KEY) || '{}'); }
catch { return {}; }
}
function saveS5State(state){
try { localStorage.setItem(S5_STATE_KEY, JSON.stringify(state)); } catch {}
}

function render5S(){
const strip = document.getElementById('s5-strip');
if (!strip) return;
const state = loadS5State();

// Marcar ON/OFF
let done = 0;
strip.querySelectorAll('.s5-pill').forEach(btn => {
const k = btn.dataset.key;
const on = !!state[k];
btn.classList.toggle('on', on);
if (on) done++;
});

// Meta “x/5” + fecha
const meta = document.getElementById('s5-meta');
if (meta){
const ts = state.updated_at ? new Date(state.updated_at).toLocaleString('es-ES') : null;
meta.textContent = `${done}/5 completadas${ts ? ` • Actualizado: ${ts}` : ''}`;
}
}

function toggle5S(key, el){
const state = loadS5State();
state[key] = !state[key];
state.updated_at = new Date().toISOString();
saveS5State(state);
render5S();
if (el){ el.classList.add('bump'); setTimeout(()=> el.classList.remove('bump'), 220); }
}

function init5S(){
const strip = document.getElementById('s5-strip');
if (!strip) return;
// Delegación de eventos
strip.addEventListener('click', (e)=>{
const btn = e.target.closest('.s5-pill');
if (!btn) return;
const key = btn.dataset.key;
if (!key) return;
toggle5S(key, btn);
});
render5S();
}
/* ===== Briefing / Checklist ===== */
const BR_KEY = 'briefing_state_v1';

function br_parseTimerText(txt){
// Acepta HH:MM:SS o MM:SS
const m = String(txt||'').trim().split(':').map(Number);
if (m.length === 3) return (m[0]*3600 + m[1]*60 + m[2])|0;
if (m.length === 2) return (m[0]*60 + m[1])|0;
return 0;
}
function br_fmtMMSS(sec){
sec = Math.max(0, Number(sec)||0);
const m = Math.floor(sec/60), s = sec%60;
return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function br_todayISO(){
const d = new Date();
return d.toISOString().slice(0,10);
}
function br_load(){
try{ return JSON.parse(localStorage.getItem(BR_KEY) || 'null'); } catch{ return null; }
}
function br_save(state){
try{
localStorage.setItem(BR_KEY, JSON.stringify(state));
const hint = document.getElementById('briefing-save-hint');
if (hint){ hint.textContent = `Guardado local: ${new Date().toLocaleString('es-ES')}`; }
}catch{}
}
function br_collect(){
const state = {
date_iso: document.getElementById('br-date').value || br_todayISO(),
shift: (document.querySelector('input[name="br-shift"]:checked')?.value)||'',
supervisor: document.getElementById('br-supervisor').value || '',
duration_sec: br_parseTimerText(document.getElementById('br-duration').value || '00:00'),
attendance_pct: Number(document.getElementById('br-attendance').value||'')||null,
sections: {}
};
document.querySelectorAll('#briefing-sections .br-section').forEach(sec=>{
const key = sec.dataset.key;
const status = sec.querySelector('.br-status input:checked')?.value || '';
const notes = sec.querySelector('[data-notes]')?.value || '';
const criteria = {};
sec.querySelectorAll('.br-criteria [data-c]').forEach(chk=>{
criteria[chk.dataset.c] = !!chk.checked;
});
state.sections[key] = { status, criteria, notes };
});
// cálculo
state.ok_blocks = ['s1','s2','s3','s4','s5','s6'].reduce((acc,k)=> acc + (state.sections[k]?.status==='OK' ? 1:0), 0);
state.coverage_pct = Math.round((state.ok_blocks/6)*100);
state.standard_met = (state.coverage_pct >= 95) && (state.duration_sec <= 600);
return state;
}
function br_render(state){
if (!state) return;
document.getElementById('br-date').value = state.date_iso || br_todayISO();
['06:00','14:00','22:00'].forEach(v=>{
const el = document.querySelector(`input[name="br-shift"][value="${v}"]`);
if (el) el.checked = (state.shift === v);
});
document.getElementById('br-supervisor').value = state.supervisor || '';
document.getElementById('br-duration').value = br_fmtMMSS(state.duration_sec||0);
document.getElementById('br-attendance').value = (state.attendance_pct ?? '');

Object.entries(state.sections || {}).forEach(([key, sec])=>{
const host = document.querySelector(`#briefing-sections .br-section[data-key="${key}"]`);
if (!host) return;
if (sec.status){
const radio = host.querySelector(`.br-status input[value="${sec.status}"]`);
if (radio) radio.checked = true;
}
host.querySelectorAll('.br-status .opt').forEach(l=>{
const val = l.getAttribute('data-v');
l.classList.toggle('on', val === sec.status);
});
Object.entries(sec.criteria || {}).forEach(([ck, val])=>{
const chk = host.querySelector(`.br-criteria [data-c="${ck}"]`);
if (chk) chk.checked = !!val;
});
const notes = host.querySelector('[data-notes]');
if (notes) notes.value = sec.notes || '';
});

document.getElementById('br-ok').textContent = state.ok_blocks ?? 0;
document.getElementById('br-cov').textContent = `${state.coverage_pct ?? 0}%`;
document.getElementById('br-std').textContent = (state.standard_met ? 'Sí' : 'No');
}
function br_applyRosterHint(roster){
const hint = document.getElementById('br-roster-hint');
if (!hint) return;
const count = Array.isArray(roster?.people) ? roster.people.length : 0;
const shift = roster?.shift || '';
if (count){ hint.textContent = `Roster actual: ${count} personas • Turno: ${shift}`; }
else { hint.textContent = 'Roster no disponible.'; }
// Preselección de turno según ventana
const w = roster?.window;
const from = w?.from;
if (from && ['06:00','14:00','22:00'].includes(from)){
const el = document.querySelector(`input[name="br-shift"][value="${from}"]`);
if (el) el.checked = true;
}
}
async function br_fetchRoster(){
try{
const r = await fetch('/api/roster/current',{cache:'no-store'});
if (!r.ok) return;
const data = await r.json();
br_applyRosterHint(data);
}catch{}
}

async function br_saveToServer(){
const state = br_collect();
br_save(state);
try{
const r = await fetch('/api/briefing', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(state) });
if (r.ok){
const hint = document.getElementById('briefing-save-hint');
hint.textContent = `Guardado en servidor: ${new Date().toLocaleString('es-ES')}`;
}
}catch{}
}

function initBriefing(){
// Si esta vista solo tiene el checklist compacto, salimos y evitamos errores
if (!document.getElementById('br-date')) return;// eventos
// status chips
document.querySelectorAll('#briefing-sections .br-status .opt').forEach(lbl=>{
lbl.addEventListener('click', ()=>{
const val = lbl.getAttribute('data-v');
const host = lbl.closest('.br-section');
const radio = host?.querySelector(`.br-status input[value="${val}"]`);
if (radio){ radio.checked = true; }
host?.querySelectorAll('.br-status .opt').forEach(l=> l.classList.toggle('on', l === lbl));
br_render(br_collect()); br_save(br_collect());
});
});
// inputs que recalculan
['br-date','br-supervisor','br-duration','br-attendance'].forEach(id=>{
const el = document.getElementById(id);
el?.addEventListener('input', ()=>{ br_render(br_collect()); br_save(br_collect()); });
});
document.querySelectorAll('#briefing-sections input, #briefing-sections textarea').forEach(el=>{
el.addEventListener('input', ()=>{ br_render(br_collect()); br_save(br_collect()); });
el.addEventListener('change', ()=>{ br_render(br_collect()); br_save(br_collect()); });
});

// copiar del cronómetro
document.getElementById('br-copy-timer')?.addEventListener('click', ()=>{
const t = document.getElementById('timer-display')?.textContent || '00:00:00';
const sec = br_parseTimerText(t);
document.getElementById('br-duration').value = br_fmtMMSS(sec);
br_render(br_collect()); br_save(br_collect());
});

// guardar servidor / imprimir
document.getElementById('br-save')?.addEventListener('click', br_saveToServer);
document.getElementById('br-print')?.addEventListener('click', ()=> window.print());

// primer estado
const state = br_load() || { date_iso: br_todayISO(), shift:'', supervisor:'', duration_sec:0, attendance_pct:null, sections:{} , ok_blocks:0, coverage_pct:0, standard_met:false };
br_render(state);
br_fetchRoster();
}

(function(){
const host=document.getElementById('brief-check'); if(!host) return;
const meta=host.querySelector('#brief-check-meta');
const KEY='brief_check_v1';

function save(){
const data={};
host.querySelectorAll('.check-actions input:checked').forEach(i=>data[i.name]=i.value);
try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch{}
}
function load(){
try{
const data=JSON.parse(localStorage.getItem(KEY)||'{}');
Object.entries(data).forEach(([n,v])=>{
const el=host.querySelector(`input[name="${n}"][value="${v}"]`);
if(el) el.checked=true;
});
}catch{}
}
function recalc(){
const groups=[...new Set([...host.querySelectorAll('.check-actions input')].map(i=>i.name))];
const ok=groups.filter(n=>{
const sel=host.querySelector(`input[name="${n}"]:checked`);
return sel && sel.value==='OK';
}).length;
if(meta) meta.textContent=`Bloques OK: ${ok} / ${groups.length} · Cobertura: ${groups.length?Math.round(ok/groups.length*100):0}%`;
}

function bump(){            // ← NUEVO: centraliza el refresco
save(); recalc();
updateSpotlightRouting?.();  // ← NUEVO: recalcula el parpadeo
}

load(); 
recalc();
updateSpotlightRouting?.();    // ← NUEVO: al iniciar, ajusta el foco

host.addEventListener('change', e=>{
if(e.target.matches('.check-actions input')) bump();
});
host.addEventListener('input', e=>{          // ← NUEVO: por si ‘change’ no dispara en iOS/Safari
if(e.target.matches('.check-actions input')) bump();
});
})();


/* ===== Fecha/Hora y Turno automático ===== */
function computeShift(d=new Date()){
const m = d.getHours()*60 + d.getMinutes();
// Mañana 06:00–14:00, Tarde 14:00–22:00, Noche 22:00–06:00
if (m >= 360 && m < 840)   return { name:'Mañana', from:'06:00', to:'14:00' };
if (m >= 840 && m < 1320)  return { name:'Tarde',  from:'14:00', to:'22:00' };
return { name:'Noche', from:'22:00', to:'06:00' };
}

/* ===== Reset checklist al cambiar de turno ===== */
const SHIFT_NAME_KEY = 'shift_name_v1';

function resetBriefChecklistTo(val='NO'){
const host = document.getElementById('brief-check');
if (!host) return;

// Detecta los grupos (c1..c6) y marca el valor indicado
const groups = [...new Set([...host.querySelectorAll('.check-actions input')].map(i=>i.name))];
groups.forEach(n=>{
const target = host.querySelector(`input[name="${n}"][value="${val}"]`);
if (target){
target.checked = true;
// Dispara 'change' para que se guarde y refresque meta/spotlight
target.dispatchEvent(new Event('change', { bubbles:true }));
}
});

// Persistencia rápida (opcional, por si el listener no estuviera)
try{
const data = Object.fromEntries(groups.map(n => [n, val]));
localStorage.setItem('brief_check_v1', JSON.stringify(data));
}catch{}

// Recalcula el foco de parpadeo
updateSpotlightRouting?.();
}

function paintDateTimeAndShift(){
const now = new Date();
const dt = now.toLocaleString('es-ES', {
weekday:'long', day:'2-digit', month:'long', year:'numeric',
hour:'2-digit', minute:'2-digit'
});
const headEl = document.getElementById('now-header');
if (headEl) headEl.textContent = dt;

const shift = computeShift(now);
const paintBadge = (el) => {
  if (!el) return;
  el.textContent = `Turno: ${shift.name} (${shift.from}–${shift.to})`;
  el.setAttribute('data-shift', shift.name);
};
paintBadge(document.getElementById('shift-badge'));         // checklist
paintBadge(document.getElementById('shift-badge-header'));  // header
  // Refresca tips si cambió el día
  const lastTipsKey = 'sec_tips_last_date_v1';
  try {
    const today = now.toISOString().slice(0,10);
    const last = localStorage.getItem(lastTipsKey);
    if (last !== today){
      renderDailySecurityTips();
      localStorage.setItem(lastTipsKey, today);
    }
  } catch {}

}


function initDateTimeAndShift(){
// pinta ya
paintDateTimeAndShift();
// sincroniza al siguiente minuto y luego cada minuto
const now = new Date();
const msToNextMin = (60 - now.getSeconds())*1000 - now.getMilliseconds();
setTimeout(()=>{ paintDateTimeAndShift(); setInterval(paintDateTimeAndShift, 60000); }, Math.max(0, msToNextMin));
}

/* ===== Actualizaciones Operativas (v3, limpio y unificado) ===== */
(function(){
  const OPS_KEY = 'ops_updates_v3';
  const STATION = (window.STATION_CODE || 'MAD');

  const $ = (id)=>document.getElementById(id);
  const wrap = $('ops-updates-widget');
  if (!wrap) return;

  const els = {
    list: $('ops-list'),
    search: $('ops-search'),
    fPrio: $('ops-filter-prio'),
    fScope: $('ops-filter-scope'),
    add: $('ops-add'),
    exportTxt: $('ops-export-txt'),
    exportCsv: $('ops-export-csv'),
    badgePend: $('ops-badge-pend'),
    dlg: $('ops-dialog'),
    form: $('ops-form'),
    id: $('ops-id'),
    title: $('ops-title'),
    impact: $('ops-impact'),
    scope: $('ops-scope'),
    assignee: $('ops-assignee'),
    vFrom: $('ops-valid-from'),
    vTo: $('ops-valid-to'),
    reqAck: $('ops-require-ack'),
    save: $('ops-save'),
  };

  const rank = {Alto:0, Medio:1, Bajo:2};
  const defaultScopes = ['General','Isla','Dorada','Muelle Imp','Muelle Exp','Import','Export'];

  function load(){ try{ return JSON.parse(localStorage.getItem(OPS_KEY)||'[]'); }catch{ return []; } }
  function save(list){ try{ localStorage.setItem(OPS_KEY, JSON.stringify(list)); }catch{} }

  // Migración simple desde claves antiguas si existieran
  (function migrate(){
    if (localStorage.getItem('OPS_SECTIONS_KEY')) localStorage.removeItem('OPS_SECTIONS_KEY');
    const v2 = localStorage.getItem('ops_updates_v2');
    if (v2 && !localStorage.getItem(OPS_KEY)) localStorage.setItem(OPS_KEY, v2);
  })();

  function uid(){ return 'op_' + Math.random().toString(36).slice(2,9); }
  function nowISO(){ return new Date().toISOString(); }
  function sameDay(a,b){ return a && b && a.slice(0,10) === b.slice(0,10); }

  function ackProgress(it){
    const names = (window.TEAM_STATE?.people || []).map(p => p.nombre_completo).filter(Boolean);
    const present = names.filter(n => (window.TEAM_STATE?.attendance||{})[n] === true);
    const universe = present.length ? present : names;
    const acks = Object.keys(it.acks||{});
    const count = acks.filter(n => universe.includes(n)).length;
    const total = universe.length || 0;
    const pct = total ? Math.round(count*100/total) : 0;
    return {count,total,pct, universe};
  }

  function isExpired(it){
    if (!it.valid_to) return false;
    const d = new Date(it.valid_to);
    return !isNaN(d) && d < new Date();
  }
  function isStale(it){
    if (!it.valid_from) return false;
    const d = new Date(it.valid_from);
    if (isNaN(d)) return false;
    const days = Math.floor((Date.now() - d.getTime())/86400000);
    const done = ackProgress(it).pct === 100;
    return days >= 7 && (!it.require_ack || done);
  }

  function normalizeText(s){ return String(s||'').toLowerCase(); }

  function render(){
    const list = load().filter(x => !x.station || x.station === STATION);

    // Filtros
    const q = normalizeText(els.search?.value||'');
    const fImp = els.fPrio?.value || '';
    const fScope = els.fScope?.value || '';
    const filtered = list.filter(it => {
      const txt = [it.title,it.scope,it.assignee].map(normalizeText).join(' ');
      const okQ = !q || txt.includes(q);
      const okI = !fImp || it.impact === fImp;
      const okS = !fScope || it.scope === fScope;
      return okQ && okI && okS;
    });

    // Orden: fijados > impacto > fecha
    filtered.sort((a,b)=>{
      if ((b.pinned|0) - (a.pinned|0)) return 1*((b.pinned|0)-(a.pinned|0));
      const ri = (rank[a.impact]??9) - (rank[b.impact]??9);
      if (ri) return ri;
      return (new Date(b.ts||0)) - (new Date(a.ts||0));
    });

    els.list.innerHTML = '';
    let pend = 0;

    filtered.forEach(it=>{
      const expired = isExpired(it);
      const stale = isStale(it);
      const ack = ackProgress(it);
      const needs = it.require_ack && ack.pct < 100 && !expired;
      if (needs) pend++;

      const item = document.createElement('div');
      item.className = 'ops-item' + (expired?' ops-expired': stale?' ops-stale':'');
      item.dataset.id = it.id;
      item.innerHTML = `
        <div class="ops-head">
          <div class="ops-title">${esc(it.title||'')}</div>
          <div class="ops-flags">
            <span class="ops-impact ${esc(it.impact||'')}">${esc(it.impact||'—')}</span>
            <span class="ops-scope">${esc(it.scope||'General')}</span>
          </div>
        </div>
        <div class="ops-meta">
          <span>Alta: ${it.ts ? new Date(it.ts).toLocaleString('es-ES') : '—'}</span>
          ${it.valid_from ? `<span>Vigente desde: ${new Date(it.valid_from).toLocaleDateString('es-ES')}</span>`:''}
          ${it.valid_to   ? `<span>Hasta: ${new Date(it.valid_to).toLocaleDateString('es-ES')}</span>`:''}
          ${it.assignee   ? `<span>Resp.: ${esc(it.assignee)}</span>`:''}
          ${it.require_ack? `<span>Requiere acuse</span>`:''}
        </div>
        ${it.require_ack ? `
        <div class="ops-ack">
          <div class="ops-ack-bar" title="${ack.count}/${ack.total}">
            <span style="width:${ack.pct}%;"></span>
          </div>
          <strong>${ack.pct}%</strong>
          <button class="ops-btn ops-ack-manage" type="button">Gestionar acuses</button>
        </div>`:''}
        <div class="ops-actions">
          <button class="ops-btn ops-edit" type="button">Editar</button>
          <button class="ops-btn ops-pin ${it.pinned?'on':''}" type="button">${it.pinned?'Fijado':'Fijar'}</button>
          <button class="ops-btn ops-delete" type="button" style="color:#991b1b;">Eliminar</button>
        </div>
      `;
      els.list.appendChild(item);
    });

    // meta badge
    if (els.badgePend){
      els.badgePend.style.display = pend ? '' : 'none';
      els.badgePend.textContent = `${pend} pendientes`;
    }
  }

  // —— CRUD helpers —— //
  function openDialog(edit=null){
    if (edit){
      els.id.value = edit.id;
      els.title.value = edit.title || '';
      els.impact.value = edit.impact || 'Medio';
      els.scope.value = defaultScopes.includes(edit.scope) ? edit.scope : 'General';
      els.assignee.value = edit.assignee || '';
      els.vFrom.value = edit.valid_from || '';
      els.vTo.value = edit.valid_to || '';
      els.reqAck.checked = !!edit.require_ack;
    } else {
      els.id.value = '';
      els.title.value = '';
      els.impact.value = 'Medio';
      els.scope.value = 'General';
      els.assignee.value = '';
      els.vFrom.value = '';
      els.vTo.value = '';
      els.reqAck.checked = false;
    }
    els.dlg.showModal();
  }

  function upsertFromDialog(){
    const id = els.id.value || uid();
    const it = {
      id,
      title: (els.title.value||'').trim(),
      impact: els.impact.value,
      scope: els.scope.value || 'General',
      assignee: (els.assignee.value||'').trim() || null,
      valid_from: els.vFrom.value || null,
      valid_to: els.vTo.value || null,
      require_ack: !!els.reqAck.checked,
      acks: {},                     // se respeta al editar si existe
      station: STATION,
      ts: nowISO(),
      pinned: false,
    };
    if (!it.title) return false;

    const list = load();
    const i = list.findIndex(x => x.id === id);
    if (i >= 0){
      // conservar acks y pin
      it.acks = list[i].acks || {};
      it.pinned = !!list[i].pinned;
      list[i] = it;
    } else {
      list.push(it);
    }
    save(list);
    return true;
  }

  // —— Eventos globales —— //
  els.add?.addEventListener('click', ()=> openDialog());
  els.form?.addEventListener('close', ()=> render());
  els.save?.addEventListener('click', (e)=>{
    e.preventDefault();
    if (upsertFromDialog()) els.dlg.close();
  });

  // Filtros
  [els.search, els.fPrio, els.fScope].forEach(el=>{
    el?.addEventListener('input', render);
    el?.addEventListener('change', render);
  });

  // Delegación de acciones en la lista
  els.list?.addEventListener('click', (e)=>{
    const row = e.target.closest('.ops-item'); if (!row) return;
    const id = row.dataset.id;
    const list = load();
    const idx = list.findIndex(x => x.id === id);
    if (idx < 0) return;

    if (e.target.closest('.ops-edit')){
      openDialog(list[idx]);
      return;
    }
    if (e.target.closest('.ops-pin')){
      list[idx].pinned = !list[idx].pinned;
      save(list); render(); return;
    }
    if (e.target.closest('.ops-delete')){
      if (!confirm('¿Eliminar la actualización?')) return;
      list.splice(idx,1); save(list); render(); return;
    }
    if (e.target.closest('.ops-ack-manage')){
      // panel inline de acuses
      const it = list[idx];
      const ackId = 'ack-panel-' + id;
      let panel = row.querySelector('#'+ackId);
      if (panel){ panel.remove(); return; }

      const {universe} = ackProgress(it);
      panel = document.createElement('div');
      panel.id = ackId;
      panel.style.cssText = 'margin-top:6px;border:1px solid var(--border);border-radius:10px;padding:8px;';
      panel.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <strong>Acuses del turno (${universe.length})</strong>
          <div style="display:flex;gap:6px;">
            <button class="ops-btn ack-all" type="button">Marcar todos</button>
            <button class="ops-btn ack-none" type="button">Quitar todos</button>
          </div>
        </div>
        <div class="ack-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:6px;max-height:220px;overflow:auto;"></div>
      `;
      row.appendChild(panel);

      const grid = panel.querySelector('.ack-grid');
      universe.forEach(n=>{
        const chk = document.createElement('label');
        chk.style.cssText = 'display:flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff;';
        const checked = !!(it.acks||{})[n];
        chk.innerHTML = `<input type="checkbox" ${checked?'checked':''} data-name="${esc(n)}"> <span>${esc(n)}</span>`;
        grid.appendChild(chk);
      });

      panel.querySelector('.ack-all')?.addEventListener('click', ()=>{
        it.acks = {}; universe.forEach(n => it.acks[n] = true);
        save(list); render();
      });
      panel.querySelector('.ack-none')?.addEventListener('click', ()=>{
        it.acks = {}; save(list); render();
      });
      grid.addEventListener('change', (ev)=>{
        const inp = ev.target.closest('input[type="checkbox"]'); if (!inp) return;
        const name = inp.getAttribute('data-name');
        it.acks = it.acks || {};
        if (inp.checked) it.acks[name] = true; else delete it.acks[name];
        save(list); render();
      });

      return;
    }
  });

  // —— Exportaciones —— //
  els.exportTxt?.addEventListener('click', async ()=>{
    const list = load().filter(x => !x.station || x.station === STATION);
    const lines = list.map(it=>{
      const f = it.valid_from ? new Date(it.valid_from).toLocaleDateString('es-ES') : '';
      const t = it.valid_to   ? new Date(it.valid_to).toLocaleDateString('es-ES')   : '';
      const sign = it.impact==='Alto'?'‼️': it.impact==='Medio'?'❗':'•';
      return `${sign} ${it.title} [${it.scope}] ${f&&t?`(${f}→${t})`:''} ${it.assignee?`• Resp: ${it.assignee}`:''}`;
    });
    const txt = lines.join('\n') || '—';
    try{
      await navigator.clipboard.writeText(txt);
      alert('Resumen copiado al portapapeles');
    }catch{
      const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      alert('Resumen copiado');
    }
  });

  els.exportCsv?.addEventListener('click', ()=>{
    const list = load().filter(x => !x.station || x.station === STATION);
    const header = ['id','title','impact','scope','assignee','valid_from','valid_to','require_ack','pinned','created_at','station'];
    const rows = list.map(it => [
      it.id, it.title, it.impact, it.scope, it.assignee||'',
      it.valid_from||'', it.valid_to||'',
      it.require_ack?1:0, it.pinned?1:0, it.ts||'', it.station||''
    ]);
    const csv = [header, ...rows].map(r=>r.map(v=>{
      const s = String(v??'');
      return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(';')).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ops_updates_${STATION}_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Primer render y reactivo a cambios de roster (para % acuses)
  render();
  // Si usas WebSocket y haces update del roster, re-rendera:
  window.addEventListener('team_roster_updated', render);
})();


/* ===== Seguridad: tips diarios automáticos (2/día) ===== */
const SECURITY_TIPS = [
  "Temas de seguridad de actualidad (noticias, redes sociales, cambios de nivel de amenaza, etc.).",
  "Incidentes o no conformidades en tu estación u otras.",
  "Resultados de auditorías (aerolíneas, autoridades, autoauditorías).",
  "Próximas auditorías o visitas.",
  "Mantener puertas cerradas cuando no se usen.",
  "Reportar comportamientos sospechosos.",
  "Retar a personas sin acreditación o acompañamiento.",
  "Acompañar a todos los visitantes en todo momento.",
  "Llevar chaleco de alta visibilidad en almacén y zona aire.",
  "Saber dónde están los contactos de emergencia.",
  "Segregar carga segura e insegura.",
  "Revisar signos de manipulación en paquetes.",
  "Llevar la acreditación visible en todo momento.",
  "No llevar mochilas ni bolsas a zonas seguras.",
  "Guardar cintas, precintos y elementos de seguridad de forma segura.",
  "No permitir el acceso de personas no autorizadas.",
  "Preguntar si no se conoce un procedimiento.",
  "No dar información de seguridad a externos.",
  "No permitir personas no autorizadas cerca de carga segura.",
  "No saltarse procedimientos.",
  "Si una carga no es segura, no cargarla y revisarla.",
  "Leer todos los avisos de seguridad y pedir aclaraciones.",
  "Si ves algo, dilo.",
  "Informar si las normas no son prácticas o seguras.",
  "Escalar errores o riesgos de seguridad a la dirección.",
  "Mantener la información sensible segura.",
  "Cumplir siempre las normas y procedimientos de seguridad.",
  "No seguir instrucciones que comprometan la seguridad.",
  "No cargar mercancía con etiquetas de parada o retención.",
  "Animar a los compañeros a cumplir las normas.",
  "Revisar la validez de la acreditación y avisar si va a caducar.",
  "Si no sabes, pregunta; si sabes, enseña.",
  "Pensar en las consecuencias de no cumplir las normas.",
  "Identificar a la persona con la que hablas.",
  "Comparar la foto de la acreditación con la persona.",
  "Registrar entrada y salida de visitantes.",
  "Si ves conductores deambulando, indícale la zona designada.",
  "Mantener puertas de zona aire cerradas.",
  "No interferir con los controles de seguridad.",
  "Al controlar, centrarse en la tarea.",
  "Rechazar o revisar carga dañada.",
  "No aceptar carga sin identificación o documentación.",
  "Revisar que los camiones estén sellados.",
  "Comprobar la identificación de quien recoge la carga.",
  "Contar todas las piezas de un envío.",
  "Comparar el nombre del visitante con el registro.",
  "Comprobar la validez en bases de datos oficiales.",
  "Verificar acuerdos de subcontratistas.",
  "No prestar acreditaciones.",
  "Avisar si se pierde la acreditación.",
  "Comprobar identificación y estatus en cada ocasión.",
  "No permitir acceso no autorizado a zonas restringidas.",
  "Asistir y prestar atención a la reunión de turno.",
  "Presentar la acreditación en lectores de proximidad.",
  "Informar de errores a supervisores.",
  "Todos pueden pulsar el botón de parada de emergencia por seguridad.",
  "Mejor prevenir que curar.",
  "Cooperar en los controles de seguridad.",
  "Avisar si algo no parece correcto.",
  "No manipular ni poner en riesgo sistemas de seguridad.",
  "Sospechar de precintos diferentes en paquetes.",
  "Las fechas límite no justifican saltarse la seguridad.",
  "Dejar trabajar a los perros de seguridad.",
  "Asegurarse de que la carga ha sido revisada.",
  "La seguridad es responsabilidad de todos.",
  "Informar de puertas, ventanas o vallas dañadas.",
  "Retar a desconocidos en el almacén.",
  "Ayudar a los controladores en el escaneo de envíos.",
  "Usar cinta de seguridad para cerrar paquetes revisados.",
  "Usar sellos correctos para indicar el estado de seguridad.",
  "Llamar a la policía si es necesario.",
  "Leer los boletines de seguridad y pedir aclaraciones.",
  "Ayudar a nuevos empleados a cumplir las normas.",
  "Informar de daños en carga, puertas, ventanas, señalización.",
  "Transferir la carga segura inmediatamente a la zona segura.",
  "Guardar carga valiosa en áreas designadas y bajo CCTV.",
  "Asegurarse de que los visitantes devuelvan su acreditación.",
  "Dejar pertenencias personales en la taquilla.",
  "No entregar carga a conductores no autorizados.",
  "Comprobar que los controles de seguridad estén registrados.",
  "Asegurarse de que los archivos de vuelo estén completos.",
  "Comprobar que cada envío tenga el CSD correcto.",
  "La seguridad es para proteger a todos, incluidos tus seres queridos.",
  "Todos deben estar formados según su función.",
  "Adaptar los procedimientos a la seguridad, no al revés.",
  "No tomar fotos en zonas seguras.",
  "No publicar información de seguridad en redes sociales.",
  "No permitir que los clientes decidan el método de control.",
  "No permitir que clientes/conductores usen baños sin acompañamiento.",
  "Mantener cerradas las puertas de zonas restringidas.",
  "Informar siempre de carga dañada.",
  "Informar de carga manipulada o posible robo.",
  "Informar de comportamientos extraños de compañeros.",
  "Conocer el cartel de “whistle blower”.",
  "Concienciación sobre amenazas internas.",
  "No asumir riesgos innecesarios con la seguridad.",
  "No dejar carga segura desatendida fuera de la instalación.",
  "Mantenerse siempre alerta.",
  "No dejar puertas abiertas sin vigilancia.",
  "No compartir procesos de seguridad del sector.",
  "La seguridad es tu responsabilidad."
];

// hash determinista sencillo a partir de la fecha YYYY-MM-DD
function hashDateSeed(dateStr){
  let h = 2166136261; // FNV-1a base
  for (let i=0;i<dateStr.length;i++){
    h ^= dateStr.charCodeAt(i);
    h = (h * 16777619) >>> 0;
  }
  return h >>> 0;
}

// Selecciona N tips distintos de forma determinista por día
function getDailySecurityTips(n=2, d=new Date()){
  const dateStr = d.toISOString().slice(0,10); // YYYY-MM-DD
  const seed = hashDateSeed(dateStr);
  const L = SECURITY_TIPS.length;
  if (L === 0) return [];

  // dos índices distintos basados en el seed (sin necesidad de localStorage)
  const i1 = seed % L;
  let i2 = (seed * 1103515245 + 12345) % L;  // LCG simple
  if (i2 === i1) i2 = (i2 + 1) % L;

  const picks = [SECURITY_TIPS[i1], SECURITY_TIPS[i2]];
  return picks.slice(0, Math.min(n, picks.length));
}

function renderDailySecurityTips(){
  const host = document.getElementById('sec-daily-tips');
  if (!host) return;
  const tips = getDailySecurityTips(2, new Date());
  if (!tips.length){
    host.innerHTML = '';
    return;
  }
  host.innerHTML = `
    <div class="sec-item" role="note" aria-label="Recordatorios diarios de seguridad">
      <div style="font-weight:700">Recordatorio diario de seguridad</div>
      <ul style="margin:0; padding-left:18px;">
        ${tips.map(t => `<li>${t}</li>`).join('')}
      </ul>
      <div class="meta-row"><span class="badge">Fecha: ${new Date().toLocaleDateString('es-ES')}</span></div>
    </div>
  `;
}


/* ===== Seguridad y protección (estado rápido + notas) ===== */
const SEC_KEY = 'seguridad_state_v1';
function sec_load(){ try{ return JSON.parse(localStorage.getItem(SEC_KEY)||'{"risks":{}}'); }catch{ return {risks:{}}; } }
function sec_save(s){ try{ localStorage.setItem(SEC_KEY, JSON.stringify(s)); }catch{} }

function sec_render(){
  const state = sec_load();
  // pinta toggles
  document.querySelectorAll('#seguridad-widget .risk-pill').forEach(btn=>{
    const k = btn.dataset.risk;
    btn.classList.toggle('on', !!state.risks?.[k]);
  });
  // pinta nota
  const note = document.getElementById('sec-note');
  if(note && typeof state.note === 'string') note.value = state.note;

  // listado histórico mínimo (si quieres ver marcas)
  const list = document.getElementById('sec-list');
  const meta = document.getElementById('sec-meta');
  if(list){
    list.innerHTML = '';
    const active = Object.entries(state.risks||{}).filter(([,v])=>v).map(([k])=>k);
    if(active.length){
      const el = document.createElement('div');
      el.className = 'sec-item';
      el.innerHTML = `
        <div style="font-weight:700">Riesgos activos del turno</div>
        <div class="meta-row">${active.map(k=>`<span class="badge">${esc(k)}</span>`).join(' ')}</div>`;
      list.appendChild(el);
    }
    if(meta) meta.textContent = `Riesgos activos: ${active.length} • Actualizado: ${new Date().toLocaleString('es-ES')}`;
  }
}

(function initSeguridad(){
  const host = document.getElementById('seguridad-widget');
  if(!host) return;

  // toggles
  host.addEventListener('click', async (e)=>{
    const pill = e.target.closest('.risk-pill');
    if(!pill) return;
    const st = sec_load();
    const k  = pill.dataset.risk;
    st.risks = st.risks || {};
    st.risks[k] = !st.risks[k];
    st.ts = Date.now();
    sec_save(st);
    // opcional backend:
    try{
      await fetch('/api/security/state', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ station: STATION_CODE, risks: st.risks, timestamp: new Date().toISOString() })
      }).catch(()=>{});
    }catch{}
    sec_render();
    renderDailySecurityTips();
  });

  // nota
  const note = document.getElementById('sec-note');
  note?.addEventListener('input', ()=>{
    const st = sec_load();
    st.note = note.value || '';
    st.ts = Date.now();
    sec_save(st);
  });

  sec_render();
})();

/* ===== Unión Checklist → Widgets (spotlight) ===== */
function rosterComplete(){
const total = (TEAM_STATE?.people || []).length;
if (!total) return false;
const att = TEAM_STATE?.attendance || {};
// Completo cuando cada persona tiene true/false (no undefined)
return TEAM_STATE.people.every(p => {
const k = p.nombre_completo || '—';
return att[k] === true || att[k] === false;
});
}

function readC(name){
const sel = document.querySelector(`#brief-check input[name="${name}"]:checked`);
return sel ? sel.value : null;
}
function setSpotlight(ids){
  const ALL = [
    'team-widget',
    'prev-shift-widget',
    'rotativas-widget',   // 5S & GW
    'incidentes-widget',
    'kanban-widget',
    'kpi-center',         // KPIs operativos (centro)
    'kpi-costes'          // costes (derecha-centro)
  ];
  ALL.forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('spotlight-blink', ids.includes(id));
  });
}

function updateSpotlightRouting(){
  if (!rosterComplete()) return setSpotlight(['team-widget']);
  if (readC('c1') !== 'OK') return setSpotlight(['prev-shift-widget']);
  if (readC('c2') !== 'OK') return setSpotlight(['ops-updates-widget']);
  if (readC('c3') !== 'OK') return setSpotlight(['team-widget']);
  if (readC('c4') !== 'OK') return setSpotlight(['seguridad-widget']);
  if (readC('c5') !== 'OK') return setSpotlight(['incidentes-widget']);
  if (readC('c6') !== 'OK') return setSpotlight(['kpi-center','kpi-costes']);
  if (readC('c7') !== 'OK') return setSpotlight(['kanban-widget']);
  setSpotlight([]);
}

window.updateSpotlightRouting = updateSpotlightRouting;  // acceso global

(function initBriefExplain(){
  const host   = document.getElementById('brief-check');
  if (!host) return;

  const targetText = host.querySelector('#brief-check-explain .br-explain-text');
  const DEFAULT_MSG = 'Pasa el ratón por cada punto para ver una explicación.';

  const setText = (t)=> {
    if (targetText) targetText.textContent = t || DEFAULT_MSG;
  };

  host.querySelectorAll('.check-card').forEach(card => {
    const msg =
      card.getAttribute('data-help') ||
      card.querySelector('.check-title')?.textContent ||
      '';
    // Soportar tanto data-target como el posible typo data-targer
    const targetId =
      card.getAttribute('data-target') ||
      card.getAttribute('data-targer') ||
      '';

    // Hover / foco: texto explicativo
    card.addEventListener('mouseenter', ()=> setText(msg));
    card.addEventListener('mouseleave', ()=> setText());
    card.addEventListener('focusin',    ()=> setText(msg));
    card.addEventListener('focusout',   ()=> setText());

    // Click en la tarjeta → abrir widget en fullscreen
    card.addEventListener('click', (e)=>{
      // No interceptar clics en radios/labels
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'LABEL') return;
      if (targetId) {
        e.preventDefault();
        openWidgetFromChecklist(targetId);
      }
    });

    // Teclado: Enter o Space con foco en la tarjeta
    card.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ' ') {
        if (targetId) {
          e.preventDefault();
          openWidgetFromChecklist(targetId);
        }
      }
    });
  });

  setText();
})();

function updateFiixDisplay(metric, value) {
    const mapping = {
        'fiix_wfs4_availability': 'fiix-availability',
        'fiix_wfs4_damage_count_24h': 'fiix-damage-24h'
    };

    if (metric === 'fiix_wfs4_broken_text') {
        const el = document.getElementById('fiix-broken-text');
        if (el) {
            el.textContent = value;
            if (value.includes('⚠️')) {
                el.style.color = "#dc2626"; // Rojo alerta
                el.style.fontWeight = "800";
            }
        }
        return;
    }

    const targetId = mapping[metric];
    const el = document.getElementById(targetId);
    if (el) {
        el.textContent = value;
        // WFS4: Si disponibilidad < 95%, parpadeo crítico (Spotlight)
        if (metric === 'fiix_wfs4_availability') {
            const tile = el.closest('.kpi-tile');
            if (value < 95) tile.classList.add('spotlight-blink');
            else tile.classList.remove('spotlight-blink');
        }
    }
}

// 2. CARGA AUTOMÁTICA (Igual que el Roster)
async function initFiixDashboard() {
    try {
        // Obtenemos la ruta base para no fallar en sub-apps (/mad/n4/ops/...)
        const res = await fetch('api/fiix/current'); 
        const data = await res.json();
        
        console.log("📥 Fiix Snapshot cargado:", data);

        // Pintamos todo lo que ha llegado
        Object.keys(data).forEach(metricName => {
            updateFiixDisplay(metricName, data[metricName]);
        });
    } catch (e) {
        console.error("❌ Error cargando Fiix al inicio:", e);
    }
}

  
/* Init */
/* =========================================================
   4. INICIALIZACIÓN FINAL (CORREGIDA)
   ========================================================= */
document.addEventListener('DOMContentLoaded', () => {
    const btnResumen = document.querySelector('header .header-controls .btn-primary');
    if (btnResumen) btnResumen.onclick = generateAndSendToExcel;

    // LLAMADAS CRÍTICAS
    try { initDateTimeAndShift(); } catch(e){}
    try { initHeaderTimer(); } catch(e){}
    try { setupEventListeners(); } catch(e){} 
    try { makeColumnsSortable(); } catch(e){}
    try { hydrateKpiTotalCost(); } catch(e){}
    try { loadBoardsInitial(); } catch(e){}
    try { loadIncidentes(); } catch(e){}
    try { connectWebSocket(); } catch(e){}
    try { initTeamRoster(); } catch(e){}
    try { initFiixDashboard(); } catch(e){}
    try { initEhsSimple(); } catch(e){}
    try { initFullscreenToggles(); } catch(e){}
    try { init5S(); } catch(e){}
    
    // --- ESTAS DOS LÍNEAS SON LAS QUE HACEN QUE FUNCIONE EL + Y EL CHECKLIST ---
    try { initPrevShiftSystem(); } catch(e){ console.error("Error al iniciar Highlights:", e); }
    try { if(window.updateSpotlightRouting) window.updateSpotlightRouting(); } catch(e){}
    
    try { initManualIncidents(); } catch(e){} 
    try { initAutoShiftChange(); } catch(e){} 

    // Voz (Simplificado)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR) {
        const r = new SR(); r.lang = 'es-ES';
        document.body.addEventListener('click', e => {
            const btn = e.target.closest('.btn-mic');
            if(btn) { 
                const target = document.getElementById(btn.dataset.target);
                r.start(); btn.classList.add('listening');
                r.onresult = ev => { target.value += " " + ev.results[0][0].transcript; target.dispatchEvent(new Event('input')); };
                r.onend = () => btn.classList.remove('listening');
            }
        });
    }
});

let weeklyFiixChart = null;

async function renderFiixWeeklyHistory() {
    try {
        const canvas = document.getElementById('fiixWeeklyChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // La ruta es 'api/fiix/history' (tu interceptor la convertirá en /bcn/api/fiix/history)
        const res = await fetch('api/fiix/history'); 
        const data = await res.json();

        if (!data || data.length === 0) {
            console.warn("⚠️ [BCN] Sin datos históricos de Fiix.");
            return;
        }

        if (weeklyFiixChart) weeklyFiixChart.destroy();

        // Estilo Vivid UI: Space Grotesk y Colores de Marca
        weeklyFiixChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.week),
                datasets: [{
                    label: 'Averías de Flota',
                    data: data.map(d => d.count),
                    backgroundColor: '#ef4444', // brand-red-500
                    borderRadius: 8,
                    borderSkipped: false,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: { family: 'Space Grotesk', size: 14 },
                        bodyFont: { family: 'Inter', size: 12 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false },
                        ticks: { 
                            stepSize: 1,
                            font: { family: 'Inter', weight: '600' }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            font: { family: 'Space Grotesk', weight: '700' }
                        }
                    }
                }
            }
        });
    } catch (e) {
        console.error("❌ [BCN] Error renderizando historial:", e);
    }
}

document.addEventListener('DOMContentLoaded', renderFiixWeeklyHistory);
  
/* ===== Protocolo de Incidentes (editable) ===== */
(function initIncidentsProtocol(){
  const FORM_KEY = 'incidents_protocol_v1';
  const form  = document.getElementById('incidents-protocol-form');
  const sEl   = document.getElementById('incidents-protocol-status');
  const note  = document.getElementById('ip-understanding-note');
  const todo  = document.getElementById('ip-what-to-do');
  const cont  = document.getElementById('ip-contacts');
  const tools = document.getElementById('ip-tools-location');
  const banner= document.querySelector('#incidentes-widget .incident-remember');
  const chips = document.querySelector('#incidentes-widget .title-bullets');

  if (!form) return;

  const esc = (s)=> String(s??'').trim();

  function shorten(s, max=50){
    s = esc(s);
    if (s.length <= max) return s;
    return s.slice(0, max-1) + '…';
  }

  function saveLocal(state){
    try { localStorage.setItem(FORM_KEY, JSON.stringify(state)); } catch {}
  }
  function loadLocal(){
    try { return JSON.parse(localStorage.getItem(FORM_KEY)||'null'); } catch { return null; }
  }

  function paint(state){
    if (!state) return;
    if (note)  note.value  = state.understanding_note || '';
    if (todo)  todo.value  = state.what_to_do || '';
    if (cont)  cont.value  = state.contacts || '';
    if (tools) tools.value = state.tools_location || '';

    // Actualiza banner “RECORDAR…”
    if (banner){
      const txt = esc(state.what_to_do);
      banner.textContent = txt ? `RECORDAR: ${txt}` : 'RECORDAR: En caso de accidente…';
      banner.classList.toggle('filled', !!esc(state.what_to_do));

    }
    // Actualiza chips del título con resúmenes
    if (chips){
      chips.innerHTML = `
        <li class="title-chip" title="Qué hacer">${shorten(state.what_to_do || 'Qué hacer')}</li>
        <li class="title-chip" title="A quién avisar">${shorten(state.contacts || 'A quién avisar')}</li>
        <li class="title-chip" title="Herramientas">${shorten(state.tools_location || 'Herramientas')}</li>
        <li class="title-chip" title="Comprensión">${shorten(state.understanding_note || 'Comprensión del procedimiento')}</li>
      `;
    }
    // Pista de guardado
    if (sEl) {
      const when = state.saved_at ? new Date(state.saved_at).toLocaleString('es-ES') : '—';
      sEl.textContent = `Guardado: ${when}`;
    }
  }

  async function pullServer(){
    try{
      const r = await fetch('/api/incidents/protocol', {cache:'no-store'});
      if (!r.ok) return null;
      const data = await r.json();
      if (data && typeof data === 'object') return data;
      return null;
    }catch{ return null; }
  }

  async function pushServer(state){
    try{
      await fetch('/api/incidents/protocol', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(state)
      });
    }catch{/* opcional */}
  }

  function collect(){
    return {
      understanding_note: esc(note?.value),
      what_to_do:         esc(todo?.value),
      contacts:           esc(cont?.value),
      tools_location:     esc(tools?.value),
      station:            (typeof STATION_CODE !== 'undefined' ? STATION_CODE : undefined),
      saved_at:           new Date().toISOString()
    };
  }

  function autosave(){
    const st = collect();
    saveLocal(st);
    paint(st);
    pushServer(st); // opcional: no bloquea
  }

  // Carga inicial: servidor → local → vacío
  (async ()=>{
    const server = await pullServer();
    if (server){
      saveLocal(server);
      paint(server);
      return;
    }
    const cached = loadLocal();
    if (cached){ paint(cached); }
  })();

  // Guardado manual (botón)
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    autosave();
  });

  // Guardado automático (cada cambio)
  [note, todo, cont, tools].forEach(el=>{
    el?.addEventListener('input', ()=> {
      // Debounce ligero
      clearTimeout(el._t);
      el._t = setTimeout(autosave, 300);
    });
  });
})();


// ===== Fecha/Hora y Turno automático =====
function computeShift(d = new Date()){
  const m = d.getHours()*60 + d.getMinutes();
  // Mañana 06:00–14:00, Tarde 14:00–22:00, Noche 22:00–06:00
  if (m >= 360 && m < 840)   return { name:'Mañana', from:'06:00', to:'14:00' };
  if (m >= 840 && m < 1320)  return { name:'Tarde',  from:'14:00', to:'22:00' };
  // Noche cubre dos tramos: [22:00, 24:00) ∪ [00:00, 06:00)
  return { name:'Noche', from:'22:00', to:'06:00' };
}

function paintNowAndShift(){
  const nowEl   = document.getElementById('now-header');
  const badgeEl = document.getElementById('shift-badge') || document.getElementById('shift-badge-header');
  const now = new Date();
  const sh  = computeShift(now);

  if (nowEl)   nowEl.textContent = now.toLocaleString('es-ES', { dateStyle:'full', timeStyle:'short' });
  if (badgeEl){
    badgeEl.textContent = sh.name;
    badgeEl.setAttribute('data-shift', sh.name);
  }
}

function initNowTicker(){
  paintNowAndShift();
  // refresca cada minuto
  setInterval(paintNowAndShift, 60_000);
}

// ===== Inicio global seguro =====
document.addEventListener('DOMContentLoaded', () => {
 
  // UI / accesibilidad
  try { initHeaderTimer?.(); } catch(e){ console.warn('initHeaderTimer', e); }
  try { initFullscreenToggles?.(); } catch(e){ console.warn('initFullscreenToggles', e); }
  initNowTicker();

  // Widgets funcionales
  try { initTeamRoster?.(); } catch(e){ console.warn('initTeamRoster', e); }
  try { makeColumnsSortable?.(); } catch(e){ console.warn('makeColumnsSortable', e); }
  try { setupEventListeners?.(); } catch(e){ console.warn('setupEventListeners', e); }
  try { loadBoardsInitial?.(); } catch(e){ console.warn('loadBoardsInitial', e); }
  try { connectWebSocket?.(); } catch(e){ console.warn('connectWebSocket', e); }
  try { hydrateKpiTotalCost?.(); } catch(e){ console.warn('hydrateKpiTotalCost', e); }
  try { initEhsSimple?.(); } catch(e){ console.warn('initEhsSimple', e); }
  try { init5S?.(); } catch(e){ console.warn('init5S', e); }
});

// ===== Limpieza opcional =====
// Normaliza los nombres de zona en selects existentes (corrige "Muele" -> "Muelle")
document.addEventListener('change', (e) => {
  if (e.target?.classList?.contains('zone-select')) {
    const val = e.target.value;
    if (val === 'Muele Imp') e.target.value = 'Muelle Imp';
    if (val === 'Muele Exp') e.target.value = 'Muelle Exp';
  }
});

/* ========= OPS ultra-simple: CRUD local + render inmediato ========= */


/* ===================== OPS UPDATES (SOLUCIÓN UNIFICADA Y CORREGIDA) ===================== */
(function initOpsUpdates(){
  const LIST   = document.getElementById('ops-list');
  const DIALOG = document.getElementById('ops-dialog');
  const FORM   = document.getElementById('ops-form');
  const BTN_ADD= document.getElementById('ops-add');
  const BTN_SAVE = document.getElementById('ops-save');
  
  // Filtros
  const Q      = document.getElementById('ops-q');
  const FILT_PRIO  = document.getElementById('ops-prio');
  const FILT_SCOPE = document.getElementById('ops-scope');

  // IDENTIDAD DE LA ESTACIÓN (Asegúrate de que coincida con el backend)
  const CURRENT_STATION = (window.STATION_OVERRIDE || 'WFS1ALM').toUpperCase();

  if (!LIST || !DIALOG || !FORM) return;

  async function apiAction(url, method, data=null){
    const opts = { method, headers: {} };
    if(data){
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(data);
    }
    const r = await fetch(url, opts);
    if(method === 'DELETE' && r.status === 404) return true; 
    if(!r.ok) throw new Error(`Error ${method}`);
    return method === 'DELETE' ? True : await r.json();
  }

  // RENDERIZADOR
  window.renderOpsCard = function(it) {
    if(!LIST) return;
    // Si la tarjeta que llega no es de mi estación, la ignoro (Seguridad para WebSocket)
    if (it.station && it.station.toUpperCase() !== CURRENT_STATION) return;

    const existing = document.getElementById(`ops-${it.id}`);
    if (existing) existing.remove();

    const el = document.createElement('div');
    el.className = 'ops-item';
    el.id = `ops-${it.id}`;
    el.dataset.id = it.id;
    
    const impact = it.impact || 'Medio';
    const scope = it.scope || 'General';
    const owner = it.owner || '—';
    const dateStr = it.created_at ? new Date(it.created_at).toLocaleDateString() : '';
    const ackPct = Number(it.ack_pct || 0);

    el.innerHTML = `
      <div class="ops-head">
        <div class="ops-title" style="font-weight:800;">${esc(it.title)}</div>
        <div class="ops-flags">
          <span class="ops-impact ${esc(impact)}">${esc(impact)}</span>
          <span class="ops-scope">${esc(scope)}</span>
        </div>
      </div>
      <div class="ops-meta" style="margin-top:5px; font-size:0.85rem; color:var(--text-muted);">
        <span>Resp: <strong>${esc(owner)}</strong></span>
        <span style="margin-left:auto;">${dateStr}</span>
      </div>
      <div class="ops-actions" style="margin-top:10px; display:flex; gap:8px;">
        <button class="ops-btn" data-action="edit" style="font-size:0.75rem; padding:4px 8px;">Editar</button>
        <button class="ops-btn" data-action="delete" style="color:#b91c1c; font-size:0.75rem; padding:4px 8px;">Eliminar 🗑️</button>
      </div>
    `;
    
    // Insertar arriba (más reciente primero)
    LIST.prepend(el);
  };

  // CARGA INICIAL (Solo lo que pertenece a esta nave)
  async function loadInitial(){
    try {
        // Pedimos al servidor todas las tareas de tipo ops_update
        const items = await (await fetch('api/tasks?task_type=ops_update')).json();
        
        LIST.innerHTML = ''; 
        
        // Filtro estricto: solo muestro lo que sea de mi nave
        const filtered = items.filter(it => (it.station || '').toUpperCase() === CURRENT_STATION);

        if (filtered.length === 0) {
            LIST.innerHTML = '<div style="padding:15px;color:#888;text-align:center;">No hay actualizaciones para esta nave.</div>';
            return;
        }
        
        // Ordenar por fecha y renderizar
        filtered.sort((a,b) => new Date(a.created_at) - new Date(b.created_at)).forEach(window.renderOpsCard);
        
    } catch(e) { console.warn('Error cargando actualizaciones iniciales', e); }
  }

  // EVENTO GUARDAR
  BTN_SAVE?.addEventListener('click', async (e) => {
    e.preventDefault();
    const id = document.getElementById('ops-id').value;
    const payload = {
      task_type: 'ops_update',
      title: document.getElementById('ops-title').value.trim(),
      impact: document.getElementById('ops-impact').value,
      scope: document.getElementById('ops-scope-field').value,
      owner: document.getElementById('ops-owner').value.trim(),
      station: CURRENT_STATION // <--- CLAVE: Se guarda con la identidad de la nave
    };

    if (!payload.title) return alert('El título es obligatorio');
    
    try {
        if (id) {
            await apiAction(`api/tasks/${id}`, 'PATCH', payload);
        } else {
            await apiAction('api/tasks', 'POST', payload);
        }
        closeDialog();
        loadInitial(); // Recargamos para asegurar orden y limpieza
    } catch(err) { alert("Error al conectar con el servidor."); }
  });

  // DELEGACIÓN (EDITAR / BORRAR)
  LIST.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const card = btn.closest('.ops-item');
    const id = card.dataset.id;

    if (btn.dataset.action === 'delete') {
        if(confirm('¿Borrar actualización operativa?')){
            await apiAction(`api/tasks/${id}`, 'DELETE');
            card.remove();
        }
    } else if (btn.dataset.action === 'edit') {
        const title = card.querySelector('.ops-title').textContent;
        const impact = card.querySelector('.ops-impact').textContent.trim();
        const scope = card.querySelector('.ops-scope').textContent.trim();
        const owner = card.querySelector('.ops-meta strong').textContent;
        openDialog({id, title, impact, scope, owner});
    }
  });

  function openDialog(d){
    FORM.reset();
    document.getElementById('ops-id').value = d?.id || '';
    if(d){
        document.getElementById('ops-title').value = d.title || '';
        document.getElementById('ops-impact').value = d.impact || 'Medio';
        document.getElementById('ops-scope-field').value = d.scope || 'General';
        document.getElementById('ops-owner').value = d.owner || '';
    }
    DIALOG.showModal();
  }
  function closeDialog(){ DIALOG.close(); }

  BTN_ADD?.addEventListener('click', ()=>openDialog());
  FORM.querySelector('[value="cancel"]')?.addEventListener('click', (e)=>{ e.preventDefault(); closeDialog(); });

  loadInitial();
})();
// ... (El código anterior de initOpsUpdates y demás se mantiene igual) ...

// =========================================================
//  LÓGICA DE FLUJO GUIADO, RESET Y PANTALLA FINAL
// =========================================================

document.addEventListener('DOMContentLoaded', () => {
    // 1. CONFIGURACIÓN DEL FLUJO (Orden y Checkbox asociado)
    const WIDGET_MAP = [
        { id: 'team-widget',        check: 'c1', label: '1. Dotación' },
        { id: 'ops-updates-widget', check: 'c2', label: '2. Actualizaciones' },
        { id: 'prev-shift-widget',  check: 'c3', label: '3. Turno Anterior' },
        { id: 'seguridad-widget',   check: 'c4', label: '4. Seguridad' },
        { id: 'incidentes-widget',  check: 'c5', label: '5. Incidentes' },
        { id: 'kpi-center',         check: 'c6', label: '6. KPIs' },
        { id: 'kanban-widget',      check: 'c7', label: '7. Feedback' }
    ];

    // 2. INYECTAR BARRAS DE NAVEGACIÓN
    function injectNavigation() {
        WIDGET_MAP.forEach((step, index) => {
            const widget = document.getElementById(step.id);
            if (!widget || widget.querySelector('.widget-nav-bar')) return;

            const prevStep = index > 0 ? WIDGET_MAP[index - 1] : null;
            const nextStep = index < WIDGET_MAP.length - 1 ? WIDGET_MAP[index + 1] : null;
            
            const navBar = document.createElement('div');
            navBar.className = 'widget-nav-bar';
            navBar.innerHTML = `
                <div class="nav-group">
                    <button class="btn-nav" onclick="navTo('${prevStep ? prevStep.id : ''}')" ${!prevStep?'disabled':''}>
                        ⬅ Anterior
                    </button>
                </div>
                <div class="nav-group" style="font-size:0.9rem; color:#64748b;">
                    ${step.label} (${index + 1}/${WIDGET_MAP.length})
                </div>
                <div class="nav-group">
                    <button class="btn-nav home" onclick="exitFlow()">Salir ✖</button>
                    <button class="btn-nav next-ok" onclick="markOkAndNext('${step.check}', '${nextStep ? nextStep.id : ''}')">
                        ✅ OK y Siguiente ➡
                    </button>
                </div>
            `;
            widget.prepend(navBar);
        });
    }
    injectNavigation();

    // 3. LÓGICA DE RESET DEL CRONÓMETRO Y CHECKLIST
    const resetBtn = document.getElementById('timer-reset');
    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if (!confirm("¿Reiniciar turno? Se borrarán los checks y el tiempo.")) return;
            
            // A. Reset visual checkboxes
            document.querySelectorAll('#brief-check input[type="radio"]').forEach(r => r.checked = false);
            
            // B. Borrar localStorage específico del checklist
            Object.keys(localStorage).forEach(k => {
                if(k.includes('brief_check')) localStorage.removeItem(k);
            });
            
            // C. Recalcular spotlight (volver al paso 1)
            if(window.updateSpotlightRouting) window.updateSpotlightRouting();
            
            // D. Reset texto meta
            const meta = document.getElementById('brief-check-meta');
            if(meta) meta.textContent = "—";

            console.log("♻️ Checklist reiniciado.");
        });
    }
});

// --- FUNCIONES GLOBALES (Window) PARA LOS BOTONES ONCLICK ---

window.navTo = function(targetId) {
    if (!targetId) return;
    // Salir de pantalla completa anterior si la hay
    if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
    document.querySelectorAll('.widget--zoomed').forEach(el => el.classList.remove('widget--zoomed'));

    setTimeout(() => {
        const el = document.getElementById(targetId);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Intentar fullscreen nativo, si falla, usar CSS zoom
            if (el.requestFullscreen) {
                el.requestFullscreen({ navigationUI: 'hide' }).catch(() => el.classList.add('widget--zoomed'));
            } else {
                el.classList.add('widget--zoomed');
            }
        }
    }, 100);
};

window.exitFlow = function() {
    if (document.exitFullscreen) document.exitFullscreen().catch(() => {});
    document.querySelectorAll('.widget--zoomed').forEach(el => el.classList.remove('widget--zoomed'));
    if(window.updateSpotlightRouting) window.updateSpotlightRouting();
};

window.markOkAndNext = function(checkName, nextId) {
    // 1. Marcar OK
    if (checkName) {
        const radio = document.querySelector(`input[name="${checkName}"][value="OK"]`);
        if (radio) {
            radio.checked = true;
            // Disparar eventos para persistencia y spotlight
            radio.dispatchEvent(new Event('change', { bubbles: true }));
            radio.dispatchEvent(new Event('input', { bubbles: true }));
        }
    }

    // 2. Navegar
    if (nextId) {
        navTo(nextId);
    } else {
        // Fin del flujo
        exitFlow();
        // Scroll suave al botón de generar
        document.querySelector('header').scrollIntoView({behavior:'smooth'});
        // Pequeño feedback
        setTimeout(() => alert("🎉 Checklist completado. Ahora puedes generar el resumen."), 300);
    }
};


/* =================================================
   PANTALLA MODO INFO (POST-BRIEFING)
   ================================================= */

window.openPostBriefingMode = function() {
    console.log("🚀 Activando Modo Info...");
    const screen = document.getElementById('post-briefing-screen');
    if (!screen) return console.error("Falta #post-briefing-screen en el HTML");

    // --- 1. RECOGER HIGHLIGHTS (NUEVA LÓGICA DE LISTA) ---
    const prevItems = document.querySelectorAll('#prev-list .prev-text');
    let prevHtml = '<ul style="padding-left:20px; font-size:1.1rem; line-height:1.6;">';
    
    if (prevItems.length === 0) {
        prevHtml += "<li>Sin novedades registradas</li>";
    } else {
        prevItems.forEach(el => {
            prevHtml += `<li style="margin-bottom:10px;">${el.innerText}</li>`;
        });
    }
    prevHtml += "</ul>";
    document.getElementById('pb-prev-content').innerHTML = prevHtml;

    // --- 2. RECOGER ACTUALIZACIONES OPERATIVAS ---
    const ops = document.querySelectorAll('#ops-list .ops-item .ops-title');
    let opsHtml = '<ul style="padding-left:20px">';
    if (ops.length === 0) opsHtml += "<li>Sin actualizaciones activas</li>";
    ops.forEach(el => opsHtml += `<li style="margin-bottom:8px">${el.innerText}</li>`);
    opsHtml += "</ul>";
    document.getElementById('pb-ops-content').innerHTML = opsHtml;

    // --- 3. RECOGER KPIs ---
    const uph = document.getElementById('kpi-uph')?.innerText || "-";
    const cost = document.getElementById('kpi-total-cost')?.innerText || "-";
    document.getElementById('pb-val-uph').textContent = uph;
    document.getElementById('pb-val-cost').textContent = cost;

    // --- 4. RECOGER SEGURIDAD ---
    const tips = document.getElementById('sec-random-list')?.innerHTML || "";
    const risks = document.querySelectorAll('#sec-cards .ops-item .ops-title');
    let secHtml = `<ul style="padding-left:20px; margin-bottom:15px">${tips}</ul>`;
    if(risks.length > 0){
        secHtml += `<strong style="color:#b91c1c">Riesgos activos:</strong><ul style="padding-left:20px">`;
        risks.forEach(r => secHtml += `<li>${r.innerText}</li>`);
        secHtml += "</ul>";
    }
    document.getElementById('pb-sec-content').innerHTML = secHtml;

    // 2. Mostrar pantalla
    screen.style.display = 'flex';
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(e => console.log(e));
    }
};

window.closePostBriefingMode = function() {
    document.getElementById('post-briefing-screen').style.display = 'none';
    if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});
};

/* ===== GENERAR RESUMEN (CORREGIDO: Recoge OPS + Guardado Excel) ===== */
/* ===== GENERAR RESUMEN (CORREGIDO Y OPTIMIZADO) ===== */

// =========================================================
//  LÓGICA FINAL: CAMBIO DE TURNO, NAVEGACIÓN Y VOZ
// =========================================================

// 1. SISTEMA DE VOZ (MICRÓFONO)
(function initVoiceSystem() {
    console.log("🎤 Inicializando sistema de voz...");
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    // Comprobaciones de seguridad
    const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
    if (!SpeechRecognition) return console.warn("❌ API de voz no soportada.");
    
    const recognition = new SpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = false;
    recognition.interimResults = false;

    let activeBtn = null;
    let activeTarget = null;

    recognition.onstart = () => { if (activeBtn) activeBtn.classList.add('listening'); };
    recognition.onend = () => { 
        if (activeBtn) activeBtn.classList.remove('listening'); 
        activeBtn = null; 
        activeTarget = null; 
    };

    recognition.onresult = (event) => {
        if (!activeTarget) return;
        const transcript = event.results[0][0].transcript;
        const isInput = activeTarget.tagName === 'INPUT' || activeTarget.tagName === 'TEXTAREA';
        
        let currentText = isInput ? activeTarget.value : activeTarget.innerText;
        currentText = currentText || "";
        
        const prefix = (currentText.length > 0 && !currentText.endsWith(' ')) ? ' ' : '';
        const finalText = prefix + transcript.charAt(0).toUpperCase() + transcript.slice(1);

        if (isInput) activeTarget.value = currentText + finalText;
        else activeTarget.innerText = currentText + finalText;

        activeTarget.dispatchEvent(new Event('input', { bubbles: true }));
    };

    recognition.onerror = (event) => {
        if (activeBtn) activeBtn.classList.remove('listening');
        if (event.error === 'not-allowed') alert("⚠️ Permiso denegado. Pulsa el candado 🔒 de la URL.");
    };

    document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-mic');
        if (!btn) return;
        e.preventDefault(); e.stopPropagation();

        if (!isSecure) { alert("⚠️ El micrófono requiere HTTPS."); return; }
        if (btn.classList.contains('listening')) { recognition.stop(); return; }

        const targetId = btn.getAttribute('data-target');
        const targetEl = document.getElementById(targetId);

        if (targetEl) {
            activeBtn = btn;
            activeTarget = targetEl;
            try { recognition.start(); } catch (err) { recognition.stop(); }
        } else {
            alert("Error: No encuentro el campo de texto destino.");
        }
    });
})();

// 2. DETECCIÓN AUTOMÁTICA DE CAMBIO DE TURNO
// 2. DETECCIÓN AUTOMÁTICA DE CAMBIO DE TURNO
(function initAutoShiftChange(){
    let lastShift = null;

    function checkTime() {
        const h = new Date().getHours();
        let currentShift = 'Noche';
        if (h >= 6 && h < 14) currentShift = 'Mañana';
        if (h >= 14 && h < 22) currentShift = 'Tarde';

        if (lastShift === null) { lastShift = currentShift; return; }

        if (currentShift !== lastShift) {
            console.log(`🔄 CAMBIO DE TURNO DETECTADO: ${lastShift} -> ${currentShift}`);
            lastShift = currentShift;
            triggerShiftMode(currentShift);
        }
    }

    window.triggerShiftMode = function(shiftName) {
        // 1. ACTIVAR MODO TURNO (Clase unificada)
        document.body.classList.add('shift-mode'); 
        
        // 2. Resetear Timer
        const btnReset = document.getElementById('timer-reset');
        if(btnReset) btnReset.click();
        
        // 3. Resetear Checks visuales
        document.querySelectorAll('#brief-check input[type="radio"]').forEach(r => r.checked = false);
        
        // 4. Enfocar Checklist (Fake Fullscreen)
        const checklist = document.getElementById('brief-check');
        if(checklist) {
            checklist.classList.add('shift-focus');
            
            // Cambiar título temporalmente para indicar cambio
            const title = checklist.querySelector('.widget-title');
            if(title) {
                if(!title.dataset.original) title.dataset.original = title.innerHTML;
                title.innerHTML = `COMIENZO TURNO: <span style="color:#dc2626">${(shiftName || 'NUEVO').toUpperCase()}</span>`;
            }
        }
    };

    // Función manual para salir y limpiar todo
    window.exitShiftMode = function() {
        // Quitar clases del body
        document.body.classList.remove('shift-mode');
        document.body.classList.remove('shift-active'); // Por si acaso
        
        // Quitar fullscreen del checklist
        const checklist = document.getElementById('brief-check');
        if(checklist) {
            checklist.classList.remove('shift-focus');
            // Restaurar título original
            const title = checklist.querySelector('.widget-title');
            if(title && title.dataset.original) {
                title.innerHTML = title.dataset.original;
            }
        }
    };

    setInterval(checkTime, 1000);
})();

// 3. NAVEGACIÓN GUIADA (ZOOM + CRONO)
window.navTo = function(targetId) {
    const el = document.getElementById(targetId);
    if (!el) return;

    // Limpiar zooms previos
    document.querySelectorAll('.widget--zoomed').forEach(w => w.classList.remove('widget--zoomed'));
    
    // Activar modo tarjeta abierta (hace visible el crono encima)
    document.body.classList.add('card-open');

    // Zoom a la tarjeta
    el.classList.add('widget--zoomed');
    el.scrollTop = 0;
};

window.exitFlow = function() {
    // Quitar zoom
    document.querySelectorAll('.widget--zoomed').forEach(w => w.classList.remove('widget--zoomed'));
    // Quitar estado tarjeta abierta
    document.body.classList.remove('card-open');

    // Si estábamos en modo turno, volver al checklist fullscreen
    if (document.body.classList.contains('shift-mode')) {
        const checklist = document.getElementById('brief-check');
        if(checklist) checklist.classList.add('shift-focus');
    } else {
        // Limpieza total
        document.querySelectorAll('.shift-focus').forEach(w => w.classList.remove('shift-focus'));
    }
    
    if(window.updateSpotlightRouting) window.updateSpotlightRouting();
};

window.markOkAndNext = function(checkName, nextId) {
    // Marcar OK
    if (checkName) {
        const radio = document.querySelector(`input[name="${checkName}"][value="OK"]`);
        if (radio) {
            radio.checked = true;
            radio.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    // Navegar
    if (nextId) {
        navTo(nextId);
    } else {
        exitFlow();
        alert("🎉 Checklist completado.");
    }
};





/* =========================================================
   1. SISTEMA DE FUSION: CORRECTOR DE RUTAS (BASE_PATH)
   ========================================================= */
(function() {
    let path = window.location.pathname;
    if (!path.endsWith('/')) path += '/';
    const BASE_PATH = path; 

    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
        if (typeof url === 'string' && (url.startsWith('api/') || url.startsWith('/api/'))) {
            const cleanUrl = url.startsWith('/') ? url.substring(1) : url;
            url = BASE_PATH + cleanUrl;
        }
        return originalFetch(url, options);
    };

    const OriginalWebSocket = window.WebSocket;
    window.WebSocket = function(url) {
        if (url.includes('/ws') && !url.includes(BASE_PATH)) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            url = `${protocol}//${window.location.host}${BASE_PATH}ws`;
        }
        return new OriginalWebSocket(url);
    };
    console.log("📍 ALM Warehouse - Base detectada:", BASE_PATH);
})();

/* =========================================================
   2. TARJETA 5: INCIDENTES (SOLUCIÓN DEFINITIVA BUG RELOAD)
   ========================================================= */
function initManualIncidents() {
    const KEY = 'incidents_manual_entries_v1';
    const listEl = document.getElementById('incidents-list-container');
    const form = document.getElementById('manual-inc-form');
    if (!listEl || !form) return;

    const load = () => { try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; } };
    const save = (data) => { localStorage.setItem(KEY, JSON.stringify(data)); };
    
    const render = () => {
        const items = load();
        listEl.innerHTML = items.length ? '' : '<div style="text-align:center;padding:20px;color:#9ca3af;">No hay incidentes registrados hoy.</div>';
        items.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
            const card = document.createElement('div');
            const typeClass = item.type === 'incident' ? 'type-incident' : 'type-lesson';
            const badgeText = item.type === 'incident' ? '🔴 INCIDENTE' : '💡 LECCIÓN';
            card.className = `inc-card ${typeClass}`;
            card.innerHTML = `
                <div class="inc-header">
                    <div>
                        <span class="inc-badge">${badgeText}</span>
                        <div class="inc-title" style="margin-top:4px;">${esc(item.title)}</div>
                    </div>
                    <button type="button" class="inc-del-btn" data-id="${item.id}">🗑️</button>
                </div>
                <div class="inc-desc">${esc(item.desc)}</div>`;
            listEl.appendChild(card);
        });
    };

    form.onsubmit = function(e) {
        e.preventDefault(); 
        e.stopPropagation(); // BLOQUEO TOTAL DE RECARGA
        const items = load();
        items.push({ 
            id: Date.now().toString(), 
            type: document.getElementById('new-inc-type').value, 
            title: document.getElementById('new-inc-title').value.trim(), 
            desc: document.getElementById('new-inc-desc').value.trim(), 
            date: new Date().toISOString() 
        });
        save(items);
        form.reset();
        render();
    };

    listEl.onclick = function(e) {
        const btn = e.target.closest('.inc-del-btn');
        if (btn && confirm("¿Borrar registro?")) {
            save(load().filter(i => i.id !== btn.dataset.id));
            render();
        }
    };
    render();
}

function openSupportModal() {
    document.getElementById('support-form').style.display = 'block';
    document.getElementById('support-thanks').style.display = 'none';
    document.getElementById('issue-details').value = '';
    document.getElementById('support-modal').showModal();
}

async function sendDashboardIssue() {
    const type = document.getElementById('issue-type').value;
    const details = document.getElementById('issue-details').value.trim();
    const btn = document.getElementById('btn-submit-support');

    if (!details) return alert("Por favor, describe el error para poder ayudarte.");

    // IDENTIFICACIÓN AUTOMÁTICA DE LA ESTACIÓN
    // Combina el Título (Dashboard - WFSx) y la Ruta (/wfsxwh)
    const stationIdentity = `${document.title} (URL: ${window.location.pathname})`;

    btn.disabled = true;
    btn.textContent = "Enviando...";

    try {
        const payload = {
            estacion: stationIdentity,
            supervisor: document.getElementById('briefing-supervisor')?.value || "No identificado",
            tipo_fallo: type,
            detalles: details
        };

        const res = await fetch('api/report-dashboard-issue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            document.getElementById('display-station-name').textContent = stationIdentity;
            document.getElementById('support-form').style.display = 'none';
            document.getElementById('support-thanks').style.display = 'block';
        } else {
            throw new Error("Error en servidor");
        }
    } catch (e) {
        alert("Fallo al contactar con el sistema de soporte técnico.");
    } finally {
        btn.disabled = false;
        btn.textContent = "AVISAR A SOPORTE";
    }
}
  
/* =========================================================
   3. GENERAR RESUMEN (MAPEADO PARA ALM - SIN ERRORES 422)
   ========================================================= */
async function generateAndSendToExcel() {
    const timerText = document.getElementById('timer-display').textContent;
    
    // Si el cronómetro está en cero, no dejar avanzar (aunque se hackee el botón)
    if (timerText === "00:00:00") {
        alert("⚠️ Es obligatorio iniciar el cronómetro (Botón Comenzar) antes de generar el resumen.");
        return;
    }

    const btn = document.getElementById('btn-generate-summary');
    const supInput = document.getElementById('briefing-supervisor');
    
    if (!supInput || !supInput.value.trim()) {
        alert("⚠️ El nombre del Supervisor es obligatorio.");
        supInput.focus();
        return;
    }

    btn.textContent = 'Enviando...';
    btn.disabled = true;

    try {
        // A. Card 1: Equipo (CORREGIDO)
       // --- DENTRO DEL EVENTO CLICK DEL BOTÓN GENERAR RESUMEN ---
        const team = window.TEAM_STATE;
        
        // Recoger lista filtrada y cruzar con asistencia real en memoria
        const rosterDetails = (team.people || []).map(p => {
            const name = p.nombre_completo;
            const status = team.attendance[name];
            let icon = "➖"; 
            if (status === true) icon = "✅";
            if (status === false) icon = "❌";
            return `${name} (${icon})`;
        }).join(", ") || "Sin personal marcado";;

        // B. Card 3: Highlights Turno Anterior
        const highlights = Array.from(document.querySelectorAll('#prev-list .prev-text'))
                                .map(el => el.innerText).join(" | ");

        // C. Card 2: Actualizaciones Operativas (Desde el DOM)
        const opsNodes = document.querySelectorAll('#ops-list .ops-item');
        const opsData = Array.from(opsNodes).map(node => ({
            title: node.querySelector('.ops-title')?.innerText || '',
            impact: node.querySelector('.ops-impact')?.innerText || 'Medio'
        }));

        // D. SEGURIDAD TOTAL (Card 4 + Card 5)
        const safetyTips = Array.from(document.querySelectorAll('#sec-random-list li')).map(li => ({
            title: "Recordatorio Diario", desc: li.innerText
        }));
        const card4Risks = JSON.parse(localStorage.getItem('sec_cards_v1') || '[]').map(c => ({
            title: "Riesgo Detectado", desc: `${c.title} (Resp: ${c.owner})`
        }));
        const card5Manual = JSON.parse(localStorage.getItem('incidents_manual_entries_v1') || '[]').map(i => ({
            title: i.type.toUpperCase(), desc: `${i.title}: ${i.desc}`
        }));

        const payload = {
            station: "ALM",
            date: new Date().toLocaleDateString('es-ES'),
            shift: document.getElementById('shift-badge-header')?.innerText || 'General',
            timer: document.getElementById('timer-display')?.innerText || '00:00:00',
            briefing_time: new Date().toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}),
            supervisor: supInput.value.trim(),
            checklist: {}, 
            kpis: {
                "UPH": document.getElementById('kpi-uph')?.innerText || "-",
                "Costes": document.getElementById('kpi-total-cost')?.innerText || "-",
                "Backlog": document.getElementById('fiix-backlog')?.innerText || "-"
            },
            roster_details: rosterDetails, // Mapeo exacto para el server
            prev_shift_note: highlights,  // Mapeo exacto para el server
            ops_updates: opsData,
            safety_incidents: [...safetyTips, ...card4Risks, ...card5Manual] // UNIÓN TOTAL
        };

        const res = await fetch('api/briefing/summary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(`Error ${res.status}`);

        alert("✅ Resumen ALM enviado a Excel correctamente.");
        if(window.openPostBriefingMode) window.openPostBriefingMode();
        if(window.resetFactoryTimer) window.resetFactoryTimer();
        supInput.value = "";

    } catch (err) {
        console.error(err);
        alert("❌ Error al enviar. Revisa la conexión.");
    } finally {
        btn.textContent = 'Generar Resumen';
        btn.disabled = false;
    }
}

/* =========================================================
   4. INICIALIZACIÓN FINAL (Funcionalidades Originales)
   ========================================================= */
document.addEventListener('DOMContentLoaded', () => {
    // Vincular botón principal
    const btnResumen = document.querySelector('header .header-controls .btn-primary');
    if (btnResumen) btnResumen.onclick = generateAndSendToExcel;

    // Lanzar módulos originales
    try { initDateTimeAndShift(); } catch(e){}
    try { initHeaderTimer(); } catch(e){}
    try { setupEventListeners(); } catch(e){} 
    try { makeColumnsSortable(); } catch(e){}
    try { hydrateKpiTotalCost(); } catch(e){}
    try { loadBoardsInitial(); } catch(e){}
    try { loadIncidentes(); } catch(e){}
    try { connectWebSocket(); } catch(e){}
    try { initTeamRoster(); } catch(e){}
    try { initEhsSimple(); } catch(e){}
    try { initFullscreenToggles(); } catch(e){}
    try { init5S(); } catch(e){}
    try { initPrevShiftSystem(); } catch(e){} 
    try { initManualIncidents(); } catch(e){} 
    try { initAutoShiftChange(); } catch(e){} 
    
    // Voz
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR) {
        const r = new SR(); r.lang = 'es-ES';
        document.body.addEventListener('click', e => {
            const btn = e.target.closest('.btn-mic');
            if(btn) { 
                const target = document.getElementById(btn.dataset.target);
                r.start(); btn.classList.add('listening');
                r.onresult = ev => { target.value += " " + ev.results[0][0].transcript; target.dispatchEvent(new Event('input')); };
                r.onend = () => btn.classList.remove('listening');
            }
        });
    }
});
</script>
</body>
</html>
